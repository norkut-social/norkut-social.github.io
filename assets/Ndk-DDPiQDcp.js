var yi=Object.defineProperty;var gi=(t,e,n)=>e in t?yi(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var _=(t,e,n)=>gi(t,typeof e!="symbol"?e+"":e,n);import{H as Hash$2,x as createView$2,y as toBytes$2,z as wrapConstructor$2,A as rotr$2,B as bech32,q as bytesToHex$3,C as hexToBytes$3,D as concatBytes$4,E as randomBytes$2,G as base64,s as defineStore}from"./index-BJ0JNMUl.js";function number$3(t){if(!Number.isSafeInteger(t)||t<0)throw new Error(`Wrong positive integer: ${t}`)}function bytes$3(t,...e){if(!(t instanceof Uint8Array))throw new Error("Expected Uint8Array");if(e.length>0&&!e.includes(t.length))throw new Error(`Expected Uint8Array of length ${e}, not of length=${t.length}`)}function hash$2(t){if(typeof t!="function"||typeof t.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");number$3(t.outputLen),number$3(t.blockLen)}function exists$2(t,e=!0){if(t.destroyed)throw new Error("Hash instance has been destroyed");if(e&&t.finished)throw new Error("Hash#digest() has already been called")}function output$2(t,e){bytes$3(t);const n=e.outputLen;if(t.length<n)throw new Error(`digestInto() expects output buffer of length at least ${n}`)}const crypto$2=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */const u8a$1=t=>t instanceof Uint8Array,createView$1=t=>new DataView(t.buffer,t.byteOffset,t.byteLength),rotr$1=(t,e)=>t<<32-e|t>>>e,isLE$1=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!isLE$1)throw new Error("Non little-endian hardware is not supported");function utf8ToBytes$3(t){if(typeof t!="string")throw new Error(`utf8ToBytes expected string, got ${typeof t}`);return new Uint8Array(new TextEncoder().encode(t))}function toBytes$1(t){if(typeof t=="string"&&(t=utf8ToBytes$3(t)),!u8a$1(t))throw new Error(`expected Uint8Array, got ${typeof t}`);return t}function concatBytes$3(...t){const e=new Uint8Array(t.reduce((r,s)=>r+s.length,0));let n=0;return t.forEach(r=>{if(!u8a$1(r))throw new Error("Uint8Array expected");e.set(r,n),n+=r.length}),e}let Hash$1=class{clone(){return this._cloneInto()}};function wrapConstructor$1(t){const e=r=>t().update(toBytes$1(r)).digest(),n=t();return e.outputLen=n.outputLen,e.blockLen=n.blockLen,e.create=()=>t(),e}function randomBytes$1(t=32){if(crypto$2&&typeof crypto$2.getRandomValues=="function")return crypto$2.getRandomValues(new Uint8Array(t));throw new Error("crypto.getRandomValues must be defined")}function setBigUint64$2(t,e,n,r){if(typeof t.setBigUint64=="function")return t.setBigUint64(e,n,r);const s=BigInt(32),a=BigInt(4294967295),u=Number(n>>s&a),l=Number(n&a),f=r?4:0,y=r?0:4;t.setUint32(e+f,u,r),t.setUint32(e+y,l,r)}let SHA2$1=class extends Hash$1{constructor(e,n,r,s){super(),this.blockLen=e,this.outputLen=n,this.padOffset=r,this.isLE=s,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=createView$1(this.buffer)}update(e){exists$2(this);const{view:n,buffer:r,blockLen:s}=this;e=toBytes$1(e);const a=e.length;for(let u=0;u<a;){const l=Math.min(s-this.pos,a-u);if(l===s){const f=createView$1(e);for(;s<=a-u;u+=s)this.process(f,u);continue}r.set(e.subarray(u,u+l),this.pos),this.pos+=l,u+=l,this.pos===s&&(this.process(n,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){exists$2(this),output$2(e,this),this.finished=!0;const{buffer:n,view:r,blockLen:s,isLE:a}=this;let{pos:u}=this;n[u++]=128,this.buffer.subarray(u).fill(0),this.padOffset>s-u&&(this.process(r,0),u=0);for(let m=u;m<s;m++)n[m]=0;setBigUint64$2(r,s-8,BigInt(this.length*8),a),this.process(r,0);const l=createView$1(e),f=this.outputLen;if(f%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const y=f/4,b=this.get();if(y>b.length)throw new Error("_sha2: outputLen bigger than state");for(let m=0;m<y;m++)l.setUint32(4*m,b[m],a)}digest(){const{buffer:e,outputLen:n}=this;this.digestInto(e);const r=e.slice(0,n);return this.destroy(),r}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:n,buffer:r,length:s,finished:a,destroyed:u,pos:l}=this;return e.length=s,e.pos=l,e.finished=a,e.destroyed=u,s%n&&e.buffer.set(r),e}};const Chi$2=(t,e,n)=>t&e^~t&n,Maj$2=(t,e,n)=>t&e^t&n^e&n,SHA256_K$2=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),IV$1=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),SHA256_W$2=new Uint32Array(64);let SHA256$2=class extends SHA2$1{constructor(){super(64,32,8,!1),this.A=IV$1[0]|0,this.B=IV$1[1]|0,this.C=IV$1[2]|0,this.D=IV$1[3]|0,this.E=IV$1[4]|0,this.F=IV$1[5]|0,this.G=IV$1[6]|0,this.H=IV$1[7]|0}get(){const{A:e,B:n,C:r,D:s,E:a,F:u,G:l,H:f}=this;return[e,n,r,s,a,u,l,f]}set(e,n,r,s,a,u,l,f){this.A=e|0,this.B=n|0,this.C=r|0,this.D=s|0,this.E=a|0,this.F=u|0,this.G=l|0,this.H=f|0}process(e,n){for(let m=0;m<16;m++,n+=4)SHA256_W$2[m]=e.getUint32(n,!1);for(let m=16;m<64;m++){const E=SHA256_W$2[m-15],C=SHA256_W$2[m-2],O=rotr$1(E,7)^rotr$1(E,18)^E>>>3,$=rotr$1(C,17)^rotr$1(C,19)^C>>>10;SHA256_W$2[m]=$+SHA256_W$2[m-7]+O+SHA256_W$2[m-16]|0}let{A:r,B:s,C:a,D:u,E:l,F:f,G:y,H:b}=this;for(let m=0;m<64;m++){const E=rotr$1(l,6)^rotr$1(l,11)^rotr$1(l,25),C=b+E+Chi$2(l,f,y)+SHA256_K$2[m]+SHA256_W$2[m]|0,$=(rotr$1(r,2)^rotr$1(r,13)^rotr$1(r,22))+Maj$2(r,s,a)|0;b=y,y=f,f=l,l=u+C|0,u=a,a=s,s=r,r=C+$|0}r=r+this.A|0,s=s+this.B|0,a=a+this.C|0,u=u+this.D|0,l=l+this.E|0,f=f+this.F|0,y=y+this.G|0,b=b+this.H|0,this.set(r,s,a,u,l,f,y,b)}roundClean(){SHA256_W$2.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};const sha256$2=wrapConstructor$1(()=>new SHA256$2);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const _0n$9=BigInt(0),_1n$9=BigInt(1),_2n$5=BigInt(2),u8a=t=>t instanceof Uint8Array,hexes$2=Array.from({length:256},(t,e)=>e.toString(16).padStart(2,"0"));function bytesToHex$2(t){if(!u8a(t))throw new Error("Uint8Array expected");let e="";for(let n=0;n<t.length;n++)e+=hexes$2[t[n]];return e}function numberToHexUnpadded$1(t){const e=t.toString(16);return e.length&1?`0${e}`:e}function hexToNumber$1(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);return BigInt(t===""?"0":`0x${t}`)}function hexToBytes$2(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);const e=t.length;if(e%2)throw new Error("padded hex string expected, got unpadded hex of length "+e);const n=new Uint8Array(e/2);for(let r=0;r<n.length;r++){const s=r*2,a=t.slice(s,s+2),u=Number.parseInt(a,16);if(Number.isNaN(u)||u<0)throw new Error("Invalid byte sequence");n[r]=u}return n}function bytesToNumberBE$1(t){return hexToNumber$1(bytesToHex$2(t))}function bytesToNumberLE$1(t){if(!u8a(t))throw new Error("Uint8Array expected");return hexToNumber$1(bytesToHex$2(Uint8Array.from(t).reverse()))}function numberToBytesBE$1(t,e){return hexToBytes$2(t.toString(16).padStart(e*2,"0"))}function numberToBytesLE$1(t,e){return numberToBytesBE$1(t,e).reverse()}function numberToVarBytesBE$1(t){return hexToBytes$2(numberToHexUnpadded$1(t))}function ensureBytes$1(t,e,n){let r;if(typeof e=="string")try{r=hexToBytes$2(e)}catch(a){throw new Error(`${t} must be valid hex string, got "${e}". Cause: ${a}`)}else if(u8a(e))r=Uint8Array.from(e);else throw new Error(`${t} must be hex string or Uint8Array`);const s=r.length;if(typeof n=="number"&&s!==n)throw new Error(`${t} expected ${n} bytes, got ${s}`);return r}function concatBytes$2(...t){const e=new Uint8Array(t.reduce((r,s)=>r+s.length,0));let n=0;return t.forEach(r=>{if(!u8a(r))throw new Error("Uint8Array expected");e.set(r,n),n+=r.length}),e}function equalBytes$2(t,e){if(t.length!==e.length)return!1;for(let n=0;n<t.length;n++)if(t[n]!==e[n])return!1;return!0}function utf8ToBytes$2(t){if(typeof t!="string")throw new Error(`utf8ToBytes expected string, got ${typeof t}`);return new Uint8Array(new TextEncoder().encode(t))}function bitLen$1(t){let e;for(e=0;t>_0n$9;t>>=_1n$9,e+=1);return e}function bitGet$1(t,e){return t>>BigInt(e)&_1n$9}const bitSet$1=(t,e,n)=>t|(n?_1n$9:_0n$9)<<BigInt(e),bitMask$1=t=>(_2n$5<<BigInt(t-1))-_1n$9,u8n$1=t=>new Uint8Array(t),u8fr$1=t=>Uint8Array.from(t);function createHmacDrbg$1(t,e,n){if(typeof t!="number"||t<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof n!="function")throw new Error("hmacFn must be a function");let r=u8n$1(t),s=u8n$1(t),a=0;const u=()=>{r.fill(1),s.fill(0),a=0},l=(...m)=>n(s,r,...m),f=(m=u8n$1())=>{s=l(u8fr$1([0]),m),r=l(),m.length!==0&&(s=l(u8fr$1([1]),m),r=l())},y=()=>{if(a++>=1e3)throw new Error("drbg: tried 1000 values");let m=0;const E=[];for(;m<e;){r=l();const C=r.slice();E.push(C),m+=r.length}return concatBytes$2(...E)};return(m,E)=>{u(),f(m);let C;for(;!(C=E(y()));)f();return u(),C}}const validatorFns$1={bigint:t=>typeof t=="bigint",function:t=>typeof t=="function",boolean:t=>typeof t=="boolean",string:t=>typeof t=="string",stringOrUint8Array:t=>typeof t=="string"||t instanceof Uint8Array,isSafeInteger:t=>Number.isSafeInteger(t),array:t=>Array.isArray(t),field:(t,e)=>e.Fp.isValid(t),hash:t=>typeof t=="function"&&Number.isSafeInteger(t.outputLen)};function validateObject$1(t,e,n={}){const r=(s,a,u)=>{const l=validatorFns$1[a];if(typeof l!="function")throw new Error(`Invalid validator "${a}", expected function`);const f=t[s];if(!(u&&f===void 0)&&!l(f,t))throw new Error(`Invalid param ${String(s)}=${f} (${typeof f}), expected ${a}`)};for(const[s,a]of Object.entries(e))r(s,a,!1);for(const[s,a]of Object.entries(n))r(s,a,!0);return t}const ut$1=Object.freeze(Object.defineProperty({__proto__:null,bitGet:bitGet$1,bitLen:bitLen$1,bitMask:bitMask$1,bitSet:bitSet$1,bytesToHex:bytesToHex$2,bytesToNumberBE:bytesToNumberBE$1,bytesToNumberLE:bytesToNumberLE$1,concatBytes:concatBytes$2,createHmacDrbg:createHmacDrbg$1,ensureBytes:ensureBytes$1,equalBytes:equalBytes$2,hexToBytes:hexToBytes$2,hexToNumber:hexToNumber$1,numberToBytesBE:numberToBytesBE$1,numberToBytesLE:numberToBytesLE$1,numberToHexUnpadded:numberToHexUnpadded$1,numberToVarBytesBE:numberToVarBytesBE$1,utf8ToBytes:utf8ToBytes$2,validateObject:validateObject$1},Symbol.toStringTag,{value:"Module"}));/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const _0n$8=BigInt(0),_1n$8=BigInt(1),_2n$4=BigInt(2),_3n$3=BigInt(3),_4n$1=BigInt(4),_5n$1=BigInt(5),_8n$1=BigInt(8);BigInt(9);BigInt(16);function mod$1(t,e){const n=t%e;return n>=_0n$8?n:e+n}function pow$1(t,e,n){if(n<=_0n$8||e<_0n$8)throw new Error("Expected power/modulo > 0");if(n===_1n$8)return _0n$8;let r=_1n$8;for(;e>_0n$8;)e&_1n$8&&(r=r*t%n),t=t*t%n,e>>=_1n$8;return r}function pow2$1(t,e,n){let r=t;for(;e-- >_0n$8;)r*=r,r%=n;return r}function invert$1(t,e){if(t===_0n$8||e<=_0n$8)throw new Error(`invert: expected positive integers, got n=${t} mod=${e}`);let n=mod$1(t,e),r=e,s=_0n$8,a=_1n$8;for(;n!==_0n$8;){const l=r/n,f=r%n,y=s-a*l;r=n,n=f,s=a,a=y}if(r!==_1n$8)throw new Error("invert: does not exist");return mod$1(s,e)}function tonelliShanks$1(t){const e=(t-_1n$8)/_2n$4;let n,r,s;for(n=t-_1n$8,r=0;n%_2n$4===_0n$8;n/=_2n$4,r++);for(s=_2n$4;s<t&&pow$1(s,e,t)!==t-_1n$8;s++);if(r===1){const u=(t+_1n$8)/_4n$1;return function(f,y){const b=f.pow(y,u);if(!f.eql(f.sqr(b),y))throw new Error("Cannot find square root");return b}}const a=(n+_1n$8)/_2n$4;return function(l,f){if(l.pow(f,e)===l.neg(l.ONE))throw new Error("Cannot find square root");let y=r,b=l.pow(l.mul(l.ONE,s),n),m=l.pow(f,a),E=l.pow(f,n);for(;!l.eql(E,l.ONE);){if(l.eql(E,l.ZERO))return l.ZERO;let C=1;for(let $=l.sqr(E);C<y&&!l.eql($,l.ONE);C++)$=l.sqr($);const O=l.pow(b,_1n$8<<BigInt(y-C-1));b=l.sqr(O),m=l.mul(m,O),E=l.mul(E,b),y=C}return m}}function FpSqrt$1(t){if(t%_4n$1===_3n$3){const e=(t+_1n$8)/_4n$1;return function(r,s){const a=r.pow(s,e);if(!r.eql(r.sqr(a),s))throw new Error("Cannot find square root");return a}}if(t%_8n$1===_5n$1){const e=(t-_5n$1)/_8n$1;return function(r,s){const a=r.mul(s,_2n$4),u=r.pow(a,e),l=r.mul(s,u),f=r.mul(r.mul(l,_2n$4),u),y=r.mul(l,r.sub(f,r.ONE));if(!r.eql(r.sqr(y),s))throw new Error("Cannot find square root");return y}}return tonelliShanks$1(t)}const FIELD_FIELDS$1=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function validateField$1(t){const e={ORDER:"bigint",MASK:"bigint",BYTES:"isSafeInteger",BITS:"isSafeInteger"},n=FIELD_FIELDS$1.reduce((r,s)=>(r[s]="function",r),e);return validateObject$1(t,n)}function FpPow$1(t,e,n){if(n<_0n$8)throw new Error("Expected power > 0");if(n===_0n$8)return t.ONE;if(n===_1n$8)return e;let r=t.ONE,s=e;for(;n>_0n$8;)n&_1n$8&&(r=t.mul(r,s)),s=t.sqr(s),n>>=_1n$8;return r}function FpInvertBatch$1(t,e){const n=new Array(e.length),r=e.reduce((a,u,l)=>t.is0(u)?a:(n[l]=a,t.mul(a,u)),t.ONE),s=t.inv(r);return e.reduceRight((a,u,l)=>t.is0(u)?a:(n[l]=t.mul(a,n[l]),t.mul(a,u)),s),n}function nLength$1(t,e){const n=e!==void 0?e:t.toString(2).length,r=Math.ceil(n/8);return{nBitLength:n,nByteLength:r}}function Field$1(t,e,n=!1,r={}){if(t<=_0n$8)throw new Error(`Expected Field ORDER > 0, got ${t}`);const{nBitLength:s,nByteLength:a}=nLength$1(t,e);if(a>2048)throw new Error("Field lengths over 2048 bytes are not supported");const u=FpSqrt$1(t),l=Object.freeze({ORDER:t,BITS:s,BYTES:a,MASK:bitMask$1(s),ZERO:_0n$8,ONE:_1n$8,create:f=>mod$1(f,t),isValid:f=>{if(typeof f!="bigint")throw new Error(`Invalid field element: expected bigint, got ${typeof f}`);return _0n$8<=f&&f<t},is0:f=>f===_0n$8,isOdd:f=>(f&_1n$8)===_1n$8,neg:f=>mod$1(-f,t),eql:(f,y)=>f===y,sqr:f=>mod$1(f*f,t),add:(f,y)=>mod$1(f+y,t),sub:(f,y)=>mod$1(f-y,t),mul:(f,y)=>mod$1(f*y,t),pow:(f,y)=>FpPow$1(l,f,y),div:(f,y)=>mod$1(f*invert$1(y,t),t),sqrN:f=>f*f,addN:(f,y)=>f+y,subN:(f,y)=>f-y,mulN:(f,y)=>f*y,inv:f=>invert$1(f,t),sqrt:r.sqrt||(f=>u(l,f)),invertBatch:f=>FpInvertBatch$1(l,f),cmov:(f,y,b)=>b?y:f,toBytes:f=>n?numberToBytesLE$1(f,a):numberToBytesBE$1(f,a),fromBytes:f=>{if(f.length!==a)throw new Error(`Fp.fromBytes: expected ${a}, got ${f.length}`);return n?bytesToNumberLE$1(f):bytesToNumberBE$1(f)}});return Object.freeze(l)}function getFieldBytesLength$1(t){if(typeof t!="bigint")throw new Error("field order must be bigint");const e=t.toString(2).length;return Math.ceil(e/8)}function getMinHashLength$1(t){const e=getFieldBytesLength$1(t);return e+Math.ceil(e/2)}function mapHashToField$1(t,e,n=!1){const r=t.length,s=getFieldBytesLength$1(e),a=getMinHashLength$1(e);if(r<16||r<a||r>1024)throw new Error(`expected ${a}-1024 bytes of input, got ${r}`);const u=n?bytesToNumberBE$1(t):bytesToNumberLE$1(t),l=mod$1(u,e-_1n$8)+_1n$8;return n?numberToBytesLE$1(l,s):numberToBytesBE$1(l,s)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const _0n$7=BigInt(0),_1n$7=BigInt(1);function wNAF$1(t,e){const n=(s,a)=>{const u=a.negate();return s?u:a},r=s=>{const a=Math.ceil(e/s)+1,u=2**(s-1);return{windows:a,windowSize:u}};return{constTimeNegate:n,unsafeLadder(s,a){let u=t.ZERO,l=s;for(;a>_0n$7;)a&_1n$7&&(u=u.add(l)),l=l.double(),a>>=_1n$7;return u},precomputeWindow(s,a){const{windows:u,windowSize:l}=r(a),f=[];let y=s,b=y;for(let m=0;m<u;m++){b=y,f.push(b);for(let E=1;E<l;E++)b=b.add(y),f.push(b);y=b.double()}return f},wNAF(s,a,u){const{windows:l,windowSize:f}=r(s);let y=t.ZERO,b=t.BASE;const m=BigInt(2**s-1),E=2**s,C=BigInt(s);for(let O=0;O<l;O++){const $=O*f;let k=Number(u&m);u>>=C,k>f&&(k-=E,u+=_1n$7);const I=$,q=$+Math.abs(k)-1,W=O%2!==0,te=k<0;k===0?b=b.add(n(W,a[I])):y=y.add(n(te,a[q]))}return{p:y,f:b}},wNAFCached(s,a,u,l){const f=s._WINDOW_SIZE||1;let y=a.get(s);return y||(y=this.precomputeWindow(s,f),f!==1&&a.set(s,l(y))),this.wNAF(f,y,u)}}}function validateBasic$1(t){return validateField$1(t.Fp),validateObject$1(t,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...nLength$1(t.n,t.nBitLength),...t,p:t.Fp.ORDER})}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function validatePointOpts$1(t){const e=validateBasic$1(t);validateObject$1(e,{a:"field",b:"field"},{allowedPrivateKeyLengths:"array",wrapPrivateKey:"boolean",isTorsionFree:"function",clearCofactor:"function",allowInfinityPoint:"boolean",fromBytes:"function",toBytes:"function"});const{endo:n,Fp:r,a:s}=e;if(n){if(!r.eql(s,r.ZERO))throw new Error("Endomorphism can only be defined for Koblitz curves that have a=0");if(typeof n!="object"||typeof n.beta!="bigint"||typeof n.splitScalar!="function")throw new Error("Expected endomorphism with beta: bigint and splitScalar: function")}return Object.freeze({...e})}const{bytesToNumberBE:b2n$1,hexToBytes:h2b$1}=ut$1,DER$1={Err:class extends Error{constructor(e=""){super(e)}},_parseInt(t){const{Err:e}=DER$1;if(t.length<2||t[0]!==2)throw new e("Invalid signature integer tag");const n=t[1],r=t.subarray(2,n+2);if(!n||r.length!==n)throw new e("Invalid signature integer: wrong length");if(r[0]&128)throw new e("Invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new e("Invalid signature integer: unnecessary leading zero");return{d:b2n$1(r),l:t.subarray(n+2)}},toSig(t){const{Err:e}=DER$1,n=typeof t=="string"?h2b$1(t):t;if(!(n instanceof Uint8Array))throw new Error("ui8a expected");let r=n.length;if(r<2||n[0]!=48)throw new e("Invalid signature tag");if(n[1]!==r-2)throw new e("Invalid signature: incorrect length");const{d:s,l:a}=DER$1._parseInt(n.subarray(2)),{d:u,l}=DER$1._parseInt(a);if(l.length)throw new e("Invalid signature: left bytes after parsing");return{r:s,s:u}},hexFromSig(t){const e=y=>Number.parseInt(y[0],16)&8?"00"+y:y,n=y=>{const b=y.toString(16);return b.length&1?`0${b}`:b},r=e(n(t.s)),s=e(n(t.r)),a=r.length/2,u=s.length/2,l=n(a),f=n(u);return`30${n(u+a+4)}02${f}${s}02${l}${r}`}},_0n$6=BigInt(0),_1n$6=BigInt(1);BigInt(2);const _3n$2=BigInt(3);BigInt(4);function weierstrassPoints$1(t){const e=validatePointOpts$1(t),{Fp:n}=e,r=e.toBytes||((O,$,k)=>{const I=$.toAffine();return concatBytes$2(Uint8Array.from([4]),n.toBytes(I.x),n.toBytes(I.y))}),s=e.fromBytes||(O=>{const $=O.subarray(1),k=n.fromBytes($.subarray(0,n.BYTES)),I=n.fromBytes($.subarray(n.BYTES,2*n.BYTES));return{x:k,y:I}});function a(O){const{a:$,b:k}=e,I=n.sqr(O),q=n.mul(I,O);return n.add(n.add(q,n.mul(O,$)),k)}if(!n.eql(n.sqr(e.Gy),a(e.Gx)))throw new Error("bad generator point: equation left != right");function u(O){return typeof O=="bigint"&&_0n$6<O&&O<e.n}function l(O){if(!u(O))throw new Error("Expected valid bigint: 0 < bigint < curve.n")}function f(O){const{allowedPrivateKeyLengths:$,nByteLength:k,wrapPrivateKey:I,n:q}=e;if($&&typeof O!="bigint"){if(O instanceof Uint8Array&&(O=bytesToHex$2(O)),typeof O!="string"||!$.includes(O.length))throw new Error("Invalid key");O=O.padStart(k*2,"0")}let W;try{W=typeof O=="bigint"?O:bytesToNumberBE$1(ensureBytes$1("private key",O,k))}catch{throw new Error(`private key must be ${k} bytes, hex or bigint, not ${typeof O}`)}return I&&(W=mod$1(W,q)),l(W),W}const y=new Map;function b(O){if(!(O instanceof m))throw new Error("ProjectivePoint expected")}class m{constructor($,k,I){if(this.px=$,this.py=k,this.pz=I,$==null||!n.isValid($))throw new Error("x required");if(k==null||!n.isValid(k))throw new Error("y required");if(I==null||!n.isValid(I))throw new Error("z required")}static fromAffine($){const{x:k,y:I}=$||{};if(!$||!n.isValid(k)||!n.isValid(I))throw new Error("invalid affine point");if($ instanceof m)throw new Error("projective point not allowed");const q=W=>n.eql(W,n.ZERO);return q(k)&&q(I)?m.ZERO:new m(k,I,n.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ($){const k=n.invertBatch($.map(I=>I.pz));return $.map((I,q)=>I.toAffine(k[q])).map(m.fromAffine)}static fromHex($){const k=m.fromAffine(s(ensureBytes$1("pointHex",$)));return k.assertValidity(),k}static fromPrivateKey($){return m.BASE.multiply(f($))}_setWindowSize($){this._WINDOW_SIZE=$,y.delete(this)}assertValidity(){if(this.is0()){if(e.allowInfinityPoint&&!n.is0(this.py))return;throw new Error("bad point: ZERO")}const{x:$,y:k}=this.toAffine();if(!n.isValid($)||!n.isValid(k))throw new Error("bad point: x or y not FE");const I=n.sqr(k),q=a($);if(!n.eql(I,q))throw new Error("bad point: equation left != right");if(!this.isTorsionFree())throw new Error("bad point: not in prime-order subgroup")}hasEvenY(){const{y:$}=this.toAffine();if(n.isOdd)return!n.isOdd($);throw new Error("Field doesn't support isOdd")}equals($){b($);const{px:k,py:I,pz:q}=this,{px:W,py:te,pz:oe}=$,V=n.eql(n.mul(k,oe),n.mul(W,q)),j=n.eql(n.mul(I,oe),n.mul(te,q));return V&&j}negate(){return new m(this.px,n.neg(this.py),this.pz)}double(){const{a:$,b:k}=e,I=n.mul(k,_3n$2),{px:q,py:W,pz:te}=this;let oe=n.ZERO,V=n.ZERO,j=n.ZERO,G=n.mul(q,q),le=n.mul(W,W),me=n.mul(te,te),ce=n.mul(q,W);return ce=n.add(ce,ce),j=n.mul(q,te),j=n.add(j,j),oe=n.mul($,j),V=n.mul(I,me),V=n.add(oe,V),oe=n.sub(le,V),V=n.add(le,V),V=n.mul(oe,V),oe=n.mul(ce,oe),j=n.mul(I,j),me=n.mul($,me),ce=n.sub(G,me),ce=n.mul($,ce),ce=n.add(ce,j),j=n.add(G,G),G=n.add(j,G),G=n.add(G,me),G=n.mul(G,ce),V=n.add(V,G),me=n.mul(W,te),me=n.add(me,me),G=n.mul(me,ce),oe=n.sub(oe,G),j=n.mul(me,le),j=n.add(j,j),j=n.add(j,j),new m(oe,V,j)}add($){b($);const{px:k,py:I,pz:q}=this,{px:W,py:te,pz:oe}=$;let V=n.ZERO,j=n.ZERO,G=n.ZERO;const le=e.a,me=n.mul(e.b,_3n$2);let ce=n.mul(k,W),de=n.mul(I,te),be=n.mul(q,oe),Q=n.add(k,I),F=n.add(W,te);Q=n.mul(Q,F),F=n.add(ce,de),Q=n.sub(Q,F),F=n.add(k,q);let H=n.add(W,oe);return F=n.mul(F,H),H=n.add(ce,be),F=n.sub(F,H),H=n.add(I,q),V=n.add(te,oe),H=n.mul(H,V),V=n.add(de,be),H=n.sub(H,V),G=n.mul(le,F),V=n.mul(me,be),G=n.add(V,G),V=n.sub(de,G),G=n.add(de,G),j=n.mul(V,G),de=n.add(ce,ce),de=n.add(de,ce),be=n.mul(le,be),F=n.mul(me,F),de=n.add(de,be),be=n.sub(ce,be),be=n.mul(le,be),F=n.add(F,be),ce=n.mul(de,F),j=n.add(j,ce),ce=n.mul(H,F),V=n.mul(Q,V),V=n.sub(V,ce),ce=n.mul(Q,de),G=n.mul(H,G),G=n.add(G,ce),new m(V,j,G)}subtract($){return this.add($.negate())}is0(){return this.equals(m.ZERO)}wNAF($){return C.wNAFCached(this,y,$,k=>{const I=n.invertBatch(k.map(q=>q.pz));return k.map((q,W)=>q.toAffine(I[W])).map(m.fromAffine)})}multiplyUnsafe($){const k=m.ZERO;if($===_0n$6)return k;if(l($),$===_1n$6)return this;const{endo:I}=e;if(!I)return C.unsafeLadder(this,$);let{k1neg:q,k1:W,k2neg:te,k2:oe}=I.splitScalar($),V=k,j=k,G=this;for(;W>_0n$6||oe>_0n$6;)W&_1n$6&&(V=V.add(G)),oe&_1n$6&&(j=j.add(G)),G=G.double(),W>>=_1n$6,oe>>=_1n$6;return q&&(V=V.negate()),te&&(j=j.negate()),j=new m(n.mul(j.px,I.beta),j.py,j.pz),V.add(j)}multiply($){l($);let k=$,I,q;const{endo:W}=e;if(W){const{k1neg:te,k1:oe,k2neg:V,k2:j}=W.splitScalar(k);let{p:G,f:le}=this.wNAF(oe),{p:me,f:ce}=this.wNAF(j);G=C.constTimeNegate(te,G),me=C.constTimeNegate(V,me),me=new m(n.mul(me.px,W.beta),me.py,me.pz),I=G.add(me),q=le.add(ce)}else{const{p:te,f:oe}=this.wNAF(k);I=te,q=oe}return m.normalizeZ([I,q])[0]}multiplyAndAddUnsafe($,k,I){const q=m.BASE,W=(oe,V)=>V===_0n$6||V===_1n$6||!oe.equals(q)?oe.multiplyUnsafe(V):oe.multiply(V),te=W(this,k).add(W($,I));return te.is0()?void 0:te}toAffine($){const{px:k,py:I,pz:q}=this,W=this.is0();$==null&&($=W?n.ONE:n.inv(q));const te=n.mul(k,$),oe=n.mul(I,$),V=n.mul(q,$);if(W)return{x:n.ZERO,y:n.ZERO};if(!n.eql(V,n.ONE))throw new Error("invZ was invalid");return{x:te,y:oe}}isTorsionFree(){const{h:$,isTorsionFree:k}=e;if($===_1n$6)return!0;if(k)return k(m,this);throw new Error("isTorsionFree() has not been declared for the elliptic curve")}clearCofactor(){const{h:$,clearCofactor:k}=e;return $===_1n$6?this:k?k(m,this):this.multiplyUnsafe(e.h)}toRawBytes($=!0){return this.assertValidity(),r(m,this,$)}toHex($=!0){return bytesToHex$2(this.toRawBytes($))}}m.BASE=new m(e.Gx,e.Gy,n.ONE),m.ZERO=new m(n.ZERO,n.ONE,n.ZERO);const E=e.nBitLength,C=wNAF$1(m,e.endo?Math.ceil(E/2):E);return{CURVE:e,ProjectivePoint:m,normPrivateKeyToScalar:f,weierstrassEquation:a,isWithinCurveOrder:u}}function validateOpts$1(t){const e=validateBasic$1(t);return validateObject$1(e,{hash:"hash",hmac:"function",randomBytes:"function"},{bits2int:"function",bits2int_modN:"function",lowS:"boolean"}),Object.freeze({lowS:!0,...e})}function weierstrass$1(t){const e=validateOpts$1(t),{Fp:n,n:r}=e,s=n.BYTES+1,a=2*n.BYTES+1;function u(F){return _0n$6<F&&F<n.ORDER}function l(F){return mod$1(F,r)}function f(F){return invert$1(F,r)}const{ProjectivePoint:y,normPrivateKeyToScalar:b,weierstrassEquation:m,isWithinCurveOrder:E}=weierstrassPoints$1({...e,toBytes(F,H,Y){const se=H.toAffine(),he=n.toBytes(se.x),ye=concatBytes$2;return Y?ye(Uint8Array.from([H.hasEvenY()?2:3]),he):ye(Uint8Array.from([4]),he,n.toBytes(se.y))},fromBytes(F){const H=F.length,Y=F[0],se=F.subarray(1);if(H===s&&(Y===2||Y===3)){const he=bytesToNumberBE$1(se);if(!u(he))throw new Error("Point is not on curve");const ye=m(he);let we=n.sqrt(ye);const xe=(we&_1n$6)===_1n$6;return(Y&1)===1!==xe&&(we=n.neg(we)),{x:he,y:we}}else if(H===a&&Y===4){const he=n.fromBytes(se.subarray(0,n.BYTES)),ye=n.fromBytes(se.subarray(n.BYTES,2*n.BYTES));return{x:he,y:ye}}else throw new Error(`Point of length ${H} was invalid. Expected ${s} compressed bytes or ${a} uncompressed bytes`)}}),C=F=>bytesToHex$2(numberToBytesBE$1(F,e.nByteLength));function O(F){const H=r>>_1n$6;return F>H}function $(F){return O(F)?l(-F):F}const k=(F,H,Y)=>bytesToNumberBE$1(F.slice(H,Y));class I{constructor(H,Y,se){this.r=H,this.s=Y,this.recovery=se,this.assertValidity()}static fromCompact(H){const Y=e.nByteLength;return H=ensureBytes$1("compactSignature",H,Y*2),new I(k(H,0,Y),k(H,Y,2*Y))}static fromDER(H){const{r:Y,s:se}=DER$1.toSig(ensureBytes$1("DER",H));return new I(Y,se)}assertValidity(){if(!E(this.r))throw new Error("r must be 0 < r < CURVE.n");if(!E(this.s))throw new Error("s must be 0 < s < CURVE.n")}addRecoveryBit(H){return new I(this.r,this.s,H)}recoverPublicKey(H){const{r:Y,s:se,recovery:he}=this,ye=j(ensureBytes$1("msgHash",H));if(he==null||![0,1,2,3].includes(he))throw new Error("recovery id invalid");const we=he===2||he===3?Y+e.n:Y;if(we>=n.ORDER)throw new Error("recovery id 2 or 3 invalid");const xe=he&1?"03":"02",Te=y.fromHex(xe+C(we)),Ue=f(we),Fe=l(-ye*Ue),Ie=l(se*Ue),Ke=y.BASE.multiplyAndAddUnsafe(Te,Fe,Ie);if(!Ke)throw new Error("point at infinify");return Ke.assertValidity(),Ke}hasHighS(){return O(this.s)}normalizeS(){return this.hasHighS()?new I(this.r,l(-this.s),this.recovery):this}toDERRawBytes(){return hexToBytes$2(this.toDERHex())}toDERHex(){return DER$1.hexFromSig({r:this.r,s:this.s})}toCompactRawBytes(){return hexToBytes$2(this.toCompactHex())}toCompactHex(){return C(this.r)+C(this.s)}}const q={isValidPrivateKey(F){try{return b(F),!0}catch{return!1}},normPrivateKeyToScalar:b,randomPrivateKey:()=>{const F=getMinHashLength$1(e.n);return mapHashToField$1(e.randomBytes(F),e.n)},precompute(F=8,H=y.BASE){return H._setWindowSize(F),H.multiply(BigInt(3)),H}};function W(F,H=!0){return y.fromPrivateKey(F).toRawBytes(H)}function te(F){const H=F instanceof Uint8Array,Y=typeof F=="string",se=(H||Y)&&F.length;return H?se===s||se===a:Y?se===2*s||se===2*a:F instanceof y}function oe(F,H,Y=!0){if(te(F))throw new Error("first arg must be private key");if(!te(H))throw new Error("second arg must be public key");return y.fromHex(H).multiply(b(F)).toRawBytes(Y)}const V=e.bits2int||function(F){const H=bytesToNumberBE$1(F),Y=F.length*8-e.nBitLength;return Y>0?H>>BigInt(Y):H},j=e.bits2int_modN||function(F){return l(V(F))},G=bitMask$1(e.nBitLength);function le(F){if(typeof F!="bigint")throw new Error("bigint expected");if(!(_0n$6<=F&&F<G))throw new Error(`bigint expected < 2^${e.nBitLength}`);return numberToBytesBE$1(F,e.nByteLength)}function me(F,H,Y=ce){if(["recovered","canonical"].some(ue=>ue in Y))throw new Error("sign() legacy options not supported");const{hash:se,randomBytes:he}=e;let{lowS:ye,prehash:we,extraEntropy:xe}=Y;ye==null&&(ye=!0),F=ensureBytes$1("msgHash",F),we&&(F=ensureBytes$1("prehashed msgHash",se(F)));const Te=j(F),Ue=b(H),Fe=[le(Ue),le(Te)];if(xe!=null){const ue=xe===!0?he(n.BYTES):xe;Fe.push(ensureBytes$1("extraEntropy",ue))}const Ie=concatBytes$2(...Fe),Ke=Te;function Ve(ue){const Ze=V(ue);if(!E(Ze))return;const je=f(Ze),ve=y.BASE.multiply(Ze).toAffine(),Be=l(ve.x);if(Be===_0n$6)return;const Je=l(je*l(Ke+Be*Ue));if(Je===_0n$6)return;let We=(ve.x===Be?0:2)|Number(ve.y&_1n$6),Vt=Je;return ye&&O(Je)&&(Vt=$(Je),We^=1),new I(Be,Vt,We)}return{seed:Ie,k2sig:Ve}}const ce={lowS:e.lowS,prehash:!1},de={lowS:e.lowS,prehash:!1};function be(F,H,Y=ce){const{seed:se,k2sig:he}=me(F,H,Y),ye=e;return createHmacDrbg$1(ye.hash.outputLen,ye.nByteLength,ye.hmac)(se,he)}y.BASE._setWindowSize(8);function Q(F,H,Y,se=de){var ve;const he=F;if(H=ensureBytes$1("msgHash",H),Y=ensureBytes$1("publicKey",Y),"strict"in se)throw new Error("options.strict was renamed to lowS");const{lowS:ye,prehash:we}=se;let xe,Te;try{if(typeof he=="string"||he instanceof Uint8Array)try{xe=I.fromDER(he)}catch(Be){if(!(Be instanceof DER$1.Err))throw Be;xe=I.fromCompact(he)}else if(typeof he=="object"&&typeof he.r=="bigint"&&typeof he.s=="bigint"){const{r:Be,s:Je}=he;xe=new I(Be,Je)}else throw new Error("PARSE");Te=y.fromHex(Y)}catch(Be){if(Be.message==="PARSE")throw new Error("signature must be Signature instance, Uint8Array or hex string");return!1}if(ye&&xe.hasHighS())return!1;we&&(H=e.hash(H));const{r:Ue,s:Fe}=xe,Ie=j(H),Ke=f(Fe),Ve=l(Ie*Ke),ue=l(Ue*Ke),Ze=(ve=y.BASE.multiplyAndAddUnsafe(Te,Ve,ue))==null?void 0:ve.toAffine();return Ze?l(Ze.x)===Ue:!1}return{CURVE:e,getPublicKey:W,getSharedSecret:oe,sign:be,verify:Q,ProjectivePoint:y,Signature:I,utils:q}}let HMAC$2=class extends Hash$1{constructor(e,n){super(),this.finished=!1,this.destroyed=!1,hash$2(e);const r=toBytes$1(n);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const s=this.blockLen,a=new Uint8Array(s);a.set(r.length>s?e.create().update(r).digest():r);for(let u=0;u<a.length;u++)a[u]^=54;this.iHash.update(a),this.oHash=e.create();for(let u=0;u<a.length;u++)a[u]^=106;this.oHash.update(a),a.fill(0)}update(e){return exists$2(this),this.iHash.update(e),this}digestInto(e){exists$2(this),bytes$3(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:n,iHash:r,finished:s,destroyed:a,blockLen:u,outputLen:l}=this;return e=e,e.finished=s,e.destroyed=a,e.blockLen=u,e.outputLen=l,e.oHash=n._cloneInto(e.oHash),e.iHash=r._cloneInto(e.iHash),e}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}};const hmac$2=(t,e,n)=>new HMAC$2(t,e).update(n).digest();hmac$2.create=(t,e)=>new HMAC$2(t,e);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function getHash$1(t){return{hash:t,hmac:(e,...n)=>hmac$2(t,e,concatBytes$3(...n)),randomBytes:randomBytes$1}}function createCurve$1(t,e){const n=r=>weierstrass$1({...t,...getHash$1(r)});return Object.freeze({...n(e),create:n})}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const secp256k1P$1=BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),secp256k1N$1=BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),_1n$5=BigInt(1),_2n$3=BigInt(2),divNearest$1=(t,e)=>(t+e/_2n$3)/e;function sqrtMod$1(t){const e=secp256k1P$1,n=BigInt(3),r=BigInt(6),s=BigInt(11),a=BigInt(22),u=BigInt(23),l=BigInt(44),f=BigInt(88),y=t*t*t%e,b=y*y*t%e,m=pow2$1(b,n,e)*b%e,E=pow2$1(m,n,e)*b%e,C=pow2$1(E,_2n$3,e)*y%e,O=pow2$1(C,s,e)*C%e,$=pow2$1(O,a,e)*O%e,k=pow2$1($,l,e)*$%e,I=pow2$1(k,f,e)*k%e,q=pow2$1(I,l,e)*$%e,W=pow2$1(q,n,e)*b%e,te=pow2$1(W,u,e)*O%e,oe=pow2$1(te,r,e)*y%e,V=pow2$1(oe,_2n$3,e);if(!Fp$1.eql(Fp$1.sqr(V),t))throw new Error("Cannot find square root");return V}const Fp$1=Field$1(secp256k1P$1,void 0,void 0,{sqrt:sqrtMod$1}),secp256k1$1=createCurve$1({a:BigInt(0),b:BigInt(7),Fp:Fp$1,n:secp256k1N$1,Gx:BigInt("55066263022277343669578718895168534326250603453777594175500187360389116729240"),Gy:BigInt("32670510020758816978083085130507043184471273380659243275938904335757337482424"),h:BigInt(1),lowS:!0,endo:{beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar:t=>{const e=secp256k1N$1,n=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),r=-_1n$5*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),s=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),a=n,u=BigInt("0x100000000000000000000000000000000"),l=divNearest$1(a*t,e),f=divNearest$1(-r*t,e);let y=mod$1(t-l*n-f*s,e),b=mod$1(-l*r-f*a,e);const m=y>u,E=b>u;if(m&&(y=e-y),E&&(b=e-b),y>u||b>u)throw new Error("splitScalar: Endomorphism failed, k="+t);return{k1neg:m,k1:y,k2neg:E,k2:b}}}},sha256$2),_0n$5=BigInt(0),fe=t=>typeof t=="bigint"&&_0n$5<t&&t<secp256k1P$1,ge=t=>typeof t=="bigint"&&_0n$5<t&&t<secp256k1N$1,TAGGED_HASH_PREFIXES$1={};function taggedHash$1(t,...e){let n=TAGGED_HASH_PREFIXES$1[t];if(n===void 0){const r=sha256$2(Uint8Array.from(t,s=>s.charCodeAt(0)));n=concatBytes$2(r,r),TAGGED_HASH_PREFIXES$1[t]=n}return sha256$2(concatBytes$2(n,...e))}const pointToBytes$1=t=>t.toRawBytes(!0).slice(1),numTo32b$1=t=>numberToBytesBE$1(t,32),modP$1=t=>mod$1(t,secp256k1P$1),modN$1=t=>mod$1(t,secp256k1N$1),Point$1=secp256k1$1.ProjectivePoint,GmulAdd$1=(t,e,n)=>Point$1.BASE.multiplyAndAddUnsafe(t,e,n);function schnorrGetExtPubKey$1(t){let e=secp256k1$1.utils.normPrivateKeyToScalar(t),n=Point$1.fromPrivateKey(e);return{scalar:n.hasEvenY()?e:modN$1(-e),bytes:pointToBytes$1(n)}}function lift_x$1(t){if(!fe(t))throw new Error("bad x: need 0 < x < p");const e=modP$1(t*t),n=modP$1(e*t+BigInt(7));let r=sqrtMod$1(n);r%_2n$3!==_0n$5&&(r=modP$1(-r));const s=new Point$1(t,r,_1n$5);return s.assertValidity(),s}function challenge$1(...t){return modN$1(bytesToNumberBE$1(taggedHash$1("BIP0340/challenge",...t)))}function schnorrGetPublicKey$1(t){return schnorrGetExtPubKey$1(t).bytes}function schnorrSign$1(t,e,n=randomBytes$1(32)){const r=ensureBytes$1("message",t),{bytes:s,scalar:a}=schnorrGetExtPubKey$1(e),u=ensureBytes$1("auxRand",n,32),l=numTo32b$1(a^bytesToNumberBE$1(taggedHash$1("BIP0340/aux",u))),f=taggedHash$1("BIP0340/nonce",l,s,r),y=modN$1(bytesToNumberBE$1(f));if(y===_0n$5)throw new Error("sign failed: k is zero");const{bytes:b,scalar:m}=schnorrGetExtPubKey$1(y),E=challenge$1(b,s,r),C=new Uint8Array(64);if(C.set(b,0),C.set(numTo32b$1(modN$1(m+E*a)),32),!schnorrVerify$1(C,r,s))throw new Error("sign: Invalid signature produced");return C}function schnorrVerify$1(t,e,n){const r=ensureBytes$1("signature",t,64),s=ensureBytes$1("message",e),a=ensureBytes$1("publicKey",n,32);try{const u=lift_x$1(bytesToNumberBE$1(a)),l=bytesToNumberBE$1(r.subarray(0,32));if(!fe(l))return!1;const f=bytesToNumberBE$1(r.subarray(32,64));if(!ge(f))return!1;const y=challenge$1(numTo32b$1(l),pointToBytes$1(u),s),b=GmulAdd$1(u,f,modN$1(-y));return!(!b||!b.hasEvenY()||b.toAffine().x!==l)}catch{return!1}}const schnorr$1={getPublicKey:schnorrGetPublicKey$1,sign:schnorrSign$1,verify:schnorrVerify$1,utils:{randomPrivateKey:secp256k1$1.utils.randomPrivateKey,lift_x:lift_x$1,pointToBytes:pointToBytes$1,numberToBytesBE:numberToBytesBE$1,bytesToNumberBE:bytesToNumberBE$1,taggedHash:taggedHash$1,mod:mod$1}};function number$2(t){if(!Number.isSafeInteger(t)||t<0)throw new Error(`Wrong positive integer: ${t}`)}function bool$1(t){if(typeof t!="boolean")throw new Error(`Expected boolean, not ${t}`)}function bytes$2(t,...e){if(!(t instanceof Uint8Array))throw new Error("Expected Uint8Array");if(e.length>0&&!e.includes(t.length))throw new Error(`Expected Uint8Array of length ${e}, not of length=${t.length}`)}function hash$1(t){if(typeof t!="function"||typeof t.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");number$2(t.outputLen),number$2(t.blockLen)}function exists$1(t,e=!0){if(t.destroyed)throw new Error("Hash instance has been destroyed");if(e&&t.finished)throw new Error("Hash#digest() has already been called")}function output$1(t,e){bytes$2(t);const n=e.outputLen;if(t.length<n)throw new Error(`digestInto() expects output buffer of length at least ${n}`)}const assert={number:number$2,bool:bool$1,bytes:bytes$2,hash:hash$1,exists:exists$1,output:output$1};function setBigUint64$1(t,e,n,r){if(typeof t.setBigUint64=="function")return t.setBigUint64(e,n,r);const s=BigInt(32),a=BigInt(4294967295),u=Number(n>>s&a),l=Number(n&a),f=r?4:0,y=r?0:4;t.setUint32(e+f,u,r),t.setUint32(e+y,l,r)}class SHA2 extends Hash$2{constructor(e,n,r,s){super(),this.blockLen=e,this.outputLen=n,this.padOffset=r,this.isLE=s,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=createView$2(this.buffer)}update(e){assert.exists(this);const{view:n,buffer:r,blockLen:s}=this;e=toBytes$2(e);const a=e.length;for(let u=0;u<a;){const l=Math.min(s-this.pos,a-u);if(l===s){const f=createView$2(e);for(;s<=a-u;u+=s)this.process(f,u);continue}r.set(e.subarray(u,u+l),this.pos),this.pos+=l,u+=l,this.pos===s&&(this.process(n,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){assert.exists(this),assert.output(e,this),this.finished=!0;const{buffer:n,view:r,blockLen:s,isLE:a}=this;let{pos:u}=this;n[u++]=128,this.buffer.subarray(u).fill(0),this.padOffset>s-u&&(this.process(r,0),u=0);for(let m=u;m<s;m++)n[m]=0;setBigUint64$1(r,s-8,BigInt(this.length*8),a),this.process(r,0);const l=createView$2(e),f=this.outputLen;if(f%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const y=f/4,b=this.get();if(y>b.length)throw new Error("_sha2: outputLen bigger than state");for(let m=0;m<y;m++)l.setUint32(4*m,b[m],a)}digest(){const{buffer:e,outputLen:n}=this;this.digestInto(e);const r=e.slice(0,n);return this.destroy(),r}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:n,buffer:r,length:s,finished:a,destroyed:u,pos:l}=this;return e.length=s,e.pos=l,e.finished=a,e.destroyed=u,s%n&&e.buffer.set(r),e}}const Chi$1=(t,e,n)=>t&e^~t&n,Maj$1=(t,e,n)=>t&e^t&n^e&n,SHA256_K$1=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),IV=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),SHA256_W$1=new Uint32Array(64);let SHA256$1=class extends SHA2{constructor(){super(64,32,8,!1),this.A=IV[0]|0,this.B=IV[1]|0,this.C=IV[2]|0,this.D=IV[3]|0,this.E=IV[4]|0,this.F=IV[5]|0,this.G=IV[6]|0,this.H=IV[7]|0}get(){const{A:e,B:n,C:r,D:s,E:a,F:u,G:l,H:f}=this;return[e,n,r,s,a,u,l,f]}set(e,n,r,s,a,u,l,f){this.A=e|0,this.B=n|0,this.C=r|0,this.D=s|0,this.E=a|0,this.F=u|0,this.G=l|0,this.H=f|0}process(e,n){for(let m=0;m<16;m++,n+=4)SHA256_W$1[m]=e.getUint32(n,!1);for(let m=16;m<64;m++){const E=SHA256_W$1[m-15],C=SHA256_W$1[m-2],O=rotr$2(E,7)^rotr$2(E,18)^E>>>3,$=rotr$2(C,17)^rotr$2(C,19)^C>>>10;SHA256_W$1[m]=$+SHA256_W$1[m-7]+O+SHA256_W$1[m-16]|0}let{A:r,B:s,C:a,D:u,E:l,F:f,G:y,H:b}=this;for(let m=0;m<64;m++){const E=rotr$2(l,6)^rotr$2(l,11)^rotr$2(l,25),C=b+E+Chi$1(l,f,y)+SHA256_K$1[m]+SHA256_W$1[m]|0,$=(rotr$2(r,2)^rotr$2(r,13)^rotr$2(r,22))+Maj$1(r,s,a)|0;b=y,y=f,f=l,l=u+C|0,u=a,a=s,s=r,r=C+$|0}r=r+this.A|0,s=s+this.B|0,a=a+this.C|0,u=u+this.D|0,l=l+this.E|0,f=f+this.F|0,y=y+this.G|0,b=b+this.H|0,this.set(r,s,a,u,l,f,y,b)}roundClean(){SHA256_W$1.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};class SHA224 extends SHA256$1{constructor(){super(),this.A=-1056596264,this.B=914150663,this.C=812702999,this.D=-150054599,this.E=-4191439,this.F=1750603025,this.G=1694076839,this.H=-1090891868,this.outputLen=28}}const sha256$1=wrapConstructor$2(()=>new SHA256$1);wrapConstructor$2(()=>new SHA224);function number$1(t){if(!Number.isSafeInteger(t)||t<0)throw new Error(`positive integer expected, not ${t}`)}function bool(t){if(typeof t!="boolean")throw new Error(`boolean expected, not ${t}`)}function isBytes$2(t){return t instanceof Uint8Array||t!=null&&typeof t=="object"&&t.constructor.name==="Uint8Array"}function bytes$1(t,...e){if(!isBytes$2(t))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(t.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${t.length}`)}/*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) */const u32=t=>new Uint32Array(t.buffer,t.byteOffset,Math.floor(t.byteLength/4)),isLE=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!isLE)throw new Error("Non little-endian hardware is not supported");function checkOpts(t,e){if(e==null||typeof e!="object")throw new Error("options must be defined");return Object.assign(t,e)}function equalBytes$1(t,e){if(t.length!==e.length)return!1;let n=0;for(let r=0;r<t.length;r++)n|=t[r]^e[r];return n===0}const wrapCipher=(t,e)=>(Object.assign(e,t),e),BLOCK_SIZE=16,POLY=283;function mul2(t){return t<<1^POLY&-(t>>7)}function mul(t,e){let n=0;for(;e>0;e>>=1)n^=t&-(e&1),t=mul2(t);return n}const sbox=(()=>{let t=new Uint8Array(256);for(let n=0,r=1;n<256;n++,r^=mul2(r))t[n]=r;const e=new Uint8Array(256);e[0]=99;for(let n=0;n<255;n++){let r=t[255-n];r|=r<<8,e[t[n]]=(r^r>>4^r>>5^r>>6^r>>7^99)&255}return e})(),invSbox=sbox.map((t,e)=>sbox.indexOf(e)),rotr32_8=t=>t<<24|t>>>8,rotl32_8=t=>t<<8|t>>>24;function genTtable(t,e){if(t.length!==256)throw new Error("Wrong sbox length");const n=new Uint32Array(256).map((y,b)=>e(t[b])),r=n.map(rotl32_8),s=r.map(rotl32_8),a=s.map(rotl32_8),u=new Uint32Array(256*256),l=new Uint32Array(256*256),f=new Uint16Array(256*256);for(let y=0;y<256;y++)for(let b=0;b<256;b++){const m=y*256+b;u[m]=n[y]^r[b],l[m]=s[y]^a[b],f[m]=t[y]<<8|t[b]}return{sbox:t,sbox2:f,T0:n,T1:r,T2:s,T3:a,T01:u,T23:l}}const tableEncoding=genTtable(sbox,t=>mul(t,3)<<24|t<<16|t<<8|mul(t,2)),tableDecoding=genTtable(invSbox,t=>mul(t,11)<<24|mul(t,13)<<16|mul(t,9)<<8|mul(t,14)),xPowers=(()=>{const t=new Uint8Array(16);for(let e=0,n=1;e<16;e++,n=mul2(n))t[e]=n;return t})();function expandKeyLE(t){bytes$1(t);const e=t.length;if(![16,24,32].includes(e))throw new Error(`aes: wrong key size: should be 16, 24 or 32, got: ${e}`);const{sbox2:n}=tableEncoding,r=u32(t),s=r.length,a=l=>applySbox(n,l,l,l,l),u=new Uint32Array(e+28);u.set(r);for(let l=s;l<u.length;l++){let f=u[l-1];l%s===0?f=a(rotr32_8(f))^xPowers[l/s-1]:s>6&&l%s===4&&(f=a(f)),u[l]=u[l-s]^f}return u}function expandKeyDecLE(t){const e=expandKeyLE(t),n=e.slice(),r=e.length,{sbox2:s}=tableEncoding,{T0:a,T1:u,T2:l,T3:f}=tableDecoding;for(let y=0;y<r;y+=4)for(let b=0;b<4;b++)n[y+b]=e[r-y-4+b];e.fill(0);for(let y=4;y<r-4;y++){const b=n[y],m=applySbox(s,b,b,b,b);n[y]=a[m&255]^u[m>>>8&255]^l[m>>>16&255]^f[m>>>24]}return n}function apply0123(t,e,n,r,s,a){return t[n<<8&65280|r>>>8&255]^e[s>>>8&65280|a>>>24&255]}function applySbox(t,e,n,r,s){return t[e&255|n&65280]|t[r>>>16&255|s>>>16&65280]<<16}function encrypt$2(t,e,n,r,s){const{sbox2:a,T01:u,T23:l}=tableEncoding;let f=0;e^=t[f++],n^=t[f++],r^=t[f++],s^=t[f++];const y=t.length/4-2;for(let O=0;O<y;O++){const $=t[f++]^apply0123(u,l,e,n,r,s),k=t[f++]^apply0123(u,l,n,r,s,e),I=t[f++]^apply0123(u,l,r,s,e,n),q=t[f++]^apply0123(u,l,s,e,n,r);e=$,n=k,r=I,s=q}const b=t[f++]^applySbox(a,e,n,r,s),m=t[f++]^applySbox(a,n,r,s,e),E=t[f++]^applySbox(a,r,s,e,n),C=t[f++]^applySbox(a,s,e,n,r);return{s0:b,s1:m,s2:E,s3:C}}function decrypt$2(t,e,n,r,s){const{sbox2:a,T01:u,T23:l}=tableDecoding;let f=0;e^=t[f++],n^=t[f++],r^=t[f++],s^=t[f++];const y=t.length/4-2;for(let O=0;O<y;O++){const $=t[f++]^apply0123(u,l,e,s,r,n),k=t[f++]^apply0123(u,l,n,e,s,r),I=t[f++]^apply0123(u,l,r,n,e,s),q=t[f++]^apply0123(u,l,s,r,n,e);e=$,n=k,r=I,s=q}const b=t[f++]^applySbox(a,e,s,r,n),m=t[f++]^applySbox(a,n,e,s,r),E=t[f++]^applySbox(a,r,n,e,s),C=t[f++]^applySbox(a,s,r,n,e);return{s0:b,s1:m,s2:E,s3:C}}function getDst(t,e){if(!e)return new Uint8Array(t);if(bytes$1(e),e.length<t)throw new Error(`aes: wrong destination length, expected at least ${t}, got: ${e.length}`);return e}function validateBlockDecrypt(t){if(bytes$1(t),t.length%BLOCK_SIZE!==0)throw new Error(`aes/(cbc-ecb).decrypt ciphertext should consist of blocks with size ${BLOCK_SIZE}`)}function validateBlockEncrypt(t,e,n){let r=t.length;const s=r%BLOCK_SIZE;if(!e&&s!==0)throw new Error("aec/(cbc-ecb): unpadded plaintext with disabled padding");const a=u32(t);if(e){let f=BLOCK_SIZE-s;f||(f=BLOCK_SIZE),r=r+f}const u=getDst(r,n),l=u32(u);return{b:a,o:l,out:u}}function validatePCKS(t,e){if(!e)return t;const n=t.length;if(!n)throw new Error("aes/pcks5: empty ciphertext not allowed");const r=t[n-1];if(r<=0||r>16)throw new Error(`aes/pcks5: wrong padding byte: ${r}`);const s=t.subarray(0,-r);for(let a=0;a<r;a++)if(t[n-a-1]!==r)throw new Error("aes/pcks5: wrong padding");return s}function padPCKS(t){const e=new Uint8Array(16),n=u32(e);e.set(t);const r=BLOCK_SIZE-t.length;for(let s=BLOCK_SIZE-r;s<BLOCK_SIZE;s++)e[s]=r;return n}const cbc=wrapCipher({blockSize:16,nonceLength:16},function(e,n,r={}){bytes$1(e),bytes$1(n,16);const s=!r.disablePadding;return{encrypt:(a,u)=>{const l=expandKeyLE(e),{b:f,o:y,out:b}=validateBlockEncrypt(a,s,u),m=u32(n);let E=m[0],C=m[1],O=m[2],$=m[3],k=0;for(;k+4<=f.length;)E^=f[k+0],C^=f[k+1],O^=f[k+2],$^=f[k+3],{s0:E,s1:C,s2:O,s3:$}=encrypt$2(l,E,C,O,$),y[k++]=E,y[k++]=C,y[k++]=O,y[k++]=$;if(s){const I=padPCKS(a.subarray(k*4));E^=I[0],C^=I[1],O^=I[2],$^=I[3],{s0:E,s1:C,s2:O,s3:$}=encrypt$2(l,E,C,O,$),y[k++]=E,y[k++]=C,y[k++]=O,y[k++]=$}return l.fill(0),b},decrypt:(a,u)=>{validateBlockDecrypt(a);const l=expandKeyDecLE(e),f=u32(n),y=getDst(a.length,u),b=u32(a),m=u32(y);let E=f[0],C=f[1],O=f[2],$=f[3];for(let k=0;k+4<=b.length;){const I=E,q=C,W=O,te=$;E=b[k+0],C=b[k+1],O=b[k+2],$=b[k+3];const{s0:oe,s1:V,s2:j,s3:G}=decrypt$2(l,E,C,O,$);m[k++]=oe^I,m[k++]=V^q,m[k++]=j^W,m[k++]=G^te}return l.fill(0),validatePCKS(y,s)}}}),_utf8ToBytes=t=>Uint8Array.from(t.split("").map(e=>e.charCodeAt(0))),sigma16=_utf8ToBytes("expand 16-byte k"),sigma32=_utf8ToBytes("expand 32-byte k"),sigma16_32=u32(sigma16),sigma32_32=u32(sigma32);sigma32_32.slice();function rotl(t,e){return t<<e|t>>>32-e}function isAligned32(t){return t.byteOffset%4===0}const BLOCK_LEN=64,BLOCK_LEN32=16,MAX_COUNTER=2**32-1,U32_EMPTY=new Uint32Array;function runCipher(t,e,n,r,s,a,u,l){const f=s.length,y=new Uint8Array(BLOCK_LEN),b=u32(y),m=isAligned32(s)&&isAligned32(a),E=m?u32(s):U32_EMPTY,C=m?u32(a):U32_EMPTY;for(let O=0;O<f;u++){if(t(e,n,r,b,u,l),u>=MAX_COUNTER)throw new Error("arx: counter overflow");const $=Math.min(BLOCK_LEN,f-O);if(m&&$===BLOCK_LEN){const k=O/4;if(O%4!==0)throw new Error("arx: invalid block position");for(let I=0,q;I<BLOCK_LEN32;I++)q=k+I,C[q]=E[q]^b[I];O+=BLOCK_LEN;continue}for(let k=0,I;k<$;k++)I=O+k,a[I]=s[I]^y[k];O+=$}}function createCipher(t,e){const{allowShortKeys:n,extendNonceFn:r,counterLength:s,counterRight:a,rounds:u}=checkOpts({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},e);if(typeof t!="function")throw new Error("core must be a function");return number$1(s),number$1(u),bool(a),bool(n),(l,f,y,b,m=0)=>{bytes$1(l),bytes$1(f),bytes$1(y);const E=y.length;if(b||(b=new Uint8Array(E)),bytes$1(b),number$1(m),m<0||m>=MAX_COUNTER)throw new Error("arx: counter overflow");if(b.length<E)throw new Error(`arx: output (${b.length}) is shorter than data (${E})`);const C=[];let O=l.length,$,k;if(O===32)$=l.slice(),C.push($),k=sigma32_32;else if(O===16&&n)$=new Uint8Array(32),$.set(l),$.set(l,16),k=sigma16_32,C.push($);else throw new Error(`arx: invalid 32-byte key, got length=${O}`);isAligned32(f)||(f=f.slice(),C.push(f));const I=u32($);if(r){if(f.length!==24)throw new Error("arx: extended nonce must be 24 bytes");r(k,I,u32(f.subarray(0,16)),I),f=f.subarray(16)}const q=16-s;if(q!==f.length)throw new Error(`arx: nonce must be ${q} or 16 bytes`);if(q!==12){const te=new Uint8Array(12);te.set(f,a?0:12-f.length),f=te,C.push(f)}const W=u32(f);for(runCipher(t,k,I,W,y,b,m,u);C.length>0;)C.pop().fill(0);return b}}function chachaCore(t,e,n,r,s,a=20){let u=t[0],l=t[1],f=t[2],y=t[3],b=e[0],m=e[1],E=e[2],C=e[3],O=e[4],$=e[5],k=e[6],I=e[7],q=s,W=n[0],te=n[1],oe=n[2],V=u,j=l,G=f,le=y,me=b,ce=m,de=E,be=C,Q=O,F=$,H=k,Y=I,se=q,he=W,ye=te,we=oe;for(let Te=0;Te<a;Te+=2)V=V+me|0,se=rotl(se^V,16),Q=Q+se|0,me=rotl(me^Q,12),V=V+me|0,se=rotl(se^V,8),Q=Q+se|0,me=rotl(me^Q,7),j=j+ce|0,he=rotl(he^j,16),F=F+he|0,ce=rotl(ce^F,12),j=j+ce|0,he=rotl(he^j,8),F=F+he|0,ce=rotl(ce^F,7),G=G+de|0,ye=rotl(ye^G,16),H=H+ye|0,de=rotl(de^H,12),G=G+de|0,ye=rotl(ye^G,8),H=H+ye|0,de=rotl(de^H,7),le=le+be|0,we=rotl(we^le,16),Y=Y+we|0,be=rotl(be^Y,12),le=le+be|0,we=rotl(we^le,8),Y=Y+we|0,be=rotl(be^Y,7),V=V+ce|0,we=rotl(we^V,16),H=H+we|0,ce=rotl(ce^H,12),V=V+ce|0,we=rotl(we^V,8),H=H+we|0,ce=rotl(ce^H,7),j=j+de|0,se=rotl(se^j,16),Y=Y+se|0,de=rotl(de^Y,12),j=j+de|0,se=rotl(se^j,8),Y=Y+se|0,de=rotl(de^Y,7),G=G+be|0,he=rotl(he^G,16),Q=Q+he|0,be=rotl(be^Q,12),G=G+be|0,he=rotl(he^G,8),Q=Q+he|0,be=rotl(be^Q,7),le=le+me|0,ye=rotl(ye^le,16),F=F+ye|0,me=rotl(me^F,12),le=le+me|0,ye=rotl(ye^le,8),F=F+ye|0,me=rotl(me^F,7);let xe=0;r[xe++]=u+V|0,r[xe++]=l+j|0,r[xe++]=f+G|0,r[xe++]=y+le|0,r[xe++]=b+me|0,r[xe++]=m+ce|0,r[xe++]=E+de|0,r[xe++]=C+be|0,r[xe++]=O+Q|0,r[xe++]=$+F|0,r[xe++]=k+H|0,r[xe++]=I+Y|0,r[xe++]=q+se|0,r[xe++]=W+he|0,r[xe++]=te+ye|0,r[xe++]=oe+we|0}const chacha20=createCipher(chachaCore,{counterRight:!1,counterLength:4,allowShortKeys:!1});let HMAC$1=class extends Hash$2{constructor(e,n){super(),this.finished=!1,this.destroyed=!1,assert.hash(e);const r=toBytes$2(n);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const s=this.blockLen,a=new Uint8Array(s);a.set(r.length>s?e.create().update(r).digest():r);for(let u=0;u<a.length;u++)a[u]^=54;this.iHash.update(a),this.oHash=e.create();for(let u=0;u<a.length;u++)a[u]^=106;this.oHash.update(a),a.fill(0)}update(e){return assert.exists(this),this.iHash.update(e),this}digestInto(e){assert.exists(this),assert.bytes(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:n,iHash:r,finished:s,destroyed:a,blockLen:u,outputLen:l}=this;return e=e,e.finished=s,e.destroyed=a,e.blockLen=u,e.outputLen=l,e.oHash=n._cloneInto(e.oHash),e.iHash=r._cloneInto(e.iHash),e}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}};const hmac$1=(t,e,n)=>new HMAC$1(t,e).update(n).digest();hmac$1.create=(t,e)=>new HMAC$1(t,e);function extract(t,e,n){return assert.hash(t),hmac$1(t,toBytes$2(n),toBytes$2(e))}const HKDF_COUNTER=new Uint8Array([0]),EMPTY_BUFFER=new Uint8Array;function expand(t,e,n,r=32){if(assert.hash(t),assert.number(r),r>255*t.outputLen)throw new Error("Length should be <= 255*HashLen");const s=Math.ceil(r/t.outputLen);n===void 0&&(n=EMPTY_BUFFER);const a=new Uint8Array(s*t.outputLen),u=hmac$1.create(t,e),l=u._cloneInto(),f=new Uint8Array(u.outputLen);for(let y=0;y<s;y++)HKDF_COUNTER[0]=y+1,l.update(y===0?EMPTY_BUFFER:f).update(n).update(HKDF_COUNTER).digestInto(f),a.set(f,t.outputLen*y),u._cloneInto(l);return u.destroy(),l.destroy(),f.fill(0),HKDF_COUNTER.fill(0),a.slice(0,r)}var __defProp=Object.defineProperty,__export=(t,e)=>{for(var n in e)__defProp(t,n,{get:e[n],enumerable:!0})},verifiedSymbol=Symbol("verified"),isRecord=t=>t instanceof Object;function validateEvent(t){if(!isRecord(t)||typeof t.kind!="number"||typeof t.content!="string"||typeof t.created_at!="number"||typeof t.pubkey!="string"||!t.pubkey.match(/^[a-f0-9]{64}$/)||!Array.isArray(t.tags))return!1;for(let e=0;e<t.tags.length;e++){let n=t.tags[e];if(!Array.isArray(n))return!1;for(let r=0;r<n.length;r++)if(typeof n[r]=="object")return!1}return!0}var utils_exports={};__export(utils_exports,{Queue:()=>Queue$1,QueueNode:()=>QueueNode,binarySearch:()=>binarySearch,insertEventIntoAscendingList:()=>insertEventIntoAscendingList,insertEventIntoDescendingList:()=>insertEventIntoDescendingList,normalizeURL:()=>normalizeURL,utf8Decoder:()=>utf8Decoder,utf8Encoder:()=>utf8Encoder});var utf8Decoder=new TextDecoder("utf-8"),utf8Encoder=new TextEncoder;function normalizeURL(t){t.indexOf("://")===-1&&(t="wss://"+t);let e=new URL(t);return e.pathname=e.pathname.replace(/\/+/g,"/"),e.pathname.endsWith("/")&&(e.pathname=e.pathname.slice(0,-1)),(e.port==="80"&&e.protocol==="ws:"||e.port==="443"&&e.protocol==="wss:")&&(e.port=""),e.searchParams.sort(),e.hash="",e.toString()}function insertEventIntoDescendingList(t,e){const[n,r]=binarySearch(t,s=>e.id===s.id?0:e.created_at===s.created_at?-1:s.created_at-e.created_at);return r||t.splice(n,0,e),t}function insertEventIntoAscendingList(t,e){const[n,r]=binarySearch(t,s=>e.id===s.id?0:e.created_at===s.created_at?-1:e.created_at-s.created_at);return r||t.splice(n,0,e),t}function binarySearch(t,e){let n=0,r=t.length-1;for(;n<=r;){const s=Math.floor((n+r)/2),a=e(t[s]);if(a===0)return[s,!0];a<0?r=s-1:n=s+1}return[n,!1]}var QueueNode=class{constructor(t){_(this,"value");_(this,"next",null);_(this,"prev",null);this.value=t}},Queue$1=class{constructor(){_(this,"first");_(this,"last");this.first=null,this.last=null}enqueue(e){const n=new QueueNode(e);return this.last?this.last===this.first?(this.last=n,this.last.prev=this.first,this.first.next=n):(n.prev=this.last,this.last.next=n,this.last=n):(this.first=n,this.last=n),!0}dequeue(){if(!this.first)return null;if(this.first===this.last){const n=this.first;return this.first=null,this.last=null,n.value}const e=this.first;return this.first=e.next,e.value}},JS=class{generateSecretKey(){return schnorr$1.utils.randomPrivateKey()}getPublicKey(t){return bytesToHex$3(schnorr$1.getPublicKey(t))}finalizeEvent(t,e){const n=t;return n.pubkey=bytesToHex$3(schnorr$1.getPublicKey(e)),n.id=getEventHash$1(n),n.sig=bytesToHex$3(schnorr$1.sign(getEventHash$1(n),e)),n[verifiedSymbol]=!0,n}verifyEvent(t){if(typeof t[verifiedSymbol]=="boolean")return t[verifiedSymbol];const e=getEventHash$1(t);if(e!==t.id)return t[verifiedSymbol]=!1,!1;try{const n=schnorr$1.verify(t.sig,e,t.pubkey);return t[verifiedSymbol]=n,n}catch{return t[verifiedSymbol]=!1,!1}}};function serializeEvent(t){if(!validateEvent(t))throw new Error("can't serialize event with wrong or missing properties");return JSON.stringify([0,t.pubkey,t.created_at,t.kind,t.tags,t.content])}function getEventHash$1(t){let e=sha256$1(utf8Encoder.encode(serializeEvent(t)));return bytesToHex$3(e)}var i=new JS,generateSecretKey=i.generateSecretKey,getPublicKey=i.getPublicKey,finalizeEvent=i.finalizeEvent,verifyEvent=i.verifyEvent,kinds_exports={};__export(kinds_exports,{Application:()=>Application,BadgeAward:()=>BadgeAward,BadgeDefinition:()=>BadgeDefinition,BlockedRelaysList:()=>BlockedRelaysList,BookmarkList:()=>BookmarkList,Bookmarksets:()=>Bookmarksets,Calendar:()=>Calendar,CalendarEventRSVP:()=>CalendarEventRSVP,ChannelCreation:()=>ChannelCreation,ChannelHideMessage:()=>ChannelHideMessage,ChannelMessage:()=>ChannelMessage,ChannelMetadata:()=>ChannelMetadata,ChannelMuteUser:()=>ChannelMuteUser,ClassifiedListing:()=>ClassifiedListing,ClientAuth:()=>ClientAuth,CommunitiesList:()=>CommunitiesList,CommunityDefinition:()=>CommunityDefinition,CommunityPostApproval:()=>CommunityPostApproval,Contacts:()=>Contacts,CreateOrUpdateProduct:()=>CreateOrUpdateProduct,CreateOrUpdateStall:()=>CreateOrUpdateStall,Curationsets:()=>Curationsets,Date:()=>Date2,DraftClassifiedListing:()=>DraftClassifiedListing,DraftLong:()=>DraftLong,Emojisets:()=>Emojisets,EncryptedDirectMessage:()=>EncryptedDirectMessage,EncryptedDirectMessages:()=>EncryptedDirectMessages,EventDeletion:()=>EventDeletion,FileMetadata:()=>FileMetadata,FileServerPreference:()=>FileServerPreference,Followsets:()=>Followsets,GenericRepost:()=>GenericRepost,Genericlists:()=>Genericlists,HTTPAuth:()=>HTTPAuth,Handlerinformation:()=>Handlerinformation,Handlerrecommendation:()=>Handlerrecommendation,Highlights:()=>Highlights,InterestsList:()=>InterestsList,Interestsets:()=>Interestsets,JobFeedback:()=>JobFeedback,JobRequest:()=>JobRequest,JobResult:()=>JobResult,Label:()=>Label,LightningPubRPC:()=>LightningPubRPC,LiveChatMessage:()=>LiveChatMessage,LiveEvent:()=>LiveEvent,LongFormArticle:()=>LongFormArticle,Metadata:()=>Metadata,Mutelist:()=>Mutelist,NWCWalletInfo:()=>NWCWalletInfo,NWCWalletRequest:()=>NWCWalletRequest,NWCWalletResponse:()=>NWCWalletResponse,NostrConnect:()=>NostrConnect,OpenTimestamps:()=>OpenTimestamps,Pinlist:()=>Pinlist,ProblemTracker:()=>ProblemTracker,ProfileBadges:()=>ProfileBadges,PublicChatsList:()=>PublicChatsList,Reaction:()=>Reaction,RecommendRelay:()=>RecommendRelay,RelayList:()=>RelayList,Relaysets:()=>Relaysets,Report:()=>Report,Reporting:()=>Reporting,Repost:()=>Repost,SearchRelaysList:()=>SearchRelaysList,ShortTextNote:()=>ShortTextNote,Time:()=>Time,UserEmojiList:()=>UserEmojiList,UserStatuses:()=>UserStatuses,Zap:()=>Zap,ZapGoal:()=>ZapGoal,ZapRequest:()=>ZapRequest,classifyKind:()=>classifyKind,isEphemeralKind:()=>isEphemeralKind,isParameterizedReplaceableKind:()=>isParameterizedReplaceableKind,isRegularKind:()=>isRegularKind,isReplaceableKind:()=>isReplaceableKind});function isRegularKind(t){return 1e3<=t&&t<1e4||[1,2,4,5,6,7,8,16,40,41,42,43,44].includes(t)}function isReplaceableKind(t){return[0,3].includes(t)||1e4<=t&&t<2e4}function isEphemeralKind(t){return 2e4<=t&&t<3e4}function isParameterizedReplaceableKind(t){return 3e4<=t&&t<4e4}function classifyKind(t){return isRegularKind(t)?"regular":isReplaceableKind(t)?"replaceable":isEphemeralKind(t)?"ephemeral":isParameterizedReplaceableKind(t)?"parameterized":"unknown"}var Metadata=0,ShortTextNote=1,RecommendRelay=2,Contacts=3,EncryptedDirectMessage=4,EncryptedDirectMessages=4,EventDeletion=5,Repost=6,Reaction=7,BadgeAward=8,GenericRepost=16,ChannelCreation=40,ChannelMetadata=41,ChannelMessage=42,ChannelHideMessage=43,ChannelMuteUser=44,OpenTimestamps=1040,FileMetadata=1063,LiveChatMessage=1311,ProblemTracker=1971,Report=1984,Reporting=1984,Label=1985,CommunityPostApproval=4550,JobRequest=5999,JobResult=6999,JobFeedback=7e3,ZapGoal=9041,ZapRequest=9734,Zap=9735,Highlights=9802,Mutelist=1e4,Pinlist=10001,RelayList=10002,BookmarkList=10003,CommunitiesList=10004,PublicChatsList=10005,BlockedRelaysList=10006,SearchRelaysList=10007,InterestsList=10015,UserEmojiList=10030,FileServerPreference=10096,NWCWalletInfo=13194,LightningPubRPC=21e3,ClientAuth=22242,NWCWalletRequest=23194,NWCWalletResponse=23195,NostrConnect=24133,HTTPAuth=27235,Followsets=3e4,Genericlists=30001,Relaysets=30002,Bookmarksets=30003,Curationsets=30004,ProfileBadges=30008,BadgeDefinition=30009,Interestsets=30015,CreateOrUpdateStall=30017,CreateOrUpdateProduct=30018,LongFormArticle=30023,DraftLong=30024,Emojisets=30030,Application=30078,LiveEvent=30311,UserStatuses=30315,ClassifiedListing=30402,DraftClassifiedListing=30403,Date2=31922,Time=31923,Calendar=31924,CalendarEventRSVP=31925,Handlerrecommendation=31989,Handlerinformation=31990,CommunityDefinition=34550;function matchFilter(t,e){if(t.ids&&t.ids.indexOf(e.id)===-1||t.kinds&&t.kinds.indexOf(e.kind)===-1||t.authors&&t.authors.indexOf(e.pubkey)===-1)return!1;for(let n in t)if(n[0]==="#"){let r=n.slice(1),s=t[`#${r}`];if(s&&!e.tags.find(([a,u])=>a===n.slice(1)&&s.indexOf(u)!==-1))return!1}return!(t.since&&e.created_at<t.since||t.until&&e.created_at>t.until)}function matchFilters(t,e){for(let n=0;n<t.length;n++)if(matchFilter(t[n],e))return!0;return!1}var fakejson_exports={};__export(fakejson_exports,{getHex64:()=>getHex64,getInt:()=>getInt,getSubscriptionId:()=>getSubscriptionId,matchEventId:()=>matchEventId,matchEventKind:()=>matchEventKind,matchEventPubkey:()=>matchEventPubkey});function getHex64(t,e){let n=e.length+3,r=t.indexOf(`"${e}":`)+n,s=t.slice(r).indexOf('"')+r+1;return t.slice(s,s+64)}function getInt(t,e){let n=e.length,r=t.indexOf(`"${e}":`)+n+3,s=t.slice(r),a=Math.min(s.indexOf(","),s.indexOf("}"));return parseInt(s.slice(0,a),10)}function getSubscriptionId(t){let e=t.slice(0,22).indexOf('"EVENT"');if(e===-1)return null;let n=t.slice(e+7+1).indexOf('"');if(n===-1)return null;let r=e+7+1+n,s=t.slice(r+1,80).indexOf('"');if(s===-1)return null;let a=r+1+s;return t.slice(r+1,a)}function matchEventId(t,e){return e===getHex64(t,"id")}function matchEventPubkey(t,e){return e===getHex64(t,"pubkey")}function matchEventKind(t,e){return e===getInt(t,"kind")}var nip42_exports={};__export(nip42_exports,{makeAuthEvent:()=>makeAuthEvent});function makeAuthEvent(t,e){return{kind:ClientAuth,created_at:Math.floor(Date.now()/1e3),tags:[["relay",t],["challenge",e]],content:""}}var _WebSocket;try{_WebSocket=WebSocket}catch{}var _WebSocket2;try{_WebSocket2=WebSocket}catch{}var nip19_exports={};__export(nip19_exports,{BECH32_REGEX:()=>BECH32_REGEX$1,Bech32MaxSize:()=>Bech32MaxSize,decode:()=>decode,encodeBytes:()=>encodeBytes,naddrEncode:()=>naddrEncode,neventEncode:()=>neventEncode,noteEncode:()=>noteEncode,nprofileEncode:()=>nprofileEncode,npubEncode:()=>npubEncode,nrelayEncode:()=>nrelayEncode,nsecEncode:()=>nsecEncode});var Bech32MaxSize=5e3,BECH32_REGEX$1=/[\x21-\x7E]{1,83}1[023456789acdefghjklmnpqrstuvwxyz]{6,}/;function integerToUint8Array(t){const e=new Uint8Array(4);return e[0]=t>>24&255,e[1]=t>>16&255,e[2]=t>>8&255,e[3]=t&255,e}function decode(t){var s,a,u,l,f,y,b,m;let{prefix:e,words:n}=bech32.decode(t,Bech32MaxSize),r=new Uint8Array(bech32.fromWords(n));switch(e){case"nprofile":{let E=parseTLV(r);if(!((s=E[0])!=null&&s[0]))throw new Error("missing TLV 0 for nprofile");if(E[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");return{type:"nprofile",data:{pubkey:bytesToHex$3(E[0][0]),relays:E[1]?E[1].map(C=>utf8Decoder.decode(C)):[]}}}case"nevent":{let E=parseTLV(r);if(!((a=E[0])!=null&&a[0]))throw new Error("missing TLV 0 for nevent");if(E[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");if(E[2]&&E[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(E[3]&&E[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"nevent",data:{id:bytesToHex$3(E[0][0]),relays:E[1]?E[1].map(C=>utf8Decoder.decode(C)):[],author:(u=E[2])!=null&&u[0]?bytesToHex$3(E[2][0]):void 0,kind:(l=E[3])!=null&&l[0]?parseInt(bytesToHex$3(E[3][0]),16):void 0}}}case"naddr":{let E=parseTLV(r);if(!((f=E[0])!=null&&f[0]))throw new Error("missing TLV 0 for naddr");if(!((y=E[2])!=null&&y[0]))throw new Error("missing TLV 2 for naddr");if(E[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(!((b=E[3])!=null&&b[0]))throw new Error("missing TLV 3 for naddr");if(E[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"naddr",data:{identifier:utf8Decoder.decode(E[0][0]),pubkey:bytesToHex$3(E[2][0]),kind:parseInt(bytesToHex$3(E[3][0]),16),relays:E[1]?E[1].map(C=>utf8Decoder.decode(C)):[]}}}case"nrelay":{let E=parseTLV(r);if(!((m=E[0])!=null&&m[0]))throw new Error("missing TLV 0 for nrelay");return{type:"nrelay",data:utf8Decoder.decode(E[0][0])}}case"nsec":return{type:e,data:r};case"npub":case"note":return{type:e,data:bytesToHex$3(r)};default:throw new Error(`unknown prefix ${e}`)}}function parseTLV(t){let e={},n=t;for(;n.length>0;){let r=n[0],s=n[1],a=n.slice(2,2+s);if(n=n.slice(2+s),a.length<s)throw new Error(`not enough data to read on TLV ${r}`);e[r]=e[r]||[],e[r].push(a)}return e}function nsecEncode(t){return encodeBytes("nsec",t)}function npubEncode(t){return encodeBytes("npub",hexToBytes$3(t))}function noteEncode(t){return encodeBytes("note",hexToBytes$3(t))}function encodeBech32(t,e){let n=bech32.toWords(e);return bech32.encode(t,n,Bech32MaxSize)}function encodeBytes(t,e){return encodeBech32(t,e)}function nprofileEncode(t){let e=encodeTLV({0:[hexToBytes$3(t.pubkey)],1:(t.relays||[]).map(n=>utf8Encoder.encode(n))});return encodeBech32("nprofile",e)}function neventEncode(t){let e;t.kind!==void 0&&(e=integerToUint8Array(t.kind));let n=encodeTLV({0:[hexToBytes$3(t.id)],1:(t.relays||[]).map(r=>utf8Encoder.encode(r)),2:t.author?[hexToBytes$3(t.author)]:[],3:e?[new Uint8Array(e)]:[]});return encodeBech32("nevent",n)}function naddrEncode(t){let e=new ArrayBuffer(4);new DataView(e).setUint32(0,t.kind,!1);let n=encodeTLV({0:[utf8Encoder.encode(t.identifier)],1:(t.relays||[]).map(r=>utf8Encoder.encode(r)),2:[hexToBytes$3(t.pubkey)],3:[new Uint8Array(e)]});return encodeBech32("naddr",n)}function nrelayEncode(t){let e=encodeTLV({0:[utf8Encoder.encode(t)]});return encodeBech32("nrelay",e)}function encodeTLV(t){let e=[];return Object.entries(t).reverse().forEach(([n,r])=>{r.forEach(s=>{let a=new Uint8Array(s.length+2);a.set([parseInt(n)],0),a.set([s.length],1),a.set(s,2),e.push(a)})}),concatBytes$4(...e)}var nip04_exports={};__export(nip04_exports,{decrypt:()=>decrypt$1,encrypt:()=>encrypt$1});async function encrypt$1(t,e,n){const r=t instanceof Uint8Array?bytesToHex$3(t):t,s=secp256k1$1.getSharedSecret(r,"02"+e),a=getNormalizedX(s);let u=Uint8Array.from(randomBytes$2(16)),l=utf8Encoder.encode(n),f=cbc(a,u).encrypt(l),y=base64.encode(new Uint8Array(f)),b=base64.encode(new Uint8Array(u.buffer));return`${y}?iv=${b}`}async function decrypt$1(t,e,n){const r=t instanceof Uint8Array?bytesToHex$3(t):t;let[s,a]=n.split("?iv="),u=secp256k1$1.getSharedSecret(r,"02"+e),l=getNormalizedX(u),f=base64.decode(a),y=base64.decode(s),b=cbc(l,f).decrypt(y);return utf8Decoder.decode(b)}function getNormalizedX(t){return t.slice(1,33)}var nip05_exports={};__export(nip05_exports,{NIP05_REGEX:()=>NIP05_REGEX$1,isValid:()=>isValid,queryProfile:()=>queryProfile,searchDomain:()=>searchDomain,useFetchImplementation:()=>useFetchImplementation});var NIP05_REGEX$1=/^(?:([\w.+-]+)@)?([\w_-]+(\.[\w_-]+)+)$/,_fetch;try{_fetch=fetch}catch{}function useFetchImplementation(t){_fetch=t}async function searchDomain(t,e=""){try{const n=`https://${t}/.well-known/nostr.json?name=${e}`;return(await(await _fetch(n,{redirect:"error"})).json()).names}catch{return{}}}async function queryProfile(t){var a;const e=t.match(NIP05_REGEX$1);if(!e)return null;const[n,r="_",s]=e;try{const u=`https://${s}/.well-known/nostr.json?name=${r}`,l=await(await _fetch(u,{redirect:"error"})).json();let f=l.names[r];return f?{pubkey:f,relays:(a=l.relays)==null?void 0:a[f]}:null}catch{return null}}async function isValid(t,e){let n=await queryProfile(e);return n?n.pubkey===t:!1}var nip10_exports={};__export(nip10_exports,{parse:()=>parse});function parse(t){const e={reply:void 0,root:void 0,mentions:[],profiles:[]},n=[];for(const r of t.tags)r[0]==="e"&&r[1]&&n.push(r),r[0]==="p"&&r[1]&&e.profiles.push({pubkey:r[1],relays:r[2]?[r[2]]:[]});for(let r=0;r<n.length;r++){const s=n[r],[a,u,l,f]=s,y={id:u,relays:l?[l]:[]},b=r===0,m=r===n.length-1;if(f==="root"){e.root=y;continue}if(f==="reply"){e.reply=y;continue}if(f==="mention"){e.mentions.push(y);continue}if(b){e.root=y;continue}if(m){e.reply=y;continue}e.mentions.push(y)}return e}var nip11_exports={};__export(nip11_exports,{fetchRelayInformation:()=>fetchRelayInformation,useFetchImplementation:()=>useFetchImplementation2});var _fetch2;try{_fetch2=fetch}catch{}function useFetchImplementation2(t){_fetch2=t}async function fetchRelayInformation(t){return await(await fetch(t.replace("ws://","http://").replace("wss://","https://"),{headers:{Accept:"application/nostr+json"}})).json()}var nip13_exports={};__export(nip13_exports,{getPow:()=>getPow,minePow:()=>minePow});function getPow(t){let e=0;for(let n=0;n<t.length;n++){const r=parseInt(t[n],16);if(r===0)e+=4;else{e+=Math.clz32(r)-28;break}}return e}function minePow(t,e){let n=0;const r=t,s=["nonce",n.toString(),e.toString()];for(r.tags.push(s);;){const a=Math.floor(new Date().getTime()/1e3);if(a!==r.created_at&&(n=0,r.created_at=a),s[1]=(++n).toString(),r.id=getEventHash$1(r),getPow(r.id)>=e)break}return r}var nip18_exports={};__export(nip18_exports,{finishRepostEvent:()=>finishRepostEvent,getRepostedEvent:()=>getRepostedEvent,getRepostedEventPointer:()=>getRepostedEventPointer});function finishRepostEvent(t,e,n,r){return finalizeEvent({kind:Repost,tags:[...t.tags??[],["e",e.id,n],["p",e.pubkey]],content:t.content===""?"":JSON.stringify(e),created_at:t.created_at},r)}function getRepostedEventPointer(t){if(t.kind!==Repost)return;let e,n;for(let r=t.tags.length-1;r>=0&&(e===void 0||n===void 0);r--){const s=t.tags[r];s.length>=2&&(s[0]==="e"&&e===void 0?e=s:s[0]==="p"&&n===void 0&&(n=s))}if(e!==void 0)return{id:e[1],relays:[e[2],n==null?void 0:n[2]].filter(r=>typeof r=="string"),author:n==null?void 0:n[1]}}function getRepostedEvent(t,{skipVerification:e}={}){const n=getRepostedEventPointer(t);if(n===void 0||t.content==="")return;let r;try{r=JSON.parse(t.content)}catch{return}if(r.id===n.id&&!(!e&&!verifyEvent(r)))return r}var nip21_exports={};__export(nip21_exports,{NOSTR_URI_REGEX:()=>NOSTR_URI_REGEX,parse:()=>parse2,test:()=>test});var NOSTR_URI_REGEX=new RegExp(`nostr:(${BECH32_REGEX$1.source})`);function test(t){return typeof t=="string"&&new RegExp(`^${NOSTR_URI_REGEX.source}$`).test(t)}function parse2(t){const e=t.match(new RegExp(`^${NOSTR_URI_REGEX.source}$`));if(!e)throw new Error(`Invalid Nostr URI: ${t}`);return{uri:e[0],value:e[1],decoded:decode(e[1])}}var nip25_exports={};__export(nip25_exports,{finishReactionEvent:()=>finishReactionEvent,getReactedEventPointer:()=>getReactedEventPointer});function finishReactionEvent(t,e,n){const r=e.tags.filter(s=>s.length>=2&&(s[0]==="e"||s[0]==="p"));return finalizeEvent({...t,kind:Reaction,tags:[...t.tags??[],...r,["e",e.id],["p",e.pubkey]],content:t.content??"+"},n)}function getReactedEventPointer(t){if(t.kind!==Reaction)return;let e,n;for(let r=t.tags.length-1;r>=0&&(e===void 0||n===void 0);r--){const s=t.tags[r];s.length>=2&&(s[0]==="e"&&e===void 0?e=s:s[0]==="p"&&n===void 0&&(n=s))}if(!(e===void 0||n===void 0))return{id:e[1],relays:[e[2],n[2]].filter(r=>r!==void 0),author:n[1]}}var nip27_exports={};__export(nip27_exports,{matchAll:()=>matchAll,regex:()=>regex,replaceAll:()=>replaceAll});var regex=()=>new RegExp(`\\b${NOSTR_URI_REGEX.source}\\b`,"g");function*matchAll(t){const e=t.matchAll(regex());for(const n of e)try{const[r,s]=n;yield{uri:r,value:s,decoded:decode(s),start:n.index,end:n.index+r.length}}catch{}}function replaceAll(t,e){return t.replaceAll(regex(),(n,r)=>e({uri:n,value:r,decoded:decode(r)}))}var nip28_exports={};__export(nip28_exports,{channelCreateEvent:()=>channelCreateEvent,channelHideMessageEvent:()=>channelHideMessageEvent,channelMessageEvent:()=>channelMessageEvent,channelMetadataEvent:()=>channelMetadataEvent,channelMuteUserEvent:()=>channelMuteUserEvent});var channelCreateEvent=(t,e)=>{let n;if(typeof t.content=="object")n=JSON.stringify(t.content);else if(typeof t.content=="string")n=t.content;else return;return finalizeEvent({kind:ChannelCreation,tags:[...t.tags??[]],content:n,created_at:t.created_at},e)},channelMetadataEvent=(t,e)=>{let n;if(typeof t.content=="object")n=JSON.stringify(t.content);else if(typeof t.content=="string")n=t.content;else return;return finalizeEvent({kind:ChannelMetadata,tags:[["e",t.channel_create_event_id],...t.tags??[]],content:n,created_at:t.created_at},e)},channelMessageEvent=(t,e)=>{const n=[["e",t.channel_create_event_id,t.relay_url,"root"]];return t.reply_to_channel_message_event_id&&n.push(["e",t.reply_to_channel_message_event_id,t.relay_url,"reply"]),finalizeEvent({kind:ChannelMessage,tags:[...n,...t.tags??[]],content:t.content,created_at:t.created_at},e)},channelHideMessageEvent=(t,e)=>{let n;if(typeof t.content=="object")n=JSON.stringify(t.content);else if(typeof t.content=="string")n=t.content;else return;return finalizeEvent({kind:ChannelHideMessage,tags:[["e",t.channel_message_event_id],...t.tags??[]],content:n,created_at:t.created_at},e)},channelMuteUserEvent=(t,e)=>{let n;if(typeof t.content=="object")n=JSON.stringify(t.content);else if(typeof t.content=="string")n=t.content;else return;return finalizeEvent({kind:ChannelMuteUser,tags:[["p",t.pubkey_to_mute],...t.tags??[]],content:n,created_at:t.created_at},e)},nip30_exports={};__export(nip30_exports,{EMOJI_SHORTCODE_REGEX:()=>EMOJI_SHORTCODE_REGEX,matchAll:()=>matchAll2,regex:()=>regex2,replaceAll:()=>replaceAll2});var EMOJI_SHORTCODE_REGEX=/:(\w+):/,regex2=()=>new RegExp(`\\B${EMOJI_SHORTCODE_REGEX.source}\\B`,"g");function*matchAll2(t){const e=t.matchAll(regex2());for(const n of e)try{const[r,s]=n;yield{shortcode:r,name:s,start:n.index,end:n.index+r.length}}catch{}}function replaceAll2(t,e){return t.replaceAll(regex2(),(n,r)=>e({shortcode:n,name:r}))}var nip39_exports={};__export(nip39_exports,{useFetchImplementation:()=>useFetchImplementation3,validateGithub:()=>validateGithub});var _fetch3;try{_fetch3=fetch}catch{}function useFetchImplementation3(t){_fetch3=t}async function validateGithub(t,e,n){try{return await(await _fetch3(`https://gist.github.com/${e}/${n}/raw`)).text()===`Verifying that I control the following Nostr public key: ${t}`}catch{return!1}}var nip44_exports={};__export(nip44_exports,{decrypt:()=>decrypt2,encrypt:()=>encrypt2,getConversationKey:()=>getConversationKey,v2:()=>v2});var minPlaintextSize=1,maxPlaintextSize=65535;function getConversationKey(t,e){const n=secp256k1$1.getSharedSecret(t,"02"+e).subarray(1,33);return extract(sha256$1,n,"nip44-v2")}function getMessageKeys(t,e){const n=expand(sha256$1,t,e,76);return{chacha_key:n.subarray(0,32),chacha_nonce:n.subarray(32,44),hmac_key:n.subarray(44,76)}}function calcPaddedLen(t){if(!Number.isSafeInteger(t)||t<1)throw new Error("expected positive integer");if(t<=32)return 32;const e=1<<Math.floor(Math.log2(t-1))+1,n=e<=256?32:e/8;return n*(Math.floor((t-1)/n)+1)}function writeU16BE(t){if(!Number.isSafeInteger(t)||t<minPlaintextSize||t>maxPlaintextSize)throw new Error("invalid plaintext size: must be between 1 and 65535 bytes");const e=new Uint8Array(2);return new DataView(e.buffer).setUint16(0,t,!1),e}function pad(t){const e=utf8Encoder.encode(t),n=e.length,r=writeU16BE(n),s=new Uint8Array(calcPaddedLen(n)-n);return concatBytes$4(r,e,s)}function unpad(t){const e=new DataView(t.buffer).getUint16(0),n=t.subarray(2,2+e);if(e<minPlaintextSize||e>maxPlaintextSize||n.length!==e||t.length!==2+calcPaddedLen(e))throw new Error("invalid padding");return utf8Decoder.decode(n)}function hmacAad(t,e,n){if(n.length!==32)throw new Error("AAD associated data must be 32 bytes");const r=concatBytes$4(n,e);return hmac$1(sha256$1,t,r)}function decodePayload(t){if(typeof t!="string")throw new Error("payload must be a valid string");const e=t.length;if(e<132||e>87472)throw new Error("invalid payload length: "+e);if(t[0]==="#")throw new Error("unknown encryption version");let n;try{n=base64.decode(t)}catch(a){throw new Error("invalid base64: "+a.message)}const r=n.length;if(r<99||r>65603)throw new Error("invalid data length: "+r);const s=n[0];if(s!==2)throw new Error("unknown encryption version "+s);return{nonce:n.subarray(1,33),ciphertext:n.subarray(33,-32),mac:n.subarray(-32)}}function encrypt2(t,e,n=randomBytes$2(32)){const{chacha_key:r,chacha_nonce:s,hmac_key:a}=getMessageKeys(e,n),u=pad(t),l=chacha20(r,s,u),f=hmacAad(a,l,n);return base64.encode(concatBytes$4(new Uint8Array([2]),n,l,f))}function decrypt2(t,e){const{nonce:n,ciphertext:r,mac:s}=decodePayload(t),{chacha_key:a,chacha_nonce:u,hmac_key:l}=getMessageKeys(e,n),f=hmacAad(l,r,n);if(!equalBytes$1(f,s))throw new Error("invalid MAC");const y=chacha20(a,u,r);return unpad(y)}var v2={utils:{getConversationKey,calcPaddedLen},encrypt:encrypt2,decrypt:decrypt2},nip47_exports={};__export(nip47_exports,{makeNwcRequestEvent:()=>makeNwcRequestEvent,parseConnectionString:()=>parseConnectionString});function parseConnectionString(t){const{pathname:e,searchParams:n}=new URL(t),r=e,s=n.get("relay"),a=n.get("secret");if(!r||!s||!a)throw new Error("invalid connection string");return{pubkey:r,relay:s,secret:a}}async function makeNwcRequestEvent(t,e,n){const s=await encrypt$1(e,t,JSON.stringify({method:"pay_invoice",params:{invoice:n}})),a={kind:NWCWalletRequest,created_at:Math.round(Date.now()/1e3),content:s,tags:[["p",t]]};return finalizeEvent(a,e)}var nip57_exports={};__export(nip57_exports,{getZapEndpoint:()=>getZapEndpoint,makeZapReceipt:()=>makeZapReceipt,makeZapRequest:()=>makeZapRequest,useFetchImplementation:()=>useFetchImplementation4,validateZapRequest:()=>validateZapRequest});var _fetch4;try{_fetch4=fetch}catch{}function useFetchImplementation4(t){_fetch4=t}async function getZapEndpoint(t){try{let e="",{lud06:n,lud16:r}=JSON.parse(t.content);if(n){let{words:u}=bech32.decode(n,1e3),l=bech32.fromWords(u);e=utf8Decoder.decode(l)}else if(r){let[u,l]=r.split("@");e=new URL(`/.well-known/lnurlp/${u}`,`https://${l}`).toString()}else return null;let a=await(await _fetch4(e)).json();if(a.allowsNostr&&a.nostrPubkey)return a.callback}catch{}return null}function makeZapRequest({profile:t,event:e,amount:n,relays:r,comment:s=""}){if(!n)throw new Error("amount not given");if(!t)throw new Error("profile not given");let a={kind:9734,created_at:Math.round(Date.now()/1e3),content:s,tags:[["p",t],["amount",n.toString()],["relays",...r]]};return e&&a.tags.push(["e",e]),a}function validateZapRequest(t){let e;try{e=JSON.parse(t)}catch{return"Invalid zap request JSON."}if(!validateEvent(e))return"Zap request is not a valid Nostr event.";if(!verifyEvent(e))return"Invalid signature on zap request.";let n=e.tags.find(([a,u])=>a==="p"&&u);if(!n)return"Zap request doesn't have a 'p' tag.";if(!n[1].match(/^[a-f0-9]{64}$/))return"Zap request 'p' tag is not valid hex.";let r=e.tags.find(([a,u])=>a==="e"&&u);return r&&!r[1].match(/^[a-f0-9]{64}$/)?"Zap request 'e' tag is not valid hex.":e.tags.find(([a,u])=>a==="relays"&&u)?null:"Zap request doesn't have a 'relays' tag."}function makeZapReceipt({zapRequest:t,preimage:e,bolt11:n,paidAt:r}){let s=JSON.parse(t),a=s.tags.filter(([l])=>l==="e"||l==="p"||l==="a"),u={kind:9735,created_at:Math.round(r.getTime()/1e3),content:"",tags:[...a,["P",s.pubkey],["bolt11",n],["description",t]]};return e&&u.tags.push(["preimage",e]),u}var nip98_exports={};__export(nip98_exports,{getToken:()=>getToken,hashPayload:()=>hashPayload,unpackEventFromToken:()=>unpackEventFromToken,validateEvent:()=>validateEvent2,validateEventKind:()=>validateEventKind,validateEventMethodTag:()=>validateEventMethodTag,validateEventPayloadTag:()=>validateEventPayloadTag,validateEventTimestamp:()=>validateEventTimestamp,validateEventUrlTag:()=>validateEventUrlTag,validateToken:()=>validateToken});var _authorizationScheme="Nostr ";async function getToken(t,e,n,r=!1,s){const a={kind:HTTPAuth,tags:[["u",t],["method",e]],created_at:Math.round(new Date().getTime()/1e3),content:""};s&&a.tags.push(["payload",hashPayload(s)]);const u=await n(a);return(r?_authorizationScheme:"")+base64.encode(utf8Encoder.encode(JSON.stringify(u)))}async function validateToken(t,e,n){const r=await unpackEventFromToken(t).catch(a=>{throw a});return await validateEvent2(r,e,n).catch(a=>{throw a})}async function unpackEventFromToken(t){if(!t)throw new Error("Missing token");t=t.replace(_authorizationScheme,"");const e=utf8Decoder.decode(base64.decode(t));if(!e||e.length===0||!e.startsWith("{"))throw new Error("Invalid token");return JSON.parse(e)}function validateEventTimestamp(t){return t.created_at?Math.round(new Date().getTime()/1e3)-t.created_at<60:!1}function validateEventKind(t){return t.kind===HTTPAuth}function validateEventUrlTag(t,e){const n=t.tags.find(r=>r[0]==="u");return n?n.length>0&&n[1]===e:!1}function validateEventMethodTag(t,e){const n=t.tags.find(r=>r[0]==="method");return n?n.length>0&&n[1].toLowerCase()===e.toLowerCase():!1}function hashPayload(t){const e=sha256$1(utf8Encoder.encode(JSON.stringify(t)));return bytesToHex$3(e)}function validateEventPayloadTag(t,e){const n=t.tags.find(s=>s[0]==="payload");if(!n)return!1;const r=hashPayload(e);return n.length>0&&n[1]===r}async function validateEvent2(t,e,n,r){if(!verifyEvent(t))throw new Error("Invalid nostr event, signature invalid");if(!validateEventKind(t))throw new Error("Invalid nostr event, kind invalid");if(!validateEventTimestamp(t))throw new Error("Invalid nostr event, created_at timestamp invalid");if(!validateEventUrlTag(t,e))throw new Error("Invalid nostr event, url tag invalid");if(!validateEventMethodTag(t,n))throw new Error("Invalid nostr event, method tag invalid");if(r&&typeof r=="object"&&Object.keys(r).length>0&&!validateEventPayloadTag(t,r))throw new Error("Invalid nostr event, payload tag does not match request body hash");return!0}var commonjsGlobal=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function getDefaultExportFromCjs(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var lib={},types={};Object.defineProperty(types,"__esModule",{value:!0});var ee={},taskCollection$1={},taskCollection={},bakeCollection={};(function(exports){Object.defineProperty(exports,"__esModule",{value:!0}),exports.bakeCollectionVariadic=exports.bakeCollectionAwait=exports.bakeCollection=exports.BAKED_EMPTY_FUNC=void 0,exports.BAKED_EMPTY_FUNC=function(){};var FORLOOP_FALLBACK=1500;function generateArgsDefCode(t){var e="";if(t===0)return e;for(var n=0;n<t-1;++n)e+="arg"+String(n)+", ";return e+="arg"+String(t-1),e}function generateBodyPartsCode(t,e){for(var n="",r="",s=0;s<e;++s)n+="var f".concat(s," = collection[").concat(s,`];
`),r+="f".concat(s,"(").concat(t,`)
`);return{funcDefCode:n,funcCallCode:r}}function generateBodyPartsVariadicCode(t){for(var e="",n="",r=0;r<t;++r)e+="var f".concat(r," = collection[").concat(r,`];
`),n+="f".concat(r,`.apply(undefined, arguments)
`);return{funcDefCode:e,funcCallCode:n}}function bakeCollection(collection,fixedArgsNum){if(collection.length===0)return exports.BAKED_EMPTY_FUNC;if(collection.length===1)return collection[0];var funcFactoryCode;if(collection.length<FORLOOP_FALLBACK){var argsDefCode=generateArgsDefCode(fixedArgsNum),_a=generateBodyPartsCode(argsDefCode,collection.length),funcDefCode=_a.funcDefCode,funcCallCode=_a.funcCallCode;funcFactoryCode=`(function(collection) {
            `.concat(funcDefCode,`
            collection = undefined;
            return (function(`).concat(argsDefCode,`) {
                `).concat(funcCallCode,`
            });
        })`)}else{var argsDefCode=generateArgsDefCode(fixedArgsNum);collection.length%10===0?funcFactoryCode=`(function(collection) {
                return (function(`.concat(argsDefCode,`) {
                    for (var i = 0; i < collection.length; i += 10) {
                        collection[i](`).concat(argsDefCode,`);
                        collection[i+1](`).concat(argsDefCode,`);
                        collection[i+2](`).concat(argsDefCode,`);
                        collection[i+3](`).concat(argsDefCode,`);
                        collection[i+4](`).concat(argsDefCode,`);
                        collection[i+5](`).concat(argsDefCode,`);
                        collection[i+6](`).concat(argsDefCode,`);
                        collection[i+7](`).concat(argsDefCode,`);
                        collection[i+8](`).concat(argsDefCode,`);
                        collection[i+9](`).concat(argsDefCode,`);
                    }
                });
            })`):collection.length%4===0?funcFactoryCode=`(function(collection) {
                return (function(`.concat(argsDefCode,`) {
                    for (var i = 0; i < collection.length; i += 4) {
                        collection[i](`).concat(argsDefCode,`);
                        collection[i+1](`).concat(argsDefCode,`);
                        collection[i+2](`).concat(argsDefCode,`);
                        collection[i+3](`).concat(argsDefCode,`);
                    }
                });
            })`):collection.length%3===0?funcFactoryCode=`(function(collection) {
                return (function(`.concat(argsDefCode,`) {
                    for (var i = 0; i < collection.length; i += 3) {
                        collection[i](`).concat(argsDefCode,`);
                        collection[i+1](`).concat(argsDefCode,`);
                        collection[i+2](`).concat(argsDefCode,`);
                    }
                });
            })`):funcFactoryCode=`(function(collection) {
                return (function(`.concat(argsDefCode,`) {
                    for (var i = 0; i < collection.length; ++i) {
                        collection[i](`).concat(argsDefCode,`);
                    }
                });
            })`)}{var funcFactory=eval(funcFactoryCode);return funcFactory(collection)}}exports.bakeCollection=bakeCollection;function bakeCollectionAwait(collection,fixedArgsNum){if(collection.length===0)return exports.BAKED_EMPTY_FUNC;if(collection.length===1)return collection[0];var funcFactoryCode;if(collection.length<FORLOOP_FALLBACK){var argsDefCode=generateArgsDefCode(fixedArgsNum),_a=generateBodyPartsCode(argsDefCode,collection.length),funcDefCode=_a.funcDefCode,funcCallCode=_a.funcCallCode;funcFactoryCode=`(function(collection) {
            `.concat(funcDefCode,`
            collection = undefined;
            return (function(`).concat(argsDefCode,`) {
                return Promise.all([ `).concat(funcCallCode,` ]);
            });
        })`)}else{var argsDefCode=generateArgsDefCode(fixedArgsNum);funcFactoryCode=`(function(collection) {
            return (function(`.concat(argsDefCode,`) {
                var promises = Array(collection.length);
                for (var i = 0; i < collection.length; ++i) {
                    promises[i] = collection[i](`).concat(argsDefCode,`);
                }
                return Promise.all(promises);
            });
        })`)}{var funcFactory=eval(funcFactoryCode);return funcFactory(collection)}}exports.bakeCollectionAwait=bakeCollectionAwait;function bakeCollectionVariadic(collection){if(collection.length===0)return exports.BAKED_EMPTY_FUNC;if(collection.length===1)return collection[0];var funcFactoryCode;if(collection.length<FORLOOP_FALLBACK){var _a=generateBodyPartsVariadicCode(collection.length),funcDefCode=_a.funcDefCode,funcCallCode=_a.funcCallCode;funcFactoryCode=`(function(collection) {
            `.concat(funcDefCode,`
            collection = undefined;
            return (function() {
                `).concat(funcCallCode,`
            });
        })`)}else funcFactoryCode=`(function(collection) {
            return (function() {
                for (var i = 0; i < collection.length; ++i) {
                    collection[i].apply(undefined, arguments);
                }
            });
        })`;{var funcFactory=eval(funcFactoryCode);return funcFactory(collection)}}exports.bakeCollectionVariadic=bakeCollectionVariadic})(bakeCollection);var __spreadArray$1=commonjsGlobal&&commonjsGlobal.__spreadArray||function(t,e,n){if(n||arguments.length===2)for(var r=0,s=e.length,a;r<s;r++)(a||!(r in e))&&(a||(a=Array.prototype.slice.call(e,0,r)),a[r]=e[r]);return t.concat(a||Array.prototype.slice.call(e))};Object.defineProperty(taskCollection,"__esModule",{value:!0});taskCollection.TaskCollection=taskCollection._fast_remove_single=void 0;var bake_collection_1=bakeCollection;function push_norebuild(t,e){var n=this.length;if(n>1)if(e){var r;(r=this._tasks).push.apply(r,arguments),this.length+=arguments.length}else this._tasks.push(t),this.length++;else if(e){if(n===1){var s=Array(1+arguments.length);s.push(s),s.push.apply(s,arguments),this._tasks=s}else{var s=Array(arguments.length);s.push.apply(s,arguments),this._tasks=s}this.length+=arguments.length}else n===1?this._tasks=[this._tasks,t]:this._tasks=t,this.length++}function push_rebuild(t,e){var n=this.length;if(n>1)if(e){var r;(r=this._tasks).push.apply(r,arguments),this.length+=arguments.length}else this._tasks.push(t),this.length++;else if(e){if(n===1){var s=Array(1+arguments.length);s.push(s),s.push.apply(s,arguments),this._tasks=s}else{var s=Array(arguments.length);s.push.apply(s,arguments),this._tasks=s}this.length+=arguments.length}else n===1?this._tasks=[this._tasks,t]:this._tasks=t,this.length++;this.firstEmitBuildStrategy?this.call=rebuild_on_first_call:this.rebuild()}function _fast_remove_single(t,e){e!==-1&&(e===0?t.shift():e===t.length-1?t.length=t.length-1:t.splice(e,1))}taskCollection._fast_remove_single=_fast_remove_single;function removeLast_norebuild(t){this.length!==0&&(this.length===1?this._tasks===t&&(this.length=0):(_fast_remove_single(this._tasks,this._tasks.lastIndexOf(t)),this._tasks.length===1?(this._tasks=this._tasks[0],this.length=1):this.length=this._tasks.length))}function removeLast_rebuild(t){if(this.length!==0){if(this.length===1)if(this._tasks===t&&(this.length=0),this.firstEmitBuildStrategy){this.call=bake_collection_1.BAKED_EMPTY_FUNC;return}else{this.rebuild();return}else _fast_remove_single(this._tasks,this._tasks.lastIndexOf(t)),this._tasks.length===1?(this._tasks=this._tasks[0],this.length=1):this.length=this._tasks.length;this.firstEmitBuildStrategy?this.call=rebuild_on_first_call:this.rebuild()}}function insert_norebuild(t){for(var e,n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];this.length===0?(this._tasks=n,this.length=1):this.length===1?(n.unshift(this._tasks),this._tasks=n,this.length=this._tasks.length):((e=this._tasks).splice.apply(e,__spreadArray$1([t,0],n,!1)),this.length=this._tasks.length)}function insert_rebuild(t){for(var e,n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];this.length===0?(this._tasks=n,this.length=1):this.length===1?(n.unshift(this._tasks),this._tasks=n,this.length=this._tasks.length):((e=this._tasks).splice.apply(e,__spreadArray$1([t,0],n,!1)),this.length=this._tasks.length),this.firstEmitBuildStrategy?this.call=rebuild_on_first_call:this.rebuild()}function rebuild_noawait(){this.length===0?this.call=bake_collection_1.BAKED_EMPTY_FUNC:this.length===1?this.call=this._tasks:this.call=(0,bake_collection_1.bakeCollection)(this._tasks,this.argsNum)}function rebuild_await(){this.length===0?this.call=bake_collection_1.BAKED_EMPTY_FUNC:this.length===1?this.call=this._tasks:this.call=(0,bake_collection_1.bakeCollectionAwait)(this._tasks,this.argsNum)}function rebuild_on_first_call(){this.rebuild(),this.call.apply(void 0,arguments)}var TaskCollection=function(){function t(e,n,r,s){n===void 0&&(n=!0),r===void 0&&(r=null),s===void 0&&(s=!1),this.awaitTasks=s,this.call=bake_collection_1.BAKED_EMPTY_FUNC,this.argsNum=e,this.firstEmitBuildStrategy=!0,s?this.rebuild=rebuild_await.bind(this):this.rebuild=rebuild_noawait.bind(this),this.setAutoRebuild(n),r?typeof r=="function"?(this._tasks=r,this.length=1):(this._tasks=r,this.length=r.length):(this._tasks=null,this.length=0),n&&this.rebuild()}return t}();taskCollection.TaskCollection=TaskCollection;function fastClear(){this._tasks=null,this.length=0,this.call=bake_collection_1.BAKED_EMPTY_FUNC}function clear(){this._tasks=null,this.length=0,this.call=bake_collection_1.BAKED_EMPTY_FUNC}function growArgsNum(t){this.argsNum<t&&(this.argsNum=t,this.firstEmitBuildStrategy?this.call=rebuild_on_first_call:this.rebuild())}function setAutoRebuild(t){t?(this.push=push_rebuild.bind(this),this.insert=insert_rebuild.bind(this),this.removeLast=removeLast_rebuild.bind(this)):(this.push=push_norebuild.bind(this),this.insert=insert_norebuild.bind(this),this.removeLast=removeLast_norebuild.bind(this))}function tasksAsArray(){return this.length===0?[]:this.length===1?[this._tasks]:this._tasks}function setTasks(t){t.length===0?(this.length=0,this.call=bake_collection_1.BAKED_EMPTY_FUNC):t.length===1?(this.length=1,this.call=t[0],this._tasks=t[0]):(this.length=t.length,this._tasks=t,this.firstEmitBuildStrategy?this.call=rebuild_on_first_call:this.rebuild())}TaskCollection.prototype.fastClear=fastClear;TaskCollection.prototype.clear=clear;TaskCollection.prototype.growArgsNum=growArgsNum;TaskCollection.prototype.setAutoRebuild=setAutoRebuild;TaskCollection.prototype.tasksAsArray=tasksAsArray;TaskCollection.prototype.setTasks=setTasks;(function(t){var e=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(r,s,a,u){u===void 0&&(u=a);var l=Object.getOwnPropertyDescriptor(s,a);(!l||("get"in l?!s.__esModule:l.writable||l.configurable))&&(l={enumerable:!0,get:function(){return s[a]}}),Object.defineProperty(r,u,l)}:function(r,s,a,u){u===void 0&&(u=a),r[u]=s[a]}),n=commonjsGlobal&&commonjsGlobal.__exportStar||function(r,s){for(var a in r)a!=="default"&&!Object.prototype.hasOwnProperty.call(s,a)&&e(s,r,a)};Object.defineProperty(t,"__esModule",{value:!0}),n(taskCollection,t)})(taskCollection$1);var utils={};Object.defineProperty(utils,"__esModule",{value:!0});utils.nullObj=void 0;function nullObj(){var t={};return t.__proto__=null,t.prototype=null,t}utils.nullObj=nullObj;var __spreadArray=commonjsGlobal&&commonjsGlobal.__spreadArray||function(t,e,n){if(n||arguments.length===2)for(var r=0,s=e.length,a;r<s;r++)(a||!(r in e))&&(a||(a=Array.prototype.slice.call(e,0,r)),a[r]=e[r]);return t.concat(a||Array.prototype.slice.call(e))};Object.defineProperty(ee,"__esModule",{value:!0});ee.EventEmitter=void 0;var task_collection_1=taskCollection$1,utils_1=utils;function emit(t,e,n,r,s,a){var u=this.events[t];return u?u.length===0?!1:(u.argsNum<6?u.call(e,n,r,s,a):u.call.apply(void 0,arguments),!0):!1}function emitHasOnce(t,e,n,r,s,a){var u=this.events[t];if(u){if(u.length===0)return!1;u.argsNum<6?u.call(e,n,r,s,a):u.call.apply(void 0,arguments)}var l=this.onceEvents[t];if(l){if(typeof l=="function")this.onceEvents[t]=void 0,arguments.length<6?l(e,n,r,s,a):l.apply(void 0,arguments);else{var f=l;if(this.onceEvents[t]=void 0,arguments.length<6)for(var y=0;y<f.length;++y)f[y](e,n,r,s,a);else for(var y=0;y<f.length;++y)f[y].apply(void 0,arguments)}return!0}return!!u}var EventEmitter=function(){function t(){this.events=(0,utils_1.nullObj)(),this.onceEvents=(0,utils_1.nullObj)(),this._symbolKeys=new Set,this.maxListeners=1/0}return Object.defineProperty(t.prototype,"_eventsCount",{get:function(){return this.eventNames().length},enumerable:!1,configurable:!0}),t}();ee.EventEmitter=EventEmitter;function once(t,e){switch(this.emit===emit&&(this.emit=emitHasOnce),typeof this.onceEvents[t]){case"undefined":this.onceEvents[t]=e,typeof t=="symbol"&&this._symbolKeys.add(t);break;case"function":this.onceEvents[t]=[this.onceEvents[t],e];break;case"object":this.onceEvents[t].push(e)}return this}function addListener(t,e,n){if(n===void 0&&(n=e.length),typeof e!="function")throw new TypeError("The listener must be a function");var r=this.events[t];return r?(r.push(e),r.growArgsNum(n),this.maxListeners!==1/0&&this.maxListeners<=r.length&&console.warn('Maximum event listeners for "'.concat(String(t),'" event!'))):(this.events[t]=new task_collection_1.TaskCollection(n,!0,e,!1),typeof t=="symbol"&&this._symbolKeys.add(t)),this}function removeListener(t,e){var n=this.events[t];n&&n.removeLast(e);var r=this.onceEvents[t];return r&&(typeof r=="function"?this.onceEvents[t]=void 0:typeof r=="object"&&(r.length===1&&r[0]===e?this.onceEvents[t]=void 0:(0,task_collection_1._fast_remove_single)(r,r.lastIndexOf(e)))),this}function addListenerBound(t,e,n,r){n===void 0&&(n=this),r===void 0&&(r=e.length),this.boundFuncs||(this.boundFuncs=new Map);var s=e.bind(n);return this.boundFuncs.set(e,s),this.addListener(t,s,r)}function removeListenerBound(t,e){var n,r,s=(n=this.boundFuncs)===null||n===void 0?void 0:n.get(e);return(r=this.boundFuncs)===null||r===void 0||r.delete(e),this.removeListener(t,s)}function hasListeners(t){return this.events[t]&&!!this.events[t].length}function prependListener(t,e,n){if(n===void 0&&(n=e.length),typeof e!="function")throw new TypeError("The listener must be a function");var r=this.events[t];return!r||!(r instanceof task_collection_1.TaskCollection)?(r=this.events[t]=new task_collection_1.TaskCollection(n,!0,e,!1),typeof t=="symbol"&&this._symbolKeys.add(t)):(r.insert(0,e),r.growArgsNum(n),this.maxListeners!==1/0&&this.maxListeners<=r.length&&console.warn('Maximum event listeners for "'.concat(String(t),'" event!'))),this}function prependOnceListener(t,e){this.emit===emit&&(this.emit=emitHasOnce);var n=this.onceEvents[t];return n?typeof n!="object"?(this.onceEvents[t]=[e,n],typeof t=="symbol"&&this._symbolKeys.add(t)):(n.unshift(e),this.maxListeners!==1/0&&this.maxListeners<=n.length&&console.warn('Maximum event listeners for "'.concat(String(t),'" once event!'))):(this.onceEvents[t]=[e],typeof t=="symbol"&&this._symbolKeys.add(t)),this}function removeAllListeners(t){return t===void 0?(this.events=(0,utils_1.nullObj)(),this.onceEvents=(0,utils_1.nullObj)(),this._symbolKeys=new Set):(this.events[t]=void 0,this.onceEvents[t]=void 0,typeof t=="symbol"&&this._symbolKeys.delete(t)),this}function setMaxListeners(t){return this.maxListeners=t,this}function getMaxListeners(){return this.maxListeners}function listeners(t){return this.emit===emit?this.events[t]?this.events[t].tasksAsArray().slice():[]:this.events[t]&&this.onceEvents[t]?__spreadArray(__spreadArray([],this.events[t].tasksAsArray(),!0),typeof this.onceEvents[t]=="function"?[this.onceEvents[t]]:this.onceEvents[t],!0):this.events[t]?this.events[t].tasksAsArray():this.onceEvents[t]?typeof this.onceEvents[t]=="function"?[this.onceEvents[t]]:this.onceEvents[t]:[]}function eventNames(){var t=this;if(this.emit===emit){var e=Object.keys(this.events);return __spreadArray(__spreadArray([],e,!0),Array.from(this._symbolKeys),!0).filter(function(r){return r in t.events&&t.events[r]&&t.events[r].length})}else{var e=Object.keys(this.events).filter(function(s){return t.events[s]&&t.events[s].length}),n=Object.keys(this.onceEvents).filter(function(s){return t.onceEvents[s]&&t.onceEvents[s].length});return __spreadArray(__spreadArray(__spreadArray([],e,!0),n,!0),Array.from(this._symbolKeys).filter(function(s){return s in t.events&&t.events[s]&&t.events[s].length||s in t.onceEvents&&t.onceEvents[s]&&t.onceEvents[s].length}),!0)}}function listenerCount(t){return this.emit===emit?this.events[t]&&this.events[t].length||0:(this.events[t]&&this.events[t].length||0)+(this.onceEvents[t]&&this.onceEvents[t].length||0)}EventEmitter.prototype.emit=emit;EventEmitter.prototype.on=addListener;EventEmitter.prototype.once=once;EventEmitter.prototype.addListener=addListener;EventEmitter.prototype.removeListener=removeListener;EventEmitter.prototype.addListenerBound=addListenerBound;EventEmitter.prototype.removeListenerBound=removeListenerBound;EventEmitter.prototype.hasListeners=hasListeners;EventEmitter.prototype.prependListener=prependListener;EventEmitter.prototype.prependOnceListener=prependOnceListener;EventEmitter.prototype.off=removeListener;EventEmitter.prototype.removeAllListeners=removeAllListeners;EventEmitter.prototype.setMaxListeners=setMaxListeners;EventEmitter.prototype.getMaxListeners=getMaxListeners;EventEmitter.prototype.listeners=listeners;EventEmitter.prototype.eventNames=eventNames;EventEmitter.prototype.listenerCount=listenerCount;(function(t){var e=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(r,s,a,u){u===void 0&&(u=a);var l=Object.getOwnPropertyDescriptor(s,a);(!l||("get"in l?!s.__esModule:l.writable||l.configurable))&&(l={enumerable:!0,get:function(){return s[a]}}),Object.defineProperty(r,u,l)}:function(r,s,a,u){u===void 0&&(u=a),r[u]=s[a]}),n=commonjsGlobal&&commonjsGlobal.__exportStar||function(r,s){for(var a in r)a!=="default"&&!Object.prototype.hasOwnProperty.call(s,a)&&e(s,r,a)};Object.defineProperty(t,"__esModule",{value:!0}),n(types,t),n(ee,t)})(lib);var browser={exports:{}},ms,hasRequiredMs;function requireMs(){if(hasRequiredMs)return ms;hasRequiredMs=1;var t=1e3,e=t*60,n=e*60,r=n*24,s=r*7,a=r*365.25;ms=function(b,m){m=m||{};var E=typeof b;if(E==="string"&&b.length>0)return u(b);if(E==="number"&&isFinite(b))return m.long?f(b):l(b);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(b))};function u(b){if(b=String(b),!(b.length>100)){var m=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(b);if(m){var E=parseFloat(m[1]),C=(m[2]||"ms").toLowerCase();switch(C){case"years":case"year":case"yrs":case"yr":case"y":return E*a;case"weeks":case"week":case"w":return E*s;case"days":case"day":case"d":return E*r;case"hours":case"hour":case"hrs":case"hr":case"h":return E*n;case"minutes":case"minute":case"mins":case"min":case"m":return E*e;case"seconds":case"second":case"secs":case"sec":case"s":return E*t;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return E;default:return}}}}function l(b){var m=Math.abs(b);return m>=r?Math.round(b/r)+"d":m>=n?Math.round(b/n)+"h":m>=e?Math.round(b/e)+"m":m>=t?Math.round(b/t)+"s":b+"ms"}function f(b){var m=Math.abs(b);return m>=r?y(b,m,r,"day"):m>=n?y(b,m,n,"hour"):m>=e?y(b,m,e,"minute"):m>=t?y(b,m,t,"second"):b+" ms"}function y(b,m,E,C){var O=m>=E*1.5;return Math.round(b/E)+" "+C+(O?"s":"")}return ms}function setup(t){n.debug=n,n.default=n,n.coerce=f,n.disable=a,n.enable=s,n.enabled=u,n.humanize=requireMs(),n.destroy=y,Object.keys(t).forEach(b=>{n[b]=t[b]}),n.names=[],n.skips=[],n.formatters={};function e(b){let m=0;for(let E=0;E<b.length;E++)m=(m<<5)-m+b.charCodeAt(E),m|=0;return n.colors[Math.abs(m)%n.colors.length]}n.selectColor=e;function n(b){let m,E=null,C,O;function $(...k){if(!$.enabled)return;const I=$,q=Number(new Date),W=q-(m||q);I.diff=W,I.prev=m,I.curr=q,m=q,k[0]=n.coerce(k[0]),typeof k[0]!="string"&&k.unshift("%O");let te=0;k[0]=k[0].replace(/%([a-zA-Z%])/g,(V,j)=>{if(V==="%%")return"%";te++;const G=n.formatters[j];if(typeof G=="function"){const le=k[te];V=G.call(I,le),k.splice(te,1),te--}return V}),n.formatArgs.call(I,k),(I.log||n.log).apply(I,k)}return $.namespace=b,$.useColors=n.useColors(),$.color=n.selectColor(b),$.extend=r,$.destroy=n.destroy,Object.defineProperty($,"enabled",{enumerable:!0,configurable:!1,get:()=>E!==null?E:(C!==n.namespaces&&(C=n.namespaces,O=n.enabled(b)),O),set:k=>{E=k}}),typeof n.init=="function"&&n.init($),$}function r(b,m){const E=n(this.namespace+(typeof m>"u"?":":m)+b);return E.log=this.log,E}function s(b){n.save(b),n.namespaces=b,n.names=[],n.skips=[];let m;const E=(typeof b=="string"?b:"").split(/[\s,]+/),C=E.length;for(m=0;m<C;m++)E[m]&&(b=E[m].replace(/\*/g,".*?"),b[0]==="-"?n.skips.push(new RegExp("^"+b.slice(1)+"$")):n.names.push(new RegExp("^"+b+"$")))}function a(){const b=[...n.names.map(l),...n.skips.map(l).map(m=>"-"+m)].join(",");return n.enable(""),b}function u(b){if(b[b.length-1]==="*")return!0;let m,E;for(m=0,E=n.skips.length;m<E;m++)if(n.skips[m].test(b))return!1;for(m=0,E=n.names.length;m<E;m++)if(n.names[m].test(b))return!0;return!1}function l(b){return b.toString().substring(2,b.toString().length-2).replace(/\.\*\?$/,"*")}function f(b){return b instanceof Error?b.stack||b.message:b}function y(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return n.enable(n.load()),n}var common=setup;(function(t,e){var n={};e.formatArgs=s,e.save=a,e.load=u,e.useColors=r,e.storage=l(),e.destroy=(()=>{let y=!1;return()=>{y||(y=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function r(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let y;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(y=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(y[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function s(y){if(y[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+y[0]+(this.useColors?"%c ":" ")+"+"+t.exports.humanize(this.diff),!this.useColors)return;const b="color: "+this.color;y.splice(1,0,b,"color: inherit");let m=0,E=0;y[0].replace(/%[a-zA-Z%]/g,C=>{C!=="%%"&&(m++,C==="%c"&&(E=m))}),y.splice(E,0,b)}e.log=console.debug||console.log||(()=>{});function a(y){try{y?e.storage.setItem("debug",y):e.storage.removeItem("debug")}catch{}}function u(){let y;try{y=e.storage.getItem("debug")}catch{}return!y&&typeof process<"u"&&"env"in process&&(y=n.DEBUG),y}function l(){try{return localStorage}catch{}}t.exports=common(e);const{formatters:f}=t.exports;f.j=function(y){try{return JSON.stringify(y)}catch(b){return"[UnexpectedJSONParseError]: "+b.message}}})(browser,browser.exports);var browserExports=browser.exports;const createDebug2=getDefaultExportFromCjs(browserExports);function number(t){if(!Number.isSafeInteger(t)||t<0)throw new Error(`positive integer expected, not ${t}`)}function isBytes$1(t){return t instanceof Uint8Array||t!=null&&typeof t=="object"&&t.constructor.name==="Uint8Array"}function bytes(t,...e){if(!isBytes$1(t))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(t.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${t.length}`)}function hash(t){if(typeof t!="function"||typeof t.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");number(t.outputLen),number(t.blockLen)}function exists(t,e=!0){if(t.destroyed)throw new Error("Hash instance has been destroyed");if(e&&t.finished)throw new Error("Hash#digest() has already been called")}function output(t,e){bytes(t);const n=e.outputLen;if(t.length<n)throw new Error(`digestInto() expects output buffer of length at least ${n}`)}const crypto$1=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */const createView=t=>new DataView(t.buffer,t.byteOffset,t.byteLength),rotr=(t,e)=>t<<32-e|t>>>e;new Uint8Array(new Uint32Array([287454020]).buffer)[0];const hexes$1=Array.from({length:256},(t,e)=>e.toString(16).padStart(2,"0"));function bytesToHex$1(t){bytes(t);let e="";for(let n=0;n<t.length;n++)e+=hexes$1[t[n]];return e}const asciis$1={_0:48,_9:57,_A:65,_F:70,_a:97,_f:102};function asciiToBase16$1(t){if(t>=asciis$1._0&&t<=asciis$1._9)return t-asciis$1._0;if(t>=asciis$1._A&&t<=asciis$1._F)return t-(asciis$1._A-10);if(t>=asciis$1._a&&t<=asciis$1._f)return t-(asciis$1._a-10)}function hexToBytes$1(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);const e=t.length,n=e/2;if(e%2)throw new Error("padded hex string expected, got unpadded hex of length "+e);const r=new Uint8Array(n);for(let s=0,a=0;s<n;s++,a+=2){const u=asciiToBase16$1(t.charCodeAt(a)),l=asciiToBase16$1(t.charCodeAt(a+1));if(u===void 0||l===void 0){const f=t[a]+t[a+1];throw new Error('hex string expected, got non-hex character "'+f+'" at index '+a)}r[s]=u*16+l}return r}function utf8ToBytes$1(t){if(typeof t!="string")throw new Error(`utf8ToBytes expected string, got ${typeof t}`);return new Uint8Array(new TextEncoder().encode(t))}function toBytes(t){return typeof t=="string"&&(t=utf8ToBytes$1(t)),bytes(t),t}function concatBytes$1(...t){let e=0;for(let r=0;r<t.length;r++){const s=t[r];bytes(s),e+=s.length}const n=new Uint8Array(e);for(let r=0,s=0;r<t.length;r++){const a=t[r];n.set(a,s),s+=a.length}return n}class Hash{clone(){return this._cloneInto()}}function wrapConstructor(t){const e=r=>t().update(toBytes(r)).digest(),n=t();return e.outputLen=n.outputLen,e.blockLen=n.blockLen,e.create=()=>t(),e}function randomBytes(t=32){if(crypto$1&&typeof crypto$1.getRandomValues=="function")return crypto$1.getRandomValues(new Uint8Array(t));if(crypto$1&&typeof crypto$1.randomBytes=="function")return crypto$1.randomBytes(t);throw new Error("crypto.getRandomValues must be defined")}function setBigUint64(t,e,n,r){if(typeof t.setBigUint64=="function")return t.setBigUint64(e,n,r);const s=BigInt(32),a=BigInt(4294967295),u=Number(n>>s&a),l=Number(n&a),f=r?4:0,y=r?0:4;t.setUint32(e+f,u,r),t.setUint32(e+y,l,r)}const Chi=(t,e,n)=>t&e^~t&n,Maj=(t,e,n)=>t&e^t&n^e&n;class HashMD extends Hash{constructor(e,n,r,s){super(),this.blockLen=e,this.outputLen=n,this.padOffset=r,this.isLE=s,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=createView(this.buffer)}update(e){exists(this);const{view:n,buffer:r,blockLen:s}=this;e=toBytes(e);const a=e.length;for(let u=0;u<a;){const l=Math.min(s-this.pos,a-u);if(l===s){const f=createView(e);for(;s<=a-u;u+=s)this.process(f,u);continue}r.set(e.subarray(u,u+l),this.pos),this.pos+=l,u+=l,this.pos===s&&(this.process(n,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){exists(this),output(e,this),this.finished=!0;const{buffer:n,view:r,blockLen:s,isLE:a}=this;let{pos:u}=this;n[u++]=128,this.buffer.subarray(u).fill(0),this.padOffset>s-u&&(this.process(r,0),u=0);for(let m=u;m<s;m++)n[m]=0;setBigUint64(r,s-8,BigInt(this.length*8),a),this.process(r,0);const l=createView(e),f=this.outputLen;if(f%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const y=f/4,b=this.get();if(y>b.length)throw new Error("_sha2: outputLen bigger than state");for(let m=0;m<y;m++)l.setUint32(4*m,b[m],a)}digest(){const{buffer:e,outputLen:n}=this;this.digestInto(e);const r=e.slice(0,n);return this.destroy(),r}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:n,buffer:r,length:s,finished:a,destroyed:u,pos:l}=this;return e.length=s,e.pos=l,e.finished=a,e.destroyed=u,s%n&&e.buffer.set(r),e}}const SHA256_K=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),SHA256_IV=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),SHA256_W=new Uint32Array(64);class SHA256 extends HashMD{constructor(){super(64,32,8,!1),this.A=SHA256_IV[0]|0,this.B=SHA256_IV[1]|0,this.C=SHA256_IV[2]|0,this.D=SHA256_IV[3]|0,this.E=SHA256_IV[4]|0,this.F=SHA256_IV[5]|0,this.G=SHA256_IV[6]|0,this.H=SHA256_IV[7]|0}get(){const{A:e,B:n,C:r,D:s,E:a,F:u,G:l,H:f}=this;return[e,n,r,s,a,u,l,f]}set(e,n,r,s,a,u,l,f){this.A=e|0,this.B=n|0,this.C=r|0,this.D=s|0,this.E=a|0,this.F=u|0,this.G=l|0,this.H=f|0}process(e,n){for(let m=0;m<16;m++,n+=4)SHA256_W[m]=e.getUint32(n,!1);for(let m=16;m<64;m++){const E=SHA256_W[m-15],C=SHA256_W[m-2],O=rotr(E,7)^rotr(E,18)^E>>>3,$=rotr(C,17)^rotr(C,19)^C>>>10;SHA256_W[m]=$+SHA256_W[m-7]+O+SHA256_W[m-16]|0}let{A:r,B:s,C:a,D:u,E:l,F:f,G:y,H:b}=this;for(let m=0;m<64;m++){const E=rotr(l,6)^rotr(l,11)^rotr(l,25),C=b+E+Chi(l,f,y)+SHA256_K[m]+SHA256_W[m]|0,$=(rotr(r,2)^rotr(r,13)^rotr(r,22))+Maj(r,s,a)|0;b=y,y=f,f=l,l=u+C|0,u=a,a=s,s=r,r=C+$|0}r=r+this.A|0,s=s+this.B|0,a=a+this.C|0,u=u+this.D|0,l=l+this.E|0,f=f+this.F|0,y=y+this.G|0,b=b+this.H|0,this.set(r,s,a,u,l,f,y,b)}roundClean(){SHA256_W.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}}const sha256=wrapConstructor(()=>new SHA256);class HMAC extends Hash{constructor(e,n){super(),this.finished=!1,this.destroyed=!1,hash(e);const r=toBytes(n);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const s=this.blockLen,a=new Uint8Array(s);a.set(r.length>s?e.create().update(r).digest():r);for(let u=0;u<a.length;u++)a[u]^=54;this.iHash.update(a),this.oHash=e.create();for(let u=0;u<a.length;u++)a[u]^=106;this.oHash.update(a),a.fill(0)}update(e){return exists(this),this.iHash.update(e),this}digestInto(e){exists(this),bytes(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:n,iHash:r,finished:s,destroyed:a,blockLen:u,outputLen:l}=this;return e=e,e.finished=s,e.destroyed=a,e.blockLen=u,e.outputLen=l,e.oHash=n._cloneInto(e.oHash),e.iHash=r._cloneInto(e.iHash),e}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const hmac=(t,e,n)=>new HMAC(t,e).update(n).digest();hmac.create=(t,e)=>new HMAC(t,e);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const _0n$4=BigInt(0),_1n$4=BigInt(1),_2n$2=BigInt(2);function isBytes(t){return t instanceof Uint8Array||t!=null&&typeof t=="object"&&t.constructor.name==="Uint8Array"}function abytes(t){if(!isBytes(t))throw new Error("Uint8Array expected")}function abool(t,e){if(typeof e!="boolean")throw new Error(`${t} must be valid boolean, got "${e}".`)}const hexes=Array.from({length:256},(t,e)=>e.toString(16).padStart(2,"0"));function bytesToHex(t){abytes(t);let e="";for(let n=0;n<t.length;n++)e+=hexes[t[n]];return e}function numberToHexUnpadded(t){const e=t.toString(16);return e.length&1?`0${e}`:e}function hexToNumber(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);return BigInt(t===""?"0":`0x${t}`)}const asciis={_0:48,_9:57,_A:65,_F:70,_a:97,_f:102};function asciiToBase16(t){if(t>=asciis._0&&t<=asciis._9)return t-asciis._0;if(t>=asciis._A&&t<=asciis._F)return t-(asciis._A-10);if(t>=asciis._a&&t<=asciis._f)return t-(asciis._a-10)}function hexToBytes(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);const e=t.length,n=e/2;if(e%2)throw new Error("padded hex string expected, got unpadded hex of length "+e);const r=new Uint8Array(n);for(let s=0,a=0;s<n;s++,a+=2){const u=asciiToBase16(t.charCodeAt(a)),l=asciiToBase16(t.charCodeAt(a+1));if(u===void 0||l===void 0){const f=t[a]+t[a+1];throw new Error('hex string expected, got non-hex character "'+f+'" at index '+a)}r[s]=u*16+l}return r}function bytesToNumberBE(t){return hexToNumber(bytesToHex(t))}function bytesToNumberLE(t){return abytes(t),hexToNumber(bytesToHex(Uint8Array.from(t).reverse()))}function numberToBytesBE(t,e){return hexToBytes(t.toString(16).padStart(e*2,"0"))}function numberToBytesLE(t,e){return numberToBytesBE(t,e).reverse()}function numberToVarBytesBE(t){return hexToBytes(numberToHexUnpadded(t))}function ensureBytes(t,e,n){let r;if(typeof e=="string")try{r=hexToBytes(e)}catch(a){throw new Error(`${t} must be valid hex string, got "${e}". Cause: ${a}`)}else if(isBytes(e))r=Uint8Array.from(e);else throw new Error(`${t} must be hex string or Uint8Array`);const s=r.length;if(typeof n=="number"&&s!==n)throw new Error(`${t} expected ${n} bytes, got ${s}`);return r}function concatBytes(...t){let e=0;for(let r=0;r<t.length;r++){const s=t[r];abytes(s),e+=s.length}const n=new Uint8Array(e);for(let r=0,s=0;r<t.length;r++){const a=t[r];n.set(a,s),s+=a.length}return n}function equalBytes(t,e){if(t.length!==e.length)return!1;let n=0;for(let r=0;r<t.length;r++)n|=t[r]^e[r];return n===0}function utf8ToBytes(t){if(typeof t!="string")throw new Error(`utf8ToBytes expected string, got ${typeof t}`);return new Uint8Array(new TextEncoder().encode(t))}const isPosBig=t=>typeof t=="bigint"&&_0n$4<=t;function inRange(t,e,n){return isPosBig(t)&&isPosBig(e)&&isPosBig(n)&&e<=t&&t<n}function aInRange(t,e,n,r){if(!inRange(e,n,r))throw new Error(`expected valid ${t}: ${n} <= n < ${r}, got ${typeof e} ${e}`)}function bitLen(t){let e;for(e=0;t>_0n$4;t>>=_1n$4,e+=1);return e}function bitGet(t,e){return t>>BigInt(e)&_1n$4}function bitSet(t,e,n){return t|(n?_1n$4:_0n$4)<<BigInt(e)}const bitMask=t=>(_2n$2<<BigInt(t-1))-_1n$4,u8n=t=>new Uint8Array(t),u8fr=t=>Uint8Array.from(t);function createHmacDrbg(t,e,n){if(typeof t!="number"||t<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof n!="function")throw new Error("hmacFn must be a function");let r=u8n(t),s=u8n(t),a=0;const u=()=>{r.fill(1),s.fill(0),a=0},l=(...m)=>n(s,r,...m),f=(m=u8n())=>{s=l(u8fr([0]),m),r=l(),m.length!==0&&(s=l(u8fr([1]),m),r=l())},y=()=>{if(a++>=1e3)throw new Error("drbg: tried 1000 values");let m=0;const E=[];for(;m<e;){r=l();const C=r.slice();E.push(C),m+=r.length}return concatBytes(...E)};return(m,E)=>{u(),f(m);let C;for(;!(C=E(y()));)f();return u(),C}}const validatorFns={bigint:t=>typeof t=="bigint",function:t=>typeof t=="function",boolean:t=>typeof t=="boolean",string:t=>typeof t=="string",stringOrUint8Array:t=>typeof t=="string"||isBytes(t),isSafeInteger:t=>Number.isSafeInteger(t),array:t=>Array.isArray(t),field:(t,e)=>e.Fp.isValid(t),hash:t=>typeof t=="function"&&Number.isSafeInteger(t.outputLen)};function validateObject(t,e,n={}){const r=(s,a,u)=>{const l=validatorFns[a];if(typeof l!="function")throw new Error(`Invalid validator "${a}", expected function`);const f=t[s];if(!(u&&f===void 0)&&!l(f,t))throw new Error(`Invalid param ${String(s)}=${f} (${typeof f}), expected ${a}`)};for(const[s,a]of Object.entries(e))r(s,a,!1);for(const[s,a]of Object.entries(n))r(s,a,!0);return t}const notImplemented=()=>{throw new Error("not implemented")};function memoized(t){const e=new WeakMap;return(n,...r)=>{const s=e.get(n);if(s!==void 0)return s;const a=t(n,...r);return e.set(n,a),a}}const ut=Object.freeze(Object.defineProperty({__proto__:null,aInRange,abool,abytes,bitGet,bitLen,bitMask,bitSet,bytesToHex,bytesToNumberBE,bytesToNumberLE,concatBytes,createHmacDrbg,ensureBytes,equalBytes,hexToBytes,hexToNumber,inRange,isBytes,memoized,notImplemented,numberToBytesBE,numberToBytesLE,numberToHexUnpadded,numberToVarBytesBE,utf8ToBytes,validateObject},Symbol.toStringTag,{value:"Module"}));/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const _0n$3=BigInt(0),_1n$3=BigInt(1),_2n$1=BigInt(2),_3n$1=BigInt(3),_4n=BigInt(4),_5n=BigInt(5),_8n=BigInt(8);BigInt(9);BigInt(16);function mod(t,e){const n=t%e;return n>=_0n$3?n:e+n}function pow(t,e,n){if(n<=_0n$3||e<_0n$3)throw new Error("Expected power/modulo > 0");if(n===_1n$3)return _0n$3;let r=_1n$3;for(;e>_0n$3;)e&_1n$3&&(r=r*t%n),t=t*t%n,e>>=_1n$3;return r}function pow2(t,e,n){let r=t;for(;e-- >_0n$3;)r*=r,r%=n;return r}function invert(t,e){if(t===_0n$3||e<=_0n$3)throw new Error(`invert: expected positive integers, got n=${t} mod=${e}`);let n=mod(t,e),r=e,s=_0n$3,a=_1n$3;for(;n!==_0n$3;){const l=r/n,f=r%n,y=s-a*l;r=n,n=f,s=a,a=y}if(r!==_1n$3)throw new Error("invert: does not exist");return mod(s,e)}function tonelliShanks(t){const e=(t-_1n$3)/_2n$1;let n,r,s;for(n=t-_1n$3,r=0;n%_2n$1===_0n$3;n/=_2n$1,r++);for(s=_2n$1;s<t&&pow(s,e,t)!==t-_1n$3;s++);if(r===1){const u=(t+_1n$3)/_4n;return function(f,y){const b=f.pow(y,u);if(!f.eql(f.sqr(b),y))throw new Error("Cannot find square root");return b}}const a=(n+_1n$3)/_2n$1;return function(l,f){if(l.pow(f,e)===l.neg(l.ONE))throw new Error("Cannot find square root");let y=r,b=l.pow(l.mul(l.ONE,s),n),m=l.pow(f,a),E=l.pow(f,n);for(;!l.eql(E,l.ONE);){if(l.eql(E,l.ZERO))return l.ZERO;let C=1;for(let $=l.sqr(E);C<y&&!l.eql($,l.ONE);C++)$=l.sqr($);const O=l.pow(b,_1n$3<<BigInt(y-C-1));b=l.sqr(O),m=l.mul(m,O),E=l.mul(E,b),y=C}return m}}function FpSqrt(t){if(t%_4n===_3n$1){const e=(t+_1n$3)/_4n;return function(r,s){const a=r.pow(s,e);if(!r.eql(r.sqr(a),s))throw new Error("Cannot find square root");return a}}if(t%_8n===_5n){const e=(t-_5n)/_8n;return function(r,s){const a=r.mul(s,_2n$1),u=r.pow(a,e),l=r.mul(s,u),f=r.mul(r.mul(l,_2n$1),u),y=r.mul(l,r.sub(f,r.ONE));if(!r.eql(r.sqr(y),s))throw new Error("Cannot find square root");return y}}return tonelliShanks(t)}const FIELD_FIELDS=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function validateField(t){const e={ORDER:"bigint",MASK:"bigint",BYTES:"isSafeInteger",BITS:"isSafeInteger"},n=FIELD_FIELDS.reduce((r,s)=>(r[s]="function",r),e);return validateObject(t,n)}function FpPow(t,e,n){if(n<_0n$3)throw new Error("Expected power > 0");if(n===_0n$3)return t.ONE;if(n===_1n$3)return e;let r=t.ONE,s=e;for(;n>_0n$3;)n&_1n$3&&(r=t.mul(r,s)),s=t.sqr(s),n>>=_1n$3;return r}function FpInvertBatch(t,e){const n=new Array(e.length),r=e.reduce((a,u,l)=>t.is0(u)?a:(n[l]=a,t.mul(a,u)),t.ONE),s=t.inv(r);return e.reduceRight((a,u,l)=>t.is0(u)?a:(n[l]=t.mul(a,n[l]),t.mul(a,u)),s),n}function nLength(t,e){const n=e!==void 0?e:t.toString(2).length,r=Math.ceil(n/8);return{nBitLength:n,nByteLength:r}}function Field(t,e,n=!1,r={}){if(t<=_0n$3)throw new Error(`Expected Field ORDER > 0, got ${t}`);const{nBitLength:s,nByteLength:a}=nLength(t,e);if(a>2048)throw new Error("Field lengths over 2048 bytes are not supported");const u=FpSqrt(t),l=Object.freeze({ORDER:t,BITS:s,BYTES:a,MASK:bitMask(s),ZERO:_0n$3,ONE:_1n$3,create:f=>mod(f,t),isValid:f=>{if(typeof f!="bigint")throw new Error(`Invalid field element: expected bigint, got ${typeof f}`);return _0n$3<=f&&f<t},is0:f=>f===_0n$3,isOdd:f=>(f&_1n$3)===_1n$3,neg:f=>mod(-f,t),eql:(f,y)=>f===y,sqr:f=>mod(f*f,t),add:(f,y)=>mod(f+y,t),sub:(f,y)=>mod(f-y,t),mul:(f,y)=>mod(f*y,t),pow:(f,y)=>FpPow(l,f,y),div:(f,y)=>mod(f*invert(y,t),t),sqrN:f=>f*f,addN:(f,y)=>f+y,subN:(f,y)=>f-y,mulN:(f,y)=>f*y,inv:f=>invert(f,t),sqrt:r.sqrt||(f=>u(l,f)),invertBatch:f=>FpInvertBatch(l,f),cmov:(f,y,b)=>b?y:f,toBytes:f=>n?numberToBytesLE(f,a):numberToBytesBE(f,a),fromBytes:f=>{if(f.length!==a)throw new Error(`Fp.fromBytes: expected ${a}, got ${f.length}`);return n?bytesToNumberLE(f):bytesToNumberBE(f)}});return Object.freeze(l)}function getFieldBytesLength(t){if(typeof t!="bigint")throw new Error("field order must be bigint");const e=t.toString(2).length;return Math.ceil(e/8)}function getMinHashLength(t){const e=getFieldBytesLength(t);return e+Math.ceil(e/2)}function mapHashToField(t,e,n=!1){const r=t.length,s=getFieldBytesLength(e),a=getMinHashLength(e);if(r<16||r<a||r>1024)throw new Error(`expected ${a}-1024 bytes of input, got ${r}`);const u=n?bytesToNumberBE(t):bytesToNumberLE(t),l=mod(u,e-_1n$3)+_1n$3;return n?numberToBytesLE(l,s):numberToBytesBE(l,s)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const _0n$2=BigInt(0),_1n$2=BigInt(1),pointPrecomputes=new WeakMap,pointWindowSizes=new WeakMap;function wNAF(t,e){const n=(a,u)=>{const l=u.negate();return a?l:u},r=a=>{if(!Number.isSafeInteger(a)||a<=0||a>e)throw new Error(`Wrong window size=${a}, should be [1..${e}]`)},s=a=>{r(a);const u=Math.ceil(e/a)+1,l=2**(a-1);return{windows:u,windowSize:l}};return{constTimeNegate:n,unsafeLadder(a,u){let l=t.ZERO,f=a;for(;u>_0n$2;)u&_1n$2&&(l=l.add(f)),f=f.double(),u>>=_1n$2;return l},precomputeWindow(a,u){const{windows:l,windowSize:f}=s(u),y=[];let b=a,m=b;for(let E=0;E<l;E++){m=b,y.push(m);for(let C=1;C<f;C++)m=m.add(b),y.push(m);b=m.double()}return y},wNAF(a,u,l){const{windows:f,windowSize:y}=s(a);let b=t.ZERO,m=t.BASE;const E=BigInt(2**a-1),C=2**a,O=BigInt(a);for(let $=0;$<f;$++){const k=$*y;let I=Number(l&E);l>>=O,I>y&&(I-=C,l+=_1n$2);const q=k,W=k+Math.abs(I)-1,te=$%2!==0,oe=I<0;I===0?m=m.add(n(te,u[q])):b=b.add(n(oe,u[W]))}return{p:b,f:m}},wNAFCached(a,u,l){const f=pointWindowSizes.get(a)||1;let y=pointPrecomputes.get(a);return y||(y=this.precomputeWindow(a,f),f!==1&&pointPrecomputes.set(a,l(y))),this.wNAF(f,y,u)},setWindowSize(a,u){r(u),pointWindowSizes.set(a,u),pointPrecomputes.delete(a)}}}function pippenger(t,e,n,r){if(!Array.isArray(n)||!Array.isArray(r)||r.length!==n.length)throw new Error("arrays of points and scalars must have equal length");r.forEach((b,m)=>{if(!e.isValid(b))throw new Error(`wrong scalar at index ${m}`)}),n.forEach((b,m)=>{if(!(b instanceof t))throw new Error(`wrong point at index ${m}`)});const s=bitLen(BigInt(n.length)),a=s>12?s-3:s>4?s-2:s?2:1,u=(1<<a)-1,l=new Array(u+1).fill(t.ZERO),f=Math.floor((e.BITS-1)/a)*a;let y=t.ZERO;for(let b=f;b>=0;b-=a){l.fill(t.ZERO);for(let E=0;E<r.length;E++){const C=r[E],O=Number(C>>BigInt(b)&BigInt(u));l[O]=l[O].add(n[E])}let m=t.ZERO;for(let E=l.length-1,C=t.ZERO;E>0;E--)C=C.add(l[E]),m=m.add(C);if(y=y.add(m),b!==0)for(let E=0;E<a;E++)y=y.double()}return y}function validateBasic(t){return validateField(t.Fp),validateObject(t,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...nLength(t.n,t.nBitLength),...t,p:t.Fp.ORDER})}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function validateSigVerOpts(t){t.lowS!==void 0&&abool("lowS",t.lowS),t.prehash!==void 0&&abool("prehash",t.prehash)}function validatePointOpts(t){const e=validateBasic(t);validateObject(e,{a:"field",b:"field"},{allowedPrivateKeyLengths:"array",wrapPrivateKey:"boolean",isTorsionFree:"function",clearCofactor:"function",allowInfinityPoint:"boolean",fromBytes:"function",toBytes:"function"});const{endo:n,Fp:r,a:s}=e;if(n){if(!r.eql(s,r.ZERO))throw new Error("Endomorphism can only be defined for Koblitz curves that have a=0");if(typeof n!="object"||typeof n.beta!="bigint"||typeof n.splitScalar!="function")throw new Error("Expected endomorphism with beta: bigint and splitScalar: function")}return Object.freeze({...e})}const{bytesToNumberBE:b2n,hexToBytes:h2b}=ut,DER={Err:class extends Error{constructor(e=""){super(e)}},_tlv:{encode:(t,e)=>{const{Err:n}=DER;if(t<0||t>256)throw new n("tlv.encode: wrong tag");if(e.length&1)throw new n("tlv.encode: unpadded data");const r=e.length/2,s=numberToHexUnpadded(r);if(s.length/2&128)throw new n("tlv.encode: long form length too big");const a=r>127?numberToHexUnpadded(s.length/2|128):"";return`${numberToHexUnpadded(t)}${a}${s}${e}`},decode(t,e){const{Err:n}=DER;let r=0;if(t<0||t>256)throw new n("tlv.encode: wrong tag");if(e.length<2||e[r++]!==t)throw new n("tlv.decode: wrong tlv");const s=e[r++],a=!!(s&128);let u=0;if(!a)u=s;else{const f=s&127;if(!f)throw new n("tlv.decode(long): indefinite length not supported");if(f>4)throw new n("tlv.decode(long): byte length is too big");const y=e.subarray(r,r+f);if(y.length!==f)throw new n("tlv.decode: length bytes not complete");if(y[0]===0)throw new n("tlv.decode(long): zero leftmost byte");for(const b of y)u=u<<8|b;if(r+=f,u<128)throw new n("tlv.decode(long): not minimal encoding")}const l=e.subarray(r,r+u);if(l.length!==u)throw new n("tlv.decode: wrong value length");return{v:l,l:e.subarray(r+u)}}},_int:{encode(t){const{Err:e}=DER;if(t<_0n$1)throw new e("integer: negative integers are not allowed");let n=numberToHexUnpadded(t);if(Number.parseInt(n[0],16)&8&&(n="00"+n),n.length&1)throw new e("unexpected assertion");return n},decode(t){const{Err:e}=DER;if(t[0]&128)throw new e("Invalid signature integer: negative");if(t[0]===0&&!(t[1]&128))throw new e("Invalid signature integer: unnecessary leading zero");return b2n(t)}},toSig(t){const{Err:e,_int:n,_tlv:r}=DER,s=typeof t=="string"?h2b(t):t;abytes(s);const{v:a,l:u}=r.decode(48,s);if(u.length)throw new e("Invalid signature: left bytes after parsing");const{v:l,l:f}=r.decode(2,a),{v:y,l:b}=r.decode(2,f);if(b.length)throw new e("Invalid signature: left bytes after parsing");return{r:n.decode(l),s:n.decode(y)}},hexFromSig(t){const{_tlv:e,_int:n}=DER,r=`${e.encode(2,n.encode(t.r))}${e.encode(2,n.encode(t.s))}`;return e.encode(48,r)}},_0n$1=BigInt(0),_1n$1=BigInt(1);BigInt(2);const _3n=BigInt(3);BigInt(4);function weierstrassPoints(t){const e=validatePointOpts(t),{Fp:n}=e,r=Field(e.n,e.nBitLength),s=e.toBytes||(($,k,I)=>{const q=k.toAffine();return concatBytes(Uint8Array.from([4]),n.toBytes(q.x),n.toBytes(q.y))}),a=e.fromBytes||($=>{const k=$.subarray(1),I=n.fromBytes(k.subarray(0,n.BYTES)),q=n.fromBytes(k.subarray(n.BYTES,2*n.BYTES));return{x:I,y:q}});function u($){const{a:k,b:I}=e,q=n.sqr($),W=n.mul(q,$);return n.add(n.add(W,n.mul($,k)),I)}if(!n.eql(n.sqr(e.Gy),u(e.Gx)))throw new Error("bad generator point: equation left != right");function l($){return inRange($,_1n$1,e.n)}function f($){const{allowedPrivateKeyLengths:k,nByteLength:I,wrapPrivateKey:q,n:W}=e;if(k&&typeof $!="bigint"){if(isBytes($)&&($=bytesToHex($)),typeof $!="string"||!k.includes($.length))throw new Error("Invalid key");$=$.padStart(I*2,"0")}let te;try{te=typeof $=="bigint"?$:bytesToNumberBE(ensureBytes("private key",$,I))}catch{throw new Error(`private key must be ${I} bytes, hex or bigint, not ${typeof $}`)}return q&&(te=mod(te,W)),aInRange("private key",te,_1n$1,W),te}function y($){if(!($ instanceof E))throw new Error("ProjectivePoint expected")}const b=memoized(($,k)=>{const{px:I,py:q,pz:W}=$;if(n.eql(W,n.ONE))return{x:I,y:q};const te=$.is0();k==null&&(k=te?n.ONE:n.inv(W));const oe=n.mul(I,k),V=n.mul(q,k),j=n.mul(W,k);if(te)return{x:n.ZERO,y:n.ZERO};if(!n.eql(j,n.ONE))throw new Error("invZ was invalid");return{x:oe,y:V}}),m=memoized($=>{if($.is0()){if(e.allowInfinityPoint&&!n.is0($.py))return;throw new Error("bad point: ZERO")}const{x:k,y:I}=$.toAffine();if(!n.isValid(k)||!n.isValid(I))throw new Error("bad point: x or y not FE");const q=n.sqr(I),W=u(k);if(!n.eql(q,W))throw new Error("bad point: equation left != right");if(!$.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});class E{constructor(k,I,q){if(this.px=k,this.py=I,this.pz=q,k==null||!n.isValid(k))throw new Error("x required");if(I==null||!n.isValid(I))throw new Error("y required");if(q==null||!n.isValid(q))throw new Error("z required");Object.freeze(this)}static fromAffine(k){const{x:I,y:q}=k||{};if(!k||!n.isValid(I)||!n.isValid(q))throw new Error("invalid affine point");if(k instanceof E)throw new Error("projective point not allowed");const W=te=>n.eql(te,n.ZERO);return W(I)&&W(q)?E.ZERO:new E(I,q,n.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(k){const I=n.invertBatch(k.map(q=>q.pz));return k.map((q,W)=>q.toAffine(I[W])).map(E.fromAffine)}static fromHex(k){const I=E.fromAffine(a(ensureBytes("pointHex",k)));return I.assertValidity(),I}static fromPrivateKey(k){return E.BASE.multiply(f(k))}static msm(k,I){return pippenger(E,r,k,I)}_setWindowSize(k){O.setWindowSize(this,k)}assertValidity(){m(this)}hasEvenY(){const{y:k}=this.toAffine();if(n.isOdd)return!n.isOdd(k);throw new Error("Field doesn't support isOdd")}equals(k){y(k);const{px:I,py:q,pz:W}=this,{px:te,py:oe,pz:V}=k,j=n.eql(n.mul(I,V),n.mul(te,W)),G=n.eql(n.mul(q,V),n.mul(oe,W));return j&&G}negate(){return new E(this.px,n.neg(this.py),this.pz)}double(){const{a:k,b:I}=e,q=n.mul(I,_3n),{px:W,py:te,pz:oe}=this;let V=n.ZERO,j=n.ZERO,G=n.ZERO,le=n.mul(W,W),me=n.mul(te,te),ce=n.mul(oe,oe),de=n.mul(W,te);return de=n.add(de,de),G=n.mul(W,oe),G=n.add(G,G),V=n.mul(k,G),j=n.mul(q,ce),j=n.add(V,j),V=n.sub(me,j),j=n.add(me,j),j=n.mul(V,j),V=n.mul(de,V),G=n.mul(q,G),ce=n.mul(k,ce),de=n.sub(le,ce),de=n.mul(k,de),de=n.add(de,G),G=n.add(le,le),le=n.add(G,le),le=n.add(le,ce),le=n.mul(le,de),j=n.add(j,le),ce=n.mul(te,oe),ce=n.add(ce,ce),le=n.mul(ce,de),V=n.sub(V,le),G=n.mul(ce,me),G=n.add(G,G),G=n.add(G,G),new E(V,j,G)}add(k){y(k);const{px:I,py:q,pz:W}=this,{px:te,py:oe,pz:V}=k;let j=n.ZERO,G=n.ZERO,le=n.ZERO;const me=e.a,ce=n.mul(e.b,_3n);let de=n.mul(I,te),be=n.mul(q,oe),Q=n.mul(W,V),F=n.add(I,q),H=n.add(te,oe);F=n.mul(F,H),H=n.add(de,be),F=n.sub(F,H),H=n.add(I,W);let Y=n.add(te,V);return H=n.mul(H,Y),Y=n.add(de,Q),H=n.sub(H,Y),Y=n.add(q,W),j=n.add(oe,V),Y=n.mul(Y,j),j=n.add(be,Q),Y=n.sub(Y,j),le=n.mul(me,H),j=n.mul(ce,Q),le=n.add(j,le),j=n.sub(be,le),le=n.add(be,le),G=n.mul(j,le),be=n.add(de,de),be=n.add(be,de),Q=n.mul(me,Q),H=n.mul(ce,H),be=n.add(be,Q),Q=n.sub(de,Q),Q=n.mul(me,Q),H=n.add(H,Q),de=n.mul(be,H),G=n.add(G,de),de=n.mul(Y,H),j=n.mul(F,j),j=n.sub(j,de),de=n.mul(F,be),le=n.mul(Y,le),le=n.add(le,de),new E(j,G,le)}subtract(k){return this.add(k.negate())}is0(){return this.equals(E.ZERO)}wNAF(k){return O.wNAFCached(this,k,E.normalizeZ)}multiplyUnsafe(k){aInRange("scalar",k,_0n$1,e.n);const I=E.ZERO;if(k===_0n$1)return I;if(k===_1n$1)return this;const{endo:q}=e;if(!q)return O.unsafeLadder(this,k);let{k1neg:W,k1:te,k2neg:oe,k2:V}=q.splitScalar(k),j=I,G=I,le=this;for(;te>_0n$1||V>_0n$1;)te&_1n$1&&(j=j.add(le)),V&_1n$1&&(G=G.add(le)),le=le.double(),te>>=_1n$1,V>>=_1n$1;return W&&(j=j.negate()),oe&&(G=G.negate()),G=new E(n.mul(G.px,q.beta),G.py,G.pz),j.add(G)}multiply(k){const{endo:I,n:q}=e;aInRange("scalar",k,_1n$1,q);let W,te;if(I){const{k1neg:oe,k1:V,k2neg:j,k2:G}=I.splitScalar(k);let{p:le,f:me}=this.wNAF(V),{p:ce,f:de}=this.wNAF(G);le=O.constTimeNegate(oe,le),ce=O.constTimeNegate(j,ce),ce=new E(n.mul(ce.px,I.beta),ce.py,ce.pz),W=le.add(ce),te=me.add(de)}else{const{p:oe,f:V}=this.wNAF(k);W=oe,te=V}return E.normalizeZ([W,te])[0]}multiplyAndAddUnsafe(k,I,q){const W=E.BASE,te=(V,j)=>j===_0n$1||j===_1n$1||!V.equals(W)?V.multiplyUnsafe(j):V.multiply(j),oe=te(this,I).add(te(k,q));return oe.is0()?void 0:oe}toAffine(k){return b(this,k)}isTorsionFree(){const{h:k,isTorsionFree:I}=e;if(k===_1n$1)return!0;if(I)return I(E,this);throw new Error("isTorsionFree() has not been declared for the elliptic curve")}clearCofactor(){const{h:k,clearCofactor:I}=e;return k===_1n$1?this:I?I(E,this):this.multiplyUnsafe(e.h)}toRawBytes(k=!0){return abool("isCompressed",k),this.assertValidity(),s(E,this,k)}toHex(k=!0){return abool("isCompressed",k),bytesToHex(this.toRawBytes(k))}}E.BASE=new E(e.Gx,e.Gy,n.ONE),E.ZERO=new E(n.ZERO,n.ONE,n.ZERO);const C=e.nBitLength,O=wNAF(E,e.endo?Math.ceil(C/2):C);return{CURVE:e,ProjectivePoint:E,normPrivateKeyToScalar:f,weierstrassEquation:u,isWithinCurveOrder:l}}function validateOpts(t){const e=validateBasic(t);return validateObject(e,{hash:"hash",hmac:"function",randomBytes:"function"},{bits2int:"function",bits2int_modN:"function",lowS:"boolean"}),Object.freeze({lowS:!0,...e})}function weierstrass(t){const e=validateOpts(t),{Fp:n,n:r}=e,s=n.BYTES+1,a=2*n.BYTES+1;function u(Q){return mod(Q,r)}function l(Q){return invert(Q,r)}const{ProjectivePoint:f,normPrivateKeyToScalar:y,weierstrassEquation:b,isWithinCurveOrder:m}=weierstrassPoints({...e,toBytes(Q,F,H){const Y=F.toAffine(),se=n.toBytes(Y.x),he=concatBytes;return abool("isCompressed",H),H?he(Uint8Array.from([F.hasEvenY()?2:3]),se):he(Uint8Array.from([4]),se,n.toBytes(Y.y))},fromBytes(Q){const F=Q.length,H=Q[0],Y=Q.subarray(1);if(F===s&&(H===2||H===3)){const se=bytesToNumberBE(Y);if(!inRange(se,_1n$1,n.ORDER))throw new Error("Point is not on curve");const he=b(se);let ye;try{ye=n.sqrt(he)}catch(Te){const Ue=Te instanceof Error?": "+Te.message:"";throw new Error("Point is not on curve"+Ue)}const we=(ye&_1n$1)===_1n$1;return(H&1)===1!==we&&(ye=n.neg(ye)),{x:se,y:ye}}else if(F===a&&H===4){const se=n.fromBytes(Y.subarray(0,n.BYTES)),he=n.fromBytes(Y.subarray(n.BYTES,2*n.BYTES));return{x:se,y:he}}else throw new Error(`Point of length ${F} was invalid. Expected ${s} compressed bytes or ${a} uncompressed bytes`)}}),E=Q=>bytesToHex(numberToBytesBE(Q,e.nByteLength));function C(Q){const F=r>>_1n$1;return Q>F}function O(Q){return C(Q)?u(-Q):Q}const $=(Q,F,H)=>bytesToNumberBE(Q.slice(F,H));class k{constructor(F,H,Y){this.r=F,this.s=H,this.recovery=Y,this.assertValidity()}static fromCompact(F){const H=e.nByteLength;return F=ensureBytes("compactSignature",F,H*2),new k($(F,0,H),$(F,H,2*H))}static fromDER(F){const{r:H,s:Y}=DER.toSig(ensureBytes("DER",F));return new k(H,Y)}assertValidity(){aInRange("r",this.r,_1n$1,r),aInRange("s",this.s,_1n$1,r)}addRecoveryBit(F){return new k(this.r,this.s,F)}recoverPublicKey(F){const{r:H,s:Y,recovery:se}=this,he=V(ensureBytes("msgHash",F));if(se==null||![0,1,2,3].includes(se))throw new Error("recovery id invalid");const ye=se===2||se===3?H+e.n:H;if(ye>=n.ORDER)throw new Error("recovery id 2 or 3 invalid");const we=se&1?"03":"02",xe=f.fromHex(we+E(ye)),Te=l(ye),Ue=u(-he*Te),Fe=u(Y*Te),Ie=f.BASE.multiplyAndAddUnsafe(xe,Ue,Fe);if(!Ie)throw new Error("point at infinify");return Ie.assertValidity(),Ie}hasHighS(){return C(this.s)}normalizeS(){return this.hasHighS()?new k(this.r,u(-this.s),this.recovery):this}toDERRawBytes(){return hexToBytes(this.toDERHex())}toDERHex(){return DER.hexFromSig({r:this.r,s:this.s})}toCompactRawBytes(){return hexToBytes(this.toCompactHex())}toCompactHex(){return E(this.r)+E(this.s)}}const I={isValidPrivateKey(Q){try{return y(Q),!0}catch{return!1}},normPrivateKeyToScalar:y,randomPrivateKey:()=>{const Q=getMinHashLength(e.n);return mapHashToField(e.randomBytes(Q),e.n)},precompute(Q=8,F=f.BASE){return F._setWindowSize(Q),F.multiply(BigInt(3)),F}};function q(Q,F=!0){return f.fromPrivateKey(Q).toRawBytes(F)}function W(Q){const F=isBytes(Q),H=typeof Q=="string",Y=(F||H)&&Q.length;return F?Y===s||Y===a:H?Y===2*s||Y===2*a:Q instanceof f}function te(Q,F,H=!0){if(W(Q))throw new Error("first arg must be private key");if(!W(F))throw new Error("second arg must be public key");return f.fromHex(F).multiply(y(Q)).toRawBytes(H)}const oe=e.bits2int||function(Q){const F=bytesToNumberBE(Q),H=Q.length*8-e.nBitLength;return H>0?F>>BigInt(H):F},V=e.bits2int_modN||function(Q){return u(oe(Q))},j=bitMask(e.nBitLength);function G(Q){return aInRange(`num < 2^${e.nBitLength}`,Q,_0n$1,j),numberToBytesBE(Q,e.nByteLength)}function le(Q,F,H=me){if(["recovered","canonical"].some(Ve=>Ve in H))throw new Error("sign() legacy options not supported");const{hash:Y,randomBytes:se}=e;let{lowS:he,prehash:ye,extraEntropy:we}=H;he==null&&(he=!0),Q=ensureBytes("msgHash",Q),validateSigVerOpts(H),ye&&(Q=ensureBytes("prehashed msgHash",Y(Q)));const xe=V(Q),Te=y(F),Ue=[G(Te),G(xe)];if(we!=null&&we!==!1){const Ve=we===!0?se(n.BYTES):we;Ue.push(ensureBytes("extraEntropy",Ve))}const Fe=concatBytes(...Ue),Ie=xe;function Ke(Ve){const ue=oe(Ve);if(!m(ue))return;const Ze=l(ue),je=f.BASE.multiply(ue).toAffine(),ve=u(je.x);if(ve===_0n$1)return;const Be=u(Ze*u(Ie+ve*Te));if(Be===_0n$1)return;let Je=(je.x===ve?0:2)|Number(je.y&_1n$1),We=Be;return he&&C(Be)&&(We=O(Be),Je^=1),new k(ve,We,Je)}return{seed:Fe,k2sig:Ke}}const me={lowS:e.lowS,prehash:!1},ce={lowS:e.lowS,prehash:!1};function de(Q,F,H=me){const{seed:Y,k2sig:se}=le(Q,F,H),he=e;return createHmacDrbg(he.hash.outputLen,he.nByteLength,he.hmac)(Y,se)}f.BASE._setWindowSize(8);function be(Q,F,H,Y=ce){var je;const se=Q;if(F=ensureBytes("msgHash",F),H=ensureBytes("publicKey",H),"strict"in Y)throw new Error("options.strict was renamed to lowS");validateSigVerOpts(Y);const{lowS:he,prehash:ye}=Y;let we,xe;try{if(typeof se=="string"||isBytes(se))try{we=k.fromDER(se)}catch(ve){if(!(ve instanceof DER.Err))throw ve;we=k.fromCompact(se)}else if(typeof se=="object"&&typeof se.r=="bigint"&&typeof se.s=="bigint"){const{r:ve,s:Be}=se;we=new k(ve,Be)}else throw new Error("PARSE");xe=f.fromHex(H)}catch(ve){if(ve.message==="PARSE")throw new Error("signature must be Signature instance, Uint8Array or hex string");return!1}if(he&&we.hasHighS())return!1;ye&&(F=e.hash(F));const{r:Te,s:Ue}=we,Fe=V(F),Ie=l(Ue),Ke=u(Fe*Ie),Ve=u(Te*Ie),ue=(je=f.BASE.multiplyAndAddUnsafe(xe,Ke,Ve))==null?void 0:je.toAffine();return ue?u(ue.x)===Te:!1}return{CURVE:e,getPublicKey:q,getSharedSecret:te,sign:de,verify:be,ProjectivePoint:f,Signature:k,utils:I}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function getHash(t){return{hash:t,hmac:(e,...n)=>hmac(t,e,concatBytes$1(...n)),randomBytes}}function createCurve(t,e){const n=r=>weierstrass({...t,...getHash(r)});return Object.freeze({...n(e),create:n})}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const secp256k1P=BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),secp256k1N=BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),_1n=BigInt(1),_2n=BigInt(2),divNearest=(t,e)=>(t+e/_2n)/e;function sqrtMod(t){const e=secp256k1P,n=BigInt(3),r=BigInt(6),s=BigInt(11),a=BigInt(22),u=BigInt(23),l=BigInt(44),f=BigInt(88),y=t*t*t%e,b=y*y*t%e,m=pow2(b,n,e)*b%e,E=pow2(m,n,e)*b%e,C=pow2(E,_2n,e)*y%e,O=pow2(C,s,e)*C%e,$=pow2(O,a,e)*O%e,k=pow2($,l,e)*$%e,I=pow2(k,f,e)*k%e,q=pow2(I,l,e)*$%e,W=pow2(q,n,e)*b%e,te=pow2(W,u,e)*O%e,oe=pow2(te,r,e)*y%e,V=pow2(oe,_2n,e);if(!Fp.eql(Fp.sqr(V),t))throw new Error("Cannot find square root");return V}const Fp=Field(secp256k1P,void 0,void 0,{sqrt:sqrtMod}),secp256k1=createCurve({a:BigInt(0),b:BigInt(7),Fp,n:secp256k1N,Gx:BigInt("55066263022277343669578718895168534326250603453777594175500187360389116729240"),Gy:BigInt("32670510020758816978083085130507043184471273380659243275938904335757337482424"),h:BigInt(1),lowS:!0,endo:{beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar:t=>{const e=secp256k1N,n=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),r=-_1n*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),s=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),a=n,u=BigInt("0x100000000000000000000000000000000"),l=divNearest(a*t,e),f=divNearest(-r*t,e);let y=mod(t-l*n-f*s,e),b=mod(-l*r-f*a,e);const m=y>u,E=b>u;if(m&&(y=e-y),E&&(b=e-b),y>u||b>u)throw new Error("splitScalar: Endomorphism failed, k="+t);return{k1neg:m,k1:y,k2neg:E,k2:b}}}},sha256),_0n=BigInt(0),TAGGED_HASH_PREFIXES={};function taggedHash(t,...e){let n=TAGGED_HASH_PREFIXES[t];if(n===void 0){const r=sha256(Uint8Array.from(t,s=>s.charCodeAt(0)));n=concatBytes(r,r),TAGGED_HASH_PREFIXES[t]=n}return sha256(concatBytes(n,...e))}const pointToBytes=t=>t.toRawBytes(!0).slice(1),numTo32b=t=>numberToBytesBE(t,32),modP=t=>mod(t,secp256k1P),modN=t=>mod(t,secp256k1N),Point=secp256k1.ProjectivePoint,GmulAdd=(t,e,n)=>Point.BASE.multiplyAndAddUnsafe(t,e,n);function schnorrGetExtPubKey(t){let e=secp256k1.utils.normPrivateKeyToScalar(t),n=Point.fromPrivateKey(e);return{scalar:n.hasEvenY()?e:modN(-e),bytes:pointToBytes(n)}}function lift_x(t){aInRange("x",t,_1n,secp256k1P);const e=modP(t*t),n=modP(e*t+BigInt(7));let r=sqrtMod(n);r%_2n!==_0n&&(r=modP(-r));const s=new Point(t,r,_1n);return s.assertValidity(),s}const num=bytesToNumberBE;function challenge(...t){return modN(num(taggedHash("BIP0340/challenge",...t)))}function schnorrGetPublicKey(t){return schnorrGetExtPubKey(t).bytes}function schnorrSign(t,e,n=randomBytes(32)){const r=ensureBytes("message",t),{bytes:s,scalar:a}=schnorrGetExtPubKey(e),u=ensureBytes("auxRand",n,32),l=numTo32b(a^num(taggedHash("BIP0340/aux",u))),f=taggedHash("BIP0340/nonce",l,s,r),y=modN(num(f));if(y===_0n)throw new Error("sign failed: k is zero");const{bytes:b,scalar:m}=schnorrGetExtPubKey(y),E=challenge(b,s,r),C=new Uint8Array(64);if(C.set(b,0),C.set(numTo32b(modN(m+E*a)),32),!schnorrVerify(C,r,s))throw new Error("sign: Invalid signature produced");return C}function schnorrVerify(t,e,n){const r=ensureBytes("signature",t,64),s=ensureBytes("message",e),a=ensureBytes("publicKey",n,32);try{const u=lift_x(num(a)),l=num(r.subarray(0,32));if(!inRange(l,_1n,secp256k1P))return!1;const f=num(r.subarray(32,64));if(!inRange(f,_1n,secp256k1N))return!1;const y=challenge(numTo32b(l),pointToBytes(u),s),b=GmulAdd(u,f,modN(-y));return!(!b||!b.hasEvenY()||b.toAffine().x!==l)}catch{return!1}}const schnorr={getPublicKey:schnorrGetPublicKey,sign:schnorrSign,verify:schnorrVerify,utils:{randomPrivateKey:secp256k1.utils.randomPrivateKey,lift_x,pointToBytes,numberToBytesBE,bytesToNumberBE,taggedHash,mod}};var dist={},LRUCache$1={},LRUCacheNode$1={};Object.defineProperty(LRUCacheNode$1,"__esModule",{value:!0});LRUCacheNode$1.LRUCacheNode=void 0;class LRUCacheNode{constructor(e,n,r){const{entryExpirationTimeInMS:s=null,next:a=null,prev:u=null,onEntryEvicted:l,onEntryMarkedAsMostRecentlyUsed:f,clone:y,cloneFn:b}=r??{};if(typeof s=="number"&&(s<=0||Number.isNaN(s)))throw new Error("entryExpirationTimeInMS must either be null (no expiry) or greater than 0");this.clone=y??!1,this.cloneFn=b??this.defaultClone,this.key=e,this.internalValue=this.clone?this.cloneFn(n):n,this.created=Date.now(),this.entryExpirationTimeInMS=s,this.next=a,this.prev=u,this.onEntryEvicted=l,this.onEntryMarkedAsMostRecentlyUsed=f}get value(){return this.clone?this.cloneFn(this.internalValue):this.internalValue}get isExpired(){return typeof this.entryExpirationTimeInMS=="number"&&Date.now()-this.created>this.entryExpirationTimeInMS}invokeOnEvicted(){if(this.onEntryEvicted){const{key:e,value:n,isExpired:r}=this;this.onEntryEvicted({key:e,value:n,isExpired:r})}}invokeOnEntryMarkedAsMostRecentlyUsed(){if(this.onEntryMarkedAsMostRecentlyUsed){const{key:e,value:n}=this;this.onEntryMarkedAsMostRecentlyUsed({key:e,value:n})}}defaultClone(e){return typeof e=="boolean"||typeof e=="string"||typeof e=="number"?e:JSON.parse(JSON.stringify(e))}}LRUCacheNode$1.LRUCacheNode=LRUCacheNode;Object.defineProperty(LRUCache$1,"__esModule",{value:!0});LRUCache$1.LRUCache=void 0;const LRUCacheNode_1=LRUCacheNode$1;class LRUCache{constructor(e){this.lookupTable=new Map,this.head=null,this.tail=null;const{maxSize:n=25,entryExpirationTimeInMS:r=null,onEntryEvicted:s,onEntryMarkedAsMostRecentlyUsed:a,cloneFn:u,clone:l}=e??{};if(Number.isNaN(n)||n<=0)throw new Error("maxSize must be greater than 0.");if(typeof r=="number"&&(r<=0||Number.isNaN(r)))throw new Error("entryExpirationTimeInMS must either be null (no expiry) or greater than 0");this.maxSizeInternal=n,this.entryExpirationTimeInMS=r,this.onEntryEvicted=s,this.onEntryMarkedAsMostRecentlyUsed=a,this.clone=l,this.cloneFn=u}get size(){return this.cleanCache(),this.lookupTable.size}get remainingSize(){return this.maxSizeInternal-this.size}get newest(){return this.head?this.head.isExpired?(this.removeNodeFromListAndLookupTable(this.head),this.newest):this.mapNodeToEntry(this.head):null}get oldest(){return this.tail?this.tail.isExpired?(this.removeNodeFromListAndLookupTable(this.tail),this.oldest):this.mapNodeToEntry(this.tail):null}get maxSize(){return this.maxSizeInternal}set maxSize(e){if(Number.isNaN(e)||e<=0)throw new Error("maxSize must be greater than 0.");this.maxSizeInternal=e,this.enforceSizeLimit()}set(e,n,r){const s=this.lookupTable.get(e);s&&this.removeNodeFromListAndLookupTable(s);const a=new LRUCacheNode_1.LRUCacheNode(e,n,{entryExpirationTimeInMS:this.entryExpirationTimeInMS,onEntryEvicted:this.onEntryEvicted,onEntryMarkedAsMostRecentlyUsed:this.onEntryMarkedAsMostRecentlyUsed,clone:this.clone,cloneFn:this.cloneFn,...r});return this.setNodeAsHead(a),this.lookupTable.set(e,a),this.enforceSizeLimit(),this}get(e){const n=this.lookupTable.get(e);return n?n.isExpired?(this.removeNodeFromListAndLookupTable(n),null):(this.setNodeAsHead(n),n.value):null}peek(e){const n=this.lookupTable.get(e);return n?n.isExpired?(this.removeNodeFromListAndLookupTable(n),null):n.value:null}delete(e){const n=this.lookupTable.get(e);return n?this.removeNodeFromListAndLookupTable(n):!1}has(e){const n=this.lookupTable.get(e);return n?n.isExpired?(this.removeNodeFromListAndLookupTable(n),!1):!0:!1}clear(){this.head=null,this.tail=null,this.lookupTable.clear()}find(e){let n=this.head;for(;n;){if(n.isExpired){const s=n.next;this.removeNodeFromListAndLookupTable(n),n=s;continue}const r=this.mapNodeToEntry(n);if(e(r))return this.setNodeAsHead(n),r;n=n.next}return null}forEach(e){let n=this.head,r=0;for(;n;){if(n.isExpired){const s=n.next;this.removeNodeFromListAndLookupTable(n),n=s;continue}e(n.value,n.key,r),n=n.next,r++}}*values(){let e=this.head;for(;e;){if(e.isExpired){const n=e.next;this.removeNodeFromListAndLookupTable(e),e=n;continue}yield e.value,e=e.next}}*keys(){let e=this.head;for(;e;){if(e.isExpired){const n=e.next;this.removeNodeFromListAndLookupTable(e),e=n;continue}yield e.key,e=e.next}}*entries(){let e=this.head;for(;e;){if(e.isExpired){const n=e.next;this.removeNodeFromListAndLookupTable(e),e=n;continue}yield this.mapNodeToEntry(e),e=e.next}}*[Symbol.iterator](){let e=this.head;for(;e;){if(e.isExpired){const n=e.next;this.removeNodeFromListAndLookupTable(e),e=n;continue}yield this.mapNodeToEntry(e),e=e.next}}enforceSizeLimit(){let e=this.tail;for(;e!==null&&this.size>this.maxSizeInternal;){const n=e.prev;this.removeNodeFromListAndLookupTable(e),e=n}}mapNodeToEntry({key:e,value:n}){return{key:e,value:n}}setNodeAsHead(e){this.removeNodeFromList(e),this.head?(e.next=this.head,this.head.prev=e,this.head=e):(this.head=e,this.tail=e),e.invokeOnEntryMarkedAsMostRecentlyUsed()}removeNodeFromList(e){e.prev!==null&&(e.prev.next=e.next),e.next!==null&&(e.next.prev=e.prev),this.head===e&&(this.head=e.next),this.tail===e&&(this.tail=e.prev),e.next=null,e.prev=null}removeNodeFromListAndLookupTable(e){return e.invokeOnEvicted(),this.removeNodeFromList(e),this.lookupTable.delete(e.key)}cleanCache(){if(!this.entryExpirationTimeInMS)return;const e=[];for(const n of this.lookupTable.values())n.isExpired&&e.push(n);e.forEach(n=>this.removeNodeFromListAndLookupTable(n))}}LRUCache$1.LRUCache=LRUCache;(function(t){var e=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(r,s,a,u){u===void 0&&(u=a);var l=Object.getOwnPropertyDescriptor(s,a);(!l||("get"in l?!s.__esModule:l.writable||l.configurable))&&(l={enumerable:!0,get:function(){return s[a]}}),Object.defineProperty(r,u,l)}:function(r,s,a,u){u===void 0&&(u=a),r[u]=s[a]}),n=commonjsGlobal&&commonjsGlobal.__exportStar||function(r,s){for(var a in r)a!=="default"&&!Object.prototype.hasOwnProperty.call(s,a)&&e(s,r,a)};Object.defineProperty(t,"__esModule",{value:!0}),n(LRUCache$1,t)})(dist);BigInt(1e3),BigInt(1e6),BigInt(1e9),BigInt(1e12);BigInt("2100000000000000000");BigInt(1e11);const TAGCODES={payment_hash:1,payment_secret:16,description:13,payee:19,description_hash:23,expiry:6,min_final_cltv_expiry:24,fallback_address:9,route_hint:3,feature_bits:5,metadata:27};for(let t=0,e=Object.keys(TAGCODES);t<e.length;t++)e[t],TAGCODES[e[t]].toString();function getRelaysForSync(t,e,n="write"){if(!t.outboxTracker)return;const r=t.outboxTracker.data.get(e);if(r)return n==="write"?r.writeRelays:r.readRelays}async function getWriteRelaysFor(t,e,n="write"){if(t.outboxTracker)return t.outboxTracker.data.has(e)||await t.outboxTracker.trackUsers([e]),getRelaysForSync(t,e,n)}function getTopRelaysForAuthors(t,e){const n=new Map;return e.forEach(s=>{const a=getRelaysForSync(t,s);a&&a.forEach(u=>{const l=n.get(u)||0;n.set(u,l+1)})}),Array.from(n.entries()).sort((s,a)=>a[1]-s[1]).map(s=>s[0])}function getAllRelaysForAllPubkeys(t,e,n="read"){const r=new Map,s=new Set;return e.forEach(a=>{const u=getRelaysForSync(t,a,n);u&&u.size>0?(u.forEach(l=>{(r.get(l)||new Set).add(a)}),r.set(a,u)):s.add(a)}),{pubkeysToRelays:r,authorsMissingRelays:s}}function chooseRelayCombinationForPubkeys(t,e,n,{count:r,preferredRelays:s}={}){r??(r=2),s??(s=new Set);const a=t.pool,u=a.connectedRelays();u.forEach(E=>{s.add(E.url)});const l=new Map,{pubkeysToRelays:f,authorsMissingRelays:y}=getAllRelaysForAllPubkeys(t,e,n),b=getTopRelaysForAuthors(t,e),m=(E,C)=>{const O=l.get(C)||[];O.push(E),l.set(C,O)};for(const[E,C]of f.entries()){let O=r;for(const $ of u)C.has($.url)&&(m(E,$.url),O--);for(const $ of C)l.has($)&&(m(E,$),O--);if(!(O<=0))for(const $ of b){if(O<=0)break;C.has($)&&(m(E,$),O--)}}for(const E of y)a.permanentAndConnectedRelays().forEach(C=>{const O=l.get(C.url)||[];O.push(E),l.set(C.url,O)});return l}function getRelaysForFilterWithAuthors(t,e,n=2){return chooseRelayCombinationForPubkeys(t,e,"write",{count:n})}function tryNormalizeRelayUrl(t){try{return normalizeRelayUrl(t)}catch{return}}function normalizeRelayUrl(t){let e=normalizeUrl(t.toLowerCase(),{stripAuthentication:!1,stripWWW:!1,stripHash:!0});return e.endsWith("/")||(e+="/"),e}function normalize(t){const e=new Set;for(const n of t)try{e.add(normalizeRelayUrl(n))}catch{}return Array.from(e)}var DATA_URL_DEFAULT_MIME_TYPE="text/plain",DATA_URL_DEFAULT_CHARSET="us-ascii",testParameter=(t,e)=>e.some(n=>n instanceof RegExp?n.test(t):n===t),supportedProtocols=new Set(["https:","http:","file:"]),hasCustomProtocol=t=>{try{const{protocol:e}=new URL(t);return e.endsWith(":")&&!e.includes(".")&&!supportedProtocols.has(e)}catch{return!1}},normalizeDataURL=(t,{stripHash:e})=>{var m,E,C,O;const n=/^data:(?<type>[^,]*?),(?<data>[^#]*?)(?:#(?<hash>.*))?$/.exec(t);if(!n)throw new Error(`Invalid URL: ${t}`);let r=((m=n.groups)==null?void 0:m.type)??"",s=((E=n.groups)==null?void 0:E.data)??"",a=((C=n.groups)==null?void 0:C.hash)??"";const u=r.split(";");a=e?"":a;let l=!1;u[u.length-1]==="base64"&&(u.pop(),l=!0);const f=((O=u.shift())==null?void 0:O.toLowerCase())??"",b=[...u.map($=>{let[k,I=""]=$.split("=").map(q=>q.trim());return k==="charset"&&(I=I.toLowerCase(),I===DATA_URL_DEFAULT_CHARSET)?"":`${k}${I?`=${I}`:""}`}).filter(Boolean)];return l&&b.push("base64"),(b.length>0||f&&f!==DATA_URL_DEFAULT_MIME_TYPE)&&b.unshift(f),`data:${b.join(";")},${l?s.trim():s}${a?`#${a}`:""}`};function normalizeUrl(t,e){if(e={defaultProtocol:"http",normalizeProtocol:!0,forceHttp:!1,forceHttps:!1,stripAuthentication:!0,stripHash:!1,stripTextFragment:!0,stripWWW:!0,removeQueryParameters:[/^utm_\w+/i],removeTrailingSlash:!0,removeSingleSlash:!0,removeDirectoryIndex:!1,removeExplicitPort:!1,sortQueryParameters:!0,...e},typeof e.defaultProtocol=="string"&&!e.defaultProtocol.endsWith(":")&&(e.defaultProtocol=`${e.defaultProtocol}:`),t=t.trim(),/^data:/i.test(t))return normalizeDataURL(t,e);if(hasCustomProtocol(t))return t;const n=t.startsWith("//");!n&&/^\.*\//.test(t)||(t=t.replace(/^(?!(?:\w+:)?\/\/)|^\/\//,e.defaultProtocol));const s=new URL(t);if(e.forceHttp&&e.forceHttps)throw new Error("The `forceHttp` and `forceHttps` options cannot be used together");if(e.forceHttp&&s.protocol==="https:"&&(s.protocol="http:"),e.forceHttps&&s.protocol==="http:"&&(s.protocol="https:"),e.stripAuthentication&&(s.username="",s.password=""),e.stripHash?s.hash="":e.stripTextFragment&&(s.hash=s.hash.replace(/#?:~:text.*?$/i,"")),s.pathname){const u=/\b[a-z][a-z\d+\-.]{1,50}:\/\//g;let l=0,f="";for(;;){const b=u.exec(s.pathname);if(!b)break;const m=b[0],E=b.index,C=s.pathname.slice(l,E);f+=C.replace(/\/{2,}/g,"/"),f+=m,l=E+m.length}const y=s.pathname.slice(l,s.pathname.length);f+=y.replace(/\/{2,}/g,"/"),s.pathname=f}if(s.pathname)try{s.pathname=decodeURI(s.pathname)}catch{}if(e.removeDirectoryIndex===!0&&(e.removeDirectoryIndex=[/^index\.[a-z]+$/]),Array.isArray(e.removeDirectoryIndex)&&e.removeDirectoryIndex.length>0){let u=s.pathname.split("/");const l=u[u.length-1];testParameter(l,e.removeDirectoryIndex)&&(u=u.slice(0,-1),s.pathname=u.slice(1).join("/")+"/")}if(s.hostname&&(s.hostname=s.hostname.replace(/\.$/,""),e.stripWWW&&/^www\.(?!www\.)[a-z\-\d]{1,63}\.[a-z.\-\d]{2,63}$/.test(s.hostname)&&(s.hostname=s.hostname.replace(/^www\./,""))),Array.isArray(e.removeQueryParameters))for(const u of[...s.searchParams.keys()])testParameter(u,e.removeQueryParameters)&&s.searchParams.delete(u);if(!Array.isArray(e.keepQueryParameters)&&e.removeQueryParameters===!0&&(s.search=""),Array.isArray(e.keepQueryParameters)&&e.keepQueryParameters.length>0)for(const u of[...s.searchParams.keys()])testParameter(u,e.keepQueryParameters)||s.searchParams.delete(u);if(e.sortQueryParameters){s.searchParams.sort();try{s.search=decodeURIComponent(s.search)}catch{}}e.removeTrailingSlash&&(s.pathname=s.pathname.replace(/\/$/,"")),e.removeExplicitPort&&s.port&&(s.port="");const a=t;return t=s.toString(),!e.removeSingleSlash&&s.pathname==="/"&&!a.endsWith("/")&&s.hash===""&&(t=t.replace(/\/$/,"")),(e.removeTrailingSlash||s.pathname==="/")&&s.hash===""&&e.removeSingleSlash&&(t=t.replace(/\/$/,"")),n&&!e.normalizeProtocol&&(t=t.replace(/^http:\/\//,"//")),e.stripProtocol&&(t=t.replace(/^(?:https?:)?\/\//,"")),t}var MAX_RECONNECT_ATTEMPTS=5,FLAPPING_THRESHOLD_MS=1e3,NDKRelayConnectivity=class{constructor(t,e){_(this,"ndkRelay");_(this,"ws");_(this,"_status");_(this,"timeoutMs");_(this,"connectedAt");_(this,"_connectionStats",{attempts:0,success:0,durations:[]});_(this,"debug");_(this,"connectTimeout");_(this,"reconnectTimeout");_(this,"ndk");_(this,"openSubs",new Map);_(this,"openCountRequests",new Map);_(this,"openEventPublishes",new Map);_(this,"serial",0);_(this,"baseEoseTimeout",4400);_(this,"updateConnectionStats",{connected:()=>{this._connectionStats.success++,this._connectionStats.connectedAt=Date.now()},disconnected:()=>{this._connectionStats.connectedAt&&(this._connectionStats.durations.push(Date.now()-this._connectionStats.connectedAt),this._connectionStats.durations.length>100&&this._connectionStats.durations.shift()),this._connectionStats.connectedAt=void 0},attempt:()=>{this._connectionStats.attempts++,this._connectionStats.connectedAt=Date.now()}});this.ndkRelay=t,this._status=1;const n=Math.floor(Math.random()*1e3);this.debug=this.ndkRelay.debug.extend("connectivity"+n),this.ndk=e}async connect(t,e=!0){if(this._status!==1||this.reconnectTimeout){this.debug("Relay requested to be connected but was in state %s or it had a reconnect timeout",this._status);return}this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),this.connectTimeout&&(clearTimeout(this.connectTimeout),this.connectTimeout=void 0),t??(t=this.timeoutMs),!this.timeoutMs&&t&&(this.timeoutMs=t),this.timeoutMs&&(this.connectTimeout=setTimeout(()=>this.onConnectionError(e),this.timeoutMs));try{this.updateConnectionStats.attempt(),this._status===1?this._status=4:this._status=2,this.ws=new WebSocket(this.ndkRelay.url),this.ws.onopen=this.onConnect.bind(this),this.ws.onclose=this.onDisconnect.bind(this),this.ws.onmessage=this.onMessage.bind(this),this.ws.onerror=this.onError.bind(this)}catch(n){throw this.debug(`Failed to connect to ${this.ndkRelay.url}`,n),this._status=1,e?this.handleReconnection():this.ndkRelay.emit("delayed-connect",2*24*60*60*1e3),n}}disconnect(){var t;this._status=0;try{(t=this.ws)==null||t.close()}catch(e){this.debug("Failed to disconnect",e),this._status=1}}onConnectionError(t){this.debug(`Error connecting to ${this.ndkRelay.url}`,this.timeoutMs),t&&!this.reconnectTimeout&&this.handleReconnection()}onConnect(){this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),this.connectTimeout&&(clearTimeout(this.connectTimeout),this.connectTimeout=void 0),this.updateConnectionStats.connected(),this._status=5,this.ndkRelay.emit("connect"),this.ndkRelay.emit("ready")}onDisconnect(){this.updateConnectionStats.disconnected(),this._status=1}onMessage(t){try{const e=JSON.parse(t.data),[n,r,...s]=e;switch(n){case"EVENT":{const a=this.openSubs.get(r),u=e[2];if(!a){this.debug(`Received event for unknown subscription ${r}`);return}a.onevent(u);return}case"COUNT":{const a=e[2],u=this.openCountRequests.get(r);u&&(u.resolve(a.count),this.openCountRequests.delete(r));return}case"EOSE":{const a=this.openSubs.get(r);if(!a)return;a.oneose();return}case"OK":{const a=e[2],u=e[3],l=this.openEventPublishes.get(r),f=l==null?void 0:l.pop();if(!l||!f){this.debug("Received OK for unknown event publish",r);return}a?f.resolve(u):f.reject(new Error(u)),l.length===0?this.openEventPublishes.delete(r):this.openEventPublishes.set(r,l);return}case"CLOSED":{const a=this.openSubs.get(r);if(!a)return;a.onclosed(e[2]);return}case"NOTICE":this.onNotice(e[1]);return;case"AUTH":{this.onAuthRequested(e[1]);return}}}catch(e){this.debug(`Error parsing message from ${this.ndkRelay.url}: ${e.message}`,e==null?void 0:e.stack);return}}async onAuthRequested(t){var n,r,s;const e=this.ndkRelay.authPolicy??((n=this.ndk)==null?void 0:n.relayAuthDefaultPolicy);if(this.debug("Relay requested authentication",{havePolicy:!!e}),this._status===7){this.debug("Already authenticating, ignoring");return}if(this._status=6,e){if(this._status>=5){this._status=7;let a;try{a=await e(this.ndkRelay,t)}catch(u){this.debug("Authentication policy threw an error",u),a=!1}if(this.debug("Authentication policy returned",!!a),a instanceof NDKEvent||a===!0){a instanceof NDKEvent&&await this.auth(a);const u=async()=>{if(this._status>=5&&this._status<8){const l=new NDKEvent(this.ndk);l.kind=22242,l.tags=[["relay",this.ndkRelay.url],["challenge",t]],await l.sign(),this.auth(l).then(()=>{this._status=8,this.ndkRelay.emit("authed"),this.debug("Authentication successful")}).catch(f=>{this._status=6,this.ndkRelay.emit("auth:failed",f),this.debug("Authentication failed",f)})}else this.debug("Authentication failed, it changed status, status is %d",this._status)};a===!0&&((r=this.ndk)!=null&&r.signer?u().catch(l=>{console.error("Error authenticating",l)}):(this.debug("No signer available for authentication localhost"),(s=this.ndk)==null||s.once("signer:ready",u))),this._status=5,this.ndkRelay.emit("authed")}}}else this.ndkRelay.emit("auth",t)}onError(t){this.debug(`WebSocket error on ${this.ndkRelay.url}:`,t)}get status(){return this._status}isAvailable(){return this._status===5}isFlapping(){const t=this._connectionStats.durations;if(t.length%3!==0)return!1;const n=t.reduce((u,l)=>u+l,0)/t.length,r=t.map(u=>Math.pow(u-n,2)).reduce((u,l)=>u+l,0)/t.length;return Math.sqrt(r)<FLAPPING_THRESHOLD_MS}async onNotice(t){this.ndkRelay.emit("notice",t)}handleReconnection(t=0){if(this.reconnectTimeout)return;if(this.isFlapping()){this.ndkRelay.emit("flapping",this._connectionStats),this._status=3;return}const e=this.connectedAt?Math.max(0,6e4-(Date.now()-this.connectedAt)):5e3*(this._connectionStats.attempts+1);this.reconnectTimeout=setTimeout(()=>{this.reconnectTimeout=void 0,this._status=2,this.connect().catch(n=>{t<MAX_RECONNECT_ATTEMPTS?setTimeout(()=>{this.handleReconnection(t+1)},1e3*(t+1)^4):this.debug("Reconnect failed")})},e),this.ndkRelay.emit("delayed-connect",e),this.debug("Reconnecting in",e),this._connectionStats.nextReconnectAt=Date.now()+e}async send(t){var e,n;this._status>=5&&((e=this.ws)==null?void 0:e.readyState)===WebSocket.OPEN?(n=this.ws)==null||n.send(t):this.debug(`Not connected to ${this.ndkRelay.url} (%d), not sending message ${t}`,this._status)}async auth(t){const e=new Promise((n,r)=>{const s=this.openEventPublishes.get(t.id)??[];s.push({resolve:n,reject:r}),this.openEventPublishes.set(t.id,s)});return this.send('["AUTH",'+JSON.stringify(t.rawEvent())+"]"),e}async publish(t){const e=new Promise((n,r)=>{const s=this.openEventPublishes.get(t.id)??[];s.length>0&&console.warn("Duplicate event publishing detected, you are publishing event "+t.id+" twice"),s.push({resolve:n,reject:r}),this.openEventPublishes.set(t.id,s)});return this.send('["EVENT",'+JSON.stringify(t)+"]"),e}async count(t,e){this.serial++;const n=(e==null?void 0:e.id)||"count:"+this.serial,r=new Promise((s,a)=>{this.openCountRequests.set(n,{resolve:s,reject:a})});return this.send('["COUNT","'+n+'",'+JSON.stringify(t).substring(1)),r}close(t,e){this.send('["CLOSE","'+t+'"]');const n=this.openSubs.get(t);this.openSubs.delete(t),n&&n.onclose(e)}req(t){this.send('["REQ","'+t.subId+'",'+JSON.stringify(t.executeFilters).substring(1))+"",this.openSubs.set(t.subId,t)}get connectionStats(){return this._connectionStats}get url(){return this.ndkRelay.url}get connected(){var t;return this._status>=5&&((t=this.ws)==null?void 0:t.readyState)===WebSocket.OPEN}},NDKRelayPublisher=class{constructor(t){_(this,"ndkRelay");_(this,"debug");this.ndkRelay=t,this.debug=t.debug.extend("publisher")}async publish(t,e=2500){let n;const r=()=>new Promise((b,m)=>{try{this.publishEvent(t).then(E=>{this.ndkRelay.emit("published",t),t.emit("relay:published",this.ndkRelay),b(!0)}).catch(m)}catch(E){m(E)}}),s=new Promise((b,m)=>{n=setTimeout(()=>{n=void 0,m(new Error("Timeout: "+e+"ms"))},e)}),a=()=>{r().then(b=>u(b)).catch(b=>l(b))};let u,l;const f=b=>{throw this.ndkRelay.debug("Publish failed",b,t.id),this.ndkRelay.emit("publish:failed",t,b),t.emit("relay:publish:failed",this.ndkRelay,b),b},y=()=>{n&&clearTimeout(n),this.ndkRelay.removeListener("connect",a)};return this.ndkRelay.status>=5?Promise.race([r(),s]).catch(f).finally(y):Promise.race([new Promise((b,m)=>{u=b,l=m,this.ndkRelay.once("connect",a)}),s]).catch(f).finally(y)}async publishEvent(t){return this.ndkRelay.connectivity.publish(t.rawEvent())}};function filterFingerprint(t,e){const n=[];for(const s of t){if(s.since||s.until)return;const u=Object.keys(s||{}).sort().join("-");n.push(u)}let r=e?"+":"";return r+=n.join("|"),r}function mergeFilters(t){const e={};return t.forEach(n=>{Object.entries(n).forEach(([r,s])=>{Array.isArray(s)?e[r]===void 0?e[r]=[...s]:e[r]=Array.from(new Set([...e[r],...s])):e[r]=s})}),e}var NDKRelaySubscription=class{constructor(t,e){_(this,"fingerprint");_(this,"items",new Map);_(this,"topSubscriptionManager");_(this,"debug");_(this,"status",0);_(this,"onClose");_(this,"relay");_(this,"eosed",!1);_(this,"itemsToRemoveAfterEose",[]);_(this,"executionTimer");_(this,"fireTime");_(this,"delayType");_(this,"executeFilters");_(this,"eventIds",new Set);_(this,"_subId");_(this,"subIdParts",new Set);_(this,"executeOnRelayReady",()=>{this.status===2&&(this.status=1,this.execute())});_(this,"reExecuteAfterAuth",(()=>{const t=this.subId;this.debug("Re-executing after auth",this.items.size),this.relay.close(this.subId),this._subId=void 0,this.status=1,this.execute(),this.debug("Re-executed after auth %s 👉 %s",t,this.subId)}).bind(this));this.relay=t;const n=Math.random().toString(36).substring(7);this.debug=t.debug.extend("subscription-"+n),this.fingerprint=e||Math.random().toString(36).substring(7)}get subId(){return this._subId?this._subId:(this._subId=this.fingerprint.slice(0,15),this._subId)}addSubIdPart(t){this.subIdParts.add(t)}addItem(t,e){if(!this.items.has(t.internalId))switch(t.on("close",this.removeItem.bind(this,t)),this.items.set(t.internalId,{subscription:t,filters:e}),this.status!==3&&t.subId&&(!this._subId||this._subId.length<48)&&(this.status===0||this.status===1)&&this.addSubIdPart(t.subId),this.status){case 0:this.evaluateExecutionPlan(t);break;case 3:break;case 1:this.evaluateExecutionPlan(t);break;case 4:throw this.debug("Subscription is closed, cannot add new items"),new Error("Cannot add new items to a closed subscription")}}removeItem(t){if(!this.eosed){this.itemsToRemoveAfterEose.push(t.internalId);return}this.items.delete(t.internalId),this.items.size===0&&this.close()}close(){if(this.status===4)return;const t=this.status;if(this.status=4,t===3)try{this.relay.close(this.subId)}catch(e){this.debug("Error closing subscription",e,this)}else this.debug("Subscription wanted to close but it wasn't running, this is probably ok",{subId:this.subId,prevStatus:t,sub:this});this.cleanup()}cleanup(){this.executionTimer&&clearTimeout(this.executionTimer),this.relay.off("ready",this.executeOnRelayReady),this.relay.off("authed",this.reExecuteAfterAuth),this.onClose&&this.onClose(this)}catchUpSubscription(t,e){this.debug("TODO: catch up subscription",t,e)}evaluateExecutionPlan(t){if(!t.isGroupable()){this.status=1,this.execute();return}const e=t.groupableDelay,n=t.groupableDelayType;if(!e)throw new Error("Cannot group a subscription without a delay");if(this.status===0)this.schedule(e,n);else{const r=this.delayType,s=this.fireTime-Date.now();if(r==="at-least"&&n==="at-least")s<e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,n));else if(r==="at-least"&&n==="at-most")s>e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,n));else if(r==="at-most"&&n==="at-most")s>e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,n));else if(r==="at-most"&&n==="at-least")s>e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,n));else throw new Error("Unknown delay type combination "+r+" "+n)}}schedule(t,e){this.status=1;const n=Date.now();this.fireTime=n+t,this.delayType=e;const r=setTimeout(this.execute.bind(this),t);e==="at-least"&&(this.executionTimer=r)}finalizeSubId(){this.subIdParts.size>0?this._subId=Array.from(this.subIdParts).join("-"):this._subId=this.fingerprint.slice(0,15),this._subId+="-"+Math.random().toString(36).substring(2,7)}execute(){if(this.status===1){if(this.relay.connected)this.relay.status<8&&this.relay.once("authed",this.reExecuteAfterAuth);else{this.status=2,this.relay.once("ready",this.executeOnRelayReady);return}this.status=3,this.finalizeSubId(),this.executeFilters=this.compileFilters(),this.relay.req(this)}}onstart(){}onevent(t){var e;(e=this.topSubscriptionManager)==null||e.seenEvent(t.id,this.relay);for(const{subscription:n}of this.items.values())matchFilters(n.filters,t)&&n.eventReceived(t,this.relay,!1)}oneose(){this.eosed=!0;for(const{subscription:t}of this.items.values())t.eoseReceived(this.relay),t.closeOnEose&&this.removeItem(t)}onclose(t){this.status=4}onclosed(t){if(t)for(const{subscription:e}of this.items.values())e.closedReceived(this.relay,t)}compileFilters(){const t=[],e=Array.from(this.items.values()).map(r=>r.filters),n=e[0].length;for(let r=0;r<n;r++){const s=e.map(a=>a[r]);t.push(mergeFilters(s))}return t}},NDKRelaySubscriptionManager=class{constructor(t,e){_(this,"relay");_(this,"subscriptions");_(this,"topSubscriptionManager");_(this,"debug");this.relay=t,this.subscriptions=new Map,this.debug=t.debug.extend("sub-manager"),this.topSubscriptionManager=e}addSubscription(t,e){let n;if(!t.isGroupable())n=this.createSubscription(t,e);else{const r=filterFingerprint(e,t.closeOnEose);r&&(n=this.subscriptions.get(r)),n??(n=this.createSubscription(t,e,r))}n.addItem(t,e)}createSubscription(t,e,n){const r=new NDKRelaySubscription(this.relay,n);return r.topSubscriptionManager=this.topSubscriptionManager,r.onClose=this.onRelaySubscriptionClose.bind(this),this.subscriptions.set(r.fingerprint,r),r}onRelaySubscriptionClose(t){this.subscriptions.delete(t.fingerprint)}},xt,NDKRelay=(xt=class extends lib.EventEmitter{constructor(n,r,s){super();_(this,"url");_(this,"scores");_(this,"connectivity");_(this,"subs");_(this,"publisher");_(this,"authPolicy");_(this,"lowestValidationRatio");_(this,"targetValidationRatio");_(this,"validationRatioFn");_(this,"validatedEventCount",0);_(this,"nonValidatedEventCount",0);_(this,"trusted",!1);_(this,"complaining",!1);_(this,"debug");_(this,"req");_(this,"close");this.url=normalizeRelayUrl(n),this.scores=new Map,this.debug=createDebug2(`ndk:relay:${n}`),this.connectivity=new NDKRelayConnectivity(this,s),this.req=this.connectivity.req.bind(this.connectivity),this.close=this.connectivity.close.bind(this.connectivity),this.subs=new NDKRelaySubscriptionManager(this,s==null?void 0:s.subManager),this.publisher=new NDKRelayPublisher(this),this.authPolicy=r,this.targetValidationRatio=s==null?void 0:s.initialValidationRatio,this.lowestValidationRatio=s==null?void 0:s.lowestValidationRatio,this.validationRatioFn=((s==null?void 0:s.validationRatioFn)??xt.defaultValidationRatioUpdateFn).bind(this),this.updateValidationRatio(),s||console.trace("relay created without ndk")}updateValidationRatio(){setTimeout(()=>{this.updateValidationRatio()},3e4)}get status(){return this.connectivity.status}get connectionStats(){return this.connectivity.connectionStats}async connect(n,r=!0){return this.connectivity.connect(n,r)}disconnect(){this.status!==1&&this.connectivity.disconnect()}subscribe(n,r){this.subs.addSubscription(n,r)}async publish(n,r=2500){return this.publisher.publish(n,r)}referenceTags(){return[["r",this.url]]}addValidatedEvent(){this.validatedEventCount++}addNonValidatedEvent(){this.nonValidatedEventCount++}get validationRatio(){return this.nonValidatedEventCount===0?1:this.validatedEventCount/(this.validatedEventCount+this.nonValidatedEventCount)}shouldValidateEvent(){return this.trusted?!1:this.targetValidationRatio===void 0?!0:this.validationRatio<this.targetValidationRatio}get connected(){return this.connectivity.connected}},_(xt,"defaultValidationRatioUpdateFn",(n,r,s)=>{if(n.lowestValidationRatio===void 0||n.targetValidationRatio===void 0)return 1;let a=n.validationRatio;if(n.validationRatio>n.targetValidationRatio){const u=r/100;a=Math.max(n.lowestValidationRatio,n.validationRatio-u)}return a<n.validationRatio?a:n.validationRatio}),xt),NDKPublishError=class extends Error{constructor(e,n,r,s){super(e);_(this,"errors");_(this,"publishedToRelays");_(this,"intendedRelaySet");this.errors=n,this.publishedToRelays=r,this.intendedRelaySet=s}get relayErrors(){const e=[];for(const[n,r]of this.errors)e.push(`${n.url}: ${r}`);return e.join(`
`)}},NDKRelaySet=class Lr{constructor(e,n){_(this,"relays");_(this,"debug");_(this,"ndk");this.relays=e,this.ndk=n,this.debug=n.debug.extend("relayset")}addRelay(e){this.relays.add(e)}get relayUrls(){return Array.from(this.relays).map(e=>e.url)}static fromRelayUrls(e,n,r=!0){const s=new Set;for(const a of e){const u=n.pool.relays.get(normalizeRelayUrl(a));if(u)u.status<5&&r&&u.connect(),s.add(u);else{const l=new NDKRelay(normalizeRelayUrl(a),n==null?void 0:n.relayAuthDefaultPolicy,n);n.pool.useTemporaryRelay(l,void 0,"requested from fromRelayUrls "+e),s.add(l)}}return new Lr(new Set(s),n)}async publish(e,n,r=1){const s=new Set,a=new Map,u=e.isEphemeral();e.publishStatus="pending";const l=Array.from(this.relays).map(f=>new Promise(y=>{f.publish(e,n).then(b=>{s.add(f),y()}).catch(b=>{u||a.set(f,b),y()})}));if(await Promise.all(l),s.size<r){if(!u){const f=new NDKPublishError("Not enough relays received the event",a,s,this);throw e.publishStatus="error",e.publishError=f,this.ndk.emit("event:publish-failed",e,f,this.relayUrls),f}}else e.emit("published",{relaySet:this,publishedToRelays:s});return s}get size(){return this.relays.size}},d$1=createDebug2("ndk:outbox:calculate");async function calculateRelaySetFromEvent(t,e){var u;const n=new Set,r=await getWriteRelaysFor(t,e.pubkey);r&&r.forEach(l=>{var y;const f=(y=t.pool)==null?void 0:y.getRelay(l);f&&n.add(f)});let s=e.tags.filter(l=>["a","e"].includes(l[0])).map(l=>l[2]).filter(l=>l&&l.startsWith("wss://")).filter(l=>{try{return new URL(l),!0}catch{return!1}}).map(l=>normalizeRelayUrl(l));s=Array.from(new Set(s)).slice(0,5),s.forEach(l=>{var y;const f=(y=t.pool)==null?void 0:y.getRelay(l,!0,!0);f&&(d$1("Adding relay hint %s",l),n.add(f))});const a=e.getMatchingTags("p").map(l=>l[1]);return a.length<5?Array.from(chooseRelayCombinationForPubkeys(t,a,"read",{preferredRelays:new Set(r)}).keys()).forEach(f=>{var b;const y=(b=t.pool)==null?void 0:b.getRelay(f,!1,!0);y&&(d$1("Adding p-tagged relay %s",f),n.add(y))}):d$1("Too many p-tags to consider %d",a.length),(u=t.pool)==null||u.permanentAndConnectedRelays().forEach(l=>n.add(l)),new NDKRelaySet(n,t)}function calculateRelaySetsFromFilter(t,e,n){const r=new Map,s=new Set;if(e.forEach(a=>{a.authors&&a.authors.forEach(u=>s.add(u))}),s.size>0){const a=getRelaysForFilterWithAuthors(t,Array.from(s));for(const u of a.keys())r.set(u,[]);for(const u of e)if(u.authors)for(const[l,f]of a.entries()){const y=u.authors.filter(b=>f.includes(b));r.set(l,[...r.get(l),{...u,authors:y}])}else for(const l of a.keys())r.set(l,[...r.get(l),u])}else t.explicitRelayUrls&&t.explicitRelayUrls.forEach(a=>{r.set(a,e)});return r.size===0&&n.permanentAndConnectedRelays().slice(0,5).forEach(a=>{r.set(a.url,e)}),r.size===0&&console.warn("No relays found for filter",e),r}function calculateRelaySetsFromFilters(t,e,n){return calculateRelaySetsFromFilter(t,e,n)}function mergeTags(t,e){const n=new Map,r=u=>u.join(","),s=(u,l)=>u.every((f,y)=>f===l[y]),a=u=>{for(const[l,f]of n)if(s(f,u)||s(u,f)){u.length>=f.length&&n.set(l,u);return}n.set(r(u),u)};return t.concat(e).forEach(a),Array.from(n.values())}async function generateContentTags(t,e=[]){const n=/(@|nostr:)(npub|nprofile|note|nevent|naddr)[a-zA-Z0-9]+/g,r=new RegExp(`(?<=\\s|^)(#[^\\s!@#$%^&*()=+./,[{\\]};:'"?><]+)`,"g"),s=[],a=u=>{e.find(l=>["q",u[0]].includes(l[0])&&l[1]===u[1])||e.push(u)};return t=t.replace(n,u=>{try{const l=u.split(/(@|nostr:)/)[2],{type:f,data:y}=nip19_exports.decode(l);let b;switch(f){case"npub":b=["p",y];break;case"nprofile":b=["p",y.pubkey];break;case"note":s.push(new Promise(async m=>{a(["e",y,await maybeGetEventRelayUrl(l),"mention"]),m()}));break;case"nevent":s.push(new Promise(async m=>{const{id:E,author:C}=y;let{relays:O}=y;(!O||O.length===0)&&(O=[await maybeGetEventRelayUrl(l)]),a(["e",E,O[0],"mention"]),C&&a(["p",C]),m()}));break;case"naddr":s.push(new Promise(async m=>{const E=[y.kind,y.pubkey,y.identifier].join(":");let C=y.relays??[];C.length===0&&(C=[await maybeGetEventRelayUrl(l)]),a(["a",E,C[0],"mention"]),a(["p",y.pubkey]),m()}));break;default:return u}return b&&a(b),`nostr:${l}`}catch{return u}}),await Promise.all(s),t=t.replace(r,(u,l)=>{const f=["t",l.slice(1)];return e.find(y=>y[0]===f[0]&&y[1]===f[1])||e.push(f),u}),{content:t,tags:e}}async function maybeGetEventRelayUrl(t){return""}function isReplaceable(){if(this.kind===void 0)throw new Error("Kind not set");return[0,3].includes(this.kind)||this.kind>=1e4&&this.kind<2e4||this.kind>=3e4&&this.kind<4e4}function isEphemeral(){if(this.kind===void 0)throw new Error("Kind not set");return this.kind>=2e4&&this.kind<3e4}function isParamReplaceable(){if(this.kind===void 0)throw new Error("Kind not set");return this.kind>=3e4&&this.kind<4e4}async function encrypt(t,e){if(!this.ndk)throw new Error("No NDK instance found!");if(e||(await this.ndk.assertSigner(),e=this.ndk.signer),!t){const n=this.getMatchingTags("p");if(n.length!==1)throw new Error("No recipient could be determined and no explicit recipient was provided");t=this.ndk.getUser({pubkey:n[0][1]})}this.content=await(e==null?void 0:e.encrypt(t,this.content))}async function decrypt(t,e){if(!this.ndk)throw new Error("No NDK instance found!");e||(await this.ndk.assertSigner(),e=this.ndk.signer),t||(t=this.author),this.content=await(e==null?void 0:e.decrypt(t,this.content))}function encode(){let t=[];return this.onRelays.length>0?t=this.onRelays.map(e=>e.url):this.relay&&(t=[this.relay.url]),this.isParamReplaceable()?nip19_exports.naddrEncode({kind:this.kind,pubkey:this.pubkey,identifier:this.replaceableDTag(),relays:t}):t.length>0?nip19_exports.neventEncode({id:this.tagId(),relays:t,author:this.pubkey}):nip19_exports.noteEncode(this.tagId())}async function repost(t=!0,e){if(!e&&t){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),e=this.ndk.signer}const n=new NDKEvent(this.ndk,{kind:getKind(this),content:""});return n.tag(this),n.kind===16?n.tags.push(["k",`${this.kind}`]):n.content=JSON.stringify(this.rawEvent()),e&&await n.sign(e),t&&await n.publish(),n}function getKind(t){return t.kind===1?6:16}function eventHasETagMarkers(t){return t.getMatchingTags("e").some(e=>e[3])}function getRootTag(t,e){e??(e=t.tagType());const n=t.tags.find(r=>r[3]==="root");if(!n){if(eventHasETagMarkers(t))return;const r=t.getMatchingTags(e);if(r.length<3)return r[0]}return n}function getReplyTag(t,e){e??(e=t.tagType());let n=t.tags.find(r=>r[3]==="reply");if(n)return n;if(n||(n=t.tags.find(r=>r[3]==="root")),!n){if(eventHasETagMarkers(t))return;const r=t.getMatchingTags(e);if(r.length===1)return r[0];if(r.length===2)return r[1]}}async function fetchTaggedEvent(t,e){if(!this.ndk)throw new Error("NDK instance not found");const n=this.getMatchingTags(t,e);if(n.length===0)return;const[r,s,a]=n[0];return await this.ndk.fetchEvent(s,{},void 0)}async function fetchRootEvent(t){if(!this.ndk)throw new Error("NDK instance not found");const e=getRootTag(this);if(e)return this.ndk.fetchEventFromTag(e,this,t)}async function fetchReplyEvent(t){if(!this.ndk)throw new Error("NDK instance not found");const e=getReplyTag(this);if(e)return this.ndk.fetchEventFromTag(e,this,t)}function serialize(t=!1,e=!1){const n=[0,this.pubkey,this.created_at,this.kind,this.tags,this.content];return t&&n.push(this.sig),e&&n.push(this.id),JSON.stringify(n)}function deserialize(t){const e=JSON.parse(t),n={pubkey:e[1],created_at:e[2],kind:e[3],tags:e[4],content:e[5]};return e.length===7&&(n.sig=e[6]),e.length===8&&(n.id=e[7]),n}var worker,processingQueue={};function signatureVerificationInit(t){worker=t,worker.onmessage=e=>{const[n,r]=e.data,s=processingQueue[n];if(!s){console.error("No record found for event",n);return}delete processingQueue[n];for(const a of s.resolves)a(r)}}async function verifySignatureAsync(t,e){return new Promise(r=>{const s=t.serialize();let a=!1;processingQueue[t.id]||(processingQueue[t.id]={event:t,resolves:[]},a=!0),processingQueue[t.id].resolves.push(r),a&&worker.postMessage({serialized:s,id:t.id,sig:t.sig,pubkey:t.pubkey})})}var PUBKEY_REGEX=/^[a-f0-9]{64}$/;function validate(){if(typeof this.kind!="number"||typeof this.content!="string"||typeof this.created_at!="number"||typeof this.pubkey!="string"||!this.pubkey.match(PUBKEY_REGEX)||!Array.isArray(this.tags))return!1;for(let t=0;t<this.tags.length;t++){const e=this.tags[t];if(!Array.isArray(e))return!1;for(let n=0;n<e.length;n++)if(typeof e[n]=="object")return!1}return!0}var verifiedSignatures=new dist.LRUCache({maxSize:1e3,entryExpirationTimeInMS:6e4});function verifySignature(t){var n;if(typeof this.signatureVerified=="boolean")return this.signatureVerified;const e=verifiedSignatures.get(this.id);if(e!==null)return this.signatureVerified=!!e;try{if((n=this.ndk)!=null&&n.asyncSigVerification)verifySignatureAsync(this,t).then(r=>{t&&(this.signatureVerified=r,r&&verifiedSignatures.set(this.id,this.sig)),r||(this.ndk.emit("event:invalid-sig",this),verifiedSignatures.set(this.id,!1))});else{const r=sha256(new TextEncoder().encode(this.serialize())),s=schnorr.verify(this.sig,r,this.pubkey);return s?verifiedSignatures.set(this.id,this.sig):verifiedSignatures.set(this.id,!1),this.signatureVerified=s}}catch{return this.signatureVerified=!1}}function getEventHash(){return getEventHashFromSerializedEvent(this.serialize())}function getEventHashFromSerializedEvent(t){const e=sha256(new TextEncoder().encode(t));return bytesToHex$1(e)}var skipClientTagOnKinds=[3],NDKEvent=class Bt extends lib.EventEmitter{constructor(n,r){var s;super();_(this,"ndk");_(this,"created_at");_(this,"content","");_(this,"tags",[]);_(this,"kind");_(this,"id","");_(this,"sig");_(this,"pubkey","");_(this,"signatureVerified");_(this,"_author");_(this,"relay");_(this,"publishStatus","success");_(this,"publishError");_(this,"serialize",serialize.bind(this));_(this,"getEventHash",getEventHash.bind(this));_(this,"validate",validate.bind(this));_(this,"verifySignature",verifySignature.bind(this));_(this,"isReplaceable",isReplaceable.bind(this));_(this,"isEphemeral",isEphemeral.bind(this));_(this,"isParamReplaceable",isParamReplaceable.bind(this));_(this,"encode",encode.bind(this));_(this,"encrypt",encrypt.bind(this));_(this,"decrypt",decrypt.bind(this));_(this,"fetchTaggedEvent",fetchTaggedEvent.bind(this));_(this,"fetchRootEvent",fetchRootEvent.bind(this));_(this,"fetchReplyEvent",fetchReplyEvent.bind(this));_(this,"repost",repost.bind(this));this.ndk=n,this.created_at=r==null?void 0:r.created_at,this.content=(r==null?void 0:r.content)||"",this.tags=(r==null?void 0:r.tags)||[],this.id=(r==null?void 0:r.id)||"",this.sig=r==null?void 0:r.sig,this.pubkey=(r==null?void 0:r.pubkey)||"",this.kind=r==null?void 0:r.kind,r instanceof Bt&&(this.relay&&(this.relay=r.relay,(s=this.ndk)==null||s.subManager.seenEvent(r.id,this.relay)),this.publishStatus=r.publishStatus,this.publishError=r.publishError)}get onRelays(){let n=[];return this.ndk?n=this.ndk.subManager.seenEvents.get(this.id)||[]:this.relay&&n.push(this.relay),n}static deserialize(n,r){return new Bt(n,deserialize(r))}rawEvent(){return{created_at:this.created_at,content:this.content,tags:this.tags,kind:this.kind,pubkey:this.pubkey,id:this.id,sig:this.sig}}set author(n){var r;this.pubkey=n.pubkey,this._author=n,(r=this._author).ndk??(r.ndk=this.ndk)}get author(){if(this._author)return this._author;if(!this.ndk)throw new Error("No NDK instance found");const n=this.ndk.getUser({pubkey:this.pubkey});return this._author=n,n}tag(n,r,s,a){let u=[];if(n.fetchProfile!==void 0){a??(a="p");const f=[a,n.pubkey];r&&f.push("",r),u.push(f)}else if(n instanceof Bt){const f=n;s??(s=(f==null?void 0:f.pubkey)===this.pubkey),u=f.referenceTags(r,s,a);for(const y of f.getMatchingTags("p"))y[1]!==this.pubkey&&(this.tags.find(b=>b[0]==="p"&&b[1]===y[1])||this.tags.push(["p",y[1]]))}else if(Array.isArray(n))u=[n];else throw new Error("Invalid argument",n);this.tags=mergeTags(this.tags,u)}async toNostrEvent(n){var a,u;if(!n&&this.pubkey===""){const l=await((u=(a=this.ndk)==null?void 0:a.signer)==null?void 0:u.user());this.pubkey=(l==null?void 0:l.pubkey)||""}this.created_at||(this.created_at=Math.floor(Date.now()/1e3));const{content:r,tags:s}=await this.generateTags();this.content=r||"",this.tags=s;try{this.id=this.getEventHash()}catch{}return this.rawEvent()}getMatchingTags(n,r){const s=this.tags.filter(a=>a[0]===n);return r===void 0?s:s.filter(a=>a[3]===r)}hasTag(n,r){return this.tags.some(s=>s[0]===n&&(!r||s[3]===r))}tagValue(n){const r=this.getMatchingTags(n);if(r.length!==0)return r[0][1]}get alt(){return this.tagValue("alt")}set alt(n){this.removeTag("alt"),n&&this.tags.push(["alt",n])}get dTag(){return this.tagValue("d")}set dTag(n){this.removeTag("d"),n&&this.tags.push(["d",n])}removeTag(n){const r=Array.isArray(n)?n:[n];this.tags=this.tags.filter(s=>!r.includes(s[0]))}async sign(n){var s;n?this.author=await n.user():((s=this.ndk)==null||s.assertSigner(),n=this.ndk.signer);const r=await this.toNostrEvent();return this.sig=await n.sign(r),this.sig}async publishReplaceable(n,r,s){return this.id="",this.created_at=Math.floor(Date.now()/1e3),this.sig="",this.publish(n,r,s)}async publish(n,r,s){var l,f;if(this.sig||await this.sign(),!this.ndk)throw new Error("NDKEvent must be associated with an NDK instance to publish");n||(n=this.ndk.devWriteRelaySet||await calculateRelaySetFromEvent(this.ndk,this)),this.kind===5&&((l=this.ndk.cacheAdapter)!=null&&l.deleteEvent)&&this.ndk.cacheAdapter.deleteEvent(this);const a=this.rawEvent();if((f=this.ndk.cacheAdapter)!=null&&f.addUnpublishedEvent)try{this.ndk.cacheAdapter.addUnpublishedEvent(this,n.relayUrls)}catch(y){console.error("Error adding unpublished event to cache",y)}this.ndk.subManager.subscriptions.forEach(y=>{y.filters.some(b=>matchFilter(b,a))&&y.eventReceived(this,void 0,!1,!0)});const u=await n.publish(this,r,s);return u.forEach(y=>{var b;return(b=this.ndk)==null?void 0:b.subManager.seenEvent(this.id,y)}),u}async generateTags(){var a,u;let n=[];const r=await generateContentTags(this.content,this.tags),s=r.content;if(n=r.tags,this.kind&&this.isParamReplaceable()&&!this.getMatchingTags("d")[0]){const f=this.tagValue("title");let b=[...Array(f?6:16)].map(()=>Math.random().toString(36)[2]).join("");f&&f.length>0&&(b=f.replace(/[^a-z0-9]+/gi,"-").replace(/^-|-$/g,"")+"-"+b),n.push(["d",b])}if(((a=this.ndk)!=null&&a.clientName||(u=this.ndk)!=null&&u.clientNip89)&&skipClientTagOnKinds.includes(this.kind)&&!this.tags.some(l=>l[0]==="client")){const l=["client",this.ndk.clientName??""];this.ndk.clientNip89&&l.push(this.ndk.clientNip89),n.push(l)}return{content:s||"",tags:n}}muted(){var a,u;const n=(a=this.ndk)==null?void 0:a.mutedIds.get(this.pubkey);if(n&&n==="p")return"author";const r=this.tagReference(),s=(u=this.ndk)==null?void 0:u.mutedIds.get(r[1]);return s&&s===r[0]?"event":null}replaceableDTag(){if(this.kind&&this.kind>=3e4&&this.kind<=4e4){const n=this.getMatchingTags("d")[0];return n?n[1]:""}throw new Error("Event is not a parameterized replaceable event")}deduplicationKey(){return this.kind===0||this.kind===3||this.kind&&this.kind>=1e4&&this.kind<2e4?`${this.kind}:${this.pubkey}`:this.tagId()}tagId(){return this.isParamReplaceable()?this.tagAddress():this.id}tagAddress(){if(!this.isParamReplaceable())throw new Error("This must only be called on replaceable events");const n=this.replaceableDTag();return`${this.kind}:${this.pubkey}:${n}`}tagType(){return this.isParamReplaceable()?"a":"e"}tagReference(n){let r;return this.isParamReplaceable()?r=["a",this.tagAddress()]:r=["e",this.tagId()],this.relay?r.push(this.relay.url):r.push(""),n&&r.push(n),r}referenceTags(n,r,s){var u;let a=[];return this.isParamReplaceable()?a=[[s??"a",this.tagAddress()],[s??"e",this.id]]:a=[[s??"e",this.id]],(u=this.relay)!=null&&u.url?a=a.map(l=>{var f;return l.push((f=this.relay)==null?void 0:f.url),l}):n&&(a=a.map(l=>(l.push(""),l))),n&&a.forEach(l=>l.push(n)),a=[...a,...this.getMatchingTags("h")],r||a.push(...this.author.referenceTags()),a}filter(){return this.isParamReplaceable()?{"#a":[this.tagId()]}:{"#e":[this.tagId()]}}async delete(n,r=!0){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner();const s=new Bt(this.ndk,{kind:5,content:n||""});return s.tag(this,void 0,!0),s.tags.push(["k",this.kind.toString()]),r&&await s.publish(),s}async react(n,r=!0){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner();const s=new Bt(this.ndk,{kind:7,content:n});return s.tag(this),r?await s.publish():await s.sign(),s}get isValid(){return this.validate()}};function queryFullyFilled(t){return!!(filterIncludesIds(t.filter)&&resultHasAllRequestedIds(t))}function filterIncludesIds(t){return!!t.ids}function resultHasAllRequestedIds(t){const e=t.filter.ids;return!!e&&e.length===t.eventFirstSeen.size}function filterFromId(t){let e;if(t.match(NIP33_A_REGEX)){const[n,r,s]=t.split(":"),a={authors:[r],kinds:[parseInt(n)]};return s&&(a["#d"]=[s]),a}if(t.match(BECH32_REGEX))try{switch(e=nip19_exports.decode(t),e.type){case"nevent":{const r={ids:[e.data.id]};return e.data.author&&(r.authors=[e.data.author]),e.data.kind&&(r.kinds=[e.data.kind]),r}case"note":return{ids:[e.data]};case"naddr":const n={authors:[e.data.pubkey],kinds:[e.data.kind]};return e.data.identifier&&(n["#d"]=[e.data.identifier]),n}}catch(n){console.error("Error decoding",t,n)}return{ids:[t]}}function isNip33AValue(t){return t.match(NIP33_A_REGEX)!==null}var NIP33_A_REGEX=/^(\d+):([0-9A-Fa-f]+)(?::(.*))?$/,BECH32_REGEX=/^n(event|ote|profile|pub|addr)1[\d\w]+$/;function relaysFromBech32(t,e){try{const n=nip19_exports.decode(t);if(["naddr","nevent"].includes(n==null?void 0:n.type)){const r=n.data;if(r!=null&&r.relays)return r.relays.map(s=>new NDKRelay(s,e==null?void 0:e.relayAuthDefaultPolicy,e))}}catch{}return[]}var defaultOpts={closeOnEose:!1,cacheUsage:"CACHE_FIRST",groupable:!0,groupableDelay:100,groupableDelayType:"at-most"},NDKSubscription=class extends lib.EventEmitter{constructor(e,n,r,s,a){super();_(this,"subId");_(this,"filters");_(this,"opts");_(this,"pool");_(this,"skipVerification",!1);_(this,"skipValidation",!1);_(this,"relayFilters");_(this,"relaySet");_(this,"ndk");_(this,"debug");_(this,"eventFirstSeen",new Map);_(this,"eosesSeen",new Set);_(this,"lastEventReceivedAt");_(this,"internalId");_(this,"closeOnEose");_(this,"poolMonitor");_(this,"eoseTimeout");_(this,"eosed",!1);if(this.ndk=e,this.pool=(r==null?void 0:r.pool)||e.pool,this.opts={...defaultOpts,...r||{}},this.filters=n instanceof Array?n:[n],this.subId=a||(r==null?void 0:r.subId),this.internalId=Math.random().toString(36).substring(7),this.relaySet=s,this.debug=e.debug.extend(`subscription[${(r==null?void 0:r.subId)??this.internalId}]`),this.skipVerification=(r==null?void 0:r.skipVerification)||!1,this.skipValidation=(r==null?void 0:r.skipValidation)||!1,this.closeOnEose=(r==null?void 0:r.closeOnEose)||!1,this.opts.cacheUsage==="ONLY_CACHE"&&!this.opts.closeOnEose)throw new Error("Cannot use cache-only options with a persistent subscription")}relaysMissingEose(){return this.relayFilters?Array.from(this.relayFilters.keys()).filter(n=>!this.eosesSeen.has(this.pool.getRelay(n,!1,!1))):[]}get filter(){return this.filters[0]}get groupableDelay(){var e;if(this.isGroupable())return(e=this.opts)==null?void 0:e.groupableDelay}get groupableDelayType(){var e;return((e=this.opts)==null?void 0:e.groupableDelayType)||"at-most"}isGroupable(){var e;return((e=this.opts)==null?void 0:e.groupable)||!1}shouldQueryCache(){var e;return((e=this.opts)==null?void 0:e.cacheUsage)!=="ONLY_RELAY"}shouldQueryRelays(){var e;return((e=this.opts)==null?void 0:e.cacheUsage)!=="ONLY_CACHE"}shouldWaitForCache(){var e;return this.opts.closeOnEose&&!!((e=this.ndk.cacheAdapter)!=null&&e.locking)&&this.opts.cacheUsage!=="PARALLEL"}async start(){let e;if(this.shouldQueryCache()&&(e=this.startWithCache(),this.shouldWaitForCache()&&(await e,queryFullyFilled(this)))){this.emit("eose",this);return}this.shouldQueryRelays()?(this.startWithRelays(),this.startPoolMonitor()):this.emit("eose",this)}startPoolMonitor(){this.debug.extend("pool-monitor"),this.poolMonitor=e=>{var r,s;if((r=this.relayFilters)!=null&&r.has(e.url))return;calculateRelaySetsFromFilters(this.ndk,this.filters,this.pool).get(e.url)&&((s=this.relayFilters)==null||s.set(e.url,this.filters),e.subscribe(this,this.filters))},this.pool.on("relay:connect",this.poolMonitor)}stop(){this.emit("close",this),this.poolMonitor&&this.pool.off("relay:connect",this.poolMonitor),this.removeAllListeners()}hasAuthorsFilter(){return this.filters.some(e=>{var n;return(n=e.authors)==null?void 0:n.length})}async startWithCache(){var e;if((e=this.ndk.cacheAdapter)!=null&&e.query){const n=this.ndk.cacheAdapter.query(this);this.ndk.cacheAdapter.locking&&await n}}startWithRelays(){if(!this.relaySet)this.relayFilters=calculateRelaySetsFromFilters(this.ndk,this.filters,this.pool);else{this.relayFilters=new Map;for(const e of this.relaySet.relays)this.relayFilters.set(e.url,this.filters)}if(!(!this.relayFilters||this.relayFilters.size===0))for(const[e,n]of this.relayFilters)this.pool.getRelay(e,!0,!0,n).subscribe(this,n)}eventReceived(e,n,r=!1,s=!1){const a=e.id,u=this.eventFirstSeen.has(a);let l;if(e instanceof NDKEvent&&(l=e),u){const f=Date.now()-(this.eventFirstSeen.get(a)||0);if(this.emit("event:dup",a,n,f,this),n){const y=verifiedSignatures.get(a);y&&typeof y=="string"&&e.sig===y&&n.addValidatedEvent()}}else{if(l??(l=new NDKEvent(this.ndk,e)),l.ndk=this.ndk,l.relay=n,!r&&!s){if(!this.skipValidation&&!l.isValid){this.debug("Event failed validation %s from relay %s",a,n==null?void 0:n.url);return}if(n)if((n==null?void 0:n.shouldValidateEvent())!==!1){if(!this.skipVerification)if(!l.verifySignature(!0)&&!this.ndk.asyncSigVerification){this.debug("Event failed signature validation",e);return}else n&&n.addValidatedEvent()}else n.addNonValidatedEvent();this.ndk.cacheAdapter&&this.ndk.cacheAdapter.setEvent(l,this.filters,n)}!r&&n&&this.ndk.emit("event",l,n),this.emit("event",l,n,this),this.eventFirstSeen.set(a,Date.now())}this.lastEventReceivedAt=Date.now()}closedReceived(e,n){this.emit("closed",e,n)}eoseReceived(e){var u;this.debug("Received EOSE from %s",e.url),this.eosesSeen.add(e);let n=this.lastEventReceivedAt?Date.now()-this.lastEventReceivedAt:void 0;const r=this.eosesSeen.size===((u=this.relayFilters)==null?void 0:u.size),s=queryFullyFilled(this),a=l=>{var f;this.eosed||(this.eoseTimeout&&clearTimeout(this.eoseTimeout),this.debug(`Performing EOSE: ${l}`),this.emit("eose",this),this.eosed=!0,(f=this.opts)!=null&&f.closeOnEose&&this.stop())};if(s||r)a("query filled or seen all");else if(this.relayFilters){let l=1e3;const f=new Set(this.pool.connectedRelays().map(m=>m.url)),y=Array.from(this.relayFilters.keys()).filter(m=>f.has(m));if(y.length===0)return;const b=this.eosesSeen.size/y.length;if(this.eosesSeen.size>=2&&b>=.5){if(l=l*(1-b),l===0){a("tiem to wait was 0");return}this.eoseTimeout&&clearTimeout(this.eoseTimeout);const m=()=>{n=this.lastEventReceivedAt?Date.now()-this.lastEventReceivedAt:void 0,n!==void 0&&n<20?this.eoseTimeout=setTimeout(m,l):a("send eose timeout: "+l)};this.eoseTimeout=setTimeout(m,l)}}}};async function follows(t,e,n=3){var s,a;if(!this.ndk)throw new Error("NDK not set");const r=await this.ndk.fetchEvent({kinds:[n],authors:[this.pubkey]},t||{groupable:!1});if(r){const u=new Set;return r.tags.forEach(l=>{l[0]==="p"&&u.add(l[1])}),e&&((a=(s=this.ndk)==null?void 0:s.outboxTracker)==null||a.trackUsers(Array.from(u))),[...u].reduce((l,f)=>{const y=new NDKUser({pubkey:f});return y.ndk=this.ndk,l.add(y),l},new Set)}return new Set}function profileFromEvent(t){const e={};let n;try{n=JSON.parse(t.content)}catch(r){throw new Error(`Failed to parse profile event: ${r}`)}return e.created_at=t.created_at,e.profileEvent=JSON.stringify(t.rawEvent()),Object.keys(n).forEach(r=>{switch(r){case"name":e.name=n.name;break;case"display_name":e.displayName=n.display_name;break;case"image":case"picture":e.image=n.picture||n.image;break;case"banner":e.banner=n.banner;break;case"bio":e.bio=n.bio;break;case"nip05":e.nip05=n.nip05;break;case"lud06":e.lud06=n.lud06;break;case"lud16":e.lud16=n.lud16;break;case"about":e.about=n.about;break;case"zapService":e.zapService=n.zapService;break;case"website":e.website=n.website;break;default:e[r]=n[r];break}}),e}function serializeProfile(t){const e={};for(const[n,r]of Object.entries(t))switch(n){case"username":case"name":e.name=r;break;case"displayName":e.display_name=r;break;case"image":case"picture":e.picture=r;break;case"bio":case"about":e.about=r;break;default:e[n]=r;break}return JSON.stringify(e)}var NIP05_REGEX=/^(?:([\w.+-]+)@)?([\w.-]+)$/;async function getNip05For(t,e,n=fetch,r={}){return await t.queuesNip05.add({id:e,func:async()=>{if(t.cacheAdapter&&t.cacheAdapter.loadNip05){const f=await t.cacheAdapter.loadNip05(e);if(f!=="missing"){if(f){const y=new NDKUser({pubkey:f.pubkey,relayUrls:f.relays,nip46Urls:f.nip46});return y.ndk=t,y}else if(r.cache!=="no-cache")return null}}const s=e.match(NIP05_REGEX);if(!s)return null;const[a,u="_",l]=s;try{const f=await n(`https://${l}/.well-known/nostr.json?name=${u}`,r),{names:y,relays:b,nip46:m}=parseNIP05Result(await f.json()),E=y[u.toLowerCase()];let C=null;return E&&(C={pubkey:E,relays:b==null?void 0:b[E],nip46:m==null?void 0:m[E]}),t!=null&&t.cacheAdapter&&t.cacheAdapter.saveNip05&&t.cacheAdapter.saveNip05(e,C),C}catch(f){return t!=null&&t.cacheAdapter&&t.cacheAdapter.saveNip05&&(t==null||t.cacheAdapter.saveNip05(e,null)),console.error("Failed to fetch NIP05 for",e,f),null}}})}function parseNIP05Result(t){const e={names:{}};for(const[n,r]of Object.entries(t.names))typeof n=="string"&&typeof r=="string"&&(e.names[n.toLowerCase()]=r);if(t.relays){e.relays={};for(const[n,r]of Object.entries(t.relays))typeof n=="string"&&Array.isArray(r)&&(e.relays[n]=r.filter(s=>typeof s=="string"))}if(t.nip46){e.nip46={};for(const[n,r]of Object.entries(t.nip46))typeof n=="string"&&Array.isArray(r)&&(e.nip46[n]=r.filter(s=>typeof s=="string"))}return e}var dt,NDKCashuMintList=(dt=class extends NDKEvent{constructor(n,r){super(n,r);_(this,"_p2pk");this.kind??(this.kind=10019)}static from(n){return new dt(n.ndk,n)}set relays(n){this.tags=this.tags.filter(r=>r[0]!=="relay");for(const r of n)this.tags.push(["relay",r])}get relays(){const n=[];for(const r of this.tags)r[0]==="relay"&&n.push(r[1]);return n}set mints(n){this.tags=this.tags.filter(r=>r[0]!=="mint");for(const r of n)this.tags.push(["mint",r])}get mints(){const n=[];for(const r of this.tags)r[0]==="mint"&&n.push(r[1]);return Array.from(new Set(n))}get p2pk(){return this._p2pk?this._p2pk:(this._p2pk=this.tagValue("pubkey")??this.pubkey,this._p2pk)}set p2pk(n){this._p2pk=n,this.removeTag("pubkey"),n&&this.tags.push(["pubkey",n])}get relaySet(){return NDKRelaySet.fromRelayUrls(this.relays,this.ndk)}},_(dt,"kind",10019),_(dt,"kinds",[10019]),dt),d2=createDebug2("ndk:zapper:ln");async function getNip57ZapSpecFromLud({lud06:t,lud16:e},n){let r;if(e&&!e.startsWith("LNURL")){const[s,a]=e.split("@");r=`https://${a}/.well-known/lnurlp/${s}`}else if(t){const{words:s}=bech32.decode(t,1e3),a=bech32.fromWords(s);r=new TextDecoder("utf-8").decode(a)}if(!r)throw d2("No zap endpoint found %o",{lud06:t,lud16:e}),new Error("No zap endpoint found");try{const a=await(n.httpFetch||fetch)(r);if(a.status!==200){const u=await a.text();throw new Error(`Unable to fetch zap endpoint ${r}: ${u}`)}return await a.json()}catch(s){throw new Error(`Unable to fetch zap endpoint ${r}: ${s}`)}}var NDKUser=class Ur{constructor(e){_(this,"ndk");_(this,"profile");_(this,"_npub");_(this,"_pubkey");_(this,"relayUrls",[]);_(this,"nip46Urls",[]);_(this,"follows",follows.bind(this));e.npub&&(this._npub=e.npub),e.hexpubkey&&(this._pubkey=e.hexpubkey),e.pubkey&&(this._pubkey=e.pubkey),e.relayUrls&&(this.relayUrls=e.relayUrls),e.nip46Urls&&(this.nip46Urls=e.nip46Urls)}get npub(){if(!this._npub){if(!this._pubkey)throw new Error("pubkey not set");this._npub=nip19_exports.npubEncode(this.pubkey)}return this._npub}set npub(e){this._npub=e}get hexpubkey(){return this.pubkey}set hexpubkey(e){this._pubkey=e}get pubkey(){if(!this._pubkey){if(!this._npub)throw new Error("npub not set");this._pubkey=nip19_exports.decode(this.npub).data}return this._pubkey}set pubkey(e){this._pubkey=e}async getZapInfo(e=!0,n=["nip61","nip57"]){if(!this.ndk)throw new Error("No NDK instance found");const r=[];if(n.includes("nip61")&&r.push(10019),n.includes("nip57")&&r.push(0),r.length===0)return[];let s=await this.ndk.fetchEvents({kinds:r,authors:[this.pubkey]},{cacheUsage:"ONLY_CACHE",groupable:!1});s.size<n.length&&(s=await this.ndk.fetchEvents({kinds:r,authors:[this.pubkey]},{cacheUsage:"ONLY_RELAY"}));const a=[],u=Array.from(s).find(f=>f.kind===10019),l=Array.from(s).find(f=>f.kind===0);if(u){const f=NDKCashuMintList.from(u);if(f.mints.length>0&&a.push({type:"nip61",data:{mints:f.mints,relays:f.relays,p2pk:f.p2pk}}),!e)return a}if(l){const f=profileFromEvent(l),{lud06:y,lud16:b}=f;try{const m=await getNip57ZapSpecFromLud({lud06:y,lud16:b},this.ndk);m&&a.push({type:"nip57",data:m})}catch(m){console.error("Error getting NIP-57 zap spec",m)}}return a}async getZapConfiguration(e){if(e??(e=this.ndk),!e)throw new Error("No NDK instance found");const n=async()=>{var s,a,u,l;if((a=(s=this.ndk)==null?void 0:s.cacheAdapter)!=null&&a.loadUsersLNURLDoc){const f=await this.ndk.cacheAdapter.loadUsersLNURLDoc(this.pubkey);if(f!=="missing"){if(f===null)return;if(f)return f}}let r;try{if(await this.fetchProfile({groupable:!1}),this.profile){const{lud06:f,lud16:y}=this.profile;r=await getNip57ZapSpecFromLud({lud06:f,lud16:y},e)}}catch{}if((l=(u=this.ndk)==null?void 0:u.cacheAdapter)!=null&&l.saveUsersLNURLDoc&&this.ndk.cacheAdapter.saveUsersLNURLDoc(this.pubkey,r||null),!!r)return r};return await e.queuesZapConfig.add({id:this.pubkey,func:n})}async getZapperPubkey(){const e=await this.getZapConfiguration();return e==null?void 0:e.nostrPubkey}static async fromNip05(e,n,r=!1){if(!n)throw new Error("No NDK instance found");const s={};r&&(s.cache="no-cache");const a=await getNip05For(n,e,n==null?void 0:n.httpFetch,s);if(a){const u=new Ur({pubkey:a.pubkey,relayUrls:a.relays,nip46Urls:a.nip46});return u.ndk=n,u}}async fetchProfile(e,n=!1){if(!this.ndk)throw new Error("NDK not set");this.profile||(this.profile={});let r=null;if(this.ndk.cacheAdapter&&this.ndk.cacheAdapter.fetchProfile&&(e==null?void 0:e.cacheUsage)!=="ONLY_RELAY"){const u=await this.ndk.cacheAdapter.fetchProfile(this.pubkey);if(u)return this.profile=u,u}!e&&this.ndk.cacheAdapter&&this.ndk.cacheAdapter.locking&&(r=await this.ndk.fetchEvents({kinds:[0],authors:[this.pubkey]},{cacheUsage:"ONLY_CACHE",closeOnEose:!0,groupable:!1}),e={cacheUsage:"ONLY_RELAY",closeOnEose:!0,groupable:!0,groupableDelay:250}),(!r||r.size===0)&&(r=await this.ndk.fetchEvents({kinds:[0],authors:[this.pubkey]},e));const s=Array.from(r).sort((u,l)=>u.created_at-l.created_at);if(s.length===0)return null;const a=s[0];return this.profile=profileFromEvent(a),n&&(this.profile.profileEvent=JSON.stringify(a)),this.profile&&this.ndk.cacheAdapter&&this.ndk.cacheAdapter.saveProfile&&this.ndk.cacheAdapter.saveProfile(this.pubkey,this.profile),this.profile}tagReference(){return["p",this.pubkey]}referenceTags(e){const n=[["p",this.pubkey]];return e&&n[0].push("",e),n}async publish(){if(!this.ndk)throw new Error("No NDK instance found");if(!this.profile)throw new Error("No profile available");this.ndk.assertSigner(),await new NDKEvent(this.ndk,{kind:0,content:serializeProfile(this.profile)}).publish()}async follow(e,n,r=3){if(!this.ndk)throw new Error("No NDK instance found");if(this.ndk.assertSigner(),n||(n=await this.follows(void 0,void 0,r)),n.has(e))return!1;n.add(e);const s=new NDKEvent(this.ndk,{kind:r});for(const a of n)s.tag(a);return await s.publish(),!0}async unfollow(e,n,r=3){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),n||(n=await this.follows(void 0,void 0,r));const s=new Set;let a=!1;for(const l of n)l.pubkey!==e.pubkey?s.add(l):a=!0;if(!a)return!1;const u=new NDKEvent(this.ndk,{kind:r});for(const l of s)u.tag(l);return await u.publish()}async validateNip05(e){if(!this.ndk)throw new Error("No NDK instance found");const n=await getNip05For(this.ndk,e);return n===null?null:n.pubkey===this.pubkey}async zap(e,n,r,s){return new Promise((a,u)=>{var y;if(!this.ndk){u("No NDK instance found");return}let l=(y=this.ndk.walletConfig)==null?void 0:y.onLnPay;l??(l=async({pr:b})=>{a(b)}),this.ndk.zap(this,e,{comment:n,tags:r,signer:s,onLnPay:l}).zap().then(a).catch(u)})}},NDKList=class Or extends NDKEvent{constructor(n,r){super(n,r);_(this,"_encryptedTags");_(this,"encryptedTagsLength");this.kind??(this.kind=30001)}static from(n){return new Or(n.ndk,n)}get title(){const n=this.tagValue("title")||this.tagValue("name");return n||(this.kind===3?"Contacts":this.kind===1e4?"Mute":this.kind===10001?"Pinned Notes":this.kind===10002?"Relay Metadata":this.kind===10003?"Bookmarks":this.kind===10004?"Communities":this.kind===10005?"Public Chats":this.kind===10006?"Blocked Relays":this.kind===10007?"Search Relays":this.kind===10015?"Interests":this.kind===10030?"Emojis":this.tagValue("d"))}set title(n){this.removeTag(["title","name"]),n&&this.tags.push(["title",n])}get name(){return this.title}set name(n){this.title=n}get description(){return this.tagValue("description")}set description(n){this.removeTag("description"),n&&this.tags.push(["description",n])}get image(){return this.tagValue("image")}set image(n){this.removeTag("image"),n&&this.tags.push(["image",n])}isEncryptedTagsCacheValid(){return!!(this._encryptedTags&&this.encryptedTagsLength===this.content.length)}async encryptedTags(n=!0){if(n&&this.isEncryptedTagsCacheValid())return this._encryptedTags;if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");const r=await this.ndk.signer.user();try{if(this.content.length>0)try{const s=await this.ndk.signer.decrypt(r,this.content),a=JSON.parse(s);return a&&a[0]?(this.encryptedTagsLength=this.content.length,this._encryptedTags=a):(this.encryptedTagsLength=this.content.length,this._encryptedTags=[])}catch{console.log(`error decrypting ${this.content}`)}}catch{}return[]}validateTag(n){return!0}getItems(n){return this.tags.filter(r=>r[0]===n)}get items(){return this.tags.filter(n=>!["d","L","l","title","name","description","published_at","summary","image","thumb","alt","expiration","subject","client"].includes(n[0]))}async addItem(n,r=void 0,s=!1,a="bottom"){if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");let u;if(n instanceof NDKEvent)u=[n.tagReference(r)];else if(n instanceof NDKUser)u=n.referenceTags();else if(n instanceof NDKRelay)u=n.referenceTags();else if(Array.isArray(n))u=[n];else throw new Error("Invalid object type");if(r&&u[0].push(r),s){const l=await this.ndk.signer.user(),f=await this.encryptedTags();a==="top"?f.unshift(...u):f.push(...u),this._encryptedTags=f,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(f),await this.encrypt(l)}else a==="top"?this.tags.unshift(...u):this.tags.push(...u);this.created_at=Math.floor(Date.now()/1e3),this.emit("change")}async removeItemByValue(n,r=!0){if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");const s=this.tags.findIndex(f=>f[1]===n);s>=0&&this.tags.splice(s,1);const a=await this.ndk.signer.user(),u=await this.encryptedTags(),l=u.findIndex(f=>f[1]===n);if(l>=0&&(u.splice(l,1),this._encryptedTags=u,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(u),await this.encrypt(a)),r)return this.publishReplaceable();this.created_at=Math.floor(Date.now()/1e3),this.emit("change")}async removeItem(n,r){if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");if(r){const s=await this.ndk.signer.user(),a=await this.encryptedTags();a.splice(n,1),this._encryptedTags=a,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(a),await this.encrypt(s)}else this.tags.splice(n,1);return this.created_at=Math.floor(Date.now()/1e3),this.emit("change"),this}has(n){return this.items.some(r=>r[1]===n)}filterForItems(){const n=new Set,r=new Map,s=[];for(const a of this.items)if(a[0]==="e"&&a[1])n.add(a[1]);else if(a[0]==="a"&&a[1]){const[u,l,f]=a[1].split(":");if(!u||!l)continue;const y=`${u}:${l}`,b=r.get(y)||[];b.push(f||""),r.set(y,b)}if(n.size>0&&s.push({ids:Array.from(n)}),r.size>0)for(const[a,u]of r.entries()){const[l,f]=a.split(":");s.push({kinds:[parseInt(l)],authors:[f],"#d":u})}return s}},lists_default=NDKList,READ_MARKER="read",WRITE_MARKER="write",NDKRelayList=class Dr extends NDKEvent{constructor(e,n){super(e,n),this.kind??(this.kind=10002)}static from(e){return new Dr(e.ndk,e.rawEvent())}get readRelayUrls(){return this.tags.filter(e=>e[0]==="r"||e[0]==="relay").filter(e=>!e[2]||e[2]&&e[2]===READ_MARKER).map(e=>tryNormalizeRelayUrl(e[1])).filter(e=>!!e)}set readRelayUrls(e){for(const n of e)this.tags.push(["r",n,READ_MARKER])}get writeRelayUrls(){return this.tags.filter(e=>e[0]==="r"||e[0]==="relay").filter(e=>!e[2]||e[2]&&e[2]===WRITE_MARKER).map(e=>tryNormalizeRelayUrl(e[1])).filter(e=>!!e)}set writeRelayUrls(e){for(const n of e)this.tags.push(["r",n,WRITE_MARKER])}get bothRelayUrls(){return this.tags.filter(e=>e[0]==="r"||e[0]==="relay").filter(e=>!e[2]).map(e=>e[1])}set bothRelayUrls(e){for(const n of e)this.tags.push(["r",n])}get relays(){return this.tags.filter(e=>e[0]==="r"||e[0]==="relay").map(e=>e[1])}get relaySet(){if(!this.ndk)throw new Error("NDKRelayList has no NDK instance");return new NDKRelaySet(new Set(this.relays.map(e=>this.ndk.pool.getRelay(e))),this.ndk)}};function relayListFromKind3(t,e){try{const n=JSON.parse(e.content),r=new NDKRelayList(t),s=new Set,a=new Set;for(let[u,l]of Object.entries(n)){try{u=normalizeRelayUrl(u)}catch{continue}if(!l)s.add(u),a.add(u);else{const f=l;f.write&&a.add(u),f.read&&s.add(u)}}return r.readRelayUrls=Array.from(s),r.writeRelayUrls=Array.from(a),r}catch{}}var pt,NDKNutzap=(pt=class extends NDKEvent{constructor(n,r){super(n,r);_(this,"debug");_(this,"_proofs",[]);_(this,"sender",this.author);this.kind??(this.kind=9321),this.debug=(n==null?void 0:n.debug.extend("nutzap"))??createDebug2("ndk:nutzap"),this.alt||(this.alt="This is a nutzap")}static from(n){const r=new this(n.ndk,n);try{const s=r.getMatchingTags("proof");s.length?r._proofs=s.map(a=>JSON.parse(a[1])):r._proofs=JSON.parse(r.content)}catch{return}if(!(!r._proofs||!r._proofs.length))return r}set comment(n){this.content=n??""}get comment(){const n=this.tagValue("comment");return n||this.content}set proofs(n){this._proofs=n,this.tags=this.tags.filter(r=>r[0]!=="proof");for(const r of n)this.tags.push(["proof",JSON.stringify(r)]);this.removeTag("amount"),this.tags.push(["amount",this.amount.toString()])}get proofs(){return this._proofs}get p2pk(){var r;const n=this.proofs[0];try{const s=JSON.parse(n.secret);let a={};if(typeof s=="string"?(a=JSON.parse(s),this.debug("stringified payload",n.secret)):typeof s=="object"&&(a=s),a[0]==="P2PK"&&((r=a[1])==null?void 0:r.data)){const f=a[1].data.slice(2,-1);if(f)return f}}catch(s){this.debug("error parsing p2pk pubkey",s,this.proofs[0])}}get mint(){return this.tagValue("u")}set mint(n){this.removeTag("u"),this.tag(["u",n])}get unit(){return this.tagValue("unit")??"msat"}set unit(n){this.removeTag("unit"),n&&this.tag(["unit",n])}get amount(){return this.proofs.reduce((r,s)=>r+s.amount,0)*1e3}set target(n){this.tags=this.tags.filter(r=>r[0]!=="p"),n instanceof NDKEvent&&this.tags.push()}set recipientPubkey(n){this.removeTag("p"),this.tag(["p",n])}get recipientPubkey(){return this.tagValue("p")}get recipient(){const n=this.recipientPubkey;return this.ndk?this.ndk.getUser({pubkey:n}):new NDKUser({pubkey:n})}get isValid(){let n=0,r=0;for(const s of this.tags)s[0]==="p"&&n++,s[0]==="u"&&r++;return n===1&&r===1&&this.proofs.length>0}},_(pt,"kind",9321),_(pt,"kinds",[pt.kind]),pt);async function payInvoice(t){return await this.sendReq("pay_invoice",{invoice:t})}var NDKPrivateKeySigner=class Fr{constructor(e){_(this,"_user");_(this,"_privateKey");if(e){if(typeof e=="string")if(e.startsWith("nsec1")){const{type:n,data:r}=nip19_exports.decode(e);n==="nsec"&&(this._privateKey=r)}else if(e.length===64)this._privateKey=hexToBytes$1(e);else throw new Error("Invalid private key provided.");else this._privateKey=e;this._privateKey&&(this._user=new NDKUser({pubkey:getPublicKey(this._privateKey)}))}}get privateKey(){if(this._privateKey)return bytesToHex$1(this._privateKey)}static generate(){const e=generateSecretKey();return new Fr(e)}async blockUntilReady(){if(!this._user)throw new Error("NDKUser not initialized");return this._user}async user(){return await this.blockUntilReady(),this._user}async sign(e){if(!this._privateKey)throw Error("Attempted to sign without a private key");return finalizeEvent(e,this._privateKey).sig}async encrypt(e,n){if(!this._privateKey)throw Error("Attempted to encrypt without a private key");const r=e.pubkey;return await nip04_exports.encrypt(this._privateKey,r,n)}async decrypt(e,n){if(!this._privateKey)throw Error("Attempted to decrypt without a private key");const r=e.pubkey;return await nip04_exports.decrypt(this._privateKey,r,n)}};async function sendReq(t,e){const n=new NDKEvent(this.ndk,{kind:23194,tags:[["p",this.walletService.pubkey]],content:JSON.stringify({method:t,params:e})});return this.debug("Sending request",n.content),await n.encrypt(this.walletService,this.signer),await n.sign(this.signer),this.debug("Request encrypted and signed"),new Promise(async(r,s)=>{try{const a=n.tagId();if(!a)throw new Error("Failed to get e-tag");const u=f=>{this.off(a,u),this.off("event",u),this.debug("Received response",f);try{const y=JSON.parse(f);y.error&&s(y),r(y)}catch(y){this.debug("Failed to parse response",y),s({result_type:"error",error:{code:"failed_to_parse_response",message:y.message}})}},l=this.ndk.subscribe({kinds:[23195],"#e":[a],limit:1},{groupable:!1,subId:`nwc-${t}`},this.relaySet);l.on("event",async f=>{await f.decrypt(f.author,this.signer),u(f.content),l.stop()}),this.once(a,u),this.once("event",u),this.debug("Sending request to relay",n.rawEvent()),await n.publish(this.relaySet)}catch(a){this.debug("Failed to send request",a,a.relayErrors),s({result_type:"error",error:{code:"failed_to_send_request",message:a.message}})}})}async function getBalance(){return await this.sendReq("get_balance",{})}async function getInfo(){return await this.sendReq("get_info",{})}var NDKNwc=class Kr extends lib.EventEmitter{constructor({ndk:n,pubkey:r,relayUrls:s,secret:a}){super();_(this,"ndk");_(this,"debug");_(this,"walletService");_(this,"relaySet");_(this,"signer");_(this,"active",!1);_(this,"getBalance",getBalance.bind(this));this.ndk=n,this.walletService=n.getUser({pubkey:r}),this.relaySet=new NDKRelaySet(new Set(s.map(u=>n.pool.getRelay(u))),n),this.signer=new NDKPrivateKeySigner(a instanceof Uint8Array?a:hexToBytes$1(a)),this.debug=n.debug.extend("nwc"),this.debug(`Starting with wallet service ${this.walletService.npub}`)}static async fromURI(n,r){const s=new URL(r);if(s.protocol!=="nostr+walletconnect:")throw new Error("Invalid protocol");return new Kr({ndk:n,pubkey:s.host??s.pathname,relayUrls:s.searchParams.getAll("relay")??[""],secret:s.searchParams.get("secret")??""})}async blockUntilReady(n){const r=await this.signer.user(),s=new Promise((l,f)=>{setTimeout(()=>{f(new Error("Timeout"))},n)}),u=[new Promise(l=>{const f=this.ndk.subscribe({kinds:[23195],"#p":[r.pubkey],limit:1},{groupable:!1,subId:"nwc"},this.relaySet);f.on("event",async y=>{this.debug("received response",y.rawEvent());const b=y.tagValue("e");if(!b){this.debug("Received an event without an e-tag");return}this.debug("received an event",b);try{await y.decrypt(y.author,this.signer),this.emit(b,y.content)}catch(m){this.debug("Failed to decrypt event",m);return}}),f.on("eose",()=>{this.debug("Subscription ready"),this.active=!0,l()}),f.on("close",()=>{this.debug("Subscription closed"),this.active=!1})})];return n&&u.push(s),await Promise.race(u)}async sendReq(n,r){return await sendReq.call(this,n,r)}async payInvoice(n){return await payInvoice.call(this,n)}async getInfo(){return await getInfo.call(this)}},NDKNip07Signer=class{constructor(t=1e3){_(this,"_userPromise");_(this,"nip04Queue",[]);_(this,"nip04Processing",!1);_(this,"debug");_(this,"waitTimeout");this.debug=createDebug2("ndk:nip07"),this.waitTimeout=t}async blockUntilReady(){await this.waitForExtension();const t=await window.nostr.getPublicKey();if(!t)throw new Error("User rejected access");return new NDKUser({pubkey:t})}async user(){return this._userPromise||(this._userPromise=this.blockUntilReady()),this._userPromise}async sign(t){return await this.waitForExtension(),(await window.nostr.signEvent(t)).sig}async relays(t){var r,s;await this.waitForExtension();const e=await((s=(r=window.nostr).getRelays)==null?void 0:s.call(r))||{},n=[];for(const a of Object.keys(e))e[a].read&&e[a].write&&n.push(a);return n.map(a=>new NDKRelay(a,t==null?void 0:t.relayAuthDefaultPolicy,t))}async encrypt(t,e){await this.waitForExtension();const n=t.pubkey;return this.queueNip04("encrypt",n,e)}async decrypt(t,e){await this.waitForExtension();const n=t.pubkey;return this.queueNip04("decrypt",n,e)}async queueNip04(t,e,n){return new Promise((r,s)=>{this.nip04Queue.push({type:t,counterpartyHexpubkey:e,value:n,resolve:r,reject:s}),this.nip04Processing||this.processNip04Queue()})}async processNip04Queue(t,e=0){if(!t&&this.nip04Queue.length===0){this.nip04Processing=!1;return}this.nip04Processing=!0;const{type:n,counterpartyHexpubkey:r,value:s,resolve:a,reject:u}=t||this.nip04Queue.shift();try{let l;n==="encrypt"?l=await window.nostr.nip04.encrypt(r,s):l=await window.nostr.nip04.decrypt(r,s),a(l)}catch(l){if(l.message&&l.message.includes("call already executing")&&e<5){this.debug("Retrying encryption queue item",{type:n,counterpartyHexpubkey:r,value:s,retries:e}),setTimeout(()=>{this.processNip04Queue(t,e+1)},50*e);return}u(l)}this.processNip04Queue()}waitForExtension(){return new Promise((t,e)=>{if(window.nostr){t();return}let n;const r=setInterval(()=>{window.nostr&&(clearTimeout(n),clearInterval(r),t())},100);n=setTimeout(()=>{clearInterval(r),e(new Error("NIP-07 extension not available"))},this.waitTimeout)})}};function dedup(t,e){return t.created_at>e.created_at?t:e}async function getRelayListForUser(t,e){return(await getRelayListForUsers([t],e)).get(t)}async function getRelayListForUsers(t,e,n=!1){var b;const r=e.outboxPool||e.pool,s=new Set;for(const m of r.relays.values())s.add(m);const a=new Map,u=new Map,l=new NDKRelaySet(s,e);if((b=e.cacheAdapter)!=null&&b.locking&&!n){const m=await e.fetchEvents({kinds:[3,10002],authors:t},{cacheUsage:"ONLY_CACHE"});for(const E of m)E.kind===10002&&a.set(E.pubkey,NDKRelayList.from(E));for(const E of m)if(E.kind===3){if(a.has(E.pubkey))continue;const C=relayListFromKind3(e,E);C&&u.set(E.pubkey,C)}t=t.filter(E=>!a.has(E)&&!u.has(E))}if(t.length===0)return a;const f=new Map,y=new Map;return new Promise(async m=>{const E=e.subscribe({kinds:[3,10002],authors:t},{closeOnEose:!0,pool:r,groupable:!0,cacheUsage:"ONLY_RELAY",subId:"ndk-relay-list-fetch"},l,!1);E.on("event",C=>{if(C.kind===10002){const O=f.get(C.pubkey);if(O&&O.created_at>C.created_at)return;f.set(C.pubkey,C)}else if(C.kind===3){const O=y.get(C.pubkey);if(O&&O.created_at>C.created_at)return;y.set(C.pubkey,C)}}),E.on("eose",()=>{for(const C of f.values())a.set(C.pubkey,NDKRelayList.from(C));for(const C of t){if(a.has(C))continue;const O=y.get(C);if(!O)continue;const $=relayListFromKind3(e,O);$&&a.set(C,$)}m(a)}),E.start()})}var OutboxItem=class{constructor(t){_(this,"type");_(this,"relayUrlScores");_(this,"readRelays");_(this,"writeRelays");this.type=t,this.relayUrlScores=new Map,this.readRelays=new Set,this.writeRelays=new Set}},OutboxTracker=class extends lib.EventEmitter{constructor(e){super();_(this,"data");_(this,"ndk");_(this,"debug");this.ndk=e,this.debug=e.debug.extend("outbox-tracker"),this.data=new dist.LRUCache({maxSize:1e5,entryExpirationTimeInMS:2*60*1e3})}async trackUsers(e,n=!1){const r=[];for(let s=0;s<e.length;s+=400){const u=e.slice(s,s+400).map(l=>getKeyFromItem(l)).filter(l=>!this.data.has(l));if(u.length!==0){for(const l of u)this.data.set(l,new OutboxItem("user"));r.push(new Promise(l=>{getRelayListForUsers(u,this.ndk,n).then(f=>{for(const[y,b]of f){let m=this.data.get(y);if(m??(m=new OutboxItem("user")),b){m.readRelays=new Set(normalize(b.readRelayUrls)),m.writeRelays=new Set(normalize(b.writeRelayUrls));for(const E of m.readRelays)this.ndk.pool.blacklistRelayUrls.has(E)&&m.readRelays.delete(E);for(const E of m.writeRelays)this.ndk.pool.blacklistRelayUrls.has(E)&&m.writeRelays.delete(E);this.data.set(y,m)}}}).finally(l)}))}}return Promise.all(r)}track(e,n,r=!0){const s=getKeyFromItem(e);n??(n=getTypeFromItem(e));let a=this.data.get(s);return a||(a=new OutboxItem(n),e instanceof NDKUser&&this.trackUsers([e])),a}};function getKeyFromItem(t){return t instanceof NDKUser?t.pubkey:t}function getTypeFromItem(t){return t instanceof NDKUser?"user":"kind"}var NDKPool=class extends lib.EventEmitter{constructor(e=[],n=[],r,s){super();_(this,"relays",new Map);_(this,"autoConnectRelays",new Set);_(this,"blacklistRelayUrls");_(this,"debug");_(this,"temporaryRelayTimers",new Map);_(this,"flappingRelays",new Set);_(this,"backoffTimes",new Map);_(this,"ndk");this.debug=s??r.debug.extend("pool"),this.ndk=r;for(const a of e){const u=new NDKRelay(a,void 0,this.ndk);this.addRelay(u,!1)}this.blacklistRelayUrls=new Set(n)}set name(e){this.debug=this.debug.extend(e)}useTemporaryRelay(e,n=3e4,r){const s=this.relays.has(e.url);s||(this.addRelay(e),this.debug("Adding temporary relay %s for filters %o",e.url,r));const a=this.temporaryRelayTimers.get(e.url);if(a&&clearTimeout(a),!s||a){const u=setTimeout(()=>{var l;(l=this.ndk.explicitRelayUrls)!=null&&l.includes(e.url)||this.removeRelay(e.url)},n);this.temporaryRelayTimers.set(e.url,u)}}addRelay(e,n=!0){var $,k;const r=this.relays.has(e.url),s=($=this.blacklistRelayUrls)==null?void 0:$.has(e.url),a=e.url.includes("/npub1");let u=!0;const l=e.url;if(r)return;if(s){this.debug(`Refusing to add relay ${l}: blacklisted`);return}if(a){this.debug(`Refusing to add relay ${l}: is a filter relay`);return}if((k=this.ndk.cacheAdapter)!=null&&k.getRelayStatus){const I=this.ndk.cacheAdapter.getRelayStatus(l);if(I&&I.dontConnectBefore)if(I.dontConnectBefore>Date.now()){const q=I.dontConnectBefore-Date.now();this.debug(`Refusing to add relay ${l}: delayed connect for ${q}ms`),setTimeout(()=>{this.addRelay(e,n)},q);return}else u=!1}const f=I=>this.emit("notice",e,I),y=()=>this.handleRelayConnect(l),b=()=>this.handleRelayReady(e),m=()=>this.emit("relay:disconnect",e),E=()=>this.handleFlapping(e),C=I=>this.emit("relay:auth",e,I),O=()=>this.emit("relay:authed",e);e.off("notice",f),e.off("connect",y),e.off("ready",b),e.off("disconnect",m),e.off("flapping",E),e.off("auth",C),e.off("authed",O),e.on("notice",f),e.on("connect",y),e.on("ready",b),e.on("disconnect",m),e.on("flapping",E),e.on("auth",C),e.on("authed",O),e.on("delayed-connect",I=>{var q;(q=this.ndk.cacheAdapter)!=null&&q.updateRelayStatus&&this.ndk.cacheAdapter.updateRelayStatus(e.url,{dontConnectBefore:Date.now()+I})}),this.relays.set(l,e),n&&this.autoConnectRelays.add(l),n&&(this.emit("relay:connecting",e),e.connect(void 0,u).catch(I=>{this.debug(`Failed to connect to relay ${l}`,I)}))}removeRelay(e){const n=this.relays.get(e);if(n)return n.disconnect(),this.relays.delete(e),this.autoConnectRelays.delete(e),this.emit("relay:disconnect",n),!0;const r=this.temporaryRelayTimers.get(e);return r&&(clearTimeout(r),this.temporaryRelayTimers.delete(e)),!1}isRelayConnected(e){const n=normalizeRelayUrl(e),r=this.relays.get(n);return r?r.status===5:!1}getRelay(e,n=!0,r=!1,s){let a=this.relays.get(normalizeRelayUrl(e));return a||(a=new NDKRelay(e,void 0,this.ndk),r?this.useTemporaryRelay(a,3e4,s):this.addRelay(a,n)),a}handleRelayConnect(e){this.emit("relay:connect",this.relays.get(e)),this.stats().connected===this.relays.size&&this.emit("connect")}handleRelayReady(e){this.emit("relay:ready",e)}async connect(e){var s;const n=[];this.debug(`Connecting to ${this.relays.size} relays${e?`, timeout ${e}...`:""}`);const r=new Set(this.autoConnectRelays.keys());(s=this.ndk.explicitRelayUrls)==null||s.forEach(a=>{const u=normalizeRelayUrl(a);r.add(u)});for(const a of r){const u=this.relays.get(a);if(!u)continue;const l=new Promise((f,y)=>(this.emit("relay:connecting",u),u.connect(e).then(f).catch(y)));if(e){const f=new Promise((y,b)=>{setTimeout(()=>b(`Timed out after ${e}ms`),e)});n.push(Promise.race([l,f]).catch(y=>{this.debug(`Failed to connect to relay ${u.url}: ${y??"No reason specified"}`)}))}else n.push(l)}e&&setTimeout(()=>{const a=this.stats().connected===this.relays.size,u=this.stats().connected>0;!a&&u&&this.emit("connect")},e),await Promise.all(n)}checkOnFlappingRelays(){const e=this.flappingRelays.size,n=this.relays.size;if(e/n>=.8)for(const r of this.flappingRelays)this.backoffTimes.set(r,0)}handleFlapping(e){this.debug(`Relay ${e.url} is flapping`);let n=this.backoffTimes.get(e.url)||5e3;n=n*2,this.backoffTimes.set(e.url,n),this.debug(`Backoff time for ${e.url} is ${n}ms`),setTimeout(()=>{this.debug(`Attempting to reconnect to ${e.url}`),this.emit("relay:connecting",e),e.connect(),this.checkOnFlappingRelays()},n),e.disconnect(),this.emit("flapping",e)}size(){return this.relays.size}stats(){const e={total:0,connected:0,disconnected:0,connecting:0};for(const n of this.relays.values())e.total++,n.status===5?e.connected++:n.status===1?e.disconnected++:n.status===4&&e.connecting++;return e}connectedRelays(){return Array.from(this.relays.values()).filter(e=>e.status===5)}permanentAndConnectedRelays(){return Array.from(this.relays.values()).filter(e=>e.status>=5&&!this.temporaryRelayTimers.has(e.url))}urls(){return Array.from(this.relays.keys())}};function correctRelaySet(t,e){const n=e.connectedRelays();if(!Array.from(t.relays).some(s=>n.map(a=>a.url).includes(s.url)))for(const s of n)t.addRelay(s);if(n.length===0)for(const s of e.relays.values())t.addRelay(s);return t}function isValidHint(t){if(!t||t==="")return!1;try{return new URL(t),!0}catch{return!1}}async function fetchEventFromTag(t,e,n,r={type:"timeout"}){const s=this.debug.extend("fetch-event-from-tag"),[a,u,l]=t;n={},s("fetching event from tag",t,n,r);const f=getRelaysForSync(this,e.pubkey);if(f&&f.size>0){s("fetching event from author relays %o",Array.from(f));const $=NDKRelaySet.fromRelayUrls(Array.from(f),this),k=await this.fetchEvent(u,n,$);if(k)return k}else s("no author relays found for %s",e.pubkey,e);const y=calculateRelaySetsFromFilters(this,[{ids:[u]}],this.pool);s("fetching event without relay hint",y);const b=await this.fetchEvent(u,n);if(b)return b;if(l&&l!==""){const $=await this.fetchEvent(u,n,this.pool.getRelay(l,!0,!0,[{ids:[u]}]));if($)return $}let m;const E=isValidHint(l)?this.pool.getRelay(l,!1,!0,[{ids:[u]}]):void 0,C=new Promise($=>{this.fetchEvent(u,n,E).then($)});if(!isValidHint(l)||r.type==="none")return C;const O=new Promise(async $=>{const k=r.relaySet,I=r.timeout??1500,q=new Promise(W=>setTimeout(W,I));if(r.type==="timeout"&&await q,m)$(m);else{s("fallback fetch triggered");const W=await this.fetchEvent(u,n,k);$(W)}});switch(r.type){case"timeout":return Promise.race([C,O]);case"eose":return m=await C,m||O}}var SPEC_PATH="/.well-known/nostr/nip96.json",Nip96=class{constructor(t,e){_(this,"ndk");_(this,"spec");_(this,"url");_(this,"nip98Required",!1);this.url=`https://${t}${SPEC_PATH}`,this.ndk=e}async prepareUpload(t,e="POST"){if(this.validateHttpFetch(),this.spec||await this.fetchSpec(),!this.spec)throw new Error("Failed to fetch NIP96 spec");let n={};return this.nip98Required&&(n={Authorization:await this.generateNip98Header(this.spec.api_url,e,t)}),{url:this.spec.api_url,headers:n}}async xhrUpload(t,e){const n="POST",{url:r,headers:s}=await this.prepareUpload(e,n);t.open(n,r,!0),s.Authorization&&t.setRequestHeader("Authorization",s.Authorization);const a=new FormData;return a.append("file",e),new Promise((u,l)=>{t.onload=function(){t.status>=200&&t.status<300?u(JSON.parse(t.responseText)):l(new Error(t.statusText))},t.onerror=function(){l(new Error("Network Error"))},t.send(a)})}async upload(t){const e="POST",{url:n,headers:r}=await this.prepareUpload(t,e),s=new FormData;s.append("file",t);const a=await this.ndk.httpFetch(this.spec.api_url,{method:e,headers:r,body:s});if(a.status!==200)throw new Error(`Failed to upload file to ${n}`);const u=await a.json();if(u.status!=="success")throw new Error(u.message);return u}validateHttpFetch(){if(!this.ndk)throw new Error("NDK is required to fetch NIP96 spec");if(!this.ndk.httpFetch)throw new Error("NDK must have an httpFetch method to fetch NIP96 spec")}async fetchSpec(){this.validateHttpFetch();const t=await this.ndk.httpFetch(this.url);if(t.status!==200)throw new Error(`Failed to fetch NIP96 spec from ${this.url}`);const e=await t.json();if(!e)throw new Error(`Failed to parse NIP96 spec from ${this.url}`);this.spec=e,this.nip98Required=this.spec.plans.free.is_nip98_required}async generateNip98Header(t,e,n){const r=new NDKEvent(this.ndk,{kind:27235,tags:[["u",t],["method",e]]});if(["POST","PUT","PATCH"].includes(e)){const a=await this.calculateSha256(n);r.tags.push(["payload",a])}return await r.sign(),`Nostr ${btoa(JSON.stringify(r.rawEvent()))}`}async calculateSha256(t){const e=await t.arrayBuffer(),n=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(n)).map(a=>a.toString(16).padStart(2,"0")).join("")}},Queue=class{constructor(t,e){_(this,"queue",[]);_(this,"maxConcurrency");_(this,"processing",new Set);_(this,"promises",new Map);this.maxConcurrency=e}add(t){if(this.promises.has(t.id))return this.promises.get(t.id);const e=new Promise((n,r)=>{this.queue.push({...t,func:()=>t.func().then(s=>(n(s),s),s=>{throw r(s),s})}),this.process()});return this.promises.set(t.id,e),e.finally(()=>{this.promises.delete(t.id),this.processing.delete(t.id),this.process()}),e}process(){if(this.processing.size>=this.maxConcurrency||this.queue.length===0)return;const t=this.queue.shift();!t||this.processing.has(t.id)||(this.processing.add(t.id),t.func())}clear(){this.queue=[]}clearProcessing(){this.processing.clear()}clearAll(){this.clear(),this.clearProcessing()}length(){return this.queue.length}},NDKSubscriptionManager=class{constructor(t){_(this,"subscriptions");_(this,"seenEvents",new Map);_(this,"debug");this.subscriptions=new Map,this.debug=t.extend("sub-manager")}add(t){this.subscriptions.set(t.internalId,t),t.on("close",()=>{this.subscriptions.delete(t.internalId)})}seenEvent(t,e){const n=this.seenEvents.get(t)||[];n.push(e),this.seenEvents.set(t,n)}},debug6=createDebug2("ndk:active-user");async function getUserRelayList(t){if(!this.autoConnectUserRelays)return;const e=await getRelayListForUser(t.pubkey,this);if(e){for(const n of e.relays){let r=this.pool.relays.get(n);r||(r=new NDKRelay(n,this.relayAuthDefaultPolicy,this),this.pool.addRelay(r))}return e}}async function setActiveUser(t){const e=this.outboxPool||this.pool;e.connectedRelays.length>0?setActiveUserConnected.call(this,t):e.once("connect",()=>{setActiveUserConnected.call(this,t)})}async function setActiveUserConnected(t){const e=await getUserRelayList.call(this,t),n=[{kinds:[10006],authors:[t.pubkey]}];this.autoFetchUserMutelist&&n[0].kinds.push(1e4);const r=e?e.relaySet:void 0,s=this.subscribe(n,{subId:"active-user-settings",closeOnEose:!0},r,!1),a=new Map;s.on("event",u=>{const l=a.get(u.kind);l&&l.created_at>=u.created_at||a.set(u.kind,u)}),s.on("eose",()=>{for(const u of a.values())processEvent.call(this,u)}),s.start()}async function processEvent(t){t.kind===10006?processBlockRelayList.call(this,t):t.kind===1e4&&processMuteList.call(this,t)}function processBlockRelayList(t){const e=lists_default.from(t);for(const n of e.items)this.pool.blacklistRelayUrls.add(n[0]);debug6("Added %d relays to relay blacklist",e.items.length)}function processMuteList(t){const e=lists_default.from(t);for(const n of e.items)this.mutedIds.set(n[1],n[0]);debug6("Added %d users to mute list",e.items.length)}async function generateZapRequest(t,e,n,r,s,a,u,l,f){const y=n.callback,b=nip57_exports.makeZapRequest({profile:r,event:null,amount:s,comment:u||"",relays:a.slice(0,4)});if(t instanceof NDKEvent){const C=t.referenceTags().filter(O=>O[0]!=="p");b.tags.push(...C)}b.tags.push(["lnurl",y]);const m=new NDKEvent(e,b);return l&&(m.tags=m.tags.concat(l)),m.tags=m.tags.filter(E=>E[0]!=="p"),m.tags.push(["p",r]),await m.sign(f),m}var d3=createDebug2("ndk:zapper"),NDKZapper=class extends lib.EventEmitter{constructor(e,n,r="msat",s,a,u,l){super();_(this,"target");_(this,"ndk");_(this,"comment");_(this,"amount");_(this,"unit");_(this,"tags");_(this,"signer");_(this,"zapMethod");_(this,"onLnPay");_(this,"onCashuPay");_(this,"onComplete");_(this,"maxRelays",3);if(this.target=e,this.ndk=a||e.ndk,!this.ndk)throw new Error("No NDK instance provided");this.amount=n,this.comment=s,this.unit=r,this.tags=u,this.signer=l}async zap(){const e=this.getZapSplits(),n=new Map;return await Promise.all(e.map(async r=>{let s;try{s=await this.zapSplit(r)}catch(a){s=a}this.emit("split:complete",r,s),n.set(r,s)})),this.emit("complete",n),this.onComplete&&this.onComplete(n),n}async zapSplit(e){let n=await this.getZapMethods(this.ndk,e.pubkey),r;if(n.length===0)throw new Error("No zap method available for recipient");n=n.sort((a,u)=>a.type==="nip61"?-1:u.type==="nip61"?1:0);const s=await this.relays(e.pubkey);for(const a of n){d3("Zapping to %s with %d %s using %s",e.pubkey,e.amount,this.unit,a.type);try{switch(a.type){case"nip61":{const u=a.data;let l;if(l=await this.onCashuPay({target:this.target,comment:this.comment,tags:this.tags,recipientPubkey:e.pubkey,amount:e.amount,unit:this.unit,...u}),d3("NIP-61 Zap result: %o",l),l instanceof Error)r=l;else if(l){const{proofs:f,mint:y}=l;if(!f||!y)throw new Error("Invalid zap confirmation: missing proofs or mint: "+l);const b=NDKRelaySet.fromRelayUrls(s,this.ndk),m=new NDKNutzap(this.ndk);return m.tags=[...m.tags,...this.tags||[]],m.proofs=f,m.mint=y,m.comment=this.comment,m.unit=this.unit,m.recipientPubkey=e.pubkey,await m.sign(this.signer),await m.publish(b),m}break}case"nip57":{const u=a.data,l=await generateZapRequest(this.target,this.ndk,u,e.pubkey,e.amount,s,this.comment,this.tags,this.signer);if(!l)throw d3("Unable to generate zap request"),new Error("Unable to generate zap request");const f=await this.getLnInvoice(l,e.amount,u);if(!f)throw d3("Unable to get payment request"),new Error("Unable to get payment request");r=await this.onLnPay({target:this.target,comment:this.comment,recipientPubkey:e.pubkey,amount:e.amount,unit:this.unit,pr:f});break}}}catch(u){u instanceof Error?r=u:r=new Error(u),d3("Error zapping to %s with %d %s using %s: %o",e.pubkey,e.amount,this.unit,a.type,u)}}if(r instanceof Error)throw r;return r}async getLnInvoice(e,n,r){const s=r.callback,a=JSON.stringify(e.rawEvent());d3(`Fetching invoice from ${s}?`+new URLSearchParams({amount:n.toString(),nostr:a}));const u=new URL(s);u.searchParams.append("amount",n.toString()),u.searchParams.append("nostr",a),d3(`Fetching invoice from ${u.toString()}`);const l=await fetch(u.toString());if(d3(`Got response from zap endpoint: ${s}`,{status:l.status}),l.status!==200){d3(`Received non-200 status from zap endpoint: ${s}`,{status:l.status,amount:n,nostr:a});const y=await l.text();throw new Error(`Unable to fetch zap endpoint ${s}: ${y}`)}return(await l.json()).pr}getZapSplits(){if(this.target instanceof NDKUser)return[{pubkey:this.target.pubkey,amount:this.amount}];const e=this.target.getMatchingTags("zap");if(e.length===0)return[{pubkey:this.target.pubkey,amount:this.amount}];const n=[],r=e.reduce((s,a)=>s+parseInt(a[2]),0);for(const s of e){const a=s[1],u=Math.floor(parseInt(s[2])/r*this.amount);n.push({pubkey:a,amount:u})}return n}async getZapMethods(e,n){const r=[];this.onCashuPay&&r.push("nip61"),r.push("nip57");const s=e.getUser({pubkey:n}),a=await s.getZapInfo(!1,r);return d3("Zap info for %s: %o",s.npub,a),a}async relays(e){var r,s,a;let n=[];if((r=this.ndk)!=null&&r.activeUser){const u=await getRelayListForUsers([this.ndk.activeUser.pubkey,e],this.ndk),l=new Map;for(const f of u.values())for(const y of f.readRelayUrls){const b=l.get(y)||0;l.set(y,b+1)}n=Array.from(l.entries()).sort((f,y)=>y[1]-f[1]).map(([f])=>f).slice(0,this.maxRelays)}return(a=(s=this.ndk)==null?void 0:s.pool)!=null&&a.permanentAndConnectedRelays().length&&(n=this.ndk.pool.permanentAndConnectedRelays().map(u=>u.url)),n.length||(n=[]),n}},DEFAULT_OUTBOX_RELAYS=["wss://purplepag.es/","wss://nos.lol/"],DEFAULT_BLACKLISTED_RELAYS=["wss://brb.io/","wss://nostr.mutinywallet.com/"],NDK=class extends lib.EventEmitter{constructor(e={}){super();_(this,"explicitRelayUrls");_(this,"pool");_(this,"outboxPool");_(this,"_signer");_(this,"_activeUser");_(this,"cacheAdapter");_(this,"debug");_(this,"devWriteRelaySet");_(this,"outboxTracker");_(this,"mutedIds");_(this,"clientName");_(this,"clientNip89");_(this,"queuesZapConfig");_(this,"queuesNip05");_(this,"asyncSigVerification",!1);_(this,"initialValidationRatio",1);_(this,"lowestValidationRatio",1);_(this,"validationRatioFn");_(this,"subManager");_(this,"publishingFailureHandled",!1);_(this,"relayAuthDefaultPolicy");_(this,"httpFetch");_(this,"autoConnectUserRelays",!0);_(this,"autoFetchUserMutelist",!0);_(this,"walletConfig");_(this,"fetchEventFromTag",fetchEventFromTag.bind(this));this.debug=e.debug||createDebug2("ndk"),this.explicitRelayUrls=e.explicitRelayUrls||[],this.subManager=new NDKSubscriptionManager(this.debug),this.pool=new NDKPool(e.explicitRelayUrls||[],e.blacklistRelayUrls||DEFAULT_BLACKLISTED_RELAYS,this),this.pool.name="main",this.pool.on("relay:auth",async(n,r)=>{this.relayAuthDefaultPolicy&&await this.relayAuthDefaultPolicy(n,r)}),this.autoConnectUserRelays=e.autoConnectUserRelays??!0,this.autoFetchUserMutelist=e.autoFetchUserMutelist??!0,this.clientName=e.clientName,this.clientNip89=e.clientNip89,this.relayAuthDefaultPolicy=e.relayAuthDefaultPolicy,e.enableOutboxModel&&(this.outboxPool=new NDKPool(e.outboxRelayUrls||DEFAULT_OUTBOX_RELAYS,e.blacklistRelayUrls||DEFAULT_BLACKLISTED_RELAYS,this,this.debug.extend("outbox-pool")),this.outboxPool.name="outbox",this.outboxTracker=new OutboxTracker(this)),this.signer=e.signer,this.cacheAdapter=e.cacheAdapter,this.mutedIds=e.mutedIds||new Map,e.devWriteRelayUrls&&(this.devWriteRelaySet=NDKRelaySet.fromRelayUrls(e.devWriteRelayUrls,this)),this.queuesZapConfig=new Queue("zaps",3),this.queuesNip05=new Queue("nip05",10),this.signatureVerificationWorker=e.signatureVerificationWorker,this.initialValidationRatio=e.initialValidationRatio||1,this.lowestValidationRatio=e.lowestValidationRatio||1;try{this.httpFetch=fetch}catch{}}set signatureVerificationWorker(e){this.asyncSigVerification=!!e,e&&signatureVerificationInit(e)}addExplicitRelay(e,n,r=!0){let s;return typeof e=="string"?s=new NDKRelay(e,n,this):s=e,this.pool.addRelay(s,r),this.explicitRelayUrls.push(s.url),s}toJSON(){return{relayCount:this.pool.relays.size}.toString()}get activeUser(){return this._activeUser}set activeUser(e){var r;const n=((r=this._activeUser)==null?void 0:r.pubkey)!==(e==null?void 0:e.pubkey);this._activeUser=e,e&&n?setActiveUser.call(this,e):e||(this.mutedIds=new Map)}get signer(){return this._signer}set signer(e){this._signer=e,e&&this.emit("signer:ready",e),e==null||e.user().then(n=>{n.ndk=this,this.activeUser=n})}async connect(e){var r,s;this._signer&&this.autoConnectUserRelays&&(this.debug("Attempting to connect to user relays specified by signer %o",await((s=(r=this._signer).relays)==null?void 0:s.call(r,this))),this._signer.relays&&(await this._signer.relays(this)).forEach(u=>this.pool.addRelay(u)));const n=[this.pool.connect(e)];return this.outboxPool&&n.push(this.outboxPool.connect(e)),this.debug("Connecting to relays %o",{timeoutMs:e}),Promise.allSettled(n).then(()=>{})}getUser(e){const n=new NDKUser(e);return n.ndk=this,n}async getUserFromNip05(e,n=!1){return NDKUser.fromNip05(e,this,n)}subscribe(e,n,r,s=!0){var u;const a=new NDKSubscription(this,e,n,r);if(this.subManager.add(a),r)for(const l of r.relays)this.pool.useTemporaryRelay(l,void 0,a.filters);if(this.outboxPool&&a.hasAuthorsFilter()){const l=a.filters.filter(f=>{var y;return f.authors&&((y=f.authors)==null?void 0:y.length)>0}).map(f=>f.authors).flat();(u=this.outboxTracker)==null||u.trackUsers(l)}return s&&setTimeout(()=>a.start(),0),a}async publish(e,n,r){return this.debug("Deprecated: Use `event.publish()` instead"),e.publish(n,r)}async fetchEvent(e,n,r){let s,a;if(r instanceof NDKRelay?a=new NDKRelaySet(new Set([r]),this):r instanceof NDKRelaySet&&(a=r),!r&&typeof e=="string"&&!isNip33AValue(e)){const u=relaysFromBech32(e,this);u.length>0&&(a=new NDKRelaySet(new Set(u),this),a=correctRelaySet(a,this.pool))}if(typeof e=="string"?s=[filterFromId(e)]:Array.isArray(e)?s=e:s=[e],s.length===0)throw new Error(`Invalid filter: ${JSON.stringify(e)}`);return new Promise(u=>{let l=null;const f=this.subscribe(s,{...n||{},closeOnEose:!0},a,!1),y=setTimeout(()=>{f.stop(),u(l)},1e4);f.on("event",b=>{b.ndk=this,b.isReplaceable()?(!l||l.created_at<b.created_at)&&(l=b):(clearTimeout(y),u(b))}),f.on("eose",()=>{clearTimeout(y),u(l)}),f.start()})}async fetchEvents(e,n,r){return new Promise(s=>{const a=new Map,u=this.subscribe(e,{...n||{},closeOnEose:!0},r,!1),l=f=>{f instanceof NDKEvent||(f=new NDKEvent(void 0,f));const y=f.deduplicationKey(),b=a.get(y);b&&(f=dedup(b,f)),f.ndk=this,a.set(y,f)};u.on("event",l),u.on("eose",()=>{s(new Set(a.values()))}),u.start()})}assertSigner(){if(!this.signer)throw this.emit("signer:required"),new Error("Signer required")}getNip96(e){return new Nip96(e,this)}async nwc(e,n=2e3){const r=await NDKNwc.fromURI(this,e);return n!==!1&&await r.blockUntilReady(n),r}zap(e,n,{comment:r,unit:s,signer:a,tags:u,onLnPay:l,onCashuPay:f,onComplete:y}){var m,E,C;a||this.assertSigner();const b=new NDKZapper(e,n,s,r,this,u,a);return l!==!1&&(b.onLnPay=l??((m=this.walletConfig)==null?void 0:m.onLnPay)),f!==!1&&(b.onCashuPay=f??((E=this.walletConfig)==null?void 0:E.onCashuPay)),b.onComplete=y??((C=this.walletConfig)==null?void 0:C.onPaymentComplete),l&&b.zap(),b}},dexie_min={exports:{}};(function(t,e){(function(n,r){t.exports=r()})(commonjsGlobal,function(){var n=function(o,c){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(h,p){h.__proto__=p}||function(h,p){for(var g in p)Object.prototype.hasOwnProperty.call(p,g)&&(h[g]=p[g])})(o,c)},r=function(){return(r=Object.assign||function(o){for(var c,h=1,p=arguments.length;h<p;h++)for(var g in c=arguments[h])Object.prototype.hasOwnProperty.call(c,g)&&(o[g]=c[g]);return o}).apply(this,arguments)};function s(o,c,h){for(var p,g=0,v=c.length;g<v;g++)!p&&g in c||((p=p||Array.prototype.slice.call(c,0,g))[g]=c[g]);return o.concat(p||Array.prototype.slice.call(c))}var a=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:commonjsGlobal,u=Object.keys,l=Array.isArray;function f(o,c){return typeof c!="object"||u(c).forEach(function(h){o[h]=c[h]}),o}typeof Promise>"u"||a.Promise||(a.Promise=Promise);var y=Object.getPrototypeOf,b={}.hasOwnProperty;function m(o,c){return b.call(o,c)}function E(o,c){typeof c=="function"&&(c=c(y(o))),(typeof Reflect>"u"?u:Reflect.ownKeys)(c).forEach(function(h){O(o,h,c[h])})}var C=Object.defineProperty;function O(o,c,h,p){C(o,c,f(h&&m(h,"get")&&typeof h.get=="function"?{get:h.get,set:h.set,configurable:!0}:{value:h,configurable:!0,writable:!0},p))}function $(o){return{from:function(c){return o.prototype=Object.create(c.prototype),O(o.prototype,"constructor",o),{extend:E.bind(null,o.prototype)}}}}var k=Object.getOwnPropertyDescriptor,I=[].slice;function q(o,c,h){return I.call(o,c,h)}function W(o,c){return c(o)}function te(o){if(!o)throw new Error("Assertion Failed")}function oe(o){a.setImmediate?setImmediate(o):setTimeout(o,0)}function V(o,c){if(typeof c=="string"&&m(o,c))return o[c];if(!c)return o;if(typeof c!="string"){for(var h=[],p=0,g=c.length;p<g;++p){var v=V(o,c[p]);h.push(v)}return h}var w=c.indexOf(".");if(w!==-1){var x=o[c.substr(0,w)];return x==null?void 0:V(x,c.substr(w+1))}}function j(o,c,h){if(o&&c!==void 0&&!("isFrozen"in Object&&Object.isFrozen(o)))if(typeof c!="string"&&"length"in c){te(typeof h!="string"&&"length"in h);for(var p=0,g=c.length;p<g;++p)j(o,c[p],h[p])}else{var v,w,x=c.indexOf(".");x!==-1?(v=c.substr(0,x),(w=c.substr(x+1))===""?h===void 0?l(o)&&!isNaN(parseInt(v))?o.splice(v,1):delete o[v]:o[v]=h:j(x=!(x=o[v])||!m(o,v)?o[v]={}:x,w,h)):h===void 0?l(o)&&!isNaN(parseInt(c))?o.splice(c,1):delete o[c]:o[c]=h}}function G(o){var c,h={};for(c in o)m(o,c)&&(h[c]=o[c]);return h}var le=[].concat;function me(o){return le.apply([],o)}var rt="BigUint64Array,BigInt64Array,Array,Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,FileSystemDirectoryHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(me([8,16,32,64].map(function(o){return["Int","Uint","Float"].map(function(c){return c+o+"Array"})}))).filter(function(o){return a[o]}),ce=new Set(rt.map(function(o){return a[o]})),de=null;function be(o){return de=new WeakMap,o=function c(h){if(!h||typeof h!="object")return h;var p=de.get(h);if(p)return p;if(l(h)){p=[],de.set(h,p);for(var g=0,v=h.length;g<v;++g)p.push(c(h[g]))}else if(ce.has(h.constructor))p=h;else{var w,x=y(h);for(w in p=x===Object.prototype?{}:Object.create(x),de.set(h,p),h)m(h,w)&&(p[w]=c(h[w]))}return p}(o),de=null,o}var Q={}.toString;function F(o){return Q.call(o).slice(8,-1)}var H=typeof Symbol<"u"?Symbol.iterator:"@@iterator",Y=typeof H=="symbol"?function(o){var c;return o!=null&&(c=o[H])&&c.apply(o)}:function(){return null};function se(o,c){return c=o.indexOf(c),0<=c&&o.splice(c,1),0<=c}var he={};function ye(o){var c,h,p,g;if(arguments.length===1){if(l(o))return o.slice();if(this===he&&typeof o=="string")return[o];if(g=Y(o)){for(h=[];!(p=g.next()).done;)h.push(p.value);return h}if(o==null)return[o];if(typeof(c=o.length)!="number")return[o];for(h=new Array(c);c--;)h[c]=o[c];return h}for(c=arguments.length,h=new Array(c);c--;)h[c]=arguments[c];return h}var we=typeof Symbol<"u"?function(o){return o[Symbol.toStringTag]==="AsyncFunction"}:function(){return!1},It=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],Ye=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(It),xe={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function Te(o,c){this.name=o,this.message=c}function Ue(o,c){return o+". Errors: "+Object.keys(c).map(function(h){return c[h].toString()}).filter(function(h,p,g){return g.indexOf(h)===p}).join(`
`)}function Fe(o,c,h,p){this.failures=c,this.failedKeys=p,this.successCount=h,this.message=Ue(o,c)}function Ie(o,c){this.name="BulkError",this.failures=Object.keys(c).map(function(h){return c[h]}),this.failuresByPos=c,this.message=Ue(o,this.failures)}$(Te).from(Error).extend({toString:function(){return this.name+": "+this.message}}),$(Fe).from(Te),$(Ie).from(Te);var Ke=Ye.reduce(function(o,c){return o[c]=c+"Error",o},{}),Ve=Te,ue=Ye.reduce(function(o,c){var h=c+"Error";function p(g,v){this.name=h,g?typeof g=="string"?(this.message="".concat(g).concat(v?`
 `+v:""),this.inner=v||null):typeof g=="object"&&(this.message="".concat(g.name," ").concat(g.message),this.inner=g):(this.message=xe[c]||h,this.inner=null)}return $(p).from(Ve),o[c]=p,o},{});ue.Syntax=SyntaxError,ue.Type=TypeError,ue.Range=RangeError;var Ze=It.reduce(function(o,c){return o[c+"Error"]=ue[c],o},{}),je=Ye.reduce(function(o,c){return["Syntax","Type","Range"].indexOf(c)===-1&&(o[c+"Error"]=ue[c]),o},{});function ve(){}function Be(o){return o}function Je(o,c){return o==null||o===Be?c:function(h){return c(o(h))}}function We(o,c){return function(){o.apply(this,arguments),c.apply(this,arguments)}}function Vt(o,c){return o===ve?c:function(){var h=o.apply(this,arguments);h!==void 0&&(arguments[0]=h);var p=this.onsuccess,g=this.onerror;this.onsuccess=null,this.onerror=null;var v=c.apply(this,arguments);return p&&(this.onsuccess=this.onsuccess?We(p,this.onsuccess):p),g&&(this.onerror=this.onerror?We(g,this.onerror):g),v!==void 0?v:h}}function Mr(o,c){return o===ve?c:function(){o.apply(this,arguments);var h=this.onsuccess,p=this.onerror;this.onsuccess=this.onerror=null,c.apply(this,arguments),h&&(this.onsuccess=this.onsuccess?We(h,this.onsuccess):h),p&&(this.onerror=this.onerror?We(p,this.onerror):p)}}function Hr(o,c){return o===ve?c:function(h){var p=o.apply(this,arguments);f(h,p);var g=this.onsuccess,v=this.onerror;return this.onsuccess=null,this.onerror=null,h=c.apply(this,arguments),g&&(this.onsuccess=this.onsuccess?We(g,this.onsuccess):g),v&&(this.onerror=this.onerror?We(v,this.onerror):v),p===void 0?h===void 0?void 0:h:f(p,h)}}function qr(o,c){return o===ve?c:function(){return c.apply(this,arguments)!==!1&&o.apply(this,arguments)}}function wn(o,c){return o===ve?c:function(){var h=o.apply(this,arguments);if(h&&typeof h.then=="function"){for(var p=this,g=arguments.length,v=new Array(g);g--;)v[g]=arguments[g];return h.then(function(){return c.apply(p,v)})}return c.apply(this,arguments)}}je.ModifyError=Fe,je.DexieError=Te,je.BulkError=Ie;var Qe=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function nr(o){Qe=o}var Nt={},rr=100,rt=typeof Promise>"u"?[]:function(){var o=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[o,y(o),o];var c=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[c,y(c),o]}(),It=rt[0],Ye=rt[1],rt=rt[2],Ye=Ye&&Ye.then,Pt=It&&It.constructor,En=!!rt,Lt=function(o,c){Ut.push([o,c]),Wt&&(queueMicrotask(jr),Wt=!1)},_n=!0,Wt=!0,yt=[],Gt=[],xn=Be,st={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:ve,pgp:!1,env:{},finalize:ve},pe=st,Ut=[],gt=0,Zt=[];function ae(o){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this._lib=!1;var c=this._PSD=pe;if(typeof o!="function"){if(o!==Nt)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(this._state===!1&&$n(this,this._value))}this._state=null,this._value=null,++c.ref,function h(p,g){try{g(function(v){if(p._state===null){if(v===p)throw new TypeError("A promise cannot be resolved with itself.");var w=p._lib&&kt();v&&typeof v.then=="function"?h(p,function(x,T){v instanceof ae?v._then(x,T):v.then(x,T)}):(p._state=!0,p._value=v,sr(p)),w&&$t()}},$n.bind(null,p))}catch(v){$n(p,v)}}(this,o)}var kn={get:function(){var o=pe,c=Qt;function h(p,g){var v=this,w=!o.global&&(o!==pe||c!==Qt),x=w&&!at(),T=new ae(function(A,P){Sn(v,new ir(ar(p,o,w,x),ar(g,o,w,x),A,P,o))});return this._consoleTask&&(T._consoleTask=this._consoleTask),T}return h.prototype=Nt,h},set:function(o){O(this,"then",o&&o.prototype===Nt?kn:{get:function(){return o},set:kn.set})}};function ir(o,c,h,p,g){this.onFulfilled=typeof o=="function"?o:null,this.onRejected=typeof c=="function"?c:null,this.resolve=h,this.reject=p,this.psd=g}function $n(o,c){var h,p;Gt.push(c),o._state===null&&(h=o._lib&&kt(),c=xn(c),o._state=!1,o._value=c,p=o,yt.some(function(g){return g._value===p._value})||yt.push(p),sr(o),h&&$t())}function sr(o){var c=o._listeners;o._listeners=[];for(var h=0,p=c.length;h<p;++h)Sn(o,c[h]);var g=o._PSD;--g.ref||g.finalize(),gt===0&&(++gt,Lt(function(){--gt==0&&An()},[]))}function Sn(o,c){if(o._state!==null){var h=o._state?c.onFulfilled:c.onRejected;if(h===null)return(o._state?c.resolve:c.reject)(o._value);++c.psd.ref,++gt,Lt(zr,[h,o,c])}else o._listeners.push(c)}function zr(o,c,h){try{var p,g=c._value;!c._state&&Gt.length&&(Gt=[]),p=Qe&&c._consoleTask?c._consoleTask.run(function(){return o(g)}):o(g),c._state||Gt.indexOf(g)!==-1||function(v){for(var w=yt.length;w;)if(yt[--w]._value===v._value)return yt.splice(w,1)}(c),h.resolve(p)}catch(v){h.reject(v)}finally{--gt==0&&An(),--h.psd.ref||h.psd.finalize()}}function jr(){mt(st,function(){kt()&&$t()})}function kt(){var o=_n;return Wt=_n=!1,o}function $t(){var o,c,h;do for(;0<Ut.length;)for(o=Ut,Ut=[],h=o.length,c=0;c<h;++c){var p=o[c];p[0].apply(null,p[1])}while(0<Ut.length);Wt=_n=!0}function An(){var o=yt;yt=[],o.forEach(function(p){p._PSD.onunhandled.call(null,p._value,p)});for(var c=Zt.slice(0),h=c.length;h;)c[--h]()}function Yt(o){return new ae(Nt,!1,o)}function Ne(o,c){var h=pe;return function(){var p=kt(),g=pe;try{return ct(h,!0),o.apply(this,arguments)}catch(v){c&&c(v)}finally{ct(g,!1),p&&$t()}}}E(ae.prototype,{then:kn,_then:function(o,c){Sn(this,new ir(null,null,o,c,pe))},catch:function(o){if(arguments.length===1)return this.then(null,o);var c=o,h=arguments[1];return typeof c=="function"?this.then(null,function(p){return(p instanceof c?h:Yt)(p)}):this.then(null,function(p){return(p&&p.name===c?h:Yt)(p)})},finally:function(o){return this.then(function(c){return ae.resolve(o()).then(function(){return c})},function(c){return ae.resolve(o()).then(function(){return Yt(c)})})},timeout:function(o,c){var h=this;return o<1/0?new ae(function(p,g){var v=setTimeout(function(){return g(new ue.Timeout(c))},o);h.then(p,g).finally(clearTimeout.bind(null,v))}):this}}),typeof Symbol<"u"&&Symbol.toStringTag&&O(ae.prototype,Symbol.toStringTag,"Dexie.Promise"),st.env=or(),E(ae,{all:function(){var o=ye.apply(null,arguments).map(en);return new ae(function(c,h){o.length===0&&c([]);var p=o.length;o.forEach(function(g,v){return ae.resolve(g).then(function(w){o[v]=w,--p||c(o)},h)})})},resolve:function(o){return o instanceof ae?o:o&&typeof o.then=="function"?new ae(function(c,h){o.then(c,h)}):new ae(Nt,!0,o)},reject:Yt,race:function(){var o=ye.apply(null,arguments).map(en);return new ae(function(c,h){o.map(function(p){return ae.resolve(p).then(c,h)})})},PSD:{get:function(){return pe},set:function(o){return pe=o}},totalEchoes:{get:function(){return Qt}},newPSD:ot,usePSD:mt,scheduler:{get:function(){return Lt},set:function(o){Lt=o}},rejectionMapper:{get:function(){return xn},set:function(o){xn=o}},follow:function(o,c){return new ae(function(h,p){return ot(function(g,v){var w=pe;w.unhandleds=[],w.onunhandled=v,w.finalize=We(function(){var x,T=this;x=function(){T.unhandleds.length===0?g():v(T.unhandleds[0])},Zt.push(function A(){x(),Zt.splice(Zt.indexOf(A),1)}),++gt,Lt(function(){--gt==0&&An()},[])},w.finalize),o()},c,h,p)})}}),Pt&&(Pt.allSettled&&O(ae,"allSettled",function(){var o=ye.apply(null,arguments).map(en);return new ae(function(c){o.length===0&&c([]);var h=o.length,p=new Array(h);o.forEach(function(g,v){return ae.resolve(g).then(function(w){return p[v]={status:"fulfilled",value:w}},function(w){return p[v]={status:"rejected",reason:w}}).then(function(){return--h||c(p)})})})}),Pt.any&&typeof AggregateError<"u"&&O(ae,"any",function(){var o=ye.apply(null,arguments).map(en);return new ae(function(c,h){o.length===0&&h(new AggregateError([]));var p=o.length,g=new Array(p);o.forEach(function(v,w){return ae.resolve(v).then(function(x){return c(x)},function(x){g[w]=x,--p||h(new AggregateError(g))})})})}));var Oe={awaits:0,echoes:0,id:0},Vr=0,Jt=[],Xt=0,Qt=0,Wr=0;function ot(o,c,h,p){var g=pe,v=Object.create(g);return v.parent=g,v.ref=0,v.global=!1,v.id=++Wr,st.env,v.env=En?{Promise:ae,PromiseProp:{value:ae,configurable:!0,writable:!0},all:ae.all,race:ae.race,allSettled:ae.allSettled,any:ae.any,resolve:ae.resolve,reject:ae.reject}:{},c&&f(v,c),++g.ref,v.finalize=function(){--this.parent.ref||this.parent.finalize()},p=mt(v,o,h,p),v.ref===0&&v.finalize(),p}function St(){return Oe.id||(Oe.id=++Vr),++Oe.awaits,Oe.echoes+=rr,Oe.id}function at(){return!!Oe.awaits&&(--Oe.awaits==0&&(Oe.id=0),Oe.echoes=Oe.awaits*rr,!0)}function en(o){return Oe.echoes&&o&&o.constructor===Pt?(St(),o.then(function(c){return at(),c},function(c){return at(),Pe(c)})):o}function Gr(){var o=Jt[Jt.length-1];Jt.pop(),ct(o,!1)}function ct(o,c){var h,p=pe;(c?!Oe.echoes||Xt++&&o===pe:!Xt||--Xt&&o===pe)||queueMicrotask(c?(function(g){++Qt,Oe.echoes&&--Oe.echoes!=0||(Oe.echoes=Oe.awaits=Oe.id=0),Jt.push(pe),ct(g,!0)}).bind(null,o):Gr),o!==pe&&(pe=o,p===st&&(st.env=or()),En&&(h=st.env.Promise,c=o.env,(p.global||o.global)&&(Object.defineProperty(a,"Promise",c.PromiseProp),h.all=c.all,h.race=c.race,h.resolve=c.resolve,h.reject=c.reject,c.allSettled&&(h.allSettled=c.allSettled),c.any&&(h.any=c.any))))}function or(){var o=a.Promise;return En?{Promise:o,PromiseProp:Object.getOwnPropertyDescriptor(a,"Promise"),all:o.all,race:o.race,allSettled:o.allSettled,any:o.any,resolve:o.resolve,reject:o.reject}:{}}function mt(o,c,h,p,g){var v=pe;try{return ct(o,!0),c(h,p,g)}finally{ct(v,!1)}}function ar(o,c,h,p){return typeof o!="function"?o:function(){var g=pe;h&&St(),ct(c,!0);try{return o.apply(this,arguments)}finally{ct(g,!1),p&&queueMicrotask(at)}}}function Rn(o){Promise===Pt&&Oe.echoes===0?Xt===0?o():enqueueNativeMicroTask(o):setTimeout(o,0)}(""+Ye).indexOf("[native code]")===-1&&(St=at=ve);var Pe=ae.reject,bt="￿",nt="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",cr="String expected.",At=[],tn="__dbnames",Tn="readonly",Cn="readwrite";function vt(o,c){return o?c?function(){return o.apply(this,arguments)&&c.apply(this,arguments)}:o:c}var ur={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function nn(o){return typeof o!="string"||/\./.test(o)?function(c){return c}:function(c){return c[o]===void 0&&o in c&&delete(c=be(c))[o],c}}function lr(){throw ue.Type()}function Ae(o,c){try{var h=hr(o),p=hr(c);if(h!==p)return h==="Array"?1:p==="Array"?-1:h==="binary"?1:p==="binary"?-1:h==="string"?1:p==="string"?-1:h==="Date"?1:p!=="Date"?NaN:-1;switch(h){case"number":case"Date":case"string":return c<o?1:o<c?-1:0;case"binary":return function(g,v){for(var w=g.length,x=v.length,T=w<x?w:x,A=0;A<T;++A)if(g[A]!==v[A])return g[A]<v[A]?-1:1;return w===x?0:w<x?-1:1}(fr(o),fr(c));case"Array":return function(g,v){for(var w=g.length,x=v.length,T=w<x?w:x,A=0;A<T;++A){var P=Ae(g[A],v[A]);if(P!==0)return P}return w===x?0:w<x?-1:1}(o,c)}}catch{}return NaN}function hr(o){var c=typeof o;return c!="object"?c:ArrayBuffer.isView(o)?"binary":(o=F(o),o==="ArrayBuffer"?"binary":o)}function fr(o){return o instanceof Uint8Array?o:ArrayBuffer.isView(o)?new Uint8Array(o.buffer,o.byteOffset,o.byteLength):new Uint8Array(o)}var dr=(Ce.prototype._trans=function(o,c,h){var p=this._tx||pe.trans,g=this.name,v=Qe&&typeof console<"u"&&console.createTask&&console.createTask("Dexie: ".concat(o==="readonly"?"read":"write"," ").concat(this.name));function w(A,P,S){if(!S.schema[g])throw new ue.NotFound("Table "+g+" not part of transaction");return c(S.idbtrans,S)}var x=kt();try{var T=p&&p.db._novip===this.db._novip?p===pe.trans?p._promise(o,w,h):ot(function(){return p._promise(o,w,h)},{trans:p,transless:pe.transless||pe}):function A(P,S,L,R){if(P.idbdb&&(P._state.openComplete||pe.letThrough||P._vip)){var N=P._createTransaction(S,L,P._dbSchema);try{N.create(),P._state.PR1398_maxLoop=3}catch(U){return U.name===Ke.InvalidState&&P.isOpen()&&0<--P._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),P.close({disableAutoOpen:!1}),P.open().then(function(){return A(P,S,L,R)})):Pe(U)}return N._promise(S,function(U,B){return ot(function(){return pe.trans=N,R(U,B,N)})}).then(function(U){if(S==="readwrite")try{N.idbtrans.commit()}catch{}return S==="readonly"?U:N._completion.then(function(){return U})})}if(P._state.openComplete)return Pe(new ue.DatabaseClosed(P._state.dbOpenError));if(!P._state.isBeingOpened){if(!P._state.autoOpen)return Pe(new ue.DatabaseClosed);P.open().catch(ve)}return P._state.dbReadyPromise.then(function(){return A(P,S,L,R)})}(this.db,o,[this.name],w);return v&&(T._consoleTask=v,T=T.catch(function(A){return console.trace(A),Pe(A)})),T}finally{x&&$t()}},Ce.prototype.get=function(o,c){var h=this;return o&&o.constructor===Object?this.where(o).first(c):o==null?Pe(new ue.Type("Invalid argument to Table.get()")):this._trans("readonly",function(p){return h.core.get({trans:p,key:o}).then(function(g){return h.hook.reading.fire(g)})}).then(c)},Ce.prototype.where=function(o){if(typeof o=="string")return new this.db.WhereClause(this,o);if(l(o))return new this.db.WhereClause(this,"[".concat(o.join("+"),"]"));var c=u(o);if(c.length===1)return this.where(c[0]).equals(o[c[0]]);var h=this.schema.indexes.concat(this.schema.primKey).filter(function(T){if(T.compound&&c.every(function(P){return 0<=T.keyPath.indexOf(P)})){for(var A=0;A<c.length;++A)if(c.indexOf(T.keyPath[A])===-1)return!1;return!0}return!1}).sort(function(T,A){return T.keyPath.length-A.keyPath.length})[0];if(h&&this.db._maxKey!==bt){var w=h.keyPath.slice(0,c.length);return this.where(w).equals(w.map(function(A){return o[A]}))}!h&&Qe&&console.warn("The query ".concat(JSON.stringify(o)," on ").concat(this.name," would benefit from a ")+"compound index [".concat(c.join("+"),"]"));var p=this.schema.idxByName,g=this.db._deps.indexedDB;function v(T,A){return g.cmp(T,A)===0}var x=c.reduce(function(L,A){var P=L[0],S=L[1],L=p[A],R=o[A];return[P||L,P||!L?vt(S,L&&L.multi?function(N){return N=V(N,A),l(N)&&N.some(function(U){return v(R,U)})}:function(N){return v(R,V(N,A))}):S]},[null,null]),w=x[0],x=x[1];return w?this.where(w.name).equals(o[w.keyPath]).filter(x):h?this.filter(x):this.where(c).equals("")},Ce.prototype.filter=function(o){return this.toCollection().and(o)},Ce.prototype.count=function(o){return this.toCollection().count(o)},Ce.prototype.offset=function(o){return this.toCollection().offset(o)},Ce.prototype.limit=function(o){return this.toCollection().limit(o)},Ce.prototype.each=function(o){return this.toCollection().each(o)},Ce.prototype.toArray=function(o){return this.toCollection().toArray(o)},Ce.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))},Ce.prototype.orderBy=function(o){return new this.db.Collection(new this.db.WhereClause(this,l(o)?"[".concat(o.join("+"),"]"):o))},Ce.prototype.reverse=function(){return this.toCollection().reverse()},Ce.prototype.mapToClass=function(o){var c,h=this.db,p=this.name;function g(){return c!==null&&c.apply(this,arguments)||this}(this.schema.mappedClass=o).prototype instanceof lr&&(function(T,A){if(typeof A!="function"&&A!==null)throw new TypeError("Class extends value "+String(A)+" is not a constructor or null");function P(){this.constructor=T}n(T,A),T.prototype=A===null?Object.create(A):(P.prototype=A.prototype,new P)}(g,c=o),Object.defineProperty(g.prototype,"db",{get:function(){return h},enumerable:!1,configurable:!0}),g.prototype.table=function(){return p},o=g);for(var v=new Set,w=o.prototype;w;w=y(w))Object.getOwnPropertyNames(w).forEach(function(T){return v.add(T)});function x(T){if(!T)return T;var A,P=Object.create(o.prototype);for(A in T)if(!v.has(A))try{P[A]=T[A]}catch{}return P}return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=x,this.hook("reading",x),o},Ce.prototype.defineClass=function(){return this.mapToClass(function(o){f(this,o)})},Ce.prototype.add=function(o,c){var h=this,p=this.schema.primKey,g=p.auto,v=p.keyPath,w=o;return v&&g&&(w=nn(v)(o)),this._trans("readwrite",function(x){return h.core.mutate({trans:x,type:"add",keys:c!=null?[c]:null,values:[w]})}).then(function(x){return x.numFailures?ae.reject(x.failures[0]):x.lastResult}).then(function(x){if(v)try{j(o,v,x)}catch{}return x})},Ce.prototype.update=function(o,c){return typeof o!="object"||l(o)?this.where(":id").equals(o).modify(c):(o=V(o,this.schema.primKey.keyPath),o===void 0?Pe(new ue.InvalidArgument("Given object does not contain its primary key")):this.where(":id").equals(o).modify(c))},Ce.prototype.put=function(o,c){var h=this,p=this.schema.primKey,g=p.auto,v=p.keyPath,w=o;return v&&g&&(w=nn(v)(o)),this._trans("readwrite",function(x){return h.core.mutate({trans:x,type:"put",values:[w],keys:c!=null?[c]:null})}).then(function(x){return x.numFailures?ae.reject(x.failures[0]):x.lastResult}).then(function(x){if(v)try{j(o,v,x)}catch{}return x})},Ce.prototype.delete=function(o){var c=this;return this._trans("readwrite",function(h){return c.core.mutate({trans:h,type:"delete",keys:[o]})}).then(function(h){return h.numFailures?ae.reject(h.failures[0]):void 0})},Ce.prototype.clear=function(){var o=this;return this._trans("readwrite",function(c){return o.core.mutate({trans:c,type:"deleteRange",range:ur})}).then(function(c){return c.numFailures?ae.reject(c.failures[0]):void 0})},Ce.prototype.bulkGet=function(o){var c=this;return this._trans("readonly",function(h){return c.core.getMany({keys:o,trans:h}).then(function(p){return p.map(function(g){return c.hook.reading.fire(g)})})})},Ce.prototype.bulkAdd=function(o,c,h){var p=this,g=Array.isArray(c)?c:void 0,v=(h=h||(g?void 0:c))?h.allKeys:void 0;return this._trans("readwrite",function(w){var A=p.schema.primKey,x=A.auto,A=A.keyPath;if(A&&g)throw new ue.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(g&&g.length!==o.length)throw new ue.InvalidArgument("Arguments objects and keys must have the same length");var T=o.length,A=A&&x?o.map(nn(A)):o;return p.core.mutate({trans:w,type:"add",keys:g,values:A,wantResults:v}).then(function(N){var S=N.numFailures,L=N.results,R=N.lastResult,N=N.failures;if(S===0)return v?L:R;throw new Ie("".concat(p.name,".bulkAdd(): ").concat(S," of ").concat(T," operations failed"),N)})})},Ce.prototype.bulkPut=function(o,c,h){var p=this,g=Array.isArray(c)?c:void 0,v=(h=h||(g?void 0:c))?h.allKeys:void 0;return this._trans("readwrite",function(w){var A=p.schema.primKey,x=A.auto,A=A.keyPath;if(A&&g)throw new ue.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(g&&g.length!==o.length)throw new ue.InvalidArgument("Arguments objects and keys must have the same length");var T=o.length,A=A&&x?o.map(nn(A)):o;return p.core.mutate({trans:w,type:"put",keys:g,values:A,wantResults:v}).then(function(N){var S=N.numFailures,L=N.results,R=N.lastResult,N=N.failures;if(S===0)return v?L:R;throw new Ie("".concat(p.name,".bulkPut(): ").concat(S," of ").concat(T," operations failed"),N)})})},Ce.prototype.bulkUpdate=function(o){var c=this,h=this.core,p=o.map(function(w){return w.key}),g=o.map(function(w){return w.changes}),v=[];return this._trans("readwrite",function(w){return h.getMany({trans:w,keys:p,cache:"clone"}).then(function(x){var T=[],A=[];o.forEach(function(S,L){var R=S.key,N=S.changes,U=x[L];if(U){for(var B=0,D=Object.keys(N);B<D.length;B++){var K=D[B],M=N[K];if(K===c.schema.primKey.keyPath){if(Ae(M,R)!==0)throw new ue.Constraint("Cannot update primary key in bulkUpdate()")}else j(U,K,M)}v.push(L),T.push(R),A.push(U)}});var P=T.length;return h.mutate({trans:w,type:"put",keys:T,values:A,updates:{keys:p,changeSpecs:g}}).then(function(S){var L=S.numFailures,R=S.failures;if(L===0)return P;for(var N=0,U=Object.keys(R);N<U.length;N++){var B,D=U[N],K=v[Number(D)];K!=null&&(B=R[D],delete R[D],R[K]=B)}throw new Ie("".concat(c.name,".bulkUpdate(): ").concat(L," of ").concat(P," operations failed"),R)})})})},Ce.prototype.bulkDelete=function(o){var c=this,h=o.length;return this._trans("readwrite",function(p){return c.core.mutate({trans:p,type:"delete",keys:o})}).then(function(w){var g=w.numFailures,v=w.lastResult,w=w.failures;if(g===0)return v;throw new Ie("".concat(c.name,".bulkDelete(): ").concat(g," of ").concat(h," operations failed"),w)})},Ce);function Ce(){}function Ot(o){function c(w,x){if(x){for(var T=arguments.length,A=new Array(T-1);--T;)A[T-1]=arguments[T];return h[w].subscribe.apply(null,A),o}if(typeof w=="string")return h[w]}var h={};c.addEventType=v;for(var p=1,g=arguments.length;p<g;++p)v(arguments[p]);return c;function v(w,x,T){if(typeof w!="object"){var A;x=x||qr;var P={subscribers:[],fire:T=T||ve,subscribe:function(S){P.subscribers.indexOf(S)===-1&&(P.subscribers.push(S),P.fire=x(P.fire,S))},unsubscribe:function(S){P.subscribers=P.subscribers.filter(function(L){return L!==S}),P.fire=P.subscribers.reduce(x,T)}};return h[w]=c[w]=P}u(A=w).forEach(function(S){var L=A[S];if(l(L))v(S,A[S][0],A[S][1]);else{if(L!=="asap")throw new ue.InvalidArgument("Invalid event config");var R=v(S,Be,function(){for(var N=arguments.length,U=new Array(N);N--;)U[N]=arguments[N];R.subscribers.forEach(function(B){oe(function(){B.apply(null,U)})})})}})}}function Dt(o,c){return $(c).from({prototype:o}),c}function Rt(o,c){return!(o.filter||o.algorithm||o.or)&&(c?o.justLimit:!o.replayFilter)}function Bn(o,c){o.filter=vt(o.filter,c)}function Nn(o,c,h){var p=o.replayFilter;o.replayFilter=p?function(){return vt(p(),c())}:c,o.justLimit=h&&!p}function rn(o,c){if(o.isPrimKey)return c.primaryKey;var h=c.getIndexByKeyPath(o.index);if(!h)throw new ue.Schema("KeyPath "+o.index+" on object store "+c.name+" is not indexed");return h}function pr(o,c,h){var p=rn(o,c.schema);return c.openCursor({trans:h,values:!o.keysOnly,reverse:o.dir==="prev",unique:!!o.unique,query:{index:p,range:o.range}})}function sn(o,c,h,p){var g=o.replayFilter?vt(o.filter,o.replayFilter()):o.filter;if(o.or){var v={},w=function(x,T,A){var P,S;g&&!g(T,A,function(L){return T.stop(L)},function(L){return T.fail(L)})||((S=""+(P=T.primaryKey))=="[object ArrayBuffer]"&&(S=""+new Uint8Array(P)),m(v,S)||(v[S]=!0,c(x,T,A)))};return Promise.all([o.or._iterate(w,h),yr(pr(o,p,h),o.algorithm,w,!o.keysOnly&&o.valueMapper)])}return yr(pr(o,p,h),vt(o.algorithm,g),c,!o.keysOnly&&o.valueMapper)}function yr(o,c,h,p){var g=Ne(p?function(v,w,x){return h(p(v),w,x)}:h);return o.then(function(v){if(v)return v.start(function(){var w=function(){return v.continue()};c&&!c(v,function(x){return w=x},function(x){v.stop(x),w=ve},function(x){v.fail(x),w=ve})||g(v.value,v,function(x){return w=x}),w()})})}var rt=Symbol(),Ft=(gr.prototype.execute=function(o){if(this.add!==void 0){var c=this.add;if(l(c))return s(s([],l(o)?o:[],!0),c).sort();if(typeof c=="number")return(Number(o)||0)+c;if(typeof c=="bigint")try{return BigInt(o)+c}catch{return BigInt(0)+c}throw new TypeError("Invalid term ".concat(c))}if(this.remove!==void 0){var h=this.remove;if(l(h))return l(o)?o.filter(function(p){return!h.includes(p)}).sort():[];if(typeof h=="number")return Number(o)-h;if(typeof h=="bigint")try{return BigInt(o)-h}catch{return BigInt(0)-h}throw new TypeError("Invalid subtrahend ".concat(h))}return c=(c=this.replacePrefix)===null||c===void 0?void 0:c[0],c&&typeof o=="string"&&o.startsWith(c)?this.replacePrefix[1]+o.substring(c.length):o},gr);function gr(o){Object.assign(this,o)}var Zr=(Re.prototype._read=function(o,c){var h=this._ctx;return h.error?h.table._trans(null,Pe.bind(null,h.error)):h.table._trans("readonly",o).then(c)},Re.prototype._write=function(o){var c=this._ctx;return c.error?c.table._trans(null,Pe.bind(null,c.error)):c.table._trans("readwrite",o,"locked")},Re.prototype._addAlgorithm=function(o){var c=this._ctx;c.algorithm=vt(c.algorithm,o)},Re.prototype._iterate=function(o,c){return sn(this._ctx,o,c,this._ctx.table.core)},Re.prototype.clone=function(o){var c=Object.create(this.constructor.prototype),h=Object.create(this._ctx);return o&&f(h,o),c._ctx=h,c},Re.prototype.raw=function(){return this._ctx.valueMapper=null,this},Re.prototype.each=function(o){var c=this._ctx;return this._read(function(h){return sn(c,o,h,c.table.core)})},Re.prototype.count=function(o){var c=this;return this._read(function(h){var p=c._ctx,g=p.table.core;if(Rt(p,!0))return g.count({trans:h,query:{index:rn(p,g.schema),range:p.range}}).then(function(w){return Math.min(w,p.limit)});var v=0;return sn(p,function(){return++v,!1},h,g).then(function(){return v})}).then(o)},Re.prototype.sortBy=function(o,c){var h=o.split(".").reverse(),p=h[0],g=h.length-1;function v(T,A){return A?v(T[h[A]],A-1):T[p]}var w=this._ctx.dir==="next"?1:-1;function x(T,A){return T=v(T,g),A=v(A,g),T<A?-w:A<T?w:0}return this.toArray(function(T){return T.sort(x)}).then(c)},Re.prototype.toArray=function(o){var c=this;return this._read(function(h){var p=c._ctx;if(p.dir==="next"&&Rt(p,!0)&&0<p.limit){var g=p.valueMapper,v=rn(p,p.table.core.schema);return p.table.core.query({trans:h,limit:p.limit,values:!0,query:{index:v,range:p.range}}).then(function(x){return x=x.result,g?x.map(g):x})}var w=[];return sn(p,function(x){return w.push(x)},h,p.table.core).then(function(){return w})},o)},Re.prototype.offset=function(o){var c=this._ctx;return o<=0||(c.offset+=o,Rt(c)?Nn(c,function(){var h=o;return function(p,g){return h===0||(h===1?--h:g(function(){p.advance(h),h=0}),!1)}}):Nn(c,function(){var h=o;return function(){return--h<0}})),this},Re.prototype.limit=function(o){return this._ctx.limit=Math.min(this._ctx.limit,o),Nn(this._ctx,function(){var c=o;return function(h,p,g){return--c<=0&&p(g),0<=c}},!0),this},Re.prototype.until=function(o,c){return Bn(this._ctx,function(h,p,g){return!o(h.value)||(p(g),c)}),this},Re.prototype.first=function(o){return this.limit(1).toArray(function(c){return c[0]}).then(o)},Re.prototype.last=function(o){return this.reverse().first(o)},Re.prototype.filter=function(o){var c;return Bn(this._ctx,function(h){return o(h.value)}),(c=this._ctx).isMatch=vt(c.isMatch,o),this},Re.prototype.and=function(o){return this.filter(o)},Re.prototype.or=function(o){return new this.db.WhereClause(this._ctx.table,o,this)},Re.prototype.reverse=function(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},Re.prototype.desc=function(){return this.reverse()},Re.prototype.eachKey=function(o){var c=this._ctx;return c.keysOnly=!c.isMatch,this.each(function(h,p){o(p.key,p)})},Re.prototype.eachUniqueKey=function(o){return this._ctx.unique="unique",this.eachKey(o)},Re.prototype.eachPrimaryKey=function(o){var c=this._ctx;return c.keysOnly=!c.isMatch,this.each(function(h,p){o(p.primaryKey,p)})},Re.prototype.keys=function(o){var c=this._ctx;c.keysOnly=!c.isMatch;var h=[];return this.each(function(p,g){h.push(g.key)}).then(function(){return h}).then(o)},Re.prototype.primaryKeys=function(o){var c=this._ctx;if(c.dir==="next"&&Rt(c,!0)&&0<c.limit)return this._read(function(p){var g=rn(c,c.table.core.schema);return c.table.core.query({trans:p,values:!1,limit:c.limit,query:{index:g,range:c.range}})}).then(function(p){return p.result}).then(o);c.keysOnly=!c.isMatch;var h=[];return this.each(function(p,g){h.push(g.primaryKey)}).then(function(){return h}).then(o)},Re.prototype.uniqueKeys=function(o){return this._ctx.unique="unique",this.keys(o)},Re.prototype.firstKey=function(o){return this.limit(1).keys(function(c){return c[0]}).then(o)},Re.prototype.lastKey=function(o){return this.reverse().firstKey(o)},Re.prototype.distinct=function(){var o=this._ctx,o=o.index&&o.table.schema.idxByName[o.index];if(!o||!o.multi)return this;var c={};return Bn(this._ctx,function(g){var p=g.primaryKey.toString(),g=m(c,p);return c[p]=!0,!g}),this},Re.prototype.modify=function(o){var c=this,h=this._ctx;return this._write(function(p){var g,v,w;w=typeof o=="function"?o:(g=u(o),v=g.length,function(B){for(var D=!1,K=0;K<v;++K){var M=g[K],z=o[M],J=V(B,M);z instanceof Ft?(j(B,M,z.execute(J)),D=!0):J!==z&&(j(B,M,z),D=!0)}return D});function x(B,M){var K=M.failures,M=M.numFailures;N+=B-M;for(var z=0,J=u(K);z<J.length;z++){var re=J[z];R.push(K[re])}}var T=h.table.core,A=T.schema.primaryKey,P=A.outbound,S=A.extractKey,L=c.db._options.modifyChunkSize||200,R=[],N=0,U=[];return c.clone().primaryKeys().then(function(B){function D(M){var z=Math.min(L,B.length-M);return T.getMany({trans:p,keys:B.slice(M,M+z),cache:"immutable"}).then(function(J){for(var re=[],X=[],ne=P?[]:null,ie=[],Z=0;Z<z;++Z){var Ee=J[Z],_e={value:be(Ee),primKey:B[M+Z]};w.call(_e,_e.value,_e)!==!1&&(_e.value==null?ie.push(B[M+Z]):P||Ae(S(Ee),S(_e.value))===0?(X.push(_e.value),P&&ne.push(B[M+Z])):(ie.push(B[M+Z]),re.push(_e.value)))}return Promise.resolve(0<re.length&&T.mutate({trans:p,type:"add",values:re}).then(function(Se){for(var ke in Se.failures)ie.splice(parseInt(ke),1);x(re.length,Se)})).then(function(){return(0<X.length||K&&typeof o=="object")&&T.mutate({trans:p,type:"put",keys:ne,values:X,criteria:K,changeSpec:typeof o!="function"&&o,isAdditionalChunk:0<M}).then(function(Se){return x(X.length,Se)})}).then(function(){return(0<ie.length||K&&o===In)&&T.mutate({trans:p,type:"delete",keys:ie,criteria:K,isAdditionalChunk:0<M}).then(function(Se){return x(ie.length,Se)})}).then(function(){return B.length>M+z&&D(M+L)})})}var K=Rt(h)&&h.limit===1/0&&(typeof o!="function"||o===In)&&{index:h.index,range:h.range};return D(0).then(function(){if(0<R.length)throw new Fe("Error modifying one or more objects",R,N,U);return B.length})})})},Re.prototype.delete=function(){var o=this._ctx,c=o.range;return Rt(o)&&(o.isPrimKey||c.type===3)?this._write(function(h){var p=o.table.core.schema.primaryKey,g=c;return o.table.core.count({trans:h,query:{index:p,range:g}}).then(function(v){return o.table.core.mutate({trans:h,type:"deleteRange",range:g}).then(function(w){var x=w.failures;if(w.lastResult,w.results,w=w.numFailures,w)throw new Fe("Could not delete some values",Object.keys(x).map(function(T){return x[T]}),v-w);return v-w})})}):this.modify(In)},Re);function Re(){}var In=function(o,c){return c.value=null};function Yr(o,c){return o<c?-1:o===c?0:1}function Jr(o,c){return c<o?-1:o===c?0:1}function Ge(o,c,h){return o=o instanceof br?new o.Collection(o):o,o._ctx.error=new(h||TypeError)(c),o}function Tt(o){return new o.Collection(o,function(){return mr("")}).limit(0)}function on(o,c,h,p){var g,v,w,x,T,A,P,S=h.length;if(!h.every(function(N){return typeof N=="string"}))return Ge(o,cr);function L(N){g=N==="next"?function(B){return B.toUpperCase()}:function(B){return B.toLowerCase()},v=N==="next"?function(B){return B.toLowerCase()}:function(B){return B.toUpperCase()},w=N==="next"?Yr:Jr;var U=h.map(function(B){return{lower:v(B),upper:g(B)}}).sort(function(B,D){return w(B.lower,D.lower)});x=U.map(function(B){return B.upper}),T=U.map(function(B){return B.lower}),P=(A=N)==="next"?"":p}L("next"),o=new o.Collection(o,function(){return lt(x[0],T[S-1]+p)}),o._ondirectionchange=function(N){L(N)};var R=0;return o._addAlgorithm(function(N,U,B){var D=N.key;if(typeof D!="string")return!1;var K=v(D);if(c(K,T,R))return!0;for(var M=null,z=R;z<S;++z){var J=function(re,X,ne,ie,Z,Ee){for(var _e=Math.min(re.length,ie.length),Se=-1,ke=0;ke<_e;++ke){var Xe=X[ke];if(Xe!==ie[ke])return Z(re[ke],ne[ke])<0?re.substr(0,ke)+ne[ke]+ne.substr(ke+1):Z(re[ke],ie[ke])<0?re.substr(0,ke)+ie[ke]+ne.substr(ke+1):0<=Se?re.substr(0,Se)+X[Se]+ne.substr(Se+1):null;Z(re[ke],Xe)<0&&(Se=ke)}return _e<ie.length&&Ee==="next"?re+ne.substr(re.length):_e<re.length&&Ee==="prev"?re.substr(0,ne.length):Se<0?null:re.substr(0,Se)+ie[Se]+ne.substr(Se+1)}(D,K,x[z],T[z],w,A);J===null&&M===null?R=z+1:(M===null||0<w(M,J))&&(M=J)}return U(M!==null?function(){N.continue(M+P)}:B),!1}),o}function lt(o,c,h,p){return{type:2,lower:o,upper:c,lowerOpen:h,upperOpen:p}}function mr(o){return{type:1,lower:o,upper:o}}var br=(Object.defineProperty(De.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0}),De.prototype.between=function(o,c,h,p){h=h!==!1,p=p===!0;try{return 0<this._cmp(o,c)||this._cmp(o,c)===0&&(h||p)&&(!h||!p)?Tt(this):new this.Collection(this,function(){return lt(o,c,!h,!p)})}catch{return Ge(this,nt)}},De.prototype.equals=function(o){return o==null?Ge(this,nt):new this.Collection(this,function(){return mr(o)})},De.prototype.above=function(o){return o==null?Ge(this,nt):new this.Collection(this,function(){return lt(o,void 0,!0)})},De.prototype.aboveOrEqual=function(o){return o==null?Ge(this,nt):new this.Collection(this,function(){return lt(o,void 0,!1)})},De.prototype.below=function(o){return o==null?Ge(this,nt):new this.Collection(this,function(){return lt(void 0,o,!1,!0)})},De.prototype.belowOrEqual=function(o){return o==null?Ge(this,nt):new this.Collection(this,function(){return lt(void 0,o)})},De.prototype.startsWith=function(o){return typeof o!="string"?Ge(this,cr):this.between(o,o+bt,!0,!0)},De.prototype.startsWithIgnoreCase=function(o){return o===""?this.startsWith(o):on(this,function(c,h){return c.indexOf(h[0])===0},[o],bt)},De.prototype.equalsIgnoreCase=function(o){return on(this,function(c,h){return c===h[0]},[o],"")},De.prototype.anyOfIgnoreCase=function(){var o=ye.apply(he,arguments);return o.length===0?Tt(this):on(this,function(c,h){return h.indexOf(c)!==-1},o,"")},De.prototype.startsWithAnyOfIgnoreCase=function(){var o=ye.apply(he,arguments);return o.length===0?Tt(this):on(this,function(c,h){return h.some(function(p){return c.indexOf(p)===0})},o,bt)},De.prototype.anyOf=function(){var o=this,c=ye.apply(he,arguments),h=this._cmp;try{c.sort(h)}catch{return Ge(this,nt)}if(c.length===0)return Tt(this);var p=new this.Collection(this,function(){return lt(c[0],c[c.length-1])});p._ondirectionchange=function(v){h=v==="next"?o._ascending:o._descending,c.sort(h)};var g=0;return p._addAlgorithm(function(v,w,x){for(var T=v.key;0<h(T,c[g]);)if(++g===c.length)return w(x),!1;return h(T,c[g])===0||(w(function(){v.continue(c[g])}),!1)}),p},De.prototype.notEqual=function(o){return this.inAnyRange([[-1/0,o],[o,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})},De.prototype.noneOf=function(){var o=ye.apply(he,arguments);if(o.length===0)return new this.Collection(this);try{o.sort(this._ascending)}catch{return Ge(this,nt)}var c=o.reduce(function(h,p){return h?h.concat([[h[h.length-1][1],p]]):[[-1/0,p]]},null);return c.push([o[o.length-1],this.db._maxKey]),this.inAnyRange(c,{includeLowers:!1,includeUppers:!1})},De.prototype.inAnyRange=function(D,c){var h=this,p=this._cmp,g=this._ascending,v=this._descending,w=this._min,x=this._max;if(D.length===0)return Tt(this);if(!D.every(function(K){return K[0]!==void 0&&K[1]!==void 0&&g(K[0],K[1])<=0}))return Ge(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",ue.InvalidArgument);var T=!c||c.includeLowers!==!1,A=c&&c.includeUppers===!0,P,S=g;function L(K,M){return S(K[0],M[0])}try{(P=D.reduce(function(K,M){for(var z=0,J=K.length;z<J;++z){var re=K[z];if(p(M[0],re[1])<0&&0<p(M[1],re[0])){re[0]=w(re[0],M[0]),re[1]=x(re[1],M[1]);break}}return z===J&&K.push(M),K},[])).sort(L)}catch{return Ge(this,nt)}var R=0,N=A?function(K){return 0<g(K,P[R][1])}:function(K){return 0<=g(K,P[R][1])},U=T?function(K){return 0<v(K,P[R][0])}:function(K){return 0<=v(K,P[R][0])},B=N,D=new this.Collection(this,function(){return lt(P[0][0],P[P.length-1][1],!T,!A)});return D._ondirectionchange=function(K){S=K==="next"?(B=N,g):(B=U,v),P.sort(L)},D._addAlgorithm(function(K,M,z){for(var J,re=K.key;B(re);)if(++R===P.length)return M(z),!1;return!N(J=re)&&!U(J)||(h._cmp(re,P[R][1])===0||h._cmp(re,P[R][0])===0||M(function(){S===g?K.continue(P[R][0]):K.continue(P[R][1])}),!1)}),D},De.prototype.startsWithAnyOf=function(){var o=ye.apply(he,arguments);return o.every(function(c){return typeof c=="string"})?o.length===0?Tt(this):this.inAnyRange(o.map(function(c){return[c,c+bt]})):Ge(this,"startsWithAnyOf() only works with strings")},De);function De(){}function et(o){return Ne(function(c){return Kt(c),o(c.target.error),!1})}function Kt(o){o.stopPropagation&&o.stopPropagation(),o.preventDefault&&o.preventDefault()}var Mt="storagemutated",Pn="x-storagemutated-1",ht=Ot(null,Mt),Xr=(tt.prototype._lock=function(){return te(!pe.global),++this._reculock,this._reculock!==1||pe.global||(pe.lockOwnerFor=this),this},tt.prototype._unlock=function(){if(te(!pe.global),--this._reculock==0)for(pe.global||(pe.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var o=this._blockedFuncs.shift();try{mt(o[1],o[0])}catch{}}return this},tt.prototype._locked=function(){return this._reculock&&pe.lockOwnerFor!==this},tt.prototype.create=function(o){var c=this;if(!this.mode)return this;var h=this.db.idbdb,p=this.db._state.dbOpenError;if(te(!this.idbtrans),!o&&!h)switch(p&&p.name){case"DatabaseClosedError":throw new ue.DatabaseClosed(p);case"MissingAPIError":throw new ue.MissingAPI(p.message,p);default:throw new ue.OpenFailed(p)}if(!this.active)throw new ue.TransactionInactive;return te(this._completion._state===null),(o=this.idbtrans=o||(this.db.core||h).transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability})).onerror=Ne(function(g){Kt(g),c._reject(o.error)}),o.onabort=Ne(function(g){Kt(g),c.active&&c._reject(new ue.Abort(o.error)),c.active=!1,c.on("abort").fire(g)}),o.oncomplete=Ne(function(){c.active=!1,c._resolve(),"mutatedParts"in o&&ht.storagemutated.fire(o.mutatedParts)}),this},tt.prototype._promise=function(o,c,h){var p=this;if(o==="readwrite"&&this.mode!=="readwrite")return Pe(new ue.ReadOnly("Transaction is readonly"));if(!this.active)return Pe(new ue.TransactionInactive);if(this._locked())return new ae(function(v,w){p._blockedFuncs.push([function(){p._promise(o,c,h).then(v,w)},pe])});if(h)return ot(function(){var v=new ae(function(w,x){p._lock();var T=c(w,x,p);T&&T.then&&T.then(w,x)});return v.finally(function(){return p._unlock()}),v._lib=!0,v});var g=new ae(function(v,w){var x=c(v,w,p);x&&x.then&&x.then(v,w)});return g._lib=!0,g},tt.prototype._root=function(){return this.parent?this.parent._root():this},tt.prototype.waitFor=function(o){var c,h=this._root(),p=ae.resolve(o);h._waitingFor?h._waitingFor=h._waitingFor.then(function(){return p}):(h._waitingFor=p,h._waitingQueue=[],c=h.idbtrans.objectStore(h.storeNames[0]),function v(){for(++h._spinCount;h._waitingQueue.length;)h._waitingQueue.shift()();h._waitingFor&&(c.get(-1/0).onsuccess=v)}());var g=h._waitingFor;return new ae(function(v,w){p.then(function(x){return h._waitingQueue.push(Ne(v.bind(null,x)))},function(x){return h._waitingQueue.push(Ne(w.bind(null,x)))}).finally(function(){h._waitingFor===g&&(h._waitingFor=null)})})},tt.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new ue.Abort))},tt.prototype.table=function(o){var c=this._memoizedTables||(this._memoizedTables={});if(m(c,o))return c[o];var h=this.schema[o];if(!h)throw new ue.NotFound("Table "+o+" not part of transaction");return h=new this.db.Table(o,h,this),h.core=this.db.core.table(o),c[o]=h},tt);function tt(){}function Ln(o,c,h,p,g,v,w){return{name:o,keyPath:c,unique:h,multi:p,auto:g,compound:v,src:(h&&!w?"&":"")+(p?"*":"")+(g?"++":"")+vr(c)}}function vr(o){return typeof o=="string"?o:o?"["+[].join.call(o,"+")+"]":""}function Un(o,c,h){return{name:o,primKey:c,indexes:h,mappedClass:null,idxByName:(p=function(g){return[g.name,g]},h.reduce(function(g,v,w){return w=p(v,w),w&&(g[w[0]]=w[1]),g},{}))};var p}var Ht=function(o){try{return o.only([[]]),Ht=function(){return[[]]},[[]]}catch{return Ht=function(){return bt},bt}};function On(o){return o==null?function(){}:typeof o=="string"?(c=o).split(".").length===1?function(h){return h[c]}:function(h){return V(h,c)}:function(h){return V(h,o)};var c}function wr(o){return[].slice.call(o)}var Qr=0;function qt(o){return o==null?":id":typeof o=="string"?o:"[".concat(o.join("+"),"]")}function ei(o,c,T){function p(B){if(B.type===3)return null;if(B.type===4)throw new Error("Cannot convert never type to IDBKeyRange");var R=B.lower,N=B.upper,U=B.lowerOpen,B=B.upperOpen;return R===void 0?N===void 0?null:c.upperBound(N,!!B):N===void 0?c.lowerBound(R,!!U):c.bound(R,N,!!U,!!B)}function g(L){var R,N=L.name;return{name:N,schema:L,mutate:function(U){var B=U.trans,D=U.type,K=U.keys,M=U.values,z=U.range;return new Promise(function(J,re){J=Ne(J);var X=B.objectStore(N),ne=X.keyPath==null,ie=D==="put"||D==="add";if(!ie&&D!=="delete"&&D!=="deleteRange")throw new Error("Invalid operation type: "+D);var Z,Ee=(K||M||{length:1}).length;if(K&&M&&K.length!==M.length)throw new Error("Given keys array must have same length as given values array.");if(Ee===0)return J({numFailures:0,failures:{},results:[],lastResult:void 0});function _e(ze){++Xe,Kt(ze)}var Se=[],ke=[],Xe=0;if(D==="deleteRange"){if(z.type===4)return J({numFailures:Xe,failures:ke,results:[],lastResult:void 0});z.type===3?Se.push(Z=X.clear()):Se.push(Z=X.delete(p(z)))}else{var ne=ie?ne?[M,K]:[M,null]:[K,null],$e=ne[0],Me=ne[1];if(ie)for(var He=0;He<Ee;++He)Se.push(Z=Me&&Me[He]!==void 0?X[D]($e[He],Me[He]):X[D]($e[He])),Z.onerror=_e;else for(He=0;He<Ee;++He)Se.push(Z=X[D]($e[He])),Z.onerror=_e}function vn(ze){ze=ze.target.result,Se.forEach(function(_t,tr){return _t.error!=null&&(ke[tr]=_t.error)}),J({numFailures:Xe,failures:ke,results:D==="delete"?K:Se.map(function(_t){return _t.result}),lastResult:ze})}Z.onerror=function(ze){_e(ze),vn(ze)},Z.onsuccess=vn})},getMany:function(U){var B=U.trans,D=U.keys;return new Promise(function(K,M){K=Ne(K);for(var z,J=B.objectStore(N),re=D.length,X=new Array(re),ne=0,ie=0,Z=function(Se){Se=Se.target,X[Se._pos]=Se.result,++ie===ne&&K(X)},Ee=et(M),_e=0;_e<re;++_e)D[_e]!=null&&((z=J.get(D[_e]))._pos=_e,z.onsuccess=Z,z.onerror=Ee,++ne);ne===0&&K(X)})},get:function(U){var B=U.trans,D=U.key;return new Promise(function(K,M){K=Ne(K);var z=B.objectStore(N).get(D);z.onsuccess=function(J){return K(J.target.result)},z.onerror=et(M)})},query:(R=A,function(U){return new Promise(function(B,D){B=Ne(B);var K,M,z,ne=U.trans,J=U.values,re=U.limit,Z=U.query,X=re===1/0?void 0:re,ie=Z.index,Z=Z.range,ne=ne.objectStore(N),ie=ie.isPrimaryKey?ne:ne.index(ie.name),Z=p(Z);if(re===0)return B({result:[]});R?((X=J?ie.getAll(Z,X):ie.getAllKeys(Z,X)).onsuccess=function(Ee){return B({result:Ee.target.result})},X.onerror=et(D)):(K=0,M=!J&&"openKeyCursor"in ie?ie.openKeyCursor(Z):ie.openCursor(Z),z=[],M.onsuccess=function(Ee){var _e=M.result;return _e?(z.push(J?_e.value:_e.primaryKey),++K===re?B({result:z}):void _e.continue()):B({result:z})},M.onerror=et(D))})}),openCursor:function(U){var B=U.trans,D=U.values,K=U.query,M=U.reverse,z=U.unique;return new Promise(function(J,re){J=Ne(J);var ie=K.index,X=K.range,ne=B.objectStore(N),ne=ie.isPrimaryKey?ne:ne.index(ie.name),ie=M?z?"prevunique":"prev":z?"nextunique":"next",Z=!D&&"openKeyCursor"in ne?ne.openKeyCursor(p(X),ie):ne.openCursor(p(X),ie);Z.onerror=et(re),Z.onsuccess=Ne(function(Ee){var _e,Se,ke,Xe,$e=Z.result;$e?($e.___id=++Qr,$e.done=!1,_e=$e.continue.bind($e),Se=(Se=$e.continuePrimaryKey)&&Se.bind($e),ke=$e.advance.bind($e),Xe=function(){throw new Error("Cursor not stopped")},$e.trans=B,$e.stop=$e.continue=$e.continuePrimaryKey=$e.advance=function(){throw new Error("Cursor not started")},$e.fail=Ne(re),$e.next=function(){var Me=this,He=1;return this.start(function(){return He--?Me.continue():Me.stop()}).then(function(){return Me})},$e.start=function(Me){function He(){if(Z.result)try{Me()}catch(ze){$e.fail(ze)}else $e.done=!0,$e.start=function(){throw new Error("Cursor behind last entry")},$e.stop()}var vn=new Promise(function(ze,_t){ze=Ne(ze),Z.onerror=et(_t),$e.fail=_t,$e.stop=function(tr){$e.stop=$e.continue=$e.continuePrimaryKey=$e.advance=Xe,ze(tr)}});return Z.onsuccess=Ne(function(ze){Z.onsuccess=He,He()}),$e.continue=_e,$e.continuePrimaryKey=Se,$e.advance=ke,He(),vn},J($e)):J(null)},re)})},count:function(U){var B=U.query,D=U.trans,K=B.index,M=B.range;return new Promise(function(z,J){var re=D.objectStore(N),X=K.isPrimaryKey?re:re.index(K.name),re=p(M),X=re?X.count(re):X.count();X.onsuccess=Ne(function(ne){return z(ne.target.result)}),X.onerror=et(J)})}}}var v,w,x,P=(w=T,x=wr((v=o).objectStoreNames),{schema:{name:v.name,tables:x.map(function(L){return w.objectStore(L)}).map(function(L){var R=L.keyPath,B=L.autoIncrement,N=l(R),U={},B={name:L.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:R==null,compound:N,keyPath:R,autoIncrement:B,unique:!0,extractKey:On(R)},indexes:wr(L.indexNames).map(function(D){return L.index(D)}).map(function(z){var K=z.name,M=z.unique,J=z.multiEntry,z=z.keyPath,J={name:K,compound:l(z),keyPath:z,unique:M,multiEntry:J,extractKey:On(z)};return U[qt(z)]=J}),getIndexByKeyPath:function(D){return U[qt(D)]}};return U[":id"]=B.primaryKey,R!=null&&(U[qt(R)]=B.primaryKey),B})},hasGetAll:0<x.length&&"getAll"in w.objectStore(x[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}),T=P.schema,A=P.hasGetAll,P=T.tables.map(g),S={};return P.forEach(function(L){return S[L.name]=L}),{stack:"dbcore",transaction:o.transaction.bind(o),table:function(L){if(!S[L])throw new Error("Table '".concat(L,"' not found"));return S[L]},MIN_KEY:-1/0,MAX_KEY:Ht(c),schema:T}}function ti(o,c,h,p){var g=h.IDBKeyRange;return h.indexedDB,{dbcore:(p=ei(c,g,p),o.dbcore.reduce(function(v,w){return w=w.create,r(r({},v),w(v))},p))}}function an(o,p){var h=p.db,p=ti(o._middlewares,h,o._deps,p);o.core=p.dbcore,o.tables.forEach(function(g){var v=g.name;o.core.schema.tables.some(function(w){return w.name===v})&&(g.core=o.core.table(v),o[v]instanceof o.Table&&(o[v].core=g.core))})}function cn(o,c,h,p){h.forEach(function(g){var v=p[g];c.forEach(function(w){var x=function T(A,P){return k(A,P)||(A=y(A))&&T(A,P)}(w,g);(!x||"value"in x&&x.value===void 0)&&(w===o.Transaction.prototype||w instanceof o.Transaction?O(w,g,{get:function(){return this.table(g)},set:function(T){C(this,g,{value:T,writable:!0,configurable:!0,enumerable:!0})}}):w[g]=new o.Table(g,v))})})}function Dn(o,c){c.forEach(function(h){for(var p in h)h[p]instanceof o.Table&&delete h[p]})}function ni(o,c){return o._cfg.version-c._cfg.version}function ri(o,c,h,p){var g=o._dbSchema;h.objectStoreNames.contains("$meta")&&!g.$meta&&(g.$meta=Un("$meta",_r("")[0],[]),o._storeNames.push("$meta"));var v=o._createTransaction("readwrite",o._storeNames,g);v.create(h),v._completion.catch(p);var w=v._reject.bind(v),x=pe.transless||pe;ot(function(){return pe.trans=v,pe.transless=x,c!==0?(an(o,h),A=c,((T=v).storeNames.includes("$meta")?T.table("$meta").get("version").then(function(P){return P??A}):ae.resolve(A)).then(function(P){return L=P,R=v,N=h,U=[],P=(S=o)._versions,B=S._dbSchema=ln(0,S.idbdb,N),(P=P.filter(function(D){return D._cfg.version>=L})).length!==0?(P.forEach(function(D){U.push(function(){var K=B,M=D._cfg.dbschema;hn(S,K,N),hn(S,M,N),B=S._dbSchema=M;var z=Fn(K,M);z.add.forEach(function(ie){Kn(N,ie[0],ie[1].primKey,ie[1].indexes)}),z.change.forEach(function(ie){if(ie.recreate)throw new ue.Upgrade("Not yet support for changing primary key");var Z=N.objectStore(ie.name);ie.add.forEach(function(Ee){return un(Z,Ee)}),ie.change.forEach(function(Ee){Z.deleteIndex(Ee.name),un(Z,Ee)}),ie.del.forEach(function(Ee){return Z.deleteIndex(Ee)})});var J=D._cfg.contentUpgrade;if(J&&D._cfg.version>L){an(S,N),R._memoizedTables={};var re=G(M);z.del.forEach(function(ie){re[ie]=K[ie]}),Dn(S,[S.Transaction.prototype]),cn(S,[S.Transaction.prototype],u(re),re),R.schema=re;var X,ne=we(J);return ne&&St(),z=ae.follow(function(){var ie;(X=J(R))&&ne&&(ie=at.bind(null,null),X.then(ie,ie))}),X&&typeof X.then=="function"?ae.resolve(X):z.then(function(){return X})}}),U.push(function(K){var M,z,J=D._cfg.dbschema;M=J,z=K,[].slice.call(z.db.objectStoreNames).forEach(function(re){return M[re]==null&&z.db.deleteObjectStore(re)}),Dn(S,[S.Transaction.prototype]),cn(S,[S.Transaction.prototype],S._storeNames,S._dbSchema),R.schema=S._dbSchema}),U.push(function(K){S.idbdb.objectStoreNames.contains("$meta")&&(Math.ceil(S.idbdb.version/10)===D._cfg.version?(S.idbdb.deleteObjectStore("$meta"),delete S._dbSchema.$meta,S._storeNames=S._storeNames.filter(function(M){return M!=="$meta"})):K.objectStore("$meta").put(D._cfg.version,"version"))})}),function D(){return U.length?ae.resolve(U.shift()(R.idbtrans)).then(D):ae.resolve()}().then(function(){Er(B,N)})):ae.resolve();var S,L,R,N,U,B}).catch(w)):(u(g).forEach(function(P){Kn(h,P,g[P].primKey,g[P].indexes)}),an(o,h),void ae.follow(function(){return o.on.populate.fire(v)}).catch(w));var T,A})}function ii(o,c){Er(o._dbSchema,c),c.db.version%10!=0||c.objectStoreNames.contains("$meta")||c.db.createObjectStore("$meta").add(Math.ceil(c.db.version/10-1),"version");var h=ln(0,o.idbdb,c);hn(o,o._dbSchema,c);for(var p=0,g=Fn(h,o._dbSchema).change;p<g.length;p++){var v=function(w){if(w.change.length||w.recreate)return console.warn("Unable to patch indexes of table ".concat(w.name," because it has changes on the type of index or primary key.")),{value:void 0};var x=c.objectStore(w.name);w.add.forEach(function(T){Qe&&console.debug("Dexie upgrade patch: Creating missing index ".concat(w.name,".").concat(T.src)),un(x,T)})}(g[p]);if(typeof v=="object")return v.value}}function Fn(o,c){var h,p={del:[],add:[],change:[]};for(h in o)c[h]||p.del.push(h);for(h in c){var g=o[h],v=c[h];if(g){var w={name:h,def:v,recreate:!1,del:[],add:[],change:[]};if(""+(g.primKey.keyPath||"")!=""+(v.primKey.keyPath||"")||g.primKey.auto!==v.primKey.auto)w.recreate=!0,p.change.push(w);else{var x=g.idxByName,T=v.idxByName,A=void 0;for(A in x)T[A]||w.del.push(A);for(A in T){var P=x[A],S=T[A];P?P.src!==S.src&&w.change.push(S):w.add.push(S)}(0<w.del.length||0<w.add.length||0<w.change.length)&&p.change.push(w)}}else p.add.push([h,v])}return p}function Kn(o,c,h,p){var g=o.db.createObjectStore(c,h.keyPath?{keyPath:h.keyPath,autoIncrement:h.auto}:{autoIncrement:h.auto});return p.forEach(function(v){return un(g,v)}),g}function Er(o,c){u(o).forEach(function(h){c.db.objectStoreNames.contains(h)||(Qe&&console.debug("Dexie: Creating missing table",h),Kn(c,h,o[h].primKey,o[h].indexes))})}function un(o,c){o.createIndex(c.name,c.keyPath,{unique:c.unique,multiEntry:c.multi})}function ln(o,c,h){var p={};return q(c.objectStoreNames,0).forEach(function(g){for(var v=h.objectStore(g),w=Ln(vr(A=v.keyPath),A||"",!0,!1,!!v.autoIncrement,A&&typeof A!="string",!0),x=[],T=0;T<v.indexNames.length;++T){var P=v.index(v.indexNames[T]),A=P.keyPath,P=Ln(P.name,A,!!P.unique,!!P.multiEntry,!1,A&&typeof A!="string",!1);x.push(P)}p[g]=Un(g,w,x)}),p}function hn(o,c,h){for(var p=h.db.objectStoreNames,g=0;g<p.length;++g){var v=p[g],w=h.objectStore(v);o._hasGetAll="getAll"in w;for(var x=0;x<w.indexNames.length;++x){var T=w.indexNames[x],A=w.index(T).keyPath,P=typeof A=="string"?A:"["+q(A).join("+")+"]";!c[v]||(A=c[v].idxByName[P])&&(A.name=T,delete c[v].idxByName[P],c[v].idxByName[T]=A)}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&a.WorkerGlobalScope&&a instanceof a.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(o._hasGetAll=!1)}function _r(o){return o.split(",").map(function(c,h){var p=(c=c.trim()).replace(/([&*]|\+\+)/g,""),g=/^\[/.test(p)?p.match(/^\[(.*)\]$/)[1].split("+"):p;return Ln(p,g||null,/\&/.test(c),/\*/.test(c),/\+\+/.test(c),l(g),h===0)})}var si=(fn.prototype._parseStoresSpec=function(o,c){u(o).forEach(function(h){if(o[h]!==null){var p=_r(o[h]),g=p.shift();if(g.unique=!0,g.multi)throw new ue.Schema("Primary key cannot be multi-valued");p.forEach(function(v){if(v.auto)throw new ue.Schema("Only primary key can be marked as autoIncrement (++)");if(!v.keyPath)throw new ue.Schema("Index must have a name and cannot be an empty string")}),c[h]=Un(h,g,p)}})},fn.prototype.stores=function(h){var c=this.db;this._cfg.storesSource=this._cfg.storesSource?f(this._cfg.storesSource,h):h;var h=c._versions,p={},g={};return h.forEach(function(v){f(p,v._cfg.storesSource),g=v._cfg.dbschema={},v._parseStoresSpec(p,g)}),c._dbSchema=g,Dn(c,[c._allTables,c,c.Transaction.prototype]),cn(c,[c._allTables,c,c.Transaction.prototype,this._cfg.tables],u(g),g),c._storeNames=u(g),this},fn.prototype.upgrade=function(o){return this._cfg.contentUpgrade=wn(this._cfg.contentUpgrade||ve,o),this},fn);function fn(){}function Mn(o,c){var h=o._dbNamesDB;return h||(h=o._dbNamesDB=new it(tn,{addons:[],indexedDB:o,IDBKeyRange:c})).version(1).stores({dbnames:"name"}),h.table("dbnames")}function Hn(o){return o&&typeof o.databases=="function"}function qn(o){return ot(function(){return pe.letThrough=!0,o()})}function zn(o){return!("from"in o)}var qe=function(o,c){if(!this){var h=new qe;return o&&"d"in o&&f(h,o),h}f(this,arguments.length?{d:1,from:o,to:1<arguments.length?c:o}:{d:0})};function zt(o,c,h){var p=Ae(c,h);if(!isNaN(p)){if(0<p)throw RangeError();if(zn(o))return f(o,{from:c,to:h,d:1});var g=o.l,p=o.r;if(Ae(h,o.from)<0)return g?zt(g,c,h):o.l={from:c,to:h,d:1,l:null,r:null},kr(o);if(0<Ae(c,o.to))return p?zt(p,c,h):o.r={from:c,to:h,d:1,l:null,r:null},kr(o);Ae(c,o.from)<0&&(o.from=c,o.l=null,o.d=p?p.d+1:1),0<Ae(h,o.to)&&(o.to=h,o.r=null,o.d=o.l?o.l.d+1:1),h=!o.r,g&&!o.l&&jt(o,g),p&&h&&jt(o,p)}}function jt(o,c){zn(c)||function h(p,T){var v=T.from,w=T.to,x=T.l,T=T.r;zt(p,v,w),x&&h(p,x),T&&h(p,T)}(o,c)}function xr(o,c){var h=dn(c),p=h.next();if(p.done)return!1;for(var g=p.value,v=dn(o),w=v.next(g.from),x=w.value;!p.done&&!w.done;){if(Ae(x.from,g.to)<=0&&0<=Ae(x.to,g.from))return!0;Ae(g.from,x.from)<0?g=(p=h.next(x.from)).value:x=(w=v.next(g.from)).value}return!1}function dn(o){var c=zn(o)?null:{s:0,n:o};return{next:function(h){for(var p=0<arguments.length;c;)switch(c.s){case 0:if(c.s=1,p)for(;c.n.l&&Ae(h,c.n.from)<0;)c={up:c,n:c.n.l,s:1};else for(;c.n.l;)c={up:c,n:c.n.l,s:1};case 1:if(c.s=2,!p||Ae(h,c.n.to)<=0)return{value:c.n,done:!1};case 2:if(c.n.r){c.s=3,c={up:c,n:c.n.r,s:0};continue}case 3:c=c.up}return{done:!0}}}}function kr(o){var c,h,p=(((c=o.r)===null||c===void 0?void 0:c.d)||0)-(((h=o.l)===null||h===void 0?void 0:h.d)||0),g=1<p?"r":p<-1?"l":"";g&&(c=g=="r"?"l":"r",h=r({},o),p=o[g],o.from=p.from,o.to=p.to,o[g]=p[g],h[g]=p[c],(o[c]=h).d=$r(h)),o.d=$r(o)}function $r(h){var c=h.r,h=h.l;return(c?h?Math.max(c.d,h.d):c.d:h?h.d:0)+1}function pn(o,c){return u(c).forEach(function(h){o[h]?jt(o[h],c[h]):o[h]=function p(g){var v,w,x={};for(v in g)m(g,v)&&(w=g[v],x[v]=!w||typeof w!="object"||ce.has(w.constructor)?w:p(w));return x}(c[h])}),o}function jn(o,c){return o.all||c.all||Object.keys(o).some(function(h){return c[h]&&xr(c[h],o[h])})}E(qe.prototype,((Ye={add:function(o){return jt(this,o),this},addKey:function(o){return zt(this,o,o),this},addKeys:function(o){var c=this;return o.forEach(function(h){return zt(c,h,h)}),this},hasKey:function(o){var c=dn(this).next(o).value;return c&&Ae(c.from,o)<=0&&0<=Ae(c.to,o)}})[H]=function(){return dn(this)},Ye));var wt={},Vn={},Wn=!1;function yn(o){pn(Vn,o),Wn||(Wn=!0,setTimeout(function(){Wn=!1,Gn(Vn,!(Vn={}))},0))}function Gn(o,c){c===void 0&&(c=!1);var h=new Set;if(o.all)for(var p=0,g=Object.values(wt);p<g.length;p++)Sr(w=g[p],o,h,c);else for(var v in o){var w,x=/^idb\:\/\/(.*)\/(.*)\//.exec(v);x&&(v=x[1],x=x[2],(w=wt["idb://".concat(v,"/").concat(x)])&&Sr(w,o,h,c))}h.forEach(function(T){return T()})}function Sr(o,c,h,p){for(var g=[],v=0,w=Object.entries(o.queries.query);v<w.length;v++){for(var x=w[v],T=x[0],A=[],P=0,S=x[1];P<S.length;P++){var L=S[P];jn(c,L.obsSet)?L.subscribers.forEach(function(B){return h.add(B)}):p&&A.push(L)}p&&g.push([T,A])}if(p)for(var R=0,N=g;R<N.length;R++){var U=N[R],T=U[0],A=U[1];o.queries.query[T]=A}}function oi(o){var c=o._state,h=o._deps.indexedDB;if(c.isBeingOpened||o.idbdb)return c.dbReadyPromise.then(function(){return c.dbOpenError?Pe(c.dbOpenError):o});c.isBeingOpened=!0,c.dbOpenError=null,c.openComplete=!1;var p=c.openCanceller,g=Math.round(10*o.verno),v=!1;function w(){if(c.openCanceller!==p)throw new ue.DatabaseClosed("db.open() was cancelled")}function x(){return new ae(function(L,R){if(w(),!h)throw new ue.MissingAPI;var N=o.name,U=c.autoSchema||!g?h.open(N):h.open(N,g);if(!U)throw new ue.MissingAPI;U.onerror=et(R),U.onblocked=Ne(o._fireOnBlocked),U.onupgradeneeded=Ne(function(B){var D;P=U.transaction,c.autoSchema&&!o._options.allowEmptyDB?(U.onerror=Kt,P.abort(),U.result.close(),(D=h.deleteDatabase(N)).onsuccess=D.onerror=Ne(function(){R(new ue.NoSuchDatabase("Database ".concat(N," doesnt exist")))})):(P.onerror=et(R),B=B.oldVersion>Math.pow(2,62)?0:B.oldVersion,S=B<1,o.idbdb=U.result,v&&ii(o,P),ri(o,B/10,P,R))},R),U.onsuccess=Ne(function(){P=null;var B,D,K,M,z,J=o.idbdb=U.result,re=q(J.objectStoreNames);if(0<re.length)try{var X=J.transaction((M=re).length===1?M[0]:M,"readonly");if(c.autoSchema)D=J,K=X,(B=o).verno=D.version/10,K=B._dbSchema=ln(0,D,K),B._storeNames=q(D.objectStoreNames,0),cn(B,[B._allTables],u(K),K);else if(hn(o,o._dbSchema,X),((z=Fn(ln(0,(z=o).idbdb,X),z._dbSchema)).add.length||z.change.some(function(ne){return ne.add.length||ne.change.length}))&&!v)return console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Dexie will add missing parts and increment native version number to workaround this."),J.close(),g=J.version+1,v=!0,L(x());an(o,X)}catch{}At.push(o),J.onversionchange=Ne(function(ne){c.vcFired=!0,o.on("versionchange").fire(ne)}),J.onclose=Ne(function(ne){o.on("close").fire(ne)}),S&&(z=o._deps,X=N,J=z.indexedDB,z=z.IDBKeyRange,Hn(J)||X===tn||Mn(J,z).put({name:X}).catch(ve)),L()},R)}).catch(function(L){switch(L==null?void 0:L.name){case"UnknownError":if(0<c.PR1398_maxLoop)return c.PR1398_maxLoop--,console.warn("Dexie: Workaround for Chrome UnknownError on open()"),x();break;case"VersionError":if(0<g)return g=0,x()}return ae.reject(L)})}var T,A=c.dbReadyResolve,P=null,S=!1;return ae.race([p,(typeof navigator>"u"?ae.resolve():!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise(function(L){function R(){return indexedDB.databases().finally(L)}T=setInterval(R,100),R()}).finally(function(){return clearInterval(T)}):Promise.resolve()).then(x)]).then(function(){return w(),c.onReadyBeingFired=[],ae.resolve(qn(function(){return o.on.ready.fire(o.vip)})).then(function L(){if(0<c.onReadyBeingFired.length){var R=c.onReadyBeingFired.reduce(wn,ve);return c.onReadyBeingFired=[],ae.resolve(qn(function(){return R(o.vip)})).then(L)}})}).finally(function(){c.openCanceller===p&&(c.onReadyBeingFired=null,c.isBeingOpened=!1)}).catch(function(L){c.dbOpenError=L;try{P&&P.abort()}catch{}return p===c.openCanceller&&o._close(),Pe(L)}).finally(function(){c.openComplete=!0,A()}).then(function(){var L;return S&&(L={},o.tables.forEach(function(R){R.schema.indexes.forEach(function(N){N.name&&(L["idb://".concat(o.name,"/").concat(R.name,"/").concat(N.name)]=new qe(-1/0,[[[]]]))}),L["idb://".concat(o.name,"/").concat(R.name,"/")]=L["idb://".concat(o.name,"/").concat(R.name,"/:dels")]=new qe(-1/0,[[[]]])}),ht(Mt).fire(L),Gn(L,!0)),o})}function Zn(o){function c(v){return o.next(v)}var h=g(c),p=g(function(v){return o.throw(v)});function g(v){return function(T){var x=v(T),T=x.value;return x.done?T:T&&typeof T.then=="function"?T.then(h,p):l(T)?Promise.all(T).then(h,p):h(T)}}return g(c)()}function gn(o,c,h){for(var p=l(o)?o.slice():[o],g=0;g<h;++g)p.push(c);return p}var ai={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(o){return r(r({},o),{table:function(c){var h=o.table(c),p=h.schema,g={},v=[];function w(S,L,R){var N=qt(S),U=g[N]=g[N]||[],B=S==null?0:typeof S=="string"?1:S.length,D=0<L,D=r(r({},R),{name:D?"".concat(N,"(virtual-from:").concat(R.name,")"):R.name,lowLevelIndex:R,isVirtual:D,keyTail:L,keyLength:B,extractKey:On(S),unique:!D&&R.unique});return U.push(D),D.isPrimaryKey||v.push(D),1<B&&w(B===2?S[0]:S.slice(0,B-1),L+1,R),U.sort(function(K,M){return K.keyTail-M.keyTail}),D}c=w(p.primaryKey.keyPath,0,p.primaryKey),g[":id"]=[c];for(var x=0,T=p.indexes;x<T.length;x++){var A=T[x];w(A.keyPath,0,A)}function P(S){var L,R=S.query.index;return R.isVirtual?r(r({},S),{query:{index:R.lowLevelIndex,range:(L=S.query.range,R=R.keyTail,{type:L.type===1?2:L.type,lower:gn(L.lower,L.lowerOpen?o.MAX_KEY:o.MIN_KEY,R),lowerOpen:!0,upper:gn(L.upper,L.upperOpen?o.MIN_KEY:o.MAX_KEY,R),upperOpen:!0})}}):S}return r(r({},h),{schema:r(r({},p),{primaryKey:c,indexes:v,getIndexByKeyPath:function(S){return(S=g[qt(S)])&&S[0]}}),count:function(S){return h.count(P(S))},query:function(S){return h.query(P(S))},openCursor:function(S){var L=S.query.index,R=L.keyTail,N=L.isVirtual,U=L.keyLength;return N?h.openCursor(P(S)).then(function(D){return D&&B(D)}):h.openCursor(S);function B(D){return Object.create(D,{continue:{value:function(K){K!=null?D.continue(gn(K,S.reverse?o.MAX_KEY:o.MIN_KEY,R)):S.unique?D.continue(D.key.slice(0,U).concat(S.reverse?o.MIN_KEY:o.MAX_KEY,R)):D.continue()}},continuePrimaryKey:{value:function(K,M){D.continuePrimaryKey(gn(K,o.MAX_KEY,R),M)}},primaryKey:{get:function(){return D.primaryKey}},key:{get:function(){var K=D.key;return U===1?K[0]:K.slice(0,U)}},value:{get:function(){return D.value}}})}}})}})}};function Yn(o,c,h,p){return h=h||{},p=p||"",u(o).forEach(function(g){var v,w,x;m(c,g)?(v=o[g],w=c[g],typeof v=="object"&&typeof w=="object"&&v&&w?(x=F(v))!==F(w)?h[p+g]=c[g]:x==="Object"?Yn(v,w,h,p+g+"."):v!==w&&(h[p+g]=c[g]):v!==w&&(h[p+g]=c[g])):h[p+g]=void 0}),u(c).forEach(function(g){m(o,g)||(h[p+g]=c[g])}),h}function Jn(o,c){return c.type==="delete"?c.keys:c.keys||c.values.map(o.extractKey)}var ci={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(o){return r(r({},o),{table:function(c){var h=o.table(c),p=h.schema.primaryKey;return r(r({},h),{mutate:function(g){var v=pe.trans,w=v.table(c).hook,x=w.deleting,T=w.creating,A=w.updating;switch(g.type){case"add":if(T.fire===ve)break;return v._promise("readwrite",function(){return P(g)},!0);case"put":if(T.fire===ve&&A.fire===ve)break;return v._promise("readwrite",function(){return P(g)},!0);case"delete":if(x.fire===ve)break;return v._promise("readwrite",function(){return P(g)},!0);case"deleteRange":if(x.fire===ve)break;return v._promise("readwrite",function(){return function S(L,R,N){return h.query({trans:L,values:!1,query:{index:p,range:R},limit:N}).then(function(U){var B=U.result;return P({type:"delete",keys:B,trans:L}).then(function(D){return 0<D.numFailures?Promise.reject(D.failures[0]):B.length<N?{failures:[],numFailures:0,lastResult:void 0}:S(L,r(r({},R),{lower:B[B.length-1],lowerOpen:!0}),N)})})}(g.trans,g.range,1e4)},!0)}return h.mutate(g);function P(S){var L,R,N,U=pe.trans,B=S.keys||Jn(p,S);if(!B)throw new Error("Keys missing");return(S=S.type==="add"||S.type==="put"?r(r({},S),{keys:B}):r({},S)).type!=="delete"&&(S.values=s([],S.values)),S.keys&&(S.keys=s([],S.keys)),L=h,N=B,((R=S).type==="add"?Promise.resolve([]):L.getMany({trans:R.trans,keys:N,cache:"immutable"})).then(function(D){var K=B.map(function(M,z){var J,re,X,ne=D[z],ie={onerror:null,onsuccess:null};return S.type==="delete"?x.fire.call(ie,M,ne,U):S.type==="add"||ne===void 0?(J=T.fire.call(ie,M,S.values[z],U),M==null&&J!=null&&(S.keys[z]=M=J,p.outbound||j(S.values[z],p.keyPath,M))):(J=Yn(ne,S.values[z]),(re=A.fire.call(ie,J,M,ne,U))&&(X=S.values[z],Object.keys(re).forEach(function(Z){m(X,Z)?X[Z]=re[Z]:j(X,Z,re[Z])}))),ie});return h.mutate(S).then(function(M){for(var z=M.failures,J=M.results,re=M.numFailures,M=M.lastResult,X=0;X<B.length;++X){var ne=(J||B)[X],ie=K[X];ne==null?ie.onerror&&ie.onerror(z[X]):ie.onsuccess&&ie.onsuccess(S.type==="put"&&D[X]?S.values[X]:ne)}return{failures:z,results:J,numFailures:re,lastResult:M}}).catch(function(M){return K.forEach(function(z){return z.onerror&&z.onerror(M)}),Promise.reject(M)})})}}})}})}};function Ar(o,c,h){try{if(!c||c.keys.length<o.length)return null;for(var p=[],g=0,v=0;g<c.keys.length&&v<o.length;++g)Ae(c.keys[g],o[v])===0&&(p.push(h?be(c.values[g]):c.values[g]),++v);return p.length===o.length?p:null}catch{return null}}var ui={stack:"dbcore",level:-1,create:function(o){return{table:function(c){var h=o.table(c);return r(r({},h),{getMany:function(p){if(!p.cache)return h.getMany(p);var g=Ar(p.keys,p.trans._cache,p.cache==="clone");return g?ae.resolve(g):h.getMany(p).then(function(v){return p.trans._cache={keys:p.keys,values:p.cache==="clone"?be(v):v},v})},mutate:function(p){return p.type!=="add"&&(p.trans._cache=null),h.mutate(p)}})}}}};function Rr(o,c){return o.trans.mode==="readonly"&&!!o.subscr&&!o.trans.explicit&&o.trans.db._options.cache!=="disabled"&&!c.schema.primaryKey.outbound}function Tr(o,c){switch(o){case"query":return c.values&&!c.unique;case"get":case"getMany":case"count":case"openCursor":return!1}}var li={stack:"dbcore",level:0,name:"Observability",create:function(o){var c=o.schema.name,h=new qe(o.MIN_KEY,o.MAX_KEY);return r(r({},o),{transaction:function(p,g,v){if(pe.subscr&&g!=="readonly")throw new ue.ReadOnly("Readwrite transaction in liveQuery context. Querier source: ".concat(pe.querier));return o.transaction(p,g,v)},table:function(p){var g=o.table(p),v=g.schema,w=v.primaryKey,S=v.indexes,x=w.extractKey,T=w.outbound,A=w.autoIncrement&&S.filter(function(R){return R.compound&&R.keyPath.includes(w.keyPath)}),P=r(r({},g),{mutate:function(R){function N(Z){return Z="idb://".concat(c,"/").concat(p,"/").concat(Z),M[Z]||(M[Z]=new qe)}var U,B,D,K=R.trans,M=R.mutatedParts||(R.mutatedParts={}),z=N(""),J=N(":dels"),re=R.type,ie=R.type==="deleteRange"?[R.range]:R.type==="delete"?[R.keys]:R.values.length<50?[Jn(w,R).filter(function(Z){return Z}),R.values]:[],X=ie[0],ne=ie[1],ie=R.trans._cache;return l(X)?(z.addKeys(X),(ie=re==="delete"||X.length===ne.length?Ar(X,ie):null)||J.addKeys(X),(ie||ne)&&(U=N,B=ie,D=ne,v.indexes.forEach(function(Z){var Ee=U(Z.name||"");function _e(ke){return ke!=null?Z.extractKey(ke):null}function Se(ke){return Z.multiEntry&&l(ke)?ke.forEach(function(Xe){return Ee.addKey(Xe)}):Ee.addKey(ke)}(B||D).forEach(function(ke,Me){var $e=B&&_e(B[Me]),Me=D&&_e(D[Me]);Ae($e,Me)!==0&&($e!=null&&Se($e),Me!=null&&Se(Me))})}))):X?(ne={from:X.lower,to:X.upper},J.add(ne),z.add(ne)):(z.add(h),J.add(h),v.indexes.forEach(function(Z){return N(Z.name).add(h)})),g.mutate(R).then(function(Z){return!X||R.type!=="add"&&R.type!=="put"||(z.addKeys(Z.results),A&&A.forEach(function(Ee){var _e=R.values.map(function(ke){return Ee.extractKey(ke)}),Se=Ee.keyPath.findIndex(function(ke){return ke===w.keyPath});Z.results.forEach(function(ke){return _e[Se]=ke}),N(Ee.name).addKeys(_e)})),K.mutatedParts=pn(K.mutatedParts||{},M),Z})}}),S=function(N){var U=N.query,N=U.index,U=U.range;return[N,new qe((N=U.lower)!==null&&N!==void 0?N:o.MIN_KEY,(U=U.upper)!==null&&U!==void 0?U:o.MAX_KEY)]},L={get:function(R){return[w,new qe(R.key)]},getMany:function(R){return[w,new qe().addKeys(R.keys)]},count:S,query:S,openCursor:S};return u(L).forEach(function(R){P[R]=function(N){var U=pe.subscr,B=!!U,D=Rr(pe,g)&&Tr(R,N)?N.obsSet={}:U;if(B){var K=function(ne){return ne="idb://".concat(c,"/").concat(p,"/").concat(ne),D[ne]||(D[ne]=new qe)},M=K(""),z=K(":dels"),U=L[R](N),B=U[0],U=U[1];if((R==="query"&&B.isPrimaryKey&&!N.values?z:K(B.name||"")).add(U),!B.isPrimaryKey){if(R!=="count"){var J=R==="query"&&T&&N.values&&g.query(r(r({},N),{values:!1}));return g[R].apply(this,arguments).then(function(ne){if(R==="query"){if(T&&N.values)return J.then(function(_e){return _e=_e.result,M.addKeys(_e),ne});var ie=N.values?ne.result.map(x):ne.result;(N.values?M:z).addKeys(ie)}else if(R==="openCursor"){var Z=ne,Ee=N.values;return Z&&Object.create(Z,{key:{get:function(){return z.addKey(Z.primaryKey),Z.key}},primaryKey:{get:function(){var _e=Z.primaryKey;return z.addKey(_e),_e}},value:{get:function(){return Ee&&M.addKey(Z.primaryKey),Z.value}}})}return ne})}z.add(h)}}return g[R].apply(this,arguments)}}),P}})}};function Cr(o,c,h){if(h.numFailures===0)return c;if(c.type==="deleteRange")return null;var p=c.keys?c.keys.length:"values"in c&&c.values?c.values.length:1;return h.numFailures===p?null:(c=r({},c),l(c.keys)&&(c.keys=c.keys.filter(function(g,v){return!(v in h.failures)})),"values"in c&&l(c.values)&&(c.values=c.values.filter(function(g,v){return!(v in h.failures)})),c)}function Xn(o,c){return h=o,((p=c).lower===void 0||(p.lowerOpen?0<Ae(h,p.lower):0<=Ae(h,p.lower)))&&(o=o,(c=c).upper===void 0||(c.upperOpen?Ae(o,c.upper)<0:Ae(o,c.upper)<=0));var h,p}function Br(o,c,L,p,g,v){if(!L||L.length===0)return o;var w=c.query.index,x=w.multiEntry,T=c.query.range,A=p.schema.primaryKey.extractKey,P=w.extractKey,S=(w.lowLevelIndex||w).extractKey,L=L.reduce(function(R,N){var U=R,B=[];if(N.type==="add"||N.type==="put")for(var D=new qe,K=N.values.length-1;0<=K;--K){var M,z=N.values[K],J=A(z);D.hasKey(J)||(M=P(z),(x&&l(M)?M.some(function(ie){return Xn(ie,T)}):Xn(M,T))&&(D.addKey(J),B.push(z)))}switch(N.type){case"add":U=R.concat(c.values?B:B.map(function(Z){return A(Z)}));break;case"put":var re=new qe().addKeys(N.values.map(function(Z){return A(Z)})),U=R.filter(function(Z){return!re.hasKey(c.values?A(Z):Z)}).concat(c.values?B:B.map(function(Z){return A(Z)}));break;case"delete":var X=new qe().addKeys(N.keys);U=R.filter(function(Z){return!X.hasKey(c.values?A(Z):Z)});break;case"deleteRange":var ne=N.range;U=R.filter(function(Z){return!Xn(A(Z),ne)})}return U},o);return L===o?o:(L.sort(function(R,N){return Ae(S(R),S(N))||Ae(A(R),A(N))}),c.limit&&c.limit<1/0&&(L.length>c.limit?L.length=c.limit:o.length===c.limit&&L.length<c.limit&&(g.dirty=!0)),v?Object.freeze(L):L)}function Nr(o,c){return Ae(o.lower,c.lower)===0&&Ae(o.upper,c.upper)===0&&!!o.lowerOpen==!!c.lowerOpen&&!!o.upperOpen==!!c.upperOpen}function hi(o,c){return function(h,p,g,v){if(h===void 0)return p!==void 0?-1:0;if(p===void 0)return 1;if((p=Ae(h,p))===0){if(g&&v)return 0;if(g)return 1;if(v)return-1}return p}(o.lower,c.lower,o.lowerOpen,c.lowerOpen)<=0&&0<=function(h,p,g,v){if(h===void 0)return p!==void 0?1:0;if(p===void 0)return-1;if((p=Ae(h,p))===0){if(g&&v)return 0;if(g)return-1;if(v)return 1}return p}(o.upper,c.upper,o.upperOpen,c.upperOpen)}function fi(o,c,h,p){o.subscribers.add(h),p.addEventListener("abort",function(){var g,v;o.subscribers.delete(h),o.subscribers.size===0&&(g=o,v=c,setTimeout(function(){g.subscribers.size===0&&se(v,g)},3e3))})}var di={stack:"dbcore",level:0,name:"Cache",create:function(o){var c=o.schema.name;return r(r({},o),{transaction:function(h,p,g){var v,w,x=o.transaction(h,p,g);return p==="readwrite"&&(w=(v=new AbortController).signal,g=function(T){return function(){if(v.abort(),p==="readwrite"){for(var A=new Set,P=0,S=h;P<S.length;P++){var L=S[P],R=wt["idb://".concat(c,"/").concat(L)];if(R){var N=o.table(L),U=R.optimisticOps.filter(function(Ee){return Ee.trans===x});if(x._explicit&&T&&x.mutatedParts)for(var B=0,D=Object.values(R.queries.query);B<D.length;B++)for(var K=0,M=(re=D[B]).slice();K<M.length;K++)jn((X=M[K]).obsSet,x.mutatedParts)&&(se(re,X),X.subscribers.forEach(function(Ee){return A.add(Ee)}));else if(0<U.length){R.optimisticOps=R.optimisticOps.filter(function(Ee){return Ee.trans!==x});for(var z=0,J=Object.values(R.queries.query);z<J.length;z++)for(var re,X,ne,ie=0,Z=(re=J[z]).slice();ie<Z.length;ie++)(X=Z[ie]).res!=null&&x.mutatedParts&&(T&&!X.dirty?(ne=Object.isFrozen(X.res),ne=Br(X.res,X.req,U,N,X,ne),X.dirty?(se(re,X),X.subscribers.forEach(function(Ee){return A.add(Ee)})):ne!==X.res&&(X.res=ne,X.promise=ae.resolve({result:ne}))):(X.dirty&&se(re,X),X.subscribers.forEach(function(Ee){return A.add(Ee)})))}}}A.forEach(function(Ee){return Ee()})}}},x.addEventListener("abort",g(!1),{signal:w}),x.addEventListener("error",g(!1),{signal:w}),x.addEventListener("complete",g(!0),{signal:w})),x},table:function(h){var p=o.table(h),g=p.schema.primaryKey;return r(r({},p),{mutate:function(v){var w=pe.trans;if(g.outbound||w.db._options.cache==="disabled"||w.explicit)return p.mutate(v);var x=wt["idb://".concat(c,"/").concat(h)];return x?(w=p.mutate(v),v.type!=="add"&&v.type!=="put"||!(50<=v.values.length||Jn(g,v).some(function(T){return T==null}))?(x.optimisticOps.push(v),v.mutatedParts&&yn(v.mutatedParts),w.then(function(T){0<T.numFailures&&(se(x.optimisticOps,v),(T=Cr(0,v,T))&&x.optimisticOps.push(T),v.mutatedParts&&yn(v.mutatedParts))}),w.catch(function(){se(x.optimisticOps,v),v.mutatedParts&&yn(v.mutatedParts)})):w.then(function(T){var A=Cr(0,r(r({},v),{values:v.values.map(function(R,S){var L,R=(L=g.keyPath)!==null&&L!==void 0&&L.includes(".")?be(R):r({},R);return j(R,g.keyPath,T.results[S]),R})}),T);x.optimisticOps.push(A),queueMicrotask(function(){return v.mutatedParts&&yn(v.mutatedParts)})}),w):p.mutate(v)},query:function(v){if(!Rr(pe,p)||!Tr("query",v))return p.query(v);var w=((A=pe.trans)===null||A===void 0?void 0:A.db._options.cache)==="immutable",S=pe,x=S.requery,T=S.signal,A=function(N,U,B,D){var K=wt["idb://".concat(N,"/").concat(U)];if(!K)return[];if(!(U=K.queries[B]))return[null,!1,K,null];var M=U[(D.query?D.query.index.name:null)||""];if(!M)return[null,!1,K,null];switch(B){case"query":var z=M.find(function(J){return J.req.limit===D.limit&&J.req.values===D.values&&Nr(J.req.query.range,D.query.range)});return z?[z,!0,K,M]:[M.find(function(J){return("limit"in J.req?J.req.limit:1/0)>=D.limit&&(!D.values||J.req.values)&&hi(J.req.query.range,D.query.range)}),!1,K,M];case"count":return z=M.find(function(J){return Nr(J.req.query.range,D.query.range)}),[z,!!z,K,M]}}(c,h,"query",v),P=A[0],S=A[1],L=A[2],R=A[3];return P&&S?P.obsSet=v.obsSet:(S=p.query(v).then(function(N){var U=N.result;if(P&&(P.res=U),w){for(var B=0,D=U.length;B<D;++B)Object.freeze(U[B]);Object.freeze(U)}else N.result=be(U);return N}).catch(function(N){return R&&P&&se(R,P),Promise.reject(N)}),P={obsSet:v.obsSet,promise:S,subscribers:new Set,type:"query",req:v,dirty:!1},R?R.push(P):(R=[P],(L=L||(wt["idb://".concat(c,"/").concat(h)]={queries:{query:{},count:{}},objs:new Map,optimisticOps:[],unsignaledParts:{}})).queries.query[v.query.index.name||""]=R)),fi(P,R,x,T),P.promise.then(function(N){return{result:Br(N.result,v,L==null?void 0:L.optimisticOps,p,P,w)}})}})}})}};function mn(o,c){return new Proxy(o,{get:function(h,p,g){return p==="db"?c:Reflect.get(h,p,g)}})}var it=(Le.prototype.version=function(o){if(isNaN(o)||o<.1)throw new ue.Type("Given version is not a positive number");if(o=Math.round(10*o)/10,this.idbdb||this._state.isBeingOpened)throw new ue.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,o);var c=this._versions,h=c.filter(function(p){return p._cfg.version===o})[0];return h||(h=new this.Version(o),c.push(h),c.sort(ni),h.stores({}),this._state.autoSchema=!1,h)},Le.prototype._whenReady=function(o){var c=this;return this.idbdb&&(this._state.openComplete||pe.letThrough||this._vip)?o():new ae(function(h,p){if(c._state.openComplete)return p(new ue.DatabaseClosed(c._state.dbOpenError));if(!c._state.isBeingOpened){if(!c._state.autoOpen)return void p(new ue.DatabaseClosed);c.open().catch(ve)}c._state.dbReadyPromise.then(h,p)}).then(o)},Le.prototype.use=function(o){var c=o.stack,h=o.create,p=o.level,g=o.name;return g&&this.unuse({stack:c,name:g}),o=this._middlewares[c]||(this._middlewares[c]=[]),o.push({stack:c,create:h,level:p??10,name:g}),o.sort(function(v,w){return v.level-w.level}),this},Le.prototype.unuse=function(o){var c=o.stack,h=o.name,p=o.create;return c&&this._middlewares[c]&&(this._middlewares[c]=this._middlewares[c].filter(function(g){return p?g.create!==p:!!h&&g.name!==h})),this},Le.prototype.open=function(){var o=this;return mt(st,function(){return oi(o)})},Le.prototype._close=function(){var o=this._state,c=At.indexOf(this);if(0<=c&&At.splice(c,1),this.idbdb){try{this.idbdb.close()}catch{}this.idbdb=null}o.isBeingOpened||(o.dbReadyPromise=new ae(function(h){o.dbReadyResolve=h}),o.openCanceller=new ae(function(h,p){o.cancelOpen=p}))},Le.prototype.close=function(h){var c=(h===void 0?{disableAutoOpen:!0}:h).disableAutoOpen,h=this._state;c?(h.isBeingOpened&&h.cancelOpen(new ue.DatabaseClosed),this._close(),h.autoOpen=!1,h.dbOpenError=new ue.DatabaseClosed):(this._close(),h.autoOpen=this._options.autoOpen||h.isBeingOpened,h.openComplete=!1,h.dbOpenError=null)},Le.prototype.delete=function(o){var c=this;o===void 0&&(o={disableAutoOpen:!0});var h=0<arguments.length&&typeof arguments[0]!="object",p=this._state;return new ae(function(g,v){function w(){c.close(o);var x=c._deps.indexedDB.deleteDatabase(c.name);x.onsuccess=Ne(function(){var T,A,P;T=c._deps,A=c.name,P=T.indexedDB,T=T.IDBKeyRange,Hn(P)||A===tn||Mn(P,T).delete(A).catch(ve),g()}),x.onerror=et(v),x.onblocked=c._fireOnBlocked}if(h)throw new ue.InvalidArgument("Invalid closeOptions argument to db.delete()");p.isBeingOpened?p.dbReadyPromise.then(w):w()})},Le.prototype.backendDB=function(){return this.idbdb},Le.prototype.isOpen=function(){return this.idbdb!==null},Le.prototype.hasBeenClosed=function(){var o=this._state.dbOpenError;return o&&o.name==="DatabaseClosed"},Le.prototype.hasFailed=function(){return this._state.dbOpenError!==null},Le.prototype.dynamicallyOpened=function(){return this._state.autoSchema},Object.defineProperty(Le.prototype,"tables",{get:function(){var o=this;return u(this._allTables).map(function(c){return o._allTables[c]})},enumerable:!1,configurable:!0}),Le.prototype.transaction=function(){var o=(function(c,h,p){var g=arguments.length;if(g<2)throw new ue.InvalidArgument("Too few arguments");for(var v=new Array(g-1);--g;)v[g-1]=arguments[g];return p=v.pop(),[c,me(v),p]}).apply(this,arguments);return this._transaction.apply(this,o)},Le.prototype._transaction=function(o,c,h){var p=this,g=pe.trans;g&&g.db===this&&o.indexOf("!")===-1||(g=null);var v,w,x=o.indexOf("?")!==-1;o=o.replace("!","").replace("?","");try{if(w=c.map(function(A){if(A=A instanceof p.Table?A.name:A,typeof A!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return A}),o=="r"||o===Tn)v=Tn;else{if(o!="rw"&&o!=Cn)throw new ue.InvalidArgument("Invalid transaction mode: "+o);v=Cn}if(g){if(g.mode===Tn&&v===Cn){if(!x)throw new ue.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");g=null}g&&w.forEach(function(A){if(g&&g.storeNames.indexOf(A)===-1){if(!x)throw new ue.SubTransaction("Table "+A+" not included in parent transaction.");g=null}}),x&&g&&!g.active&&(g=null)}}catch(A){return g?g._promise(null,function(P,S){S(A)}):Pe(A)}var T=(function A(P,S,L,R,N){return ae.resolve().then(function(){var U=pe.transless||pe,B=P._createTransaction(S,L,P._dbSchema,R);if(B.explicit=!0,U={trans:B,transless:U},R)B.idbtrans=R.idbtrans;else try{B.create(),B.idbtrans._explicit=!0,P._state.PR1398_maxLoop=3}catch(M){return M.name===Ke.InvalidState&&P.isOpen()&&0<--P._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),P.close({disableAutoOpen:!1}),P.open().then(function(){return A(P,S,L,null,N)})):Pe(M)}var D,K=we(N);return K&&St(),U=ae.follow(function(){var M;(D=N.call(B,B))&&(K?(M=at.bind(null,null),D.then(M,M)):typeof D.next=="function"&&typeof D.throw=="function"&&(D=Zn(D)))},U),(D&&typeof D.then=="function"?ae.resolve(D).then(function(M){return B.active?M:Pe(new ue.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))}):U.then(function(){return D})).then(function(M){return R&&B._resolve(),B._completion.then(function(){return M})}).catch(function(M){return B._reject(M),Pe(M)})})}).bind(null,this,v,w,g,h);return g?g._promise(v,T,"lock"):pe.trans?mt(pe.transless,function(){return p._whenReady(T)}):this._whenReady(T)},Le.prototype.table=function(o){if(!m(this._allTables,o))throw new ue.InvalidTable("Table ".concat(o," does not exist"));return this._allTables[o]},Le);function Le(o,c){var h=this;this._middlewares={},this.verno=0;var p=Le.dependencies;this._options=c=r({addons:Le.addons,autoOpen:!0,indexedDB:p.indexedDB,IDBKeyRange:p.IDBKeyRange,cache:"cloned"},c),this._deps={indexedDB:c.indexedDB,IDBKeyRange:c.IDBKeyRange},p=c.addons,this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;var g,v,w,x,T,A={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:ve,dbReadyPromise:null,cancelOpen:ve,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3,autoOpen:c.autoOpen};A.dbReadyPromise=new ae(function(S){A.dbReadyResolve=S}),A.openCanceller=new ae(function(S,L){A.cancelOpen=L}),this._state=A,this.name=o,this.on=Ot(this,"populate","blocked","versionchange","close",{ready:[wn,ve]}),this.on.ready.subscribe=W(this.on.ready.subscribe,function(S){return function(L,R){Le.vip(function(){var N,U=h._state;U.openComplete?(U.dbOpenError||ae.resolve().then(L),R&&S(L)):U.onReadyBeingFired?(U.onReadyBeingFired.push(L),R&&S(L)):(S(L),N=h,R||S(function B(){N.on.ready.unsubscribe(L),N.on.ready.unsubscribe(B)}))})}}),this.Collection=(g=this,Dt(Zr.prototype,function(D,B){this.db=g;var R=ur,N=null;if(B)try{R=B()}catch(K){N=K}var U=D._ctx,B=U.table,D=B.hook.reading.fire;this._ctx={table:B,index:U.index,isPrimKey:!U.index||B.schema.primKey.keyPath&&U.index===B.schema.primKey.name,range:R,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:N,or:U.or,valueMapper:D!==Be?D:null}})),this.Table=(v=this,Dt(dr.prototype,function(S,L,R){this.db=v,this._tx=R,this.name=S,this.schema=L,this.hook=v._allTables[S]?v._allTables[S].hook:Ot(null,{creating:[Vt,ve],reading:[Je,Be],updating:[Hr,ve],deleting:[Mr,ve]})})),this.Transaction=(w=this,Dt(Xr.prototype,function(S,L,R,N,U){var B=this;this.db=w,this.mode=S,this.storeNames=L,this.schema=R,this.chromeTransactionDurability=N,this.idbtrans=null,this.on=Ot(this,"complete","error","abort"),this.parent=U||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new ae(function(D,K){B._resolve=D,B._reject=K}),this._completion.then(function(){B.active=!1,B.on.complete.fire()},function(D){var K=B.active;return B.active=!1,B.on.error.fire(D),B.parent?B.parent._reject(D):K&&B.idbtrans&&B.idbtrans.abort(),Pe(D)})})),this.Version=(x=this,Dt(si.prototype,function(S){this.db=x,this._cfg={version:S,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})),this.WhereClause=(T=this,Dt(br.prototype,function(S,L,R){if(this.db=T,this._ctx={table:S,index:L===":id"?null:L,or:R},this._cmp=this._ascending=Ae,this._descending=function(N,U){return Ae(U,N)},this._max=function(N,U){return 0<Ae(N,U)?N:U},this._min=function(N,U){return Ae(N,U)<0?N:U},this._IDBKeyRange=T._deps.IDBKeyRange,!this._IDBKeyRange)throw new ue.MissingAPI})),this.on("versionchange",function(S){0<S.newVersion?console.warn("Another connection wants to upgrade database '".concat(h.name,"'. Closing db now to resume the upgrade.")):console.warn("Another connection wants to delete database '".concat(h.name,"'. Closing db now to resume the delete request.")),h.close({disableAutoOpen:!1})}),this.on("blocked",function(S){!S.newVersion||S.newVersion<S.oldVersion?console.warn("Dexie.delete('".concat(h.name,"') was blocked")):console.warn("Upgrade '".concat(h.name,"' blocked by other connection holding version ").concat(S.oldVersion/10))}),this._maxKey=Ht(c.IDBKeyRange),this._createTransaction=function(S,L,R,N){return new h.Transaction(S,L,R,h._options.chromeTransactionDurability,N)},this._fireOnBlocked=function(S){h.on("blocked").fire(S),At.filter(function(L){return L.name===h.name&&L!==h&&!L._state.vcFired}).map(function(L){return L.on("versionchange").fire(S)})},this.use(ui),this.use(di),this.use(li),this.use(ai),this.use(ci);var P=new Proxy(this,{get:function(S,L,R){if(L==="_vip")return!0;if(L==="table")return function(U){return mn(h.table(U),P)};var N=Reflect.get(S,L,R);return N instanceof dr?mn(N,P):L==="tables"?N.map(function(U){return mn(U,P)}):L==="_createTransaction"?function(){return mn(N.apply(this,arguments),P)}:N}});this.vip=P,p.forEach(function(S){return S(h)})}var bn,Ye=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable",pi=(Qn.prototype.subscribe=function(o,c,h){return this._subscribe(o&&typeof o!="function"?o:{next:o,error:c,complete:h})},Qn.prototype[Ye]=function(){return this},Qn);function Qn(o){this._subscribe=o}try{bn={indexedDB:a.indexedDB||a.mozIndexedDB||a.webkitIndexedDB||a.msIndexedDB,IDBKeyRange:a.IDBKeyRange||a.webkitIDBKeyRange}}catch{bn={indexedDB:null,IDBKeyRange:null}}function Ir(o){var c,h=!1,p=new pi(function(g){var v=we(o),w,x=!1,T={},A={},P={get closed(){return x},unsubscribe:function(){x||(x=!0,w&&w.abort(),S&&ht.storagemutated.unsubscribe(R))}};g.start&&g.start(P);var S=!1,L=function(){return Rn(N)},R=function(U){pn(T,U),jn(A,T)&&L()},N=function(){var U,B,D;!x&&bn.indexedDB&&(T={},U={},w&&w.abort(),w=new AbortController,D=function(K){var M=kt();try{v&&St();var z=ot(o,K);return z=v?z.finally(at):z}finally{M&&$t()}}(B={subscr:U,signal:w.signal,requery:L,querier:o,trans:null}),Promise.resolve(D).then(function(K){h=!0,c=K,x||B.signal.aborted||(T={},function(M){for(var z in M)if(m(M,z))return;return 1}(A=U)||S||(ht(Mt,R),S=!0),Rn(function(){return!x&&g.next&&g.next(K)}))},function(K){h=!1,["DatabaseClosedError","AbortError"].includes(K==null?void 0:K.name)||x||Rn(function(){x||g.error&&g.error(K)})}))};return setTimeout(L,0),P});return p.hasValue=function(){return h},p.getValue=function(){return c},p}var Et=it;function er(o){var c=ft;try{ft=!0,ht.storagemutated.fire(o),Gn(o,!0)}finally{ft=c}}E(Et,r(r({},je),{delete:function(o){return new Et(o,{addons:[]}).delete()},exists:function(o){return new Et(o,{addons:[]}).open().then(function(c){return c.close(),!0}).catch("NoSuchDatabaseError",function(){return!1})},getDatabaseNames:function(o){try{return c=Et.dependencies,h=c.indexedDB,c=c.IDBKeyRange,(Hn(h)?Promise.resolve(h.databases()).then(function(p){return p.map(function(g){return g.name}).filter(function(g){return g!==tn})}):Mn(h,c).toCollection().primaryKeys()).then(o)}catch{return Pe(new ue.MissingAPI)}var c,h},defineClass:function(){return function(o){f(this,o)}},ignoreTransaction:function(o){return pe.trans?mt(pe.transless,o):o()},vip:qn,async:function(o){return function(){try{var c=Zn(o.apply(this,arguments));return c&&typeof c.then=="function"?c:ae.resolve(c)}catch(h){return Pe(h)}}},spawn:function(o,c,h){try{var p=Zn(o.apply(h,c||[]));return p&&typeof p.then=="function"?p:ae.resolve(p)}catch(g){return Pe(g)}},currentTransaction:{get:function(){return pe.trans||null}},waitFor:function(o,c){return c=ae.resolve(typeof o=="function"?Et.ignoreTransaction(o):o).timeout(c||6e4),pe.trans?pe.trans.waitFor(c):c},Promise:ae,debug:{get:function(){return Qe},set:function(o){nr(o)}},derive:$,extend:f,props:E,override:W,Events:Ot,on:ht,liveQuery:Ir,extendObservabilitySet:pn,getByKeyPath:V,setByKeyPath:j,delByKeyPath:function(o,c){typeof c=="string"?j(o,c,void 0):"length"in c&&[].map.call(c,function(h){j(o,h,void 0)})},shallowClone:G,deepClone:be,getObjectDiff:Yn,cmp:Ae,asap:oe,minKey:-1/0,addons:[],connections:At,errnames:Ke,dependencies:bn,cache:wt,semVer:"4.0.8",version:"4.0.8".split(".").map(function(o){return parseInt(o)}).reduce(function(o,c,h){return o+c/Math.pow(10,2*h)})})),Et.maxKey=Ht(Et.dependencies.IDBKeyRange),typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(ht(Mt,function(o){ft||(o=new CustomEvent(Pn,{detail:o}),ft=!0,dispatchEvent(o),ft=!1)}),addEventListener(Pn,function(o){o=o.detail,ft||er(o)}));var Ct,ft=!1,Pr=function(){};return typeof BroadcastChannel<"u"&&((Pr=function(){(Ct=new BroadcastChannel(Pn)).onmessage=function(o){return o.data&&er(o.data)}})(),typeof Ct.unref=="function"&&Ct.unref(),ht(Mt,function(o){ft||Ct.postMessage(o)})),typeof addEventListener<"u"&&(addEventListener("pagehide",function(o){if(!it.disableBfCache&&o.persisted){Qe&&console.debug("Dexie: handling persisted pagehide"),Ct!=null&&Ct.close();for(var c=0,h=At;c<h.length;c++)h[c].close({disableAutoOpen:!1})}}),addEventListener("pageshow",function(o){!it.disableBfCache&&o.persisted&&(Qe&&console.debug("Dexie: handling persisted pageshow"),Pr(),er({all:new qe(-1/0,[[]])}))})),ae.rejectionMapper=function(o,c){return!o||o instanceof Te||o instanceof TypeError||o instanceof SyntaxError||!o.name||!Ze[o.name]?o:(c=new Ze[o.name](c||o.message,o),"stack"in o&&O(c,"stack",{get:function(){return this.inner.stack}}),c)},nr(Qe),r(it,Object.freeze({__proto__:null,Dexie:it,liveQuery:Ir,Entity:lr,cmp:Ae,PropModSymbol:rt,PropModification:Ft,replacePrefix:function(o,c){return new Ft({replacePrefix:[o,c]})},add:function(o){return new Ft({add:o})},remove:function(o){return new Ft({remove:o})},default:it,RangeSet:qe,mergeRanges:jt,rangesOverlap:xr}),{default:it}),it})})(dexie_min);var dexie_minExports=dexie_min.exports;const _Dexie=getDefaultExportFromCjs(dexie_minExports),DexieSymbol=Symbol.for("Dexie"),Dexie=globalThis[DexieSymbol]||(globalThis[DexieSymbol]=_Dexie);if(_Dexie.semVer!==Dexie.semVer)throw new Error(`Two different versions of Dexie loaded in the same app: ${_Dexie.semVer} and ${Dexie.semVer}`);var Database=class extends Dexie{constructor(e){super(e);_(this,"profiles");_(this,"events");_(this,"eventTags");_(this,"nip05");_(this,"lnurl");_(this,"relayStatus");_(this,"unpublishedEvents");this.version(15).stores({profiles:"&pubkey",events:"&id, kind",eventTags:"&tagValue",nip05:"&nip05",lnurl:"&pubkey",relayStatus:"&url",unpublishedEvents:"&id"})}},db;function createDatabase(t){db=new Database(t)}var CacheHandler=class{constructor(t){_(this,"cache");_(this,"dirtyKeys",new Set);_(this,"options");_(this,"debug");_(this,"indexes");_(this,"isSet",!1);_(this,"maxSize",0);this.debug=t.debug,this.options=t,this.maxSize=t.maxSize,t.maxSize>0&&(this.cache=new dist.LRUCache({maxSize:t.maxSize}),setInterval(()=>this.dump().catch(console.error),1e3*10)),this.indexes=new Map}getSet(t){var e;return(e=this.cache)==null?void 0:e.get(t)}getAllWithFilter(t){var n;const e=new Map;return(n=this.cache)==null||n.forEach((r,s)=>{t(s,r)&&e.set(s,r)}),e}get(t){var e;return(e=this.cache)==null?void 0:e.get(t)}async getWithFallback(t,e){let n=this.get(t);return n||(n=await e.get(t),n&&this.set(t,n)),n}async getManyWithFallback(t,e){const n=[],r=[];for(const s of t){const a=this.get(s);a?n.push(a):r.push(s)}if(n.length>0&&this.debug(`Cache hit for keys ${n.length} and miss for ${r.length} keys`),r.length>0){const s=Date.now(),a=await e.bulkGet(r),u=Date.now();let l=0;for(const f of a)f&&(this.set(f.id,f),n.push(f),l++);this.debug(`Time spent querying database: ${u-s}ms for ${r.length} keys, which added ${l} entries to the cache`)}return n}add(t,e,n=!0){var s;const r=this.get(t)??new Set;r.add(e),(s=this.cache)==null||s.set(t,r),n&&this.dirtyKeys.add(t)}set(t,e,n=!0){var r;(r=this.cache)==null||r.set(t,e),n&&this.dirtyKeys.add(t);for(const[s,a]of this.indexes.entries()){const u=e[s];if(u){const l=a.get(u)||new Set;l.add(t),a.set(u,l)}}}size(){var t;return((t=this.cache)==null?void 0:t.size)||0}delete(t){var e;(e=this.cache)==null||e.delete(t),this.dirtyKeys.add(t)}async dump(){this.dirtyKeys.size>0&&(await this.options.dump(this.dirtyKeys,this.cache),this.dirtyKeys.clear())}addIndex(t){this.indexes.set(t,new dist.LRUCache({maxSize:this.options.maxSize}))}getFromIndex(t,e){var r,s;const n=new Set;return(s=(r=this.indexes.get(t))==null?void 0:r.get(e))==null||s.forEach(a=>{const u=this.get(a);u&&n.add(u)}),n}},d=createDebug2("ndk:dexie-adapter:profiles");async function profilesWarmUp(t,e){const n=await e.limit(t.maxSize).toArray();for(const r of n){const s=r;t.set(r.pubkey,s,!1)}d("Loaded %d profiles from database",t.size())}var profilesDump=(t,e)=>async(n,r)=>{const s=[];for(const a of n){const u=r.get(a);u&&s.push(u)}s.length&&(e(`Saving ${s.length} users to database`),await t.bulkPut(s)),n.clear()};async function zapperWarmUp(t,e){const n=await e.limit(t.maxSize).toArray();for(const r of n)t.set(r.pubkey,{document:r.document,fetchedAt:r.fetchedAt},!1)}var zapperDump=(t,e)=>async(n,r)=>{const s=[];for(const a of n){const u=r.get(a);u&&s.push({pubkey:a,...u})}s.length&&(e(`Saving ${s.length} zapper cache entries to database`),await t.bulkPut(s)),n.clear()};async function nip05WarmUp(t,e){const n=await e.limit(t.maxSize).toArray();for(const r of n)t.set(r.nip05,r,!1)}var nip05Dump=(t,e)=>async(n,r)=>{const s=[];for(const a of n){const u=r.get(a);u&&s.push({nip05:a,...u})}s.length&&(e(`Saving ${s.length} NIP-05 cache entries to database`),await t.bulkPut(s)),n.clear()};async function eventsWarmUp(t,e){const n=await e.limit(t.maxSize).toArray();for(const r of n)t.set(r.id,r,!1)}var eventsDump=(t,e)=>async(n,r)=>{const s=[];for(const a of n){const u=r.get(a);u&&s.push(u)}s.length>0&&(e(`Saving ${s.length} events cache entries to database`),await t.bulkPut(s)),n.clear()};async function eventTagsWarmUp(t,e){const n=await e.limit(t.maxSize).toArray();for(const r of n)t.add(r.tagValue,r.eventId,!1)}var eventTagsDump=(t,e)=>async(n,r)=>{const s=[];for(const a of n){const u=r.get(a);if(u)for(const l of u)s.push({tagValue:a,eventId:l})}s.length>0&&(e(`Saving ${s.length} events cache entries to database`),await t.bulkPut(s)),n.clear()};async function relayInfoWarmUp(t,e){const n=await e.limit(t.maxSize).toArray();for(const r of n)t.set(r.url,{url:r.url,updatedAt:r.updatedAt,lastConnectedAt:r.lastConnectedAt,dontConnectBefore:r.dontConnectBefore},!1)}var relayInfoDump=(t,e)=>async(n,r)=>{const s=[];for(const a of n){const u=r.get(a);u&&s.push({url:a,updatedAt:u.updatedAt,lastConnectedAt:u.lastConnectedAt,dontConnectBefore:u.dontConnectBefore})}s.length>0&&(e(`Saving ${s.length} relay status cache entries to database`),await t.bulkPut(s)),n.clear()},WRITE_STATUS_THRESHOLD=3;async function unpublishedEventsWarmUp(t,e){await e.each(n=>{t.set(n.event.id,n,!1)})}function unpublishedEventsDump(t,e){return async(n,r)=>{const s=[];for(const a of n){const u=r.get(a);u&&s.push(u)}s.length>0&&(e(`Saving ${s.length} unpublished events cache entries to database`),await t.bulkPut(s)),n.clear()}}async function discardUnpublishedEvent(t,e){await t.delete(e)}async function getUnpublishedEvents(t){const e=[];return await t.each(n=>{e.push({event:new NDKEvent(void 0,n.event),relays:Object.keys(n.relays),lastTryAt:n.lastTryAt})}),e}function addUnpublishedEvent(t,e){const n={};e.forEach(s=>n[s]=!1),this.unpublishedEvents.set(t.id,{id:t.id,event:t.rawEvent(),relays:n});const r=s=>{const a=s.url,u=this.unpublishedEvents.get(t.id);if(!u){t.off("publushed",r);return}u.relays[a]=!0,this.unpublishedEvents.set(t.id,u);let l=Object.values(u.relays).filter(y=>y).length,f=Object.values(u.relays).length-l;(l>=WRITE_STATUS_THRESHOLD||f===0)&&(this.unpublishedEvents.delete(t.id),t.off("published",r))};t.on("published",r)}var INDEXABLE_TAGS_LIMIT=10,NDKCacheAdapterDexie=class{constructor(t={}){_(this,"debug");_(this,"locking",!1);_(this,"ready",!1);_(this,"profiles");_(this,"zappers");_(this,"nip05s");_(this,"events");_(this,"eventTags");_(this,"relayInfo");_(this,"unpublishedEvents");_(this,"warmedUp",!1);_(this,"warmUpPromise");_(this,"devMode",!1);_(this,"_onReady");_(this,"addUnpublishedEvent",addUnpublishedEvent.bind(this));_(this,"getUnpublishedEvents",()=>getUnpublishedEvents(db.unpublishedEvents));_(this,"discardUnpublishedEvent",t=>discardUnpublishedEvent(db.unpublishedEvents,t));createDatabase(t.dbName||"ndk"),this.debug=t.debug||createDebug2("ndk:dexie-adapter"),this.profiles=new CacheHandler({maxSize:t.profileCacheSize||1e5,dump:profilesDump(db.profiles,this.debug),debug:this.debug}),this.zappers=new CacheHandler({maxSize:t.zapperCacheSize||200,dump:zapperDump(db.lnurl,this.debug),debug:this.debug}),this.nip05s=new CacheHandler({maxSize:t.nip05CacheSize||1e3,dump:nip05Dump(db.nip05,this.debug),debug:this.debug}),this.events=new CacheHandler({maxSize:t.eventCacheSize||5e4,dump:eventsDump(db.events,this.debug),debug:this.debug}),this.events.addIndex("pubkey"),this.events.addIndex("kind"),this.eventTags=new CacheHandler({maxSize:t.eventTagsCacheSize||1e5,dump:eventTagsDump(db.eventTags,this.debug),debug:this.debug}),this.relayInfo=new CacheHandler({maxSize:500,debug:this.debug,dump:relayInfoDump(db.relayStatus,this.debug)}),this.unpublishedEvents=new CacheHandler({maxSize:5e3,debug:this.debug,dump:unpublishedEventsDump(db.unpublishedEvents,this.debug)});const e=(r,s)=>{const a=Date.now();return s().then(()=>{const u=Date.now();this.debug(r,"took",u-a,"ms")})},n=Date.now();this.warmUpPromise=Promise.allSettled([e("profilesWarmUp",()=>profilesWarmUp(this.profiles,db.profiles)),e("zapperWarmUp",()=>zapperWarmUp(this.zappers,db.lnurl)),e("nip05WarmUp",()=>nip05WarmUp(this.nip05s,db.nip05)),e("relayInfoWarmUp",()=>relayInfoWarmUp(this.relayInfo,db.relayStatus)),e("unpublishedEventsWarmUp",()=>unpublishedEventsWarmUp(this.unpublishedEvents,db.unpublishedEvents)),e("eventsWarmUp",()=>eventsWarmUp(this.events,db.events)),e("eventTagsWarmUp",()=>eventTagsWarmUp(this.eventTags,db.eventTags))]),this.warmUpPromise.then(()=>{const r=Date.now();this.warmedUp=!0,this.ready=!0,this.locking=!0,this.debug("Warm up completed, time",r-n,"ms"),this._onReady&&this._onReady()})}onReady(t){this._onReady=t}async query(t){if(!this.warmedUp){const r=Date.now();await this.warmUpPromise,this.debug("froze query for",Date.now()-r,"ms",t.filters)}const e=Date.now();t.filters.map(r=>this.processFilter(r,t));const n=Date.now()-e;n>100&&this.debug("query took",n,"ms",t.filter)}async fetchProfile(t){return this.profiles?await this.profiles.getWithFallback(t,db.profiles):null}async getProfiles(t){if(this.profiles)return this.profiles.getAllWithFilter(t)}saveProfile(t,e){const n=this.profiles.get(t);n!=null&&n.created_at&&e.created_at&&n.created_at>=e.created_at||(this.profiles.set(t,{pubkey:t,...e}),this.debug("Saved profile for pubkey",t,e))}async loadNip05(t,e=3600){var a;const n=(a=this.nip05s)==null?void 0:a.get(t);if(n){if(n.profile===null)return n.fetchedAt+e*1e3<Date.now()?"missing":null;try{return JSON.parse(n.profile)}catch{return"missing"}}const r=await db.nip05.get({nip05:t});if(!r)return"missing";const s=Date.now();if(r.profile===null)return r.fetchedAt+e*1e3<s?"missing":null;try{return JSON.parse(r.profile)}catch{return"missing"}}async saveNip05(t,e){try{const n=e?JSON.stringify(e):null;this.nip05s.set(t,{profile:n,fetchedAt:Date.now()})}catch(n){console.error("Failed to save NIP-05 profile for nip05:",t,n)}}async loadUsersLNURLDoc(t,e=86400,n=3600){var u;const r=(u=this.zappers)==null?void 0:u.get(t);if(r){if(r.document===null)return r.fetchedAt+n*1e3<Date.now()?"missing":null;try{return JSON.parse(r.document)}catch{return"missing"}}const s=await db.lnurl.get({pubkey:t});if(!s)return"missing";const a=Date.now();if(s.fetchedAt+e*1e3<a)return"missing";if(s.document===null)return s.fetchedAt+n*1e3<a?"missing":null;try{return JSON.parse(s.document)}catch{return"missing"}}async saveUsersLNURLDoc(t,e){var n;try{const r=e?JSON.stringify(e):null;(n=this.zappers)==null||n.set(t,{document:r,fetchedAt:Date.now()})}catch(r){console.error("Failed to save LNURL document for pubkey:",t,r)}}processFilter(t,e){const n={...t};delete n.limit;const r=new Set(Object.keys(n||{}));r.delete("since"),r.delete("limit"),r.delete("until");try{if(this.byNip33Query(r,t,e)||this.byAuthors(t,e)||this.byIdsQuery(t,e)||this.byTags(t,e)||this.byKinds(r,t,e))return}catch(s){console.error(s)}}async deleteEvent(t){this.events.delete(t.tagId()),await db.events.where({id:t.tagId()}).delete()}async setEvent(t,e,n){if(t.kind===0){if(!this.profiles)return;try{const s=profileFromEvent(t);this.saveProfile(t.pubkey,s)}catch{this.debug(`Failed to save profile for pubkey: ${t.pubkey}`)}}let r=!0;if(t.isParamReplaceable()){const s=this.events.get(t.tagId());s&&t.created_at&&s.createdAt>t.created_at&&(r=!1)}if(r){this.events.set(t.tagId(),{id:t.tagId(),pubkey:t.pubkey,kind:t.kind,createdAt:t.created_at,relay:n==null?void 0:n.url,event:t.serialize(!0,!0)});const s=getIndexableTags(t);for(const a of s)this.eventTags.add(a[0]+a[1],t.tagId())}}updateRelayStatus(t,e){const n={url:t,updatedAt:Date.now(),...e};this.relayInfo.set(t,n)}getRelayStatus(t){const e=this.relayInfo.get(t);if(e)return{lastConnectedAt:e.lastConnectedAt,dontConnectBefore:e.dontConnectBefore}}byAuthors(t,e){if(!t.authors)return!1;let n=0;for(const r of t.authors){let s=Array.from(this.events.getFromIndex("pubkey",r));s.length,t.kinds&&(s=s.filter(a=>t.kinds.includes(a.kind))),foundEvents(e,s,t),n+=s.length}return!0}byIdsQuery(t,e){if(t.ids){for(const n of t.ids){const r=this.events.get(n);r&&foundEvent(e,r,r.relay,t)}return!0}return!1}byNip33Query(t,e,n){const r=["#d","authors","kinds"];if(t.size===r.length&&r.every(a=>t.has(a))&&e.kinds&&e.authors){for(const a of e.kinds)if(a>=3e4&&a<4e4)for(const l of e.authors)for(const f of e["#d"]){const y=`${a}:${l}:${f}`,b=this.events.get(y);b&&foundEvent(n,b,b.relay,e)}return!0}return!1}byTags(t,e){const n=Object.entries(t).filter(([r])=>r.startsWith("#")&&r.length===2).map(([r,s])=>[r[1],s]);if(n.length===0)return!1;for(const[r,s]of n)for(const a of s){const u=r+a,l=this.eventTags.getSet(u);l&&l.forEach(f=>{const y=this.events.get(f);y&&(!t.kinds||t.kinds.includes(y.kind))&&foundEvent(e,y,y.relay,t)})}return!0}byKinds(t,e,n){if(!e.kinds)return!1;const r=["kinds"],s=t.size===r.length&&r.every(u=>t.has(u));let a=[];if(!s)return!1;for(const u of e.kinds)a=[...a,...Array.from(this.events.getFromIndex("kind",u))];return foundEvents(n,a,e),!0}};function foundEvents(t,e,n){n!=null&&n.limit&&e.length>n.limit&&(e=e.sort((r,s)=>s.createdAt-r.createdAt).slice(0,n.limit));for(const r of e)foundEvent(t,r,r.relay,n)}function foundEvent(t,e,n,r){try{const s=deserialize(e.event);if(r&&!matchFilter(r,s))return;const a=new NDKEvent(void 0,s),u=n?t.pool.getRelay(n,!1):void 0;a.relay=u,t.eventReceived(a,u,!0)}catch(s){console.error("failed to deserialize event",s)}}function getIndexableTags(t){let e=[];if(t.kind===3)return[];for(const n of t.tags)if(n[0].length===1&&(e.push(n),e.length>=INDEXABLE_TAGS_LIMIT))return[];return e}const dexieAdapter=new NDKCacheAdapterDexie({dbName:"your-db-name"}),useNdkStore=defineStore({id:"ndk-store",state:()=>({initialized:!1,defaultExplicitRelayUrls:["wss://nos.lol/","wss://relay.damus.io/","wss://nostr.mom/"],explicitRelayUrls:[],defaultOutboxRelayUrls:["wss://purplepag.es"],outboxRelayUrls:[],enableOutboxModel:!1,ndk:null}),actions:{async initNdk(){if(this.ndk===null){let t={explicitRelayUrls:this.explicitRelayUrls.length?this.explicitRelayUrls:this.defaultExplicitRelayUrls,outboxRelayUrls:this.outboxRelayUrls.length?this.outboxRelayUrls:this.defaultOutboxRelayUrls,enableOutboxModel:this.enableOutboxModel,cacheAdapter:dexieAdapter};this.ndk=new NDK(t),this.initialized=!0}},setExplicitRelays(t=[]){this.explicitRelayUrls=t},resetExplicitRelays(){this.explicitRelayUrls=this.defaultExplicitRelayUrls},setOutBoxRelays(t=[]){this.outboxRelayUrls=t},resetOutboxModelRelays(){this.outboxRelayUrls=this.defaultOutboxRelayUrls},setOutboxModel(t){this.enableOutboxModel=t}},getters:{getDefaultExplicitRelays(t){return t.defaultExplicitRelayUrls},getDefaultOutboxRelays(t){return t.defaultOutboxRelayUrls}}});export{NDKNip07Signer as N,sha256$1 as a,getDefaultExportFromCjs as g,schnorr$1 as s,useNdkStore as u};
